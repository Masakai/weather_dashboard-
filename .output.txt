ont-weight=\"bold\" fill=\"#fff\">--</text>\n                            <text x=\"80\" y=\"95\" text-anchor=\"middle\" font-size=\"12\" fill=\"#94a3b8\">/ 100</text>\n                        </svg>\n                        <p id=\"score-comment\" class=\"text-sm text-slate-300 mt-3 text-center\">計算中...</p>\n                    </div>\n\n                    <!-- お気に入り地点 -->\n                    <div class=\"flex-1 w-full\">\n                        <h4 class=\"font-semibold text-sm mb-3 flex items-center gap-2\">\n                            <i data-lucide=\"bookmark\" class=\"w-4 h-4 text-blue-400\"></i>\n                            お気に入り地点\n                        </h4>\n                        <div id=\"favorite-locations\" class=\"space-y-2\">\n                            <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                                <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                                現在地をお気に入り に追加\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- メイン指標 -->\n            <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <!-- 気温カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden group hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の気温</div>\n                    <i data-lucide=\"thermometer\" class=\"w-12 h-12 text-orange-400 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-temp\">--°C</div>\n                    <div class=\"text-slate-300\">気温</div>\n                </div>\n\n                <!-- 雲量カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の雲量</div>\n                    <i data-lucide=\"cloud\" class=\"w-12 h-12 text-slate-300 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-clouds\">--%</div>\n                    <div class=\"text-slate-300\">全天雲 量</div>\n                </div>\n\n                <!-- 雲の詳細 -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col justify-center gap-4 hover:bg-white/5 transition\">\n                    <div class=\"text-slate-400 text-sm font-medium uppercase tracking-wider mb-2\">雲の層（高度別）</div>\n                    \n                    <div class=\"flex justify-between items-center\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-up\" class=\"w-4 h-4\"></i> 上層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-high\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 上層雲: Violet -->\n                        <div id=\"bar-high\" class=\"bg-violet-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"minus\" class=\"w-4 h-4\"></i> 中層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-mid\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 中層雲: Emerald -->\n                        <div id=\"bar-mid\" class=\"bg-emerald-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-down\" class=\"w-4 h-4\"></i> 下 層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-low\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 下層 雲: 明るいグレー -->\n                        <div id=\"bar-low\" class=\"bg-gray-300 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 追加気象データ + 天文薄明時刻 -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                <!-- 追加気象データ -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"gauge\" class=\"text-cyan-400 w-5 h-5\"></i> 詳細気象データ\n                    </h3>\n                    <div class=\"grid grid-cols-2 gap-4\">\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">風速・風向</div>\n                            <div class=\"text-xl font-bold\" id=\"wind-speed\">-- m/s</div>\n                            <div class=\"text-sm text-slate-300\" id=\"wind-direction\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">気圧</div>\n                            <div class=\"text-xl font-bold\" id=\"pressure\">-- hPa</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">露点温度</div>\n                            <div class=\"text-xl font-bold\" id=\"dewpoint\">--°C</div>\n                            <div class=\"text-xs text-slate-400\" id=\"condensation-risk\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">視程</div>\n                            <div class=\"text-xl font-bold\" id=\"visibility\">-- km</div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 天文薄明・日月出没時刻 -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"sunrise\" class=\"text-orange-400 w-5 h-5\"></i> 天文薄明・出没時刻\n                    </h3>\n                    <div class=\"space-y-3\">\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明開始</span>\n                            <span class=\"font-mono font-bold\" id=\"twilight-astro-begin\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の出</span>\n                            <span class=\"font-mono font-bold\" id=\"sunrise-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の入</span>\n                            <span class=\"font-mono font-bold\" id=\"sunset-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明終了</span>\n                            <span class=\"font-mono font-bold text-green-300\" id=\"twilight-astro-end\">--:--</span>\n                        </div>\n                        <div class=\"border-t border-slate-700 pt-3 mt-3\">\n                            <div class=\"flex items-center justify-between text-sm\">\n                                <span class=\"text-slate-300\">月の出</span>\n                                <span class=\"font-mono font-bold\" id=\"moonrise-time\">--:--</span>\n                            </div>\n                            <div class=\"flex items-center justify-between text-sm mt-2\">\n                                <span class=\"text-slate-300\">月の入</span>\n                                <span class=\"font-mono font-bold\" id=\"moonset-time\">--:--</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 24時間タイムライン -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"clock\" class=\"text-purple-400 w-5 h-5\"></i> 24時間観測 適性タイムライン\n                </h3>\n                <div id=\"timeline-container\" class=\"timeline-bar\"></div>\n                <div class=\"flex items-center justify-between mt-3 text-xs text-slate-400\">\n                    <span>00:00</span>\n                    <span>06:00</span>\n                    <span>12:00</span>\n                    <span>18:00</span>\n                    <span>24:00</span>\n                </div>\n                <div class=\"flex items-center gap-4 mt-3 text-xs flex-wrap\">\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-yellow-500/50 rounded\"></div>\n                        <span>日中</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-blue-500/50 rounded\"></div>\n                        <span>薄明</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-green-500/50 rounded\"></div>\n                        <span>観測適時</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-slate-500/50 rounded\"></div>\n                        <span>月明かり</span>\n                    </div>\n                </div>\n            </div>\n\n             <!-- サマリーエリア（拡張版：天気分析＋月齢） -->\n             <div class=\"glass-panel rounded-2xl p-6\">\n                <div class=\"flex flex-col md:flex-row gap-6\">\n                    <!-- 左側：天気サマリー -->\n                    <div class=\"flex-1 flex flex-col justify-center border-l-4 border-blue-400 pl-4\">\n                        <p class=\"text-slate-300 italic\" id=\"forecast-summary\">予報を分析中...</p>\n                        <p class=\"text-xs text-slate-500 mt-2\" id=\"summary-timestamp\">--</p>\n                    </div>\n\n                    <!-- 右側：月齢情報 -->\n                    <div class=\"flex flex-col items-center justify-center min-w-[150px] border-t md:border-t-0 md:border-l border-slate-700 pt-4 md:pt-0 md:pl-6\">\n                        <div class=\"text-xs text-slate-400 mb-1 uppercase tracking-wider\">Moon Phase</div>\n                        <div class=\"text-4xl mb-1\" id=\"current-moon-icon\">\uD83C\uDF11</div>\n                        <div class=\"text-xl font-bold text-yellow-100\" id=\"current-moon-age-text\">--</div>\n                        <div class=\"text-sm text-yellow-200\" id=\"current-moon-name\">--</div>\n                    </div>\n                </div>\n             </div>\n\n            <!-- 天体イベント情報セクション -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"star\" class=\"text-yellow-400 w-5 h-5\"></i> 天体イベント情報\n                </h3>\n\n                <div class=\"space-y-3\">\n                    <!-- 天文イベント（月食・日食など） -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('astronomical-events')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"moon\" class=\"w-4 h-4 text-orange-400\"></i>\n                                <span class=\"font-semibold text-sm\">天文イベント（月食・日食）</span>\n                            </div>\n                            <i id=\"icon-astronomical-events\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-astronomical-events\" class=\"hidden px-4 pb-4\">\n                            <div id=\"astronomical-events\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 国際宇宙ステーション (ISS) -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('iss')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"satellite\" class=\"w-4 h-4 text-blue-400\"></i>\n                                <span class=\"font-semibold text-sm\">国際宇宙ステーシ ョン (ISS)</span>\n                            </div>\n                            <i id=\"icon-iss\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-iss\" class=\"hidden px-4 pb-4\">\n                            <div id=\"iss-info\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                            <!-- ISS可視予報 -->\n                            <div id=\"iss-prediction\" class=\"mt-3 pt-3 border-t border-slate-700 space-y-2 text-sm hidden\">\n                                <div class=\"flex items-center gap-2 text-yellow-400\">\n                                    <i data-lucide=\"eye\" class=\"w-4 h-4\"></i>\n                                    <span class=\"font-bold\">可視予報</span>\n                                </div>\n                                <div id=\"iss-prediction-content\" class=\"bg-blue-900/30 rounded-lg p-2 text-xs text-blue-200\">\n                                    条件を確認中...\n                                </div>\n                            </div>\n\n                            <!-- 次回パス予測 -->\n                            <div class=\"mt-3 pt-3 border-t border-slate-700 space-y-2 text-sm\">\n                                <div class=\"flex items-center justify-between\">\n                                    <div class=\"flex items-center gap-2 text-green-400\">\n                                        <i data-lucide=\"calendar-clock\" class=\"w-4 h-4\"></i>\n                                        <span class=\"font-bold\">次回パス予測（7日間）</span>\n                                    </div>\n                                    <button onclick=\"calculateISSPasses()\" class=\"text-xs text-blue-300 hover:text-blue-200 underline\">\n                                        再計算\n                                    </button>\n                                </div>\n                                <div id=\"iss-passes-list\" class=\"space-y-1 max-h-64 overflow-y-auto\">\n                                    <div class=\"text-slate-400 text-xs\">計算中...</div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 天の川視認性予測 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('milkyway')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"sparkles\" class=\"w-4 h-4 text-indigo-400\"></i>\n                                <span class=\"font-semibold text-sm\">天の川視認性予測</span>\n                            </div>\n                            <i id=\"icon-milkyway\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-milkyway\" class=\"hidden px-4 pb-4\">\n                            <div id=\"milkyway-visibility\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 今夜見える惑星 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('planets')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"planet\" class=\"w-4 h-4 text-purple-400\"></i>\n                                <span class=\"font-semibold text-sm\">今夜見える惑星</span>\n                            </div>\n                            <i id=\"icon-planets\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-planets\" class=\"hidden px-4 pb-4\">\n                            <div id=\"visible-planets\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 流星群カレンダー -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('meteors')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"zap\" class=\"w-4 h-4 text-yellow-400\"></i>\n                                <span class=\"font-semibold text-sm\">流星群カレンダー</span>\n                            </div>\n                            <i id=\"icon-meteors\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-meteors\" class=\"hidden px-4 pb-4\">\n                            <div id=\"meteor-showers\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">読み込み中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 月齢による観測推奨天体 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('recommended')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"telescope\" class=\"w-4 h-4 text-green-400\"></i>\n                                <span class=\"font-semibold text-sm\">月齢による観測推奨天体</span>\n                            </div>\n                            <i id=\"icon-recommended\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-recommended\" class=\"hidden px-4 pb-4\">\n                            <div id=\"recommended-objects\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 観測適性レーダーチャート -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"radar\" class=\"text-pink-400 w-5 h-5\"></i> 観測適性レーダーチャート\n                </h3>\n                <div class=\"relative h-80 w-full\">\n                    <canvas id=\"radarChart\"></canvas>\n                </div>\n                <p class=\"text-xs text-slate-400 mt-2 text-center\">各要素が外側に近いほど観測に適した条件です</p>\n            </div>\n\n            <!-- チャートセクション -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <!-- 気温チャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"clock\" class=\"text-orange-400 w-5 h-5\"></i> 気温予報 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"tempChart\"></canvas>\n                    </div>\n                </div>\n\n                <!-- 雲の積層チ ャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"layers\" class=\"text-blue-400 w-5 h-5\"></i> 雲量推移 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"cloudChart\"></canvas>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 週間天気予報 -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"calendar\" class=\"text-green-400 w-5 h-5\"></i> 週間天気予報\n                    <span class=\"text-xs font-normal text-slate-400 ml-2\">※日付をクリックするとその日の詳細を表示します</span>\n                </h3>\n                <div class=\"overflow-x-auto\">\n                    <table class=\"w-full text-left border-collapse\">\n                        <thead>\n                            <tr class=\"text-slate-400 text-sm border-b border-slate-700\">\n                                <th class=\"py-3 px-2\">日付</th>\n                                <th class=\"py-3 px-2\">天気</th>\n                                <th class=\"py-3 px-2 text-center\">降水確率 / 量</th>\n                                <th class=\"py-3 px-2 text-center\">平均雲量</th>\n                                <th class=\"py-3 px-2 text-center\">平均湿度</th>\n                                <th class=\"py-3 px-2 text-center\">月齢</th>\n                                <th class=\"py-3 px-2 text-right\">最高 / 最低気温</th>\n                            </tr>\n                        </thead>\n                        <tbody id=\"weekly-forecast-body\" class=\"text-sm md:text-base\">\n                            <!-- JSで生成 -->\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        </div>\n\n        <!-- フッター (APIクレジット & 著作権) -->\n        <footer class=\"glass-panel rounded-xl p-4 text-center text-slate-400 text-sm\">\n            <p class=\"mb-2\">\n                Data sources: \n                <a href=\"https://open-meteo.com/\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">Open-Meteo</a> (Weather Data), \n                <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">OpenStreetMap</a> (Map & Address Data) & \n                <a href=\"https://celestrak.org/\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">CelesTrak</a> (ISS TLE Data)\n            </p>\n            <p class=\"text-xs border-t border-slate-700/50 pt-2\">\n                &copy; 2026 株式会社リバーランズ・コンサルティング\n            </p>\n        </footer>\n\n    </div>\n\n    <!-- ISS星座図モーダル -->\n    <div id=\"iss-skymap-modal\" class=\"hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50\" onclick=\"closeISSSkymapModal(event)\">\n        <div class=\"bg-slate-900 rounded-2xl p-6 max-w-4xl w-full mx-4 border border-slate-700\" onclick=\"event.stopPropagation()\">\n            <div class=\"flex items-center justify-between mb-4\">\n                <h3 class=\"text-xl font-bold flex items-center gap-2\">\n                    <i data-lucide=\"compass\" class=\"w-6 h-6 text-blue-400\"></i>\n                    現在位 置から見える空（星座図）\n                </h3>\n                <button onclick=\"closeISSSkymapModal()\" class=\"text-slate-400 hover:text-white\">\n                    <i data-lucide=\"x\" class=\"w-6 h-6\"></i>\n                </button>\n            </div>\n            <div class=\"space-y-3\">\n                <div id=\"iss-skymap-info\" class=\"text-sm text-slate-300 bg-slate-800/50 rounded-lg p-3\"></div>\n                <div class=\"bg-black rounded-lg overflow-hidden border border-slate-700\">\n                    <canvas id=\"iss-skymap-canvas\" width=\"800\" height=\"600\" class=\"w-full\"></canvas>\n                </div>\n                <div class=\"text-xs text-slate-400 space-y-1\">\n                    <div class=\"flex items-center gap-2\">\n                        <span class=\"inline-block w-3 h-3 bg-red-500 rounded-full\"></span>\n                        <span>ISS位置（視野内の場合のみ表示）</span>\n                    </div>\n                    <div class=\"flex items-center gap-2\">\n                        <span class=\"inline-block w-3 h-3 bg-orange-500 rounded-full\"></span>\n                        <span>太陽（高度>0度）</span>\n                    </div>\n                    <div class=\"flex items-center gap-2\">\n                        <span class=\"inline-block w-3 h-3 bg-white rounded-full border border-slate-400\"></span>\n                        <span>月（高度>0度）</span>\n                    </div>\n                    <div class=\"flex items-center gap-2\">\n                        <span class=\"inline-block w-3 h-3 bg-yellow-400 rounded-full\"></span>\n                        <span>惑星（高度>0度）</span>\n                    </div>\n                    <div>※ 観測地点から見える空を方位角 ・高度で表示（地平座標系）</div>\n                    <div class=\"text-[10px]\">※ astronomy-engineの制限により恒星は表示されません</div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // --- 初期設定 ---\n        lucide.createIcons();\n        moment.locale('ja'); \n\n        let mapInstance = null;\n        let markerInstance = null;\n        let weatherData = null;\n        let tempChartInstance = null;\n        let cloudChartInstance = null;\n        let radarChartInstance = null;\n        let favoriteLocations = JSON.parse(localStorage.getItem('favoriteLocations') || '[]');\n        let currentDatetime = null; // 現在選択されている日時\n\n        // デフォ ルト位置（三島市）\n        let currentLat = 35.1167;\n        let currentLon = 138.9167;\n\n        // --- ナイトビジョンモード ---\n        function toggleNightVision() {\n            document.body.classList.toggle('night-vision');\n            const isNight = document.body.classList.contains('night-vision');\n            localStorage.setItem('nightVisionMode', isNight);\n        }\n\n        // ページロード時にナイトビジョンモードを復元\n        if (localStorage.getItem('nightVisionMode') === 'true') {\n            document.body.classList.add('night-vision');\n        }\n\n        // --- アコーディオン機能 ---\n        function toggleAccordion(id) {\n            const content = document.getElementById('content-' + id);\n            const icon = document.getElementById('icon-' + id);\n\n            if (content.classList.contains('hidden')) {\n                content.classList.remove('hidden');\n                icon.style.transform = 'rotate(180deg)';\n            } else {\n                content.classList.add('hidden');\n                icon.style.transform = 'rotate(0deg)';\n            }\n\n            // Lucideアイコンを再初期化\n            lucide.createIcons();\n        }\n\n        // --- お気に入り地点管理 ---\n        function addFavoriteLocation() {\n            const name = prompt('この地点の名前を入力してください:', document.getElementById('location-name').innerText || '未設定');\n            if (name) {\n                const location = {\n                    name: name,\n                    lat: currentLat,\n                    lon: currentLon\n                };\n                favoriteLocations.push(location);\n                if (favoriteLocations.length > 5) favoriteLocations.shift(); // 最大5件\n                localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n                renderFavoriteLocations();\n            }\n        }\n\n        function renderFavoriteLocations() {\n            const container = document.getElementById('favorite-locations');\n            if (favoriteLocations.length === 0) {\n                container.innerHTML = `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                        現在地をお気に入りに追加\n                    </button>\n                `;\n            } else {\n                container.innerHTML = favoriteLocations.map((loc, index) => `\n                    <div class=\"bg-slate-800/50 rounded-lg p-2 flex items-center justify-between border border-slate-700\">\n                        <button onclick=\"loadFavoriteLocation(${index})\" class=\"flex-1 text-left text-sm hover:text-blue-300\">\n                            <i data-lucide=\"map-pin\" class=\"w-3 h-3 inline mr-1\"></i>\n                            ${loc.name}\n                        </button>\n                        <button onclick=\"removeFavoriteLocation(${index})\" class=\"text-red-400 hover:text-red-300 text-xs\">\n                            <i data-lucide=\"x\" class=\"w-3 h-3\"></i>\n                        </button>\n                    </div>\n                `).join('') + `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-2 text-xs border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-3 h-3\"></i>\n                        追加\n                    </button>\n                `;\n            }\n            lucide.createIcons();\n        }\n\n        function loadFavoriteLocation(index) {\n            const loc = favoriteLocations[index];\n            updateAppLocation(loc.lat, loc.lon);\n        }\n\n        function removeFavoriteLocation(index) {\n            favoriteLocations.splice(index, 1);\n            localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n            renderFavoriteLocations();\n        }\n\n        // --- 星空視認性スコア計算 ---\n        function calculateStarryScore(cloudCover, moonAge, humidity, visibility = 24, windSpeed = 5) {\n            // 雲量スコア (0-100) - 雲が少ないほど高い\n            const cloudScore = Math.max(0, 100 - cloudCover);\n\n            // 月明かりスコア (0-100) - 新月に近いほど高い\n            const moonScore = moonAge < 3 || moonAge > 26 ? 100 :\n                             moonAge < 10 || moonAge > 18 ? 60 : 20;\n\n            // 湿度スコア (0-100) - 湿度が低いほど高い\n            const humidityScore = Math.max(0, 100 - humidity);\n\n            // 視程スコア (0-100)\n            const visibilityScore = Math.min(100, (visibility / 50) * 100);\n\n            // 風速スコア (0-100) - 風が弱いほど高い\n            const windScore = windSpeed < 2 ? 100 : windSpeed < 5 ? 80 : windSpeed < 10 ? 50 : 20;\n\n            // 加重平均 (雲量と月明かりを重視)\n            const totalScore = (cloudScore * 0.4 + moonScore * 0.3 + humidityScore * 0.15 + visibilityScore * 0.1 + windScore * 0.05);\n\n            return Math.round(totalScore);\n        }\n\n        function updateStarryScore(score) {\n            const circle = document.getElementById('score-circle');\n            const text = document.getElementById('score-text');\n            const comment = document.getElementById('score-comment');\n\n            // スコアに応じた円の進行度 (0-100を0-440に変換)\n            const dashOffset = 440 - (score / 100) * 440;\n            circle.style.strokeDashoffset = dashOffset;\n\n            text.textContent = score;\n\n            // コメント\n            if (score >= 80) {\n                comment.textContent = '⭐ 絶好の観測 日和！星空が最高に美しく見えるでしょう';\n            } else if (score >= 60) {\n                comment.textContent = '✨ 観測に適した条件です。良い星空が期待できます';\n            } else if (score >= 40) {\n                comment.textContent = '\uD83C\uDF24\uFE0F まずまずの条件。明るい星は観測できます';\n            } else if (score >= 20) {\n                comment.textContent = '☁\uFE0F やや 条件が悪いです。観測には忍耐が必要かも';\n            } else {\n                comment.textContent = '❌ 観測には不向きな条件です';\n            }\n        }\n\n        // 時計更新\n        setInterval(() => {\n            document.getElementById('current-clock').textContent = moment().format('HH:mm:ss');\n        }, 1000);\n\n        // --- アプリケーション起動フロー ---\n        window.addEventListener('load', () => {\n            // お気に入り地点を表示\n            renderFavoriteLocations();\n            // 現在地取得を試みる\n            getCurrentLocation(true); // true = 初回起動時の自動取得\n        });\n\n        // --- 位 置情報関連 ---\n\n        // ブラウザの現在地取得\n        function getCurrentLocation(isInitial = false) {\n            if (!navigator.geolocation) {\n                if(!isInitial) alert(\"このブラウザは位置情報をサポートしていません。\");\n                initializeDashboardWithCurrentCoords(); // デフォルトで起動\n                return;\n            }\n\n            // ロード表示\n            document.getElementById('loading').innerHTML = '現在地を取得中...';\n            document.getElementById('loading').classList.remove('hidden');\n\n            navigator.geolocation.getCurrentPosition(\n                (position) => {\n                    currentLat = position.coords.latitude;\n                    currentLon = position.coords.longitude;\n                    updateAppLocation(currentLat, currentLon);\n                },\n                (error) => {\n                    console.warn(\"位置情報取得失敗:\", error.message);\n                    if(!isInitial) alert(\"位置情報を取得できませんでした。\");\n                    // 失敗した場合はデフォルト位置（三島）で開始\n                    initializeDashboardWithCurrentCoords(); \n                }\n            );\n        }\n\n        // 座標を指定してアプリ全体を更新するメイン関数\n        async function updateAppLocation(lat, lon) {\n            currentLat = lat;\n            currentLon = lon;\n\n            // 1. UIの座標表示更新\n            document.getElementById('coords-display').innerText = `緯度: ${lat.toFixed(4)} | 経度: ${lon.toFixed(4)}`;\n\n            // 2. 住所取得 (逆ジオコーディング)\n            fetchAddress(lat, lon);\n\n            // 3. 地図マーカー更新（地図が開いている、ま たは初期化されている場合）\n            if (mapInstance) {\n                updateMapMarker(lat, lon);\n            }\n\n            // 4. 天気データ取得\n            await fetchWeather(lat, lon);\n        }\n\n        // 住所取得 (OpenStreetMap Nominatim API)\n        async function fetchAddress(lat, lon) {\n            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=ja`;\n            \n            try {\n                const response = await fetch(url, {\n                    headers: { 'User-Agent': 'WeatherDashboardDemo/1.0' } // マナーとしてUser-Agentを設定\n                });\n                const data = await response.json();\n                \n                if (data && data.address) {\n                    const addr = data.address;\n                    // 見やすい住所を構築（県 + 市町村 + 町名）\n                    const pref = addr.province || addr.state || '';\n                    const city = addr.city || addr.ward || addr.town || addr.village || '';\n                    const sub = addr.suburb || addr.quarter || addr.neighbourhood || '';\n                    \n                    const fullName = `${pref} ${city} ${sub}`.trim() || \"不明な場所\";\n                    document.getElementById('location-name').innerText = fullName;\n                } else {\n                    document.getElementById('location-name').innerText = \"住所不明\";\n                }\n            } catch (error) {\n                console.error(\"住所取得エラー:\", error);\n                document.getElementById('location-name').innerText = \"住所取得失敗\";\n            }\n        }\n\n        // デフォルト/現在の座標で初期化\n        function initializeDashboardWithCurrentCoords() {\n            updateAppLocation(currentLat, currentLon);\n        }\n\n        // --- 地図機能 ---\n\n        function toggleMap() {\n            const container = document.getElementById('location-settings');\n            const isHidden = container.classList.contains('hidden');\n            \n            if (isHidden) {\n                container.classList.remove('hidden');\n                // 地図が初めて表示されるときに初期化\n                if (!mapInstance) {\n                    initMap();\n                } else {\n                    // サイズ再計算（hiddenから復帰時に必要）\n                    setTimeout(() => mapInstance.invalidateSize(), 100);\n                }\n            } else {\n                container.classList.add('hidden');\n            }\n        }\n\n        function initMap() {\n            // 地図初期化\n            if (mapInstance) return;\n            mapInstance = L.map('map').setView([currentLat, currentLon], 13);\n\n            // OpenStreetMapタイル\n            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n            }).addTo(mapInstance);\n\n            // マーカー追加\n            markerInstance = L.marker([currentLat, currentLon], {draggable: false}).addTo(mapInstance);\n\n            // マップクリックイベ ント\n            mapInstance.on('click', function(e) {\n                const lat = e.latlng.lat;\n                const lon = e.latlng.lng;\n                updateAppLocation(lat, lon);\n            });\n        }\n\n        function updateMapMarker(lat, lon) {\n            if (markerInstance) {\n                markerInstance.setLatLng([lat, lon]);\n            }\n            mapInstance.panTo([lat, lon]);\n        }\n\n        // --- ヘルパー関数 ---\n        function getWindDirection(degrees) {\n            const directions = ['北', '北北東', '北東', '東北東', '東', '東南東', '南東', '南南東', '南', '南南西', '南西', '西南西', '西', '西北西', '北西', '北北西'];\n            const index = Math.round(degrees / 22.5) % 16;\n            return directions[index];\n        }\n\n        // --- レーダーチャート描画 ---\n        function renderRadarChart(data) {\n            const ctx = document.getElementById('radarChart').getContext('2d');\n            if (radarChartInstance) radarChartInstance.destroy();\n\n            radarChartInstance = new Chart(ctx, {\n                type: 'radar',\n                data: {\n                    labels: ['雲の少なさ', '月の暗さ', '低湿度', '高視程', '風の穏やかさ'],\n                    datasets: [{\n                        label: '観測適性',\n                        data: [data.cloudClearness, data.moonDarkness, data.lowHumidity, data.goodVisibility, data.calmWind],\n                        backgroundColor: 'rgba(34, 197, 94, 0.2)',\n                        borderColor: 'rgba(34, 197, 94, 1)',\n                        borderWidth: 2,\n                        pointBackgroundColor: 'rgba(34, 197, 94, 1)',\n                        pointBorderColor: '#fff',\n                        pointHoverBackgroundColor: '#fff',\n                        pointHoverBorderColor: 'rgba(34, 197, 94, 1)'\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    scales: {\n                        r: {\n                            beginAtZero: true,\n                            max: 100,\n                            ticks: {\n                                stepSize: 20,\n                                color: '#94a3b8'\n                            },\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)'\n                            },\n                            pointLabels: {\n                                color: '#cbd5e1',\n                                font: {\n                                    size: 12\n                                }\n                            }\n                        }\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        }\n                    }\n                }\n            });\n        }\n\n        // --- 流星群データ (年間イベント) ---\n        const meteorShowers = [\n            { name: \"しぶんぎ座流星群\", peakStart: \"01-03\", peakEnd: \"01-04\", rate: \"120個/時\", note: \"年始の三大流星群\" },\n            { name: \"こと座流星群\", peakStart: \"04-22\", peakEnd: \"04-23\", rate: \"18個/時\", note: \"安定した流星群\" },\n            { name: \"みずがめ座η流星群\", peakStart: \"05-06\", peakEnd: \"05-07\", rate: \"50個/時\", note: \"南半球で好条件\" },\n            { name: \"ペルセウス座流星群\", peakStart: \"08-12\", peakEnd: \"08-13\", rate: \"100個/時\", note: \"三大流星群の一つ\" },\n            { name: \"オリオン座流星群\", peakStart: \"10-21\", peakEnd: \"10-22\", rate: \"20個/時\", note: \"ハレー彗星起源\" },\n            { name: \"しし座流星群\", peakStart: \"11-17\", peakEnd: \"11-18\", rate: \"15個/時\", note: \"33年周期で大出 現\" },\n            { name: \"ふたご座流星群\", peakStart: \"12-13\", peakEnd: \"12-14\", rate: \"120個/時\", note: \"三大流星群の一つ\" },\n            { name: \"こぐま座流星群\", peakStart: \"12-22\", peakEnd: \"12-23\", rate: \"10個/時\", note: \"安定した観測\" }\n        ];\n\n        // --- 月齢計算ロジック ---\n        function calculateMoonData(date) {\n            // 2000年1月6日 18:14 (UTC) は新月 (Lunation Number 953)\n            // 簡易計算のため、UTCでの日付差分を利用\n            const knownNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0)); \n            const diffTime = date.getTime() - knownNewMoon.getTime();\n            const diffDays = diffTime / (1000 * 60 * 60 * 24);\n            const synodicMonth = 29.53058867;\n            \n            let age = diffDays % synodicMonth;\n            if (age < 0) age += synodicMonth;\n            \n            // 月相の判定\n            let phaseName = \"\";\n            let icon = \"\";\n            \n            // 絵文字と名前のマッピング (簡易版)\n            if (age < 1.0 || age > 28.5) { phaseName = \"新月\"; icon = \"\uD83C\uDF11\"; }\n            else if (age < 6.0) { phaseName = \"三日月\"; icon = \"\uD83C\uDF12\"; }\n            else if (age < 9.0) { phaseName = \"上弦の月\"; icon = \"\uD83C\uDF13\"; }\n            else if (age < 13.5) { phaseName = \"十日夜\"; icon = \"\uD83C\uDF14\"; }\n            else if (age < 16.5) { phaseName = \"満月\"; icon = \"\uD83C\uDF15\"; }\n            else if (age < 21.0) { phaseName = \"立待 月\"; icon = \"\uD83C\uDF16\"; }\n            else if (age < 24.0) { phaseName = \"下弦の月\"; icon = \"\uD83C\uDF17\"; }\n            else { phaseName = \"有明月\"; icon = \"\uD83C\uDF18\"; }\n\n            return {\n                age: age.toFixed(1),\n                phaseName: phaseName,\n                icon: icon\n            };\n        }\n\n        // --- 日の出入り・月の出入り・天文薄明 計算 ---\n        function calculateSunMoonTimes(date, lat, lon) {\n            try {\n                const observer = new Astronomy.Observer(lat, lon, 0);\n\n                // 日の出・日の入り\n                const sunrise = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, 1, date, 1);\n                const sunset = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, date, 1);\n\n                // 天文薄明 (-18度)\n                const astroTwilightMorning = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, -1, date, 1, -18);\n                const astroTwilightEvening = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, 1, date, 1, -18);\n\n                // 月の出・月の入り\n                const moonrise = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, 1, date, 1);\n                const moonset = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, date, 1);\n\n                return {\n                    sunrise: sunrise ? moment(sunrise.date).format('HH:mm') : '--:--',\n                    sunset: sunset ? moment(sunset.date).format('HH:mm') : '--:--',\n                    astroTwilightBegin: astroTwilightMorning ? moment(astroTwilightMorning.date).format('HH:mm') : '--:--',\n                    astroTwilightEnd: astroTwilightEvening ? moment(astroTwilightEvening.date).format('HH:mm') : '--:--',\n                    moonrise: moonrise ? moment(moonrise.date).format('HH:mm') : '--:--',\n                    moonset: moonset ? moment(moonset.date).format('HH:mm') : '--:--',\n                    sunriseDate: sunrise ? sunrise.date : null,\n                    sunsetDate: sunset ? sunset.date : null,\n                    astroBeginDate: astroTwilightMorning ? astroTwilightMorning.date : null,\n                    astroEndDate: astroTwilightEvening ? astroTwilightEvening.date : null\n                };\n            } catch (error) {\n                console.error('日月時刻計算エラー:', error);\n                return {\n                    sunrise: '--:--',\n                    sunset: '--:--',\n                    astroTwilightBegin: '--:--',\n                    astroTwilightEnd: '--:--',\n                    moonrise: '--:--',\n                    moonset: '--:--'\n                };\n            }\n        }\n\n        function updateSunMoonDisplay(times) {\n            document.getElementById('sunrise-time').innerText = times.sunrise;\n            document.getElementById('sunset-time').innerText = times.sunset;\n            document.getElementById('twilight-astro-begin').innerText = times.astroTwilightBegin;\n            document.getElementById('twilight-astro-end').innerText = times.astroTwilightEnd;\n            document.getElementById('moonrise-time').innerText = times.moonrise;\n            document.getElementById('moonset-time').innerText = times.moonset;\n        }\n\n        // --- 24時間タイムライン描画 ---\n        function renderTimeline(times, targetDate) {\n            const container = document.getElementById('timeline-container');\n            container.innerHTML = '';\n\n            const dayStart = moment(targetDate).startOf('day');\n            const dayEnd = moment(targetDate).endOf('day');\n\n            // セグメントを追加\n            const segments = [];\n\n            // 日中（日の出～日の入り）\n            if (times.sunriseDate && times.sunsetDate) {\n                const sunriseTime = moment(times.sunriseDate);\n                const sunsetTime = moment(times.sunsetDate);\n\n                const start = ((sunriseTime - dayStart) / (dayEnd - dayStart)) * 100;\n                const width = ((sunsetTime - sunriseTime) / (dayEnd - dayStart)) * 100;\n\n                segments.push({ start, width, color: '#eab308', label: '日中' });\n            }\n\n            // 天文薄明\n            if (times.astroBeginDate && times.astroEndDate) {\n                const astroBegin = moment(times.astroBeginDate);\n                const astroEnd = moment(times.astroEndDate);\n\n                // 朝の薄明\n                const morningStart = ((astroBegin - dayStart) / (dayEnd - dayStart)) * 100;\n                const morningWidth = ((moment(times.sunriseDate) - astroBegin) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: morningStart, width: morningWidth, color: '#3b82f6', label: '朝薄明' });\n\n                // 夕方の薄明\n                const eveningStart = ((moment(times.sunsetDate) - dayStart) / (dayEnd - dayStart)) * 100;\n                const eveningWidth = ((astroEnd - moment(times.sunsetDate)) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: eveningStart, width: eveningWidth, color: '#3b82f6', label: '夕薄明' });\n\n                // 観測適時（天文薄明終了後～天文薄明開始前）\n                const observeStart = ((astroEnd - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeEnd = ((astroBegin.clone().add(1, 'day') - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeWidth = observeEnd - observeStart;\n                if (observeWidth > 0) {\n                    segments.push({ start: observeStart, width: observeWidth, color: '#22c55e', label: '観測適 時' });\n                }\n            }\n\n            // セグメントを描画\n            segments.forEach(seg => {\n                const div = document.createElement('div');\n                div.className = 'timeline-segment';\n                div.style.left = `${seg.start}%`;\n                div.style.width = `${seg.width}%`;\n                div.style.background = seg.color;\n                div.title = seg.label;\n                container.appendChild(div);\n            });\n        }\n\n        // --- 天体イベント関数 ---\n\n        // 0. ISS情報 の取得と計算\n        let issTLE = null;\n        let issMarker = null;\n        let issInterval = null;\n\n        async function updateISSInfo(observerDate, observerLat, observerLon) {\n            const container = document.getElementById('iss-info');\n            \n            // リアルタイム更新用のインターバル設 定\n            if (issInterval) clearInterval(issInterval);\n            issInterval = setInterval(() => {\n                const now = new Date();\n                calculateAndDisplayISS(now, observerLat, observerLon);\n            }, 3000); // 3秒ごとに更新\n\n            // 初回計算\n            await calculateAndDisplayISS(observerDate, observerLat, observerLon);\n        }\n\n        async function calculateAndDisplayISS(date, observerLat, observerLon) {\n            const container = document.getElementById('iss-info');\n            try {\n                const now = new Date().getTime();\n                const cachedTLE = localStorage.getItem('issTLE');\n                const lastFetch = localStorage.getItem('lastTLEFetch');\n                const oneDay = 24 * 60 * 60 * 1000;\n\n                if (cachedTLE && lastFetch && (now - lastFetch < oneDay)) {\n                    issTLE = JSON.parse(cachedTLE);\n                } else {\n                    issTLE = null; // リフレッシュのためにクリア\n                }\n\n                if (!issTLE) {\n                    // CelesTrakからISSのTLEを取得\n                    try {\n                        const response = await fetch('https://celestrak.org/NORAD/elements/gp.php?GROUP=stations&FORMAT=tle&NAME=ISS');\n                        if (response.ok) {\n                            const text = await response.text();\n                            const lines = text.split('\\n');\n                            for (let i = 0; i < lines.length; i++) {\n                                if (lines[i].includes('ISS (ZARYA)')) {\n                                    issTLE = {\n                                        line1: lines[i+1].trim(),\n                                        line2: lines[i+2].trim()\n                                    };\n                                    // キャッシュに保存\n                                    localStorage.setItem('issTLE', JSON.stringify(issTLE));\n                                    localStorage.setItem('lastTLEFetch', now.toString());\n                                    break;\n                                }\n                            }\n                        }\n                    } catch (e) {\n                        console.warn('TLEの取得に失敗しました。予備データを使用し ます。', e);\n                    }\n\n                    if (!issTLE) {\n                        // 取得失敗時はキャッシュがあればそれを使う、なければデフォルト\n                        if (cachedTLE) {\n                            issTLE = JSON.parse(cachedTLE);\n                        } else {\n                            issTLE = {\n                                line1: \"1 25544U 98067A   25014.54922454  .00015647  00000-0  27838-3 0  9990\",\n                                line2: \"2 25544  51.6391 350.3705 0005239  55.5135  47.8824 15.49528481491593\"\n                            };\n                        }\n                    }\n                }\n\n                // グローバル変数に保存（星座図で使用）\n                window.currentTLE = issTLE;\n\n                const satrec = satellite.twoline2satrec(issTLE.line1, issTLE.line2);\n                const positionAndVelocity = satellite.propagate(satrec, date);\n                const positionEci = positionAndVelocity.position;\n                const gmst = satellite.gstime(date);\n                const positionGd = satellite.eciToGeodetic(positionEci, gmst);\n\n                const longitude = satellite.degreesLong(positionGd.longitude);\n                const latitude = satellite.degreesLat(positionGd.latitude);\n                const height = positionGd.height;\n\n                const observerGd = {\n                    longitude: satellite.degreesToRadians(observerLon),\n                    latitude: satellite.degreesToRadians(observerLat),\n                    height: 0\n                };\n                const lookAngles = satellite.ecfToLookAngles(observerGd, satellite.eciToEcf(positionEci, gmst));\n                \n                const azimuth = satellite.radiansToDegrees(lookAngles.azimuth);\n                const elevation = satellite.radiansToDegrees(lookAngles.elevation);\n                const range = lookAngles.rangeSat;\n\n                const isVisible = elevation > 0;\n\n                // --- 可視予報のロジック ---\n                const predictionPanel = document.getElementById('iss-prediction');\n                const predictionContent = document.getElementById('iss-prediction-content');\n\n                // 地上距離の計算（ハーバーサイン公式）\n                const R = 6371; // 地球の 半径 km\n                const dLat = (latitude - observerLat) * Math.PI / 180;\n                const dLon = (longitude - observerLon) * Math.PI / 180;\n                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +\n                          Math.cos(observerLat * Math.PI / 180) * Math.cos(latitude * Math.PI / 180) *\n                          Math.sin(dLon/2) * Math.sin(dLon/2);\n                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n                const groundDistance = R * c;\n\n                // 視認可能範囲の判定（仰角0度以上 = 地平線上）\n                const isInVisibleRange = elevation > 0;\n\n                // 日没後2H以内か日の出前2H以内\n                const sunTimes = calculateSunMoonTimes(date, observerLat, observerLon);\n                let isSunCondition = false;\n                if (sunTimes.sunsetDate && sunTimes.sunriseDate) {\n                    const sunset = moment(sunTimes.sunsetDate);\n                    const sunrise = moment(sunTimes.sunriseDate);\n                    const nowMoment = moment(date);\n\n                    const diffAfterSunset = nowMoment.diff(sunset, 'hours', true);\n                    const diffBeforeSunrise = sunrise.diff(nowMoment, 'hours', true);\n\n                    if ((diffAfterSunset >= 0 && diffAfterSunset <= 2) || (diffBeforeSunrise >= 0 && diffBeforeSunrise <= 2)) {\n                        isSunCondition = true;\n                    }\n                }\n\n                // 観測に最適な条件（距離1300km以内 +  仰角20度以上）\n                const isOptimalCondition = groundDistance <= 1300 && isSunCondition && elevation >= 20;\n\n                // 表示の優先順位：最適条件 > 視認可能範囲内 > 範囲外\n                if (isOptimalCondition) {\n                    predictionPanel.classList.remove('hidden');\n                    predictionContent.innerHTML = `\n                        <div class=\"font-bold text-yellow-300\">✨ 現在、ISSが観測に最適な条件です！</div>\n                        <div class=\"mt-1 text-sm\">\n                            距離: ${groundDistance.toFixed(0)} km (1300km以内)<br>\n                            仰角: ${elevation.toFixed(1)}° (20°以上)<br>\n                            時間: 日出前/日没後の好条件\n                        </div>\n                    `;\n                } else if (isInVisibleRange) {\n                    predictionPanel.classList.remove('hidden');\n                    predictionContent.innerHTML = `\n                        <div class=\"font-bold text-blue-300\">\uD83D\uDC41\uFE0F ISS は視認可能範囲内にあります</div>\n                        <div class=\"mt-1 text-sm text-slate-300\">\n                            地上距離: ${groundDistance.toFixed(0)} km<br>\n                            仰角: ${elevation.toFixed(1)}° (地平線上)<br>\n                            方位: ${azimuth.toFixed(1)}°\n                        </div>\n                        ${!isSunCondition ? '<div class=\"mt-1 text-xs text-slate-400\">※日中のため肉眼では見えにくい可能性があります</div>' : ''}\n                        ${elevation < 20 ? '<div class=\"mt-1 text-xs text-slate-400\">※仰角が低いため観測が困難な場合があります</div>' : ''}\n                    `;\n                } else {\n                    predictionPanel.classList.add('hidden');\n                }\n\n                container.innerHTML = `\n                    <div class=\"bg-slate-700/30 rounded-lg p-3 space-y-2\">\n                        <div class=\"flex justify-between items-center\">\n                            <span class=\"text-blue-300 font-bold\">現在位置</span>\n                            <span class=\"text-xs px-2 py-0.5 rounded ${isVisible ? 'bg-green-500/20 text-green-400' : 'bg-slate-500/20 text-slate-400'}\">\n                                ${isVisible ? '地平線上' : '地平線下'}\n                            </span>\n                        </div>\n                        <div class=\"grid grid-cols-2 gap-2 text-xs\">\n                            <div>緯度: <span class=\"text-white font-mono\">${latitude.toFixed(2)}°</span></div>\n                            <div>経度: <span class=\"text-white font-mono\">${longitude.toFixed(2)}°</span></div>\n                            <div>高度: <span class=\"text-white font-mono\">${height.toFixed(1)} km</span></div>\n                            <div>距離: <span class=\"text-white font-mono\">${range.toFixed(0)} km</span></div>\n                        </div>\n                        <div class=\"pt-2 border-t border-slate-600\">\n                            <div class=\"flex justify-between text-xs\">\n                                <span>方位角: <span class=\"text-white font-mono\">${azimuth.toFixed(1)}°</span></span>\n                                <span>仰角: <span class=\"text-white font-mono\">${elevation.toFixed(1)}°</span></span>\n                            </div>\n                            <div class=\"text-[10px] text-slate-400 mt-1\">\n                                地上距離: <span class=\"text-white font-mono\">${groundDistance.toFixed(0)} km</span>\n                            </div>\n                        </div>\n                        <div class=\"text-[10px] text-slate-500 mt-1 flex justify-between\">\n                            <span>TLE Source: CelesTrak</span>\n                            <span>Real-time Update</span>\n                        </div>\n                        <button onclick=\"openISSSkymapModal(new Date())\" class=\"w-full mt-2 bg-blue-600/30 hover:bg-blue-600/50 text-blue-200 py-2 px-3 rounded-lg text-xs font-semibold border border-blue-500/30 transition flex items-center justify-center gap-1\">\n                            <i data-lucide=\"compass\" class=\"w-3 h-3\"></i>\n                            星座図を表示\n                        </button>\n                    </div>\n                `;\n\n                // アイコンを再描画\n                lucide.createIcons();\n\n                if (document.getElementById('map')) {\n                    if (!mapInstance) {\n                        initMap();\n                    }\n                    if (mapInstance) {\n                        if (issMarker) {\n                            issMarker.setLatLng([latitude, longitude]);\n                        } else {\n                            const issIcon = L.divIcon({\n                                html: '<i data-lucide=\"satellite\" class=\"text-blue-400 w-6 h-6\"></i>',\n                                className: 'iss-map-icon',\n                                iconSize: [24, 24],\n                                iconAnchor: [12, 12]\n                            });\n                            issMarker = L.marker([latitude, longitude], {icon: issIcon}).addTo(mapInstance);\n                            issMarker.bindPopup(\"ISS (国際宇宙ステーション)\");\n                            lucide.createIcons();\n                        }\n                    }\n                }\n            } catch (error) {\n                console.error('ISS 計算エラー:', error);\n                container.innerHTML = '<div class=\"text-red-400\">ISS情報の計算に失敗しました</div>';\n            }\n\n            //  初回のみパス予測を自動計算\n            if (!window.issPassesCalculated) {\n                calculateISSPasses();\n                window.issPassesCalculated = true;\n            }\n        }\n\n        // ISS次回パス予測を計算\n        let calculatedPasses = [];\n        function calculateISSPasses() {\n            const container = document.getElementById('iss-passes-list');\n            container.innerHTML = '<div class=\"text-slate-400 text-xs\">計算中...</div>';\n\n            try {\n                if (!window.currentTLE || !currentLat || !currentLon) {\n                    container.innerHTML = '<div class=\"text-red-400 text-xs\">TLEデータが取得できていません</div>';\n                    return;\n                }\n\n                const passes = [];\n                const now = new Date();\n                const endTime = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // 7日後まで\n                const interval = 60 * 1000; // 1分 刻み\n\n                const satrec = satellite.twoline2satrec(window.currentTLE.line1, window.currentTLE.line2);\n\n                let currentPass = null;\n                let maxElevation = -90;\n                let maxElevationTime = null;\n                let maxDistance = 0;\n\n                for (let time = now.getTime(); time <= endTime.getTime(); time += interval) {\n                    const date = new Date(time);\n                    const positionAndVelocity = satellite.propagate(satrec, date);\n\n                    if (positionAndVelocity.position && typeof positionAndVelocity.position !== 'boolean') {\n                        const positionEci = positionAndVelocity.position;\n                        const gmst = satellite.gstime(date);\n\n                        const observerGd = {\n                            longitude: satellite.degreesToRadians(currentLon),\n                            latitude: satellite.degreesToRadians(currentLat),\n                            height: 0\n                        };\n\n                        const positionEcf = satellite.eciToEcf(positionEci, gmst);\n                        const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);\n\n                        const elevation = satellite.radiansToDegrees(lookAngles.elevation);\n                        const azimuth = satellite.radiansToDegrees(lookAngles.azimuth);\n                        const distance = lookAngles.rangeSat;\n\n                        if (elevation > 0) {\n                            // パス中\n                            if (!currentPass) {\n                                // 新しいパス開始\n                                currentPass = {\n                                    startTime: date,\n                                    startElevation: elevation,\n                                    startAzimuth: azimuth\n                                };\n                                maxElevation = elevation;\n                                maxElevationTime = date;\n                                maxDistance = distance;\n                            } else {\n                                // パス継続中、最大高度を更新\n                                if (elevation > maxElevation) {\n                                    maxElevation = elevation;\n                                    maxElevationTime = date;\n                                    maxDistance = distance;\n                                }\n                            }\n                        } else {\n                            // 地平線下\n                            if (currentPass) {\n                                // パス終了\n                                currentPass.endTime = new Date(time - interval); // 1分前\n                                currentPass.maxElevation = maxElevation;\n                                currentPass.maxElevationTime = maxElevationTime;\n                                currentPass.maxDistance = maxDistance;\n\n                                // 最大高度が10度以上のパスのみ記録\n                                if (maxElevation >= 10) {\n                                    passes.push(currentPass);\n                                }\n\n                                currentPass = null;\n                                maxElevation = -90;\n                            }\n                        }\n                    }\n                }\n\n                // 保存\n                calculatedPasses = passes;\n\n                // 表示\n                if (passes.length === 0) {\n                    container.innerHTML = '<div class=\"text-slate-400 text-xs\">今後7日間に観測可能なパス はありません（最大高度10°以上）</div>';\n                } else {\n                    container.innerHTML = passes.map((pass, index) => {\n                        const duration = (pass.endTime - pass.startTime) / 1000 / 60; // 分単位\n                        const startStr = moment(pass.startTime).format('M/D HH:mm');\n                        const maxStr = moment(pass.maxElevationTime).format('HH:mm');\n\n                        // 高度による評価\n                        let quality = '';\n                        let qualityColor = '';\n                        if (pass.maxElevation >= 60) {\n                            quality = '最適';\n                            qualityColor = 'text-yellow-300';\n                        } else if (pass.maxElevation >= 40) {\n                            quality = '良好';\n                            qualityColor = 'text-green-300';\n                        } else if (pass.maxElevation >= 20) {\n                            quality = '可';\n                            qualityColor = 'text-blue-300';\n                        } else {\n                            quality = '低';\n                            qualityColor = 'text-slate-400';\n                        }\n\n                        return `\n                            <div class=\"bg-slate-700/30 rounded-lg p-2 hover:bg-slate-700/50 transition cursor-pointer\" onclick=\"showPassOnSkymap(${index})\">\n                                <div class=\"flex items-center justify-between mb-1\">\n                                    <div class=\"font-semibold text-white text-xs\">${startStr}</div>\n                                    <div class=\"${qualityColor} text-xs font-bold\">${quality}</div>\n                                </div>\n                                <div class=\"grid grid-cols-3 gap-1 text-[10px]\">\n                                    <div>\n                                        <span class=\"text-slate-400\">最大高度:</span>\n                                        <span class=\"text-white font-semibold\">${pass.maxElevation.toFixed(1)}°</span>\n                                    </div>\n                                    <div>\n                                        <span class=\"text-slate-400\">時刻:</span>\n                                        <span class=\"text-white\">${maxStr}</span>\n                                    </div>\n                                    <div>\n                                        <span class=\"text-slate-400\">距離:</span>\n                                        <span class=\"text-white\">${(pass.maxDistance).toFixed(0)}km</span>\n                                    </div>\n                                </div>\n                                <div class=\"text-[10px] text-slate-500 mt-1\">\n                                    継続時間: ${duration.toFixed(0)}分 | クリックで 軌道表示\n                                </div>\n                            </div>\n                        `;\n                    }).join('');\n                }\n\n            } catch (error) {\n                console.error('パス計算 エラー:', error);\n                container.innerHTML = '<div class=\"text-red-400 text-xs\">計算エラー: ' + error.message + '</div>';\n            }\n        }\n\n        // パスを星図に表示\n        function showPassOnSkymap(passIndex) {\n            if (passIndex < 0 || passIndex >= calculatedPasses.length) return;\n\n            window.selectedPass = calculatedPasses[passIndex];\n            openISSSkymapModal();\n        }\n\n        // 1. 今夜見える惑星を計算\n        function calculateVisiblePlanets(observerDate, observerLat, observerLon) {\n            try {\n                const observer = new Astronomy.Observer(observerLat, observerLon, 0);\n                const planets = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];\n                const planetNames = {\n                    'Mercury': '水星',\n                    'Venus': '金星',\n                    'Mars': '火星',\n                    'Jupiter': '木星',\n                    'Saturn': '土星'\n                };\n                const planetIcons = {\n                    'Mercury': '⚫',\n                    'Venus': '\uD83C\uDF1F',\n                    'Mars': '\uD83D\uDD34',\n                    'Jupiter': '\uD83D\uDFE0',\n                    'Saturn': '\uD83E\uDE90'\n                };\n\n                let visiblePlanets = [];\n\n                planets.forEach(planet => {\n                    const equator = Astronomy.Equator(planet, observerDate, observer, true, true);\n                    const horizon = Astronomy.Horizon(observerDate, observer, equator.ra, equator.dec, 'normal');\n                    const illumination = Astronomy.Illumination(planet, observerDate);\n\n                    // 地平線より上（高度 > 0）で、ある程度明るい天体のみ表示\n                    if (horizon.altitude > 0) {\n                        visiblePlanets.push({\n                            name: planetNames[planet],\n                            icon: planetIcons[planet],\n                            altitude: horizon.altitude.toFixed(1),\n                            azimuth: horizon.azimuth.toFixed(1),\n                            magnitude: illumination.mag.toFixed(1)\n                        });\n                    }\n                });\n\n                // HTMLに表示\n                const container = document.getElementById('visible-planets');\n                if (visiblePlanets.length === 0) {\n                    container.innerHTML = '<div class=\"text-slate-400\">現在、地平線上に惑星はありません</div>';\n                } else {\n                    container.innerHTML = visiblePlanets.map(p => `\n                        <div class=\"flex items-center justify-between bg-slate-700/30 rounded-lg p-2\">\n                            <div class=\"flex items-center gap-2\">\n                                <span class=\"text-lg\">${p.icon}</span>\n                                <span class=\"font-semibold\">${p.name}</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400\">\n                                高度: ${p.altitude}° | 方位: ${p.azimuth}° | 等級: ${p.magnitude}\n                            </div>\n                        </div>\n                    `).join('');\n                }\n            } catch (error) {\n                console.error('惑星計算エラー:', error);\n                document.getElementById('visible-planets').innerHTML = '<div class=\"text-red-400\">計算エラー</div>';\n            }\n        }\n\n        // 1-2. 天 の川視認性を計算\n        function calculateMilkyWayVisibility(observerDate, observerLat, observerLon, moonData, cloudCover) {\n            try {\n                // 引数の検証\n                if (!observerDate || !observerLat || !observerLon || !moonData) {\n                    throw new Error('必要なパラメータが不足しています');\n                }\n                if (typeof cloudCover === 'undefined') {\n                    cloudCover = 0;\n                }\n\n                const observer = new Astronomy.Observer(observerLat, observerLon, 0);\n\n                // 銀河中心の座標（いて座A*）\n                // 赤経: 17h 45m 40s = 266.4167度、赤緯: -29° 00' 28\" = -29.0078度\n                const galacticCenterRA = 17 + 45/60 + 40/3600;  // 時間単位\n                const galacticCenterDec = -(29 + 0/60 + 28/3600);  // 度単位\n\n                // 銀河中心の地 平座標を計算\n                const gcHorizon = Astronomy.Horizon(observerDate, observer, galacticCenterRA, galacticCenterDec, 'normal');\n\n                // 月の位置を取得\n                const moonEquator = Astronomy.Equator('Moon', observerDate, observer, true, true);\n                const moonHorizon = Astronomy.Horizon(observerDate, observer, moonEquator.ra, moonEquator.dec, 'normal');\n\n                // 月と銀河中心の角距離を計算（球面三角法）\n                const raRad1 = galacticCenterRA * Math.PI / 12;  // 時間を弧度に変換\n                const decRad1 = galacticCenterDec * Math.PI / 180;\n                const raRad2 = moonEquator.ra * Math.PI / 12;\n                const decRad2 = moonEquator.dec * Math.PI / 180;\n\n                const angularDistance = Math.acos(\n                    Math.sin(decRad1) * Math.sin(decRad2) +\n                    Math.cos(decRad1) * Math.cos(decRad2) * Math.cos(raRad1 - raRad2)\n                ) * 180 / Math.PI;\n\n                // 視認性スコアを計算（0-100）\n                let visibilityScore = 100;\n\n                // 1. 銀河中心の高度によ る減点（地平線に近いほど見えにくい）\n                if (gcHorizon.altitude < 0) {\n                    visibilityScore = 0;  // 地平線下は見えない\n                } else if (gcHorizon.altitude < 20) {\n                    visibilityScore -= (20 - gcHorizon.altitude) * 2;  // 低高度は大気減光で見えにくい\n                }\n\n                // 2. 月明かりの影響\n                const moonIllumination = Astronomy.Illumination('Moon', observerDate);\n                const moonPhase = moonIllumination.phase_fraction * 100;\n\n                if (moonHorizon.altitude > 0) {  // 月が地平線上にある場合\n                    // 月齢によ る減点\n                    const moonPenalty = moonPhase * 0.3;  // 満月で最大30点減点\n\n                    // 角距離による影響（近いほど影響大）\n                    let distanceFactor = 1.0;\n                    if (angularDistance < 30) {\n                        distanceFactor = 2.0;  // 月が近い場合は影響2倍\n                    } else if (angularDistance < 60) {\n                        distanceFactor = 1.5;\n                    } else if (angularDistance < 90) {\n                        distanceFactor = 1.2;\n                    }\n\n                    visibilityScore -= moonPenalty * distanceFactor;\n                }\n\n                // 3. 雲量による減点\n                const cloudPenalty = cloudCover * 0.5;  // 雲量100%で50点減点\n                visibilityScore -= cloudPenalty;\n\n                // スコアを0-100の範囲に制限\n                visibilityScore = Math.max(0, Math.min(100, visibilityScore));\n\n                // 評 価ランク\n                let rank, rankColor, rankIcon;\n                if (visibilityScore >= 80) {\n                    rank = '絶好';\n                    rankColor = 'text-yellow-300';\n                    rankIcon = '⭐⭐⭐';\n                } else if (visibilityScore >= 60) {\n                    rank = '良好';\n                    rankColor = 'text-green-300';\n                    rankIcon = '⭐⭐';\n                } else if (visibilityScore >= 40) {\n                    rank = 'やや不良';\n                    rankColor = 'text-blue-300';\n                    rankIcon = '⭐';\n                } else if (visibilityScore >= 20) {\n                    rank = '不良';\n                    rankColor = 'text-slate-400';\n                    rankIcon = '☁\uFE0F';\n                } else {\n                    rank = '視認不可';\n                    rankColor = 'text-red-400';\n                    rankIcon = '❌';\n                }\n\n                // HTMLを生成\n                const container = document.getElementById('milkyway-visibility');\n\n                if (gcHorizon.altitude < 0) {\n                    container.innerHTML = `\n                        <div class=\"bg-slate-700/30 rounded-lg p-3\">\n                            <div class=\"text-slate-400 text-center\">\n                                <div class=\"text-lg mb-1\">\uD83C\uDF05</div>\n                                <div>銀河中心は地平線下です</div>\n                                <div class=\"text-xs mt-1\">高度: ${gcHorizon.altitude.toFixed(1)}°</div>\n                            </div>\n                        </div>\n                    `;\n                } else {\n                    // 方位を日本語に変換\n                    let direction = '';\n                    const az = gcHorizon.azimuth;\n                    if (az >= 337.5 || az < 22.5) direction = '北';\n                    else if (az >= 22.5 && az < 67.5) direction = '北東';\n                    else if (az >= 67.5 && az < 112.5) direction = '東';\n                    else if (az >= 112.5 && az < 157.5) direction = '南東';\n                    else if (az >= 157.5 && az < 202.5) direction = '南';\n                    else if (az >= 202.5 && az < 247.5) direction = '南西';\n                    else if (az >= 247.5 && az < 292.5) direction = '西';\n                    else direction = '北西';\n\n                    container.innerHTML = `\n                        <div class=\"bg-slate-700/30 rounded-lg p-3 space-y-3\">\n                            <!-- 視認性スコア -->\n                            <div class=\"text-center\">\n                                <div class=\"text-2xl font-bold ${rankColor} mb-1\">\n                                    ${rankIcon} ${rank}\n                                </div>\n                                <div class=\"text-3xl font-bold text-white\">\n                                    ${visibilityScore.toFixed(0)}点\n                                </div>\n                                <div class=\"text-xs text-slate-400 mt-1\">天の川視認性スコア</div>\n                            </div>\n\n                            <!-- 銀河中心の位置 -->\n                            <div class=\"border-t border-slate-600 pt-2\">\n                                <div class=\"text-xs text-slate-300 mb-1\">\uD83C\uDFAF 銀河中心の位置（いて座A*）</div>\n                                <div class=\"grid grid-cols-2 gap-2 text-xs\">\n                                    <div class=\"bg-slate-800/50 rounded p-2\">\n                                        <div class=\"text-slate-400\">高度</div>\n                                        <div class=\"text-white font-semibold\">${gcHorizon.altitude.toFixed(1)}°</div>\n                                    </div>\n                                    <div class=\"bg-slate-800/50 rounded p-2\">\n                                        <div class=\"text-slate-400\">方位</div>\n                                        <div class=\"text-white font-semibold\">${direction} ${gcHorizon.azimuth.toFixed(0)}°</div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- 月の影響 -->\n                            <div class=\"border-t border-slate-600 pt-2\">\n                                <div class=\"text-xs text-slate-300 mb-1\">\uD83C\uDF19 月明かりの影響</div>\n                                <div class=\"text-xs space-y-1\">\n                                    <div class=\"flex justify-between\">\n                                        <span class=\"text-slate-400\">月齢:</span>\n                                        <span class=\"text-white\">${moonData.age}日 (${moonPhase.toFixed(0)}%照)</span>\n                                    </div>\n                                    <div class=\"flex justify-between\">\n                                        <span class=\"text-slate-400\">月の高度:</span>\n                                        <span class=\"text-white\">${moonHorizon.altitude.toFixed(1)}°</span>\n                                    </div>\n                                    <div class=\"flex justify-between\">\n                                        <span class=\"text-slate-400\">角距離:</span>\n                                        <span class=\"text-white\">${angularDistance.toFixed(0)}°</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- 観測アドバイス -->\n                            <div class=\"border-t border-slate-600 pt-2\">\n                                <div class=\"text-xs text-slate-300 mb-1\">\uD83D\uDCA1 アドバイス</div>\n                                <div class=\"text-xs text-slate-400 leading-relaxed\">\n                                    ${visibilityScore >= 80 ? '絶好の天の川撮影日和です！ISO3200、F2.8、15-25秒の露出がおすすめ。' :\n                                      visibilityScore >= 60 ? '天の川の撮影が可能です。月明かりに注意しながら撮影してください。' :\n                                      visibilityScore >= 40 ? '天の川の主要部分は見えますが、淡い部分は見えにくいかもしれません。' :\n                                      visibilityScore >= 20 ? '天の川の視認は困難です。月が沈むか、雲が晴れるのを待ちましょう。' :\n                                      '現在の条件では天の川の観測は難しいです。'}\n                                </div>\n                            </div>\n                        </div>\n                    `;\n                }\n\n            } catch (error) {\n                console.error('天の川計算エラー:', error);\n                console.error('エラースタック:', error.stack);\n                console.error('引数:', { observerDate, observerLat, observerLon, moonData, cloudCover });\n                document.getElementById('milkyway-visibility').innerHTML = `\n                    <div class=\"text-red-400 text-xs p-2\">\n                        <div class=\"font-semibold mb-1\">計算エラー</div>\n                        <div class=\"text-xs text-slate-400\">${error.message}</div>\n                        <div class=\"text-xs text-slate-500 mt-1\">ブラウザのコンソールで詳細を確認してください</div>\n                    </div>\n                `;\n            }\n        }\n\n        // 2. 流星群カレンダーを更新\n        function updateMeteorShowers(targetDate) {\n            const currentYear = targetDate.getFullYear();\n            const currentMonth = String(targetDate.getMonth() + 1).padStart(2, '0');\n            const currentDay = String(targetDate.getDate()).padStart(2, '0');\n            const currentDateStr = `${currentMonth}-${currentDay}`;\n\n            // 前後30日以内の流星群をフィルタ\n            const relevantShowers = meteorShowers.filter(shower => {\n                const showerDate = new Date(`${currentYear}-${shower.peakStart}`);\n                const targetDateTime = targetDate.getTime();\n                const diffDays = Math.abs((showerDate - targetDateTime) / (1000 * 60 * 60 * 24));\n                return diffDays <= 30;\n            });\n\n            const container = document.getElementById('meteor-showers');\n            if (relevantShowers.length === 0) {\n                container.innerHTML = '<div class=\"text-slate-400\">今後30日以内に極大を迎える流星群はありません</div>';\n            } else {\n                container.innerHTML = relevantShowers.map(shower => {\n                    const isPeak = currentDateStr === shower.peakStart || currentDateStr === shower.peakEnd;\n                    const showerDateStr = shower.peakStart.replace('-', '/');\n                    return `\n                        <div class=\"bg-slate-700/30 rounded-lg p-2 ${isPeak ? 'border-l-2 border-yellow-400' : ''}\">\n                            <div class=\"flex items-center justify-between\">\n                                <span class=\"font-semibold ${isPeak ? 'text-yellow-300' : ''}\">${shower.name}</span>\n                                <span class=\"text-xs text-slate-400\">${showerDateStr} 極大</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400 mt-1\">\n                                ${shower.rate} | ${shower.note}\n                            </div>\n                            ${isPeak ? '<div class=\"text-xs text-yellow-300 mt-1\">\uD83C\uDF1F 本日が極大日です！</div>' : ''}\n                        </div>\n                    `;\n                }).join('');\n            }\n        }\n\n        // 3. 月齢による観測推奨天体\n        function updateRecommendedObjects(moonAge) {\n            const age = parseFloat(moonAge);\n            const container = document.getElementById('recommended-objects');\n\n            let recommendations = [];\n\n            if (age < 3 || age > 26) {\n                // 新月期: 暗い天体に最適\n                recommendations = [\n                    { name: 'アンドロメダ銀河 (M31)', type: '銀河', reason: '暗い夜 空で見やすい' },\n                    { name: 'オリオン大星雲 (M42)', type: '星 雲', reason: '新月期が最適' },\n                    { name: 'プレアデス星団 (M45)', type: '星団', reason: '暗い空で美しい' }\n                ];\n            } else if (age >= 3 && age < 10) {\n                // 上弦前後: 月面観測に適する\n                recommendations = [\n                    { name: '月面クレータ ー', type: '月', reason: '影が長く見やすい' },\n                    { name: '明 るい惑星', type: '惑星', reason: '月明かりの影響少ない' },\n                    { name: '二重星（アルビレオ）', type: '恒星', reason: '明るい星なら観測可' }\n                ];\n            } else if (age >= 10 && age < 18) {\n                // 満月期: 月面観測メイン\n                recommendations = [\n                    { name: '満月の地形観測', type: '月', reason: '全体像を観測' },\n                    { name: '明るい星雲 (M42)', type: '星雲', reason: '明るい天体のみ' },\n                    { name: '惑星の衛星', type: '惑星', reason: '木星の衛星など' }\n                ];\n            } else {\n                // 下弦前後: 朝方の観測\n                recommendations = [\n                    { name: '月面南部クレーター', type: '月', reason: '下弦は南部が見やすい' },\n                    { name: '明け方の惑星', type: '惑星', reason: '水星・金星が好条件' },\n                    { name: '球状星団 (M13)', type: '星団', reason: '明け方なら観測可' }\n                ];\n            }\n\n            container.innerHTML = recommendations.map(rec => `\n                <div class=\"bg-slate-700/30 rounded-lg p-2\">\n                    <div class=\"flex items-center justify-between\">\n                        <span class=\"font-semibold\">${rec.name}</span>\n                        <span class=\"text-xs bg-green-600/30 text-green-300 px-2 py-0.5 rounded\">${rec.type}</span>\n                    </div>\n                    <div class=\"text-xs text-slate-400 mt-1\">${rec.reason}</div>\n                </div>\n            `).join('');\n        }\n\n        // 4. 天文イベント（月 食・日食）\n        function updateAstronomicalEvents(targetDate) {\n            const container = document.getElementById('astronomical-events');\n            const events = [];\n\n            try {\n                const searchStart = new Date(targetDate.getTime() - 180 * 24 * 60 * 60 * 1000); // 180日前\n                const searchEnd = new Date(targetDate.getTime() + 180 * 24 * 60 * 60 * 1000);   // 180日後\n\n                // 月食の検索\n                let lunarEclipse = Astronomy.SearchLunarEclipse(searchStart);\n                const lunarEclipses = [];\n                while (lunarEclipse && lunarEclipse.peak < searchEnd) {\n                    if (lunarEclipse.peak >= searchStart) {\n                        lunarEclipses.push(lunarEclipse);\n                    }\n                    lunarEclipse = Astronomy.NextLunarEclipse(lunarEclipse.peak);\n                }\n\n                // 日食の検索\n                let solarEclipse = Astronomy.SearchGlobalSolarEclipse(searchStart);\n                const solarEclipses = [];\n                while (solarEclipse && solarEclipse.peak < searchEnd) {\n                    if (solarEclipse.peak >= searchStart) {\n                        solarEclipses.push(solarEclipse);\n                    }\n                    solarEclipse = Astronomy.NextGlobalSolarEclipse(solarEclipse.peak);\n                }\n\n                // 月食を追加\n                lunarEclipses.forEach(eclipse => {\n                    const peakDate = moment(eclipse.peak);\n                    const typeText = eclipse.kind === 'total' ? '皆既月食' :\n                                   eclipse.kind === 'partial' ? '部分月食' : '半影月食';\n                    const daysUntil = peakDate.diff(moment(targetDate), 'days');\n                    const timeText = daysUntil === 0 ? '今日' :\n                                   daysUntil > 0 ? `${daysUntil}日後` : `${-daysUntil}日前`;\n\n                    events.push({\n                        date: peakDate,\n                        type: typeText,\n                        time: peakDate.format('M月D日 HH:mm'),\n                        daysUntil: daysUntil,\n                        timeText: timeText,\n                        icon: '\uD83C\uDF15',\n                        color: 'orange'\n                    });\n                });\n\n                // 日食を追加\n                solarEclipses.forEach(eclipse => {\n                    const peakDate = moment(eclipse.peak);\n                    const typeText = eclipse.kind === 'total' ? '皆既日食' :\n                                   eclipse.kind === 'annular' ? '金環日食' :\n                                   eclipse.kind === 'partial' ? '部分日食' : '日 食';\n                    const daysUntil = peakDate.diff(moment(targetDate), 'days');\n                    const timeText = daysUntil === 0 ? '今日' :\n                                   daysUntil > 0 ? `${daysUntil}日後` : `${-daysUntil} 日前`;\n\n                    events.push({\n                        date: peakDate,\n                        type: typeText,\n                        time: peakDate.format('M月D日 HH:mm'),\n                        daysUntil: daysUntil,\n                        timeText: timeText,\n                        icon: '\uD83C\uDF11',\n                        color: 'yellow'\n                    });\n                });\n\n                // 日付順にソート\n                events.sort((a, b) => a.date - b.date);\n\n                // 表示\n                if (events.length === 0) {\n                    container.innerHTML = '<div class=\"text-slate-400 text-xs\">今後180日間に予定されている月食・日食はありません。</div>';\n                } else {\n                    container.innerHTML = events.map(event => {\n                        const isPast = event.daysUntil < 0;\n                        const bgColor = isPast ? 'bg-slate-700/30' : 'bg-' + event.color + '-900/30';\n                        const textColor = isPast ? 'text-slate-400' : 'text-' + event.color + '-300';\n\n                        return `\n                            <div class=\"${bgColor} rounded-lg p-2\">\n                                <div class=\"flex items-center justify-between\">\n                                    <span class=\"font-semibold ${textColor}\">${event.icon} ${event.type}</span>\n                                    <span class=\"text-xs ${textColor}\">${event.timeText}</span>\n                                </div>\n                                <div class=\"text-xs text-slate-400 mt-1\">${event.time}</div>\n                                ${!isPast && Math.abs(event.daysUntil) <= 30 ? '<div class=\"text-xs text-yellow-300 mt-1\">⭐ 近日開催</div>' : ''}\n                            </div>\n                        `;\n                    }).join('');\n                }\n            } catch (error) {\n                console.error('天文イベント計算エラー:', error);\n                container.innerHTML = '<div class=\"text-slate-400 text-xs\">天文イベントの計算に失敗しました。</div>';\n            }\n        }\n\n        // --- 天気データ 取得 & 描画 ---\n\n        async function fetchWeather(lat, lon) {\n            // API URL (追加気象データを含む)\n            const API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,cloud_cover,cloud_cover_low,cloud_cover_mid,cloud_cover_high,windspeed_10m,winddirection_10m,surface_pressure,dewpoint_2m,visibility&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset&timezone=Asia%2FTokyo&past_days=2&forecast_days=10`;\n\n            try {\n                const response = await fetch(API_URL);\n                weatherData = await response.json();\n                \n                // 初回は現在時刻で描画\n                // もしユーザーが過去の日付を選択中の場合はそのまま維持しても良いが、\n                // 場所を変えたら「現 在」に戻る方が自然なため、現在時刻にリセットする\n                const now = moment();\n                setDatePickerValue(now);\n                renderDashboard(now);\n            } catch (error) {\n                document.getElementById('loading').innerHTML = `<span class=\"text-red-400\">データ取得エラー: ${error.message}</span>`;\n                console.error(error);\n            }\n        }\n\n        // --- UIレンダリング (既存のロジック) ---\n\n        function setDatePickerValue(momentObj) {\n            const formatted = momentObj.format('YYYY-MM-DDTHH:mm');\n            document.getElementById('target-datetime').value = formatted;\n        }\n\n        function updateDashboardTime() {\n            const val = document.getElementById('target-datetime').value;\n            if (val && weatherData) {\n                renderDashboard(moment(val));\n\n                // ISS星図モーダルが開いている場合は再描画\n                const skymapModal = document.getElementById('iss-skymap-modal');\n                if (skymapModal && !skymapModal.classList.contains('hidden')) {\n                    console.log('updateDashboardTime: 星図を再描画');\n                    drawISSSkymapCanvas();\n                }\n            }\n        }\n\n        function resetToNow() {\n            const now = moment();\n            setDatePickerValue(now);\n            if (weatherData) {\n                renderDashboard(now);\n            }\n        }\n\n        // 新しい関数: 週間予報の日付クリック時の処理\n        function selectDate(dateStr) {\n            // 現在の入力値（時間）を取得して、日付だけ差し替える\n            const currentVal = document.getElementById('target-datetime').value;\n            let targetMoment = moment(dateStr); \n            \n            if (currentVal) {\n                const currentMoment = moment(currentVal);\n                // 時間と分を維持\n                targetMoment.hour(currentMoment.hour());\n                targetMoment.minute(currentMoment.minute());\n            } else {\n                // デフォルトは正午などにするか、現在時刻に合わせる\n                const now = moment();\n                targetMoment.hour(now.hour());\n                targetMoment.minute(now.minute());\n            }\n\n            setDatePickerValue(targetMoment);\n            renderDashboard(targetMoment);\n\n            // ISS星図モーダルが開いている場 合は再描画\n            const skymapModal = document.getElementById('iss-skymap-modal');\n            if (skymapModal && !skymapModal.classList.contains('hidden')) {\n                console.log('selectDate: 星図を再描画');\n                drawISSSkymapCanvas();\n            }\n\n            // スクロールを上部へ（ス マホなどで見やすくするため）\n            document.getElementById('dashboard-content').scrollIntoView({ behavior: 'smooth' });\n        }\n\n        function getWeatherInfo(code) {\n            if (code === 0) return { label: '快晴', icon: 'sun', color: 'text-orange-400' };\n            if (code >= 1 && code <= 3) return { label: '曇り・晴れ間', icon: 'cloud-sun', color: 'text-gray-300' };\n            if (code >= 45 && code <= 48) return { label: '霧', icon: 'align-justify', color: 'text-gray-400' };\n            if (code >= 51 && code <= 55) return { label: '霧雨', icon: 'cloud-drizzle', color: 'text-blue-300' };\n            if (code >= 61 && code <= 67) return { label: '雨', icon: 'cloud-rain', color: 'text-blue-400' };\n            if (code >= 71 && code <= 77) return { label: '雪', icon: 'snowflake', color: 'text-white' };\n            if (code >= 80 && code <= 82) return { label: 'にわか雨', icon: 'cloud-hail', color: 'text-blue-300' };\n            if (code >= 95 && code <= 99) return { label: '雷雨', icon: 'cloud-lightning', color: 'text-yellow-400' };\n            return { label: '不明', icon: 'help-circle', color: 'text-gray-500' };\n        }\n\n        function renderDashboard(targetMoment) {\n            if (!weatherData) return;\n\n            const hourly = weatherData.hourly;\n            const daily = weatherData.daily;\n            const targetDate = targetMoment.toDate();\n            currentDatetime = targetDate; // グローバル変数を更新\n            \n            let currentIndex = 0;\n            let minDiff = Infinity;\n            let isOutOfRange = true;\n\n            hourly.time.forEach((t, i) => {\n                const diff = Math.abs(new Date(t) - targetDate);\n                if (diff < minDiff) {\n                    minDiff = diff;\n                    currentIndex = i;\n                }\n                if (diff < 90 * 60 * 1000) { \n                    isOutOfRange = false;\n                }\n            });\n\n            if (isOutOfRange && minDiff > 24 * 60 * 60 * 1000) {\n                 document.getElementById('forecast-summary').innerText = \"選択された日時の詳細データがありませ ん（範囲外です）\";\n                 return;\n            }\n\n            //  現在のステータス更新\n            const currentTemp = hourly.temperature_2m[currentIndex];\n            const currentCloudTotal = hourly.cloud_cover[currentIndex];\n            const currentLow = hourly.cloud_cover_low[currentIndex];\n            const currentMid = hourly.cloud_cover_mid[currentIndex];\n            const currentHigh = hourly.cloud_cover_high[currentIndex];\n\n            document.getElementById('current-temp').innerText = `${currentTemp}°C`;\n            document.getElementById('current-clouds').innerText = `${currentCloudTotal}%`;\n            \n            document.getElementById('clouds-high').innerText = `${currentHigh}%`;\n            document.getElementById('bar-high').style.width = `${currentHigh}%`;\n            \n            document.getElementById('clouds-mid').innerText = `${currentMid}%`;\n            document.getElementById('bar-mid').style.width = `${currentMid}%`;\n            \n            document.getElementById('clouds-low').innerText = `${currentLow}%`;\n            document.getElementById('bar-low').style.width = `${currentLow}%`;\n\n            // 月齢情報の更新 (サマリーエリア)\n            const moonData = calculateMoonData(targetDate);\n            document.getElementById('current-moon-icon').innerText = moonData.icon;\n            document.getElementById('current-moon-age-text').innerText = moonData.age;\n            document.getElementById('current-moon-name').innerText = moonData.phaseName;\n\n            // 天体イベント情報を更新\n            updateAstronomicalEvents(targetDate);\n            updateISSInfo(targetDate, currentLat, currentLon);\n            calculateVisiblePlanets(targetDate, currentLat, currentLon);\n            calculateMilkyWayVisibility(targetDate, currentLat, currentLon, moonData, currentCloudTotal);\n            updateMeteorShowers(targetDate);\n            updateRecommendedObjects(moonData.age);\n\n            // 追加気象データの表示\n            const currentWindSpeed = hourly.windspeed_10m ? hourly.windspeed_10m[currentIndex] : 0;\n            const currentWindDir = hourly.winddirection_10m ? hourly.winddirection_10m[currentIndex] : 0;\n            const currentPressure = hourly.surface_pressure ? hourly.surface_pressure[currentIndex] : 1013;\n            const currentDewpoint = hourly.dewpoint_2m ? hourly.dewpoint_2m[currentIndex] : 0;\n            const currentVisibility = hourly.visibility ? (hourly.visibility[currentIndex] / 1000).toFixed(1) : 24;\n            const currentHumidity = hourly.relative_humidity_2m[currentIndex];\n\n            document.getElementById('wind-speed').innerText = `${currentWindSpeed.toFixed(1)} m/s`;\n            const windDirText = getWindDirection(currentWindDir);\n            document.getElementById('wind-direction').innerText = windDirText;\n            document.getElementById('pressure').innerText = `${currentPressure.toFixed(0)} hPa`;\n            document.getElementById('dewpoint').innerText = `${currentDewpoint.toFixed(1)}°C`;\n            document.getElementById('visibility').innerText = `${currentVisibility} km`;\n\n            // 結露リスク判定\n            const tempDiff = currentTemp - currentDewpoint;\n            let condensationRisk = '';\n            if (tempDiff < 2) condensationRisk = '⚠\uFE0F 結露リスク高';\n            else if (tempDiff < 5) condensationRisk = '⚡ 結露注意';\n            else condensationRisk = '✅ 結露リスク低';\n            document.getElementById('condensation-risk').innerText = condensationRisk;\n\n            // 日月 出没・天文薄明の計算と表示\n            // 指定日時の0時0分を基準にすることで、 その日の日の出入りを正確に取得\n            const startOfDay = moment(targetDate).startOf('day').toDate();\n            const sunMoonTimes = calculateSunMoonTimes(startOfDay, currentLat, currentLon);\n            updateSunMoonDisplay(sunMoonTimes);\n            renderTimeline(sunMoonTimes, targetDate);\n\n            // 夜間平均雲量の計算（星空視認性スコアに使用）\n            // 当日の夜 = 当日の日没から翌日の日の出まで\n            const nightStart = sunMoonTimes.sunsetDate ? moment(sunMoonTimes.sunsetDate) :\n                              targetMoment.clone().startOf('day').add(18, 'hours');\n\n            // 翌日の日の出時刻を取得\n            const nextDay = moment(targetDate).add(1, 'day').startOf('day').toDate();\n            const nextDaySunMoonTimes = calculateSunMoonTimes(nextDay, currentLat, currentLon);\n            const nightEnd = nextDaySunMoonTimes.sunriseDate ? moment(nextDaySunMoonTimes.sunriseDate) :\n                            nightStart.clone().add(12, 'hours');\n\n            let nightCloudSum = 0;\n            let nightCloudCount = 0;\n\n            hourly.time.forEach((t, i) => {\n                const time = moment(t);\n                if (time.isSameOrAfter(nightStart) && time.isBefore(nightEnd)) {\n                    nightCloudSum += hourly.cloud_cover[i];\n                    nightCloudCount++;\n                }\n            });\n\n            const avgNightCloud = nightCloudCount > 0 ? nightCloudSum / nightCloudCount : currentCloudTotal;\n\n            // デバッグログ\n            console.log('=== 星空視認性スコア計算デバッグ ===');\n            console.log('観測期間:', nightStart.format('HH:mm'), '～', nightEnd.format('HH:mm'));\n            console.log('データ数:', nightCloudCount);\n            console.log('平均雲量:', avgNightCloud.toFixed(1), '%');\n            console.log('雲量スコア:', Math.max(0, 100 - avgNightCloud).toFixed(1));\n            console.log('月齢:', moonData.age);\n            console.log('湿度:', currentHumidity, '%');\n            console.log('視程:', currentVisibility, 'km');\n            console.log('風速:', currentWindSpeed, 'm/s');\n\n            // 星空視認性スコアの計算（夜間平均雲量を使用）\n            const starryScore = calculateStarryScore(avgNightCloud, moonData.age, currentHumidity, parseFloat(currentVisibility), currentWindSpeed);\n            updateStarryScore(starryScore);\n\n            console.log('最終スコア:', starryScore);\n            console.log('=====================================');\n\n            // レーダーチャートのデータ準備（夜 間平均雲量を使用）\n            const radarData = {\n                cloudClearness: Math.max(0, 100 - avgNightCloud),\n                moonDarkness: moonData.age < 3 || moonData.age > 26 ? 100 : moonData.age < 10 || moonData.age > 18 ? 60 : 20,\n                lowHumidity: Math.max(0, 100 - currentHumidity),\n                goodVisibility: Math.min(100, (parseFloat(currentVisibility) / 50) * 100),\n                calmWind: currentWindSpeed < 2 ? 100 : currentWindSpeed < 5 ? 80 : currentWindSpeed < 10 ? 50 : 20\n            };\n            renderRadarChart(radarData);\n\n\n            // サマリーテキスト\n            const displayTimeStr = targetMoment.format('M月D日 H:mm');\n            document.getElementById('summary-timestamp').innerText = `表示データ時刻: ${displayTimeStr}`;\n\n            let summary = `気温 ${currentTemp}°C。`;\n            if(currentCloudTotal < 20) summary += \" 快晴または晴れ。\";\n            else if(currentCloudTotal < 60) summary += \" 雲間あり。\";\n            else summary += \" 曇り空。\";\n            \n            if (currentIndex + 6 < hourly.temperature_2m.length) {\n                const futureTemp = hourly.temperature_2m[currentIndex + 6];\n                const tempDiff = futureTemp - currentTemp;\n                if(tempDiff > 2) summary += \" その後、気温は上昇傾向です。\";\n                else if(tempDiff < -2) summary += \" その後、冷え込む見込みです。\";\n            }\n\n            // --- 天体観測サマリー追加 ---\n            // 日没から翌日の日の出までのデータを取得（星空視認性スコアと同じ期間）\n            const astroStart = nightStart.clone();\n            const astroEnd = nightEnd.clone();\n\n            // 観測期間の長さ（時間単位）を計算し、4等分して時間帯を動的生成\n            const observationDuration = astroEnd.diff(astroStart, 'hours', true);\n            const slotDuration = Math.max(2, observationDuration / 4); // 最低2時間\n\n            // 時間帯別の雲量データを収集（動的に4区分生成）\n            const timeSlots = [];\n            for (let i = 0; i < 4; i++) {\n                const slotStart = astroStart.clone().add(slotDuration * i, 'hours');\n                const slotEnd = i === 3 ? astroEnd.clone() : astroStart.clone().add(slotDuration * (i + 1), 'hours');\n                timeSlots.push({\n                    startTime: slotStart,\n                    endTime: slotEnd,\n                    label: `${slotStart.format('HH:mm')}-${slotEnd.format('HH:mm')}`,\n                    sum: 0,\n                    count: 0\n                });\n            }\n\n            let astroCloudSum = 0;\n            let astroCount = 0;\n\n            hourly.time.forEach((t, i) => {\n                const time = moment(t);\n                if (time.isSameOrAfter(astroStart) && time.isBefore(astroEnd)) {\n                    astroCloudSum += hourly.cloud_cover[i];\n                    astroCount++;\n\n                    // 各時間帯に分類\n                    timeSlots.forEach(slot => {\n                        if (time.isSameOrAfter(slot.startTime) && time.isBefore(slot.endTime)) {\n                            slot.sum += hourly.cloud_cover[i];\n                            slot.count++;\n                        }\n                    });\n                }\n            });\n\n            if (astroCount > 0) {\n                const avgAstroCloud = astroCloudSum / astroCount;\n                summary += \"<br><br><strong>\uD83D\uDD2D 天体観測予報:</strong> \";\n                const dateStr = astroStart.format('M/D');\n                const observationPeriod = `<span class='text-xs text-slate-500'>(${astroStart.format('HH:mm')}～${astroEnd.format('HH:mm')})</span>`;\n\n                // 月の影響を加味したコメント\n                let moonComment = \"\";\n                if (moonData.age > 10 && moonData.age < 18) {\n                    moonComment = \" <span class='text-yellow-400'>※月明かりの影響大</span>\";\n                }\n\n                // より厳しい閾値での全体評価\n                if (avgAstroCloud < 10) {\n                    summary += `${dateStr}の夜${observationPeriod}は、雲が少なく<strong class='text-green-400'>絶好の天体観測日和</strong>です。${moonComment}`;\n                } else if (avgAstroCloud < 25) {\n                    summary += `${dateStr}の夜${observationPeriod}は、<strong class='text-blue-400'>観測に適しています</strong>。${moonComment}`;\n                } else if (avgAstroCloud < 50) {\n                    summary += `${dateStr}の夜${observationPeriod}は、<strong class='text-orange-400'>やや雲が多め</strong>です。雲の切れ間を狙いましょう。`;\n                } else {\n                    summary += `${dateStr}の夜${observationPeriod}は、雲が多く<strong class='text-red-400'>観測には不向き</strong>な予報です。`;\n                }\n\n                // 時間帯別の詳細評価\n                summary += \"<div class='flex flex-wrap gap-2 mt-3'>\";\n                timeSlots.forEach(slot => {\n                    if (slot.count > 0) {\n                        const avg = slot.sum / slot.count;\n                        let icon = '';\n                        let color = '';\n                        let bg = '';\n                        if (avg < 10) {\n                            icon = '⭐';\n                            color = 'text-green-400';\n                            bg = 'bg-green-500/10';\n                        } else if (avg < 25) {\n                            icon = '✨';\n                            color = 'text-blue-400';\n                            bg = 'bg-blue-500/10';\n                        } else if (avg < 50) {\n                            icon = '\uD83C\uDF24\uFE0F';\n                            color = 'text-orange-400';\n                            bg = 'bg-orange-500/10';\n                        } else {\n                            icon = '☁\uFE0F';\n                            color = 'text-red-400';\n                            bg = 'bg-red-500/10';\n                        }\n                        summary += `\n                            <div class='flex flex-col items-center justify-center px-3 py-2 rounded-xl border border-white/5 ${bg} min-w-[80px]'>\n                                <span class='text-xs text-slate-400 mb-1'>${slot.label}</span>\n                                <span class='text-lg mb-1'>${icon}</span>\n                                <span class='text-xs font-bold ${color}'>${Math.round(avg)}%</span>\n                            </div>`;\n                    }\n                });\n                summary += \"</div>\";\n            }\n            \n            // innerText -> innerHTML (タグを有効化するため)\n            document.getElementById('forecast-summary').innerHTML = summary;\n\n            // チャート描画 (24時間分に修正)\n            const sliceStart = currentIndex;\n            const sliceEnd = Math.min(currentIndex + 24, hourly.time.length);\n            \n            const labels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('D日 H時'));\n            const fullDateLabels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('M月D日 H:mm'));\n            \n            const temps = hourly.temperature_2m.slice(sliceStart, sliceEnd);\n            const cloudLow = hourly.cloud_cover_low.slice(sliceStart, sliceEnd);\n            const cloudMid = hourly.cloud_cover_mid.slice(sliceStart, sliceEnd);\n            const cloudHigh = hourly.cloud_cover_high.slice(sliceStart, sliceEnd);\n\n            // 気温チャート\n            const ctxTemp = document.getElementById('tempChart').getContext('2d');\n            if(tempChartInstance) tempChartInstance.destroy();\n\n            let gradientTemp = ctxTemp.createLinearGradient(0, 0, 0, 400);\n            gradientTemp.addColorStop(0, 'rgba(251, 146, 60, 0.5)'); \n            gradientTemp.addColorStop(1, 'rgba(251, 146, 60, 0.0)');\n\n            tempChartInstance = new Chart(ctxTemp, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: '気温 (°C)',\n                        data: temps,\n                        borderColor: '#fb923c',\n                        backgroundColor: gradientTemp,\n                        borderWidth: 3,\n                        pointBackgroundColor: '#fff',\n                        tension: 0.4,\n                        fill: true\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { display: false },\n                        tooltip: { callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] } }\n                    },\n                    scales: {\n                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 雲チャート（個別線グラフ：積み重ねなし）\n            // 配色: 下層=Gray-300, 中層=Emerald, 上層=Violet\n            const ctxCloud = document.getElementById('cloudChart').getContext('2d');\n            if(cloudChartInstance) cloudChartInstance.destroy();\n\n            cloudChartInstance = new Chart(ctxCloud, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [\n                        { label: '下層雲', data: cloudLow, borderColor: '#d1d5db', backgroundColor: 'rgba(209, 213, 219, 0.2)', borderWidth: 2, fill: false, tension: 0.4, pointRadius: 0 },\n                        { label: '中層雲', data: cloudMid, borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.2)', borderWidth: 2, fill: false, tension: 0.4, pointRadius: 0 },\n                        { label: '上層雲', data: cloudHigh, borderColor: '#a78bfa', backgroundColor: 'rgba(167, 139, 250, 0.2)', borderWidth: 2, fill: false, tension: 0.4, pointRadius: 0 }\n                    ]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { labels: { color: '#cbd5e1' } },\n                        tooltip: {\n                            mode: 'index',\n                            intersect: false,\n                             callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] }\n                        }\n                    },\n                    scales: {\n                        y: { stacked: false, beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8', callback: (value) => value + '%' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 週間予報テーブル\n            const weeklyBody = document.getElementById('weekly-forecast-body');\n            weeklyBody.innerHTML = '';\n            \n            daily.time.forEach((t, i) => {\n                const date = moment(t);\n                const isSelectedDay = date.isSame(targetMoment, 'day');\n                const weatherInfo = getWeatherInfo(daily.weathercode[i]);\n                const maxTemp = daily.temperature_2m_max[i];\n                const minTemp = daily.temperature_2m_min[i];\n                const rainSum = daily.precipitation_sum[i];\n                const rainProb = daily.precipitation_probability_max[i];\n                \n                // 月齢計算\n                const moonInfo = calculateMoonData(date.toDate());\n\n                // 1時間ごとのデータから、この日の平均雲量と湿度を計算\n                const dateStr = t; // \"YYYY-MM-DD\"\n                let cloudSum = 0;\n                let humSum = 0;\n                let count = 0;\n                \n                // データ量が少ないので単純ループで集計\n                hourly.time.forEach((hTime, hIndex) => {\n                    if (hTime.startsWith(dateStr)) {\n                        cloudSum += hourly.cloud_cover[hIndex];\n                        humSum += hourly.relative_humidity_2m[hIndex];\n                        count++;\n                    }\n                });\n                \n                const avgCloud = count > 0 ? Math.round(cloudSum / count) : '-';\n                const avgHum = count > 0 ? Math.round(humSum / count) : '-';\n\n                const row = document.createElement('tr');\n                // cursor-pointer を追加、onclickを追加\n                row.className = `border-b border-slate-700/50 transition cursor-pointer ${isSelectedDay ? 'bg-blue-500/20 border-l-4 border-l-blue-400' : 'hover:bg-white/5'}`;\n                row.onclick = () => selectDate(t); // クリックイベント\n\n                row.innerHTML = `\n                    <td class=\"py-4 px-2\">\n                        <div class=\"font-bold ${isSelectedDay ? 'text-blue-300' : 'text-white'}\">${date.format('M/D')}</div>\n                        <div class=\"text-xs text-slate-400\">${date.format('ddd')}</div>\n                    </td>\n                    <td class=\"py-4 px-2\">\n                        <div class=\"flex items-center gap-3\">\n                            <i data-lucide=\"${weatherInfo.icon}\" class=\"${weatherInfo.color} w-6 h-6\"></i>\n                            <span class=\"hidden md:inline text-sm\">${weatherInfo.label}</span>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm\">${rainProb !== null ? rainProb + '%' : '-'}</div>\n                        <div class=\"text-xs text-blue-300\">${rainSum > 0 ? rainSum + 'mm' : ''}</div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold\">${avgCloud !== '-' ? avgCloud + '%' : '-'}</div>\n                        <div class=\"w-16 bg-slate-700/50 rounded-full h-1 mx-auto mt-1\">\n                            <div class=\"bg-slate-400 h-1 rounded-full\" style=\"width: ${avgCloud !== '-' ? avgCloud : 0}%\"></div>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold text-blue-200 flex items-center justify-center gap-1\">\n                            <i data-lucide=\"droplet\" class=\"w-3 h-3\"></i>\n                            ${avgHum !== '-' ? avgHum + '%' : '-'}\n                        </div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-lg\" title=\"${moonInfo.phaseName} (月齢${moonInfo.age})\">${moonInfo.icon}</div>\n                        <div class=\"text-xs text-slate-400\">${moonInfo.age}</div>\n                    </td>\n                    <td class=\"py-4 px-2 text-right\">\n                        <span class=\"font-bold text-orange-400\">${maxTemp}°</span> \n                        <span class=\"text-slate-500 mx-1\">/</span> \n                        <span class=\"text-blue-300\">${minTemp}°</span>\n                    </td>\n                `;\n                weeklyBody.appendChild(row);\n            });\n            \n            lucide.createIcons();\n\n            document.getElementById('loading').classList.add('hidden');\n            document.getElementById('dashboard-content').classList.remove('hidden');\n\n            // ISS 星図モーダルが開いている場合は再描画\n            const skymapModal = document.getElementById('iss-skymap-modal');\n            if (skymapModal && !skymapModal.classList.contains('hidden')) {\n                console.log('星図を再描画します。時刻:', targetDate);\n                drawISSSkymapCanvas(targetDate);\n            }\n        }\n\n        // ISS星座図モーダル関連\n        function openISSSkymapModal(forcedDate = null) {\n            const modal = document.getElementById('iss-skymap-modal');\n            modal.classList.remove('hidden');\n            drawISSSkymapCanvas(forcedDate);\n            lucide.createIcons();\n        }\n\n        function closeISSSkymapModal(event) {\n            if (event && event.target !== event.currentTarget) return;\n            const modal = document.getElementById('iss-skymap-modal');\n            modal.classList.add('hidden');\n            window.selectedPass = null; // 閉じる時にパス選択をクリア\n        }\n\n        function drawISSSkymapCanvas(forcedDate = null) {\n            const canvas = document.getElementById('iss-skymap-canvas');\n            const ctx = canvas.getContext('2d');\n            const width = canvas.width;\n            const height = canvas.height;\n\n            // キャンバスをクリア\n            ctx.fillStyle = '#000000';\n            ctx.fillRect(0, 0, width, height);\n\n            try {\n                // ISSのTLEデータと観測地点が必要\n                if (!window.currentTLE || !currentLat || !currentLon) {\n                    ctx.fillStyle = '#94a3b8';\n                    ctx.font = '16px sans-serif';\n                    ctx.textAlign = 'center';\n                    ctx.fillText('ISS情報が取得できていません', width / 2, height / 2);\n                    return;\n                }\n\n                // 時刻の決定: \n                // 1. forcedDateが指定されている場合はそれを使用\n                // 2. forcedDate がなく、パスが選択されている場合はパスの最大高度時刻を使用\n                // 3. それ以外は現在時刻（dashboard time）を使用\n                let targetDate;\n                if (forcedDate) {\n                    targetDate = forcedDate;\n                } else if (window.selectedPass) {\n                    targetDate = window.selectedPass.maxElevationTime;\n                } else {\n                    targetDate = currentDatetime ? new Date(currentDatetime) : new Date();\n                }\n                \n                console.log('星図描画時刻:', targetDate, 'forcedDate:', forcedDate, 'selectedPass:', window.selectedPass);\n                const observer = new Astronomy.Observer(currentLat, currentLon, 0);\n\n                // 極座標変換関数（方位角・高度 → Canvas座標）\n                // 中心 = 天頂（高度90°）、外側 = 地平線（高度0°）\n                // 方位角: 0度=北（上）、90度=東（右）、180度=南（下）、270度=西（左）\n                const centerX = width / 2;\n                const centerY = height / 2;\n                const maxRadius = Math.min(width, height) / 2 - 40; // マージンを 考慮\n\n                function azAltToCanvas(azimuth, altitude) {\n                    // 高度0° = maxRadius（地平線）、高度90° = 0（天頂）\n                    const radius = ((90 - altitude) / 90) * maxRadius;\n\n                    // 方位角を極座標の角度に変換（0°=北=上）\n                    const azimuthRadians = (azimuth * Math.PI) / 180;\n                    const x = centerX + radius * Math.sin(azimuthRadians);\n                    const y = centerY - radius * Math.cos(azimuthRadians);\n\n                    return { x, y };\n                }\n\n                // タイトル表示（パスが選択されている場合）\n                if (window.selectedPass) {\n                    const pass = window.selectedPass;\n                    const titleText = `${moment(pass.startTime).format('YYYY/MM/DD HH:mm')} - ${moment(pass.endTime).format('HH:mm')}`;\n                    ctx.fillStyle = '#e2e8f0';\n                    ctx.font = 'bold 16px sans-serif';\n                    ctx.textAlign = 'center';\n                    ctx.fillText(titleText, centerX, 25);\n                }\n\n                // グリッド 線を描画（極座標形式）\n                ctx.strokeStyle = '#1e293b';\n                ctx.lineWidth = 1;\n\n                // 同心円グリッド（高度15°, 30°, 45°, 60°, 75°）\n                for (let alt = 15; alt <= 75; alt += 15) {\n                    const radius = ((90 - alt) / 90) * maxRadius;\n                    ctx.beginPath();\n                    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);\n                    ctx.stroke();\n\n                    // 高度ラベ ルを北側（上）に表示\n                    ctx.fillStyle = '#475569';\n                    ctx.font = '11px sans-serif';\n                    ctx.textAlign = 'center';\n                    ctx.fillText(`${alt}°`, centerX, centerY - radius - 3);\n                }\n\n                // 地平線（高度0°）を外周の円として強 調表示\n                ctx.strokeStyle = '#334155';\n                ctx.lineWidth = 2;\n                ctx.beginPath();\n                ctx.arc(centerX, centerY, maxRadius, 0, 2 * Math.PI);\n                ctx.stroke();\n\n                // 放射線グリッド（方位角15°刻み）\n                ctx.strokeStyle = '#1e293b';\n                ctx.lineWidth = 1;\n                for (let az = 0; az < 360; az += 15) {\n                    const azRad = (az * Math.PI) / 180;\n                    const x1 = centerX;\n                    const y1 = centerY;\n                    const x2 = centerX + maxRadius * Math.sin(azRad);\n                    const y2 = centerY - maxRadius * Math.cos(azRad);\n\n                    ctx.beginPath();\n                    ctx.moveTo(x1, y1);\n                    ctx.lineTo(x2, y2);\n                    ctx.stroke();\n                }\n\n                // 方位ラベル（N, E, S, W）を外側に表示\n                const directions = [\n                    { deg: 0, label: 'N' },\n                    { deg: 90, label: 'E' },\n                    { deg: 180, label: 'S' },\n                    { deg: 270, label: 'W' }\n                ];\n\n                directions.forEach(dir => {\n                    const azRad = (dir.deg * Math.PI) / 180;\n                    const labelRadius = maxRadius + 20;\n                    const x = centerX + labelRadius * Math.sin(azRad);\n                    const y = centerY - labelRadius * Math.cos(azRad);\n\n                    ctx.fillStyle = '#94a3b8';\n                    ctx.font = 'bold 16px sans-serif';\n                    ctx.textAlign = 'center';\n                    ctx.textBaseline = 'middle';\n                    ctx.fillText(dir.label, x, y);\n                });\n\n                // 天体リスト（太陽、月、惑星のみ。astronomy-engineは恒星を サポートしていません）\n                const visibleStars = [];\n\n                // 太陽の地平座標を計算\n                try {\n                    const sunEquator = Astronomy.Equator(Astronomy.Body.Sun, targetDate, observer, true, true);\n                    const sunHorizon = Astronomy.Horizon(targetDate, observer, sunEquator.ra, sunEquator.dec, 'normal');\n\n                    if (sunHorizon.altitude > 0) {\n                        visibleStars.push({\n                            name: '太陽',\n                            azimuth: sunHorizon.azimuth,\n                            altitude: sunHorizon.altitude,\n                            isSun: true\n                        });\n                    }\n                } catch (e) {\n                    console.warn('太陽の計算をス キップ:', e.message);\n                }\n\n                // 月の地平座標を計 算\n                try {\n                    const moonEquator = Astronomy.Equator('Moon', targetDate, observer, true, true);\n                    const moonHorizon = Astronomy.Horizon(targetDate, observer, moonEquator.ra, moonEquator.dec, 'normal');\n\n                    if (moonHorizon.altitude > 0) {\n                        visibleStars.push({\n                            name: '月',\n                            azimuth: moonHorizon.azimuth,\n                            altitude: moonHorizon.altitude,\n                            isMoon: true\n                        });\n                    }\n                } catch (e) {\n                    console.warn('月の計算をスキップ:', e.message);\n                }\n\n                // 惑星の地平座標を計算（高度>0のもののみ）\n                const planets = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];\n                const planetNames = { 'Mercury': '水星', 'Venus': '金星', 'Mars': '火星', 'Jupiter': '木星', 'Saturn': '土星' };\n                planets.forEach(planet => {\n                    try {\n                        const equator = Astronomy.Equator(planet, targetDate, observer, true, true);\n                        const horizon = Astronomy.Horizon(targetDate, observer, equator.ra, equator.dec, 'normal');\n\n                        if (horizon.altitude > 0) {\n                            visibleStars.push({\n                                name: planetNames[planet],\n                                azimuth: horizon.azimuth,\n                                altitude: horizon.altitude,\n                                isPlanet: true\n                            });\n                        }\n                    } catch (e) {\n                        console.warn(`惑星 ${planet} の計算をスキップ:`, e.message);\n                    }\n                });\n\n                // 天体を描画\n                visibleStars.forEach(star => {\n                    const pos = azAltToCanvas(star.azimuth, star.altitude);\n\n                    if (star.isSun) {\n                        //  太陽はオレンジの大きめの円\n                        ctx.fillStyle = '#f97316';\n                        ctx.beginPath();\n                        ctx.arc(pos.x, pos.y, 6, 0, 2 * Math.PI);\n                        ctx.fill();\n                        ctx.strokeStyle = '#fb923c';\n                        ctx.lineWidth = 2;\n                        ctx.stroke();\n                    } else if (star.isMoon) {\n                        // 月は白い大きめの円\n                        ctx.fillStyle = '#f0f0f0';\n                        ctx.beginPath();\n                        ctx.arc(pos.x, pos.y, 5, 0, 2 * Math.PI);\n                        ctx.fill();\n                        ctx.strokeStyle = '#ffffff';\n                        ctx.lineWidth = 1;\n                        ctx.stroke();\n                    } else if (star.isPlanet) {\n                        // 惑星は黄色の小さい円\n                        ctx.fillStyle = '#fbbf24';\n                        ctx.beginPath();\n                        ctx.arc(pos.x, pos.y, 3, 0, 2 * Math.PI);\n                        ctx.fill();\n                    } else {\n                        // 恒星は白い点\n                        ctx.fillStyle = '#ffffff';\n                        ctx.beginPath();\n                        ctx.arc(pos.x, pos.y, 2, 0, 2 * Math.PI);\n                        ctx.fill();\n                    }\n\n                    // 天体名を表示\n                    ctx.fillStyle = '#94a3b8';\n                    ctx.font = '10px sans-serif';\n                    ctx.textAlign = 'left';\n                    ctx.fillText(star.name, pos.x + 5, pos.y + 3);\n                });\n\n                // 選択さ れたパスの軌道を描画\n                if (window.selectedPass) {\n                    const pass = window.selectedPass;\n                    const satrec = satellite.twoline2satrec(window.currentTLE.line1, window.currentTLE.line2);\n                    const passPoints = [];\n\n                    // パスの軌道を計算（30秒刻み）\n                    for (let time = pass.startTime.getTime(); time <= pass.endTime.getTime(); time += 30000) {\n                        const date = new Date(time);\n                        const positionAndVelocity = satellite.propagate(satrec, date);\n\n                        if (positionAndVelocity.position && typeof positionAndVelocity.position !== 'boolean') {\n                            const positionEci = positionAndVelocity.position;\n                            const gmst = satellite.gstime(date);\n\n                            const observerGd = {\n                                longitude: satellite.degreesToRadians(currentLon),\n                                latitude: satellite.degreesToRadians(currentLat),\n                                height: 0\n                            };\n\n                            const positionEcf = satellite.eciToEcf(positionEci, gmst);\n                            const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);\n\n                            const azimuth = satellite.radiansToDegrees(lookAngles.azimuth);\n                            const elevation = satellite.radiansToDegrees(lookAngles.elevation);\n\n                            if (elevation > 0) {\n                                passPoints.push({ azimuth, elevation, time: date });\n                            }\n                        }\n                    }\n\n                    // 軌道を線で描画\n                    if (passPoints.length > 1) {\n                        ctx.strokeStyle = '#eab308';\n                        ctx.lineWidth = 2;\n                        ctx.beginPath();\n\n                        const firstPoint = azAltToCanvas(passPoints[0].azimuth, passPoints[0].elevation);\n                        ctx.moveTo(firstPoint.x, firstPoint.y);\n\n                        for (let i = 1; i < passPoints.length; i++) {\n                            const point = azAltToCanvas(passPoints[i].azimuth, passPoints[i].elevation);\n                            ctx.lineTo(point.x, point.y);\n                        }\n\n                        ctx.stroke();\n\n                        // 軌道上の矢印マーカーを描画（5分刻み）\n                        passPoints.forEach((point, index) => {\n                            if (index % 10 === 0 && index < passPoints.length - 1) { // 30秒×10 = 5分\n                                const pos = azAltToCanvas(point.azimuth, point.elevation);\n                                const nextPoint = passPoints[Math.min(index + 1, passPoints.length - 1)];\n                                const nextPos = azAltToCanvas(nextPoint.azimuth, nextPoint.elevation);\n\n                                // 進行方向の角度を計算\n                                const angle = Math.atan2(nextPos.y - pos.y, nextPos.x - pos.x);\n\n                                // 矢印を描画\n                                ctx.save();\n                                ctx.translate(pos.x, pos.y);\n                                ctx.rotate(angle);\n\n                                ctx.fillStyle = '#eab308';\n                                ctx.beginPath();\n                                ctx.moveTo(8, 0);\n                                ctx.lineTo(-4, -5);\n                                ctx.lineTo(-4, 5);\n                                ctx.closePath();\n                                ctx.fill();\n\n                                ctx.restore();\n\n                                // 時刻を表示（軌道から少し離れた位置 に）\n                                const labelAngle = angle + Math.PI / 2; // 垂直方向\n                                const labelDist = 15;\n                                const labelX = pos.x + labelDist * Math.cos(labelAngle);\n                                const labelY = pos.y + labelDist * Math.sin(labelAngle);\n\n                                ctx.fillStyle = '#fbbf24';\n                                ctx.font = '11px sans-serif';\n                                ctx.textAlign = 'center';\n                                ctx.textBaseline = 'middle';\n                                ctx.fillText(moment(point.time).format('HH:mm:ss'), labelX, labelY);\n                            }\n                        });\n                    }\n                }\n\n                // ISSの現在位置を計算\n                const satrec = satellite.twoline2satrec(window.currentTLE.line1, window.currentTLE.line2);\n                const positionAndVelocity = satellite.propagate(satrec, targetDate);\n\n                let issVisible = false;\n                let issAzimuth = 0;\n                let issAltitude = 0;\n\n                if (positionAndVelocity.position && typeof positionAndVelocity.position !== 'boolean') {\n                    const positionEci = positionAndVelocity.position;\n                    const gmst = satellite.gstime(targetDate);\n                    const positionGd = satellite.eciToGeodetic(positionEci, gmst);\n\n                    const latitude = satellite.degreesLat(positionGd.latitude);\n                    const longitude = satellite.degreesLong(positionGd.longitude);\n                    const height = positionGd.height;\n\n                    const observerGd = {\n                        longitude: satellite.degreesToRadians(currentLon),\n                        latitude: satellite.degreesToRadians(currentLat),\n                        height: 0\n                    };\n\n                    const positionEcf = satellite.eciToEcf(positionEci, gmst);\n                    const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);\n\n                    issAzimuth = satellite.radiansToDegrees(lookAngles.azimuth);\n                    issAltitude = satellite.radiansToDegrees(lookAngles.elevation);\n\n                    // ISSが視野内（地平線上）にあるか\n                    issVisible = issAltitude > 0;\n\n                    if (issVisible) {\n                        // ISSの位置を描画（赤い大きな円）\n                        const issPos = azAltToCanvas(issAzimuth, issAltitude);\n\n                        // 外側の光輪\n                        const gradient = ctx.createRadialGradient(issPos.x, issPos.y, 0, issPos.x, issPos.y, 20);\n                        gradient.addColorStop(0, 'rgba(239, 68, 68, 0.6)');\n                        gradient.addColorStop(1, 'rgba(239, 68, 68, 0)');\n                        ctx.fillStyle = gradient;\n                        ctx.beginPath();\n                        ctx.arc(issPos.x, issPos.y, 20, 0, 2 * Math.PI);\n                        ctx.fill();\n\n                        // ISS本体\n                        ctx.fillStyle = '#ef4444';\n                        ctx.beginPath();\n                        ctx.arc(issPos.x, issPos.y, 6, 0, 2 * Math.PI);\n                        ctx.fill();\n\n                        // ISS外周\n                        ctx.strokeStyle = '#ffffff';\n                        ctx.lineWidth = 2;\n                        ctx.beginPath();\n                        ctx.arc(issPos.x, issPos.y, 6, 0, 2 * Math.PI);\n                        ctx.stroke();\n\n                        // ISSラベル\n                        ctx.fillStyle = '#ffffff';\n                        ctx.font = 'bold 14px sans-serif';\n                        ctx.textAlign = 'center';\n                        ctx.fillText('ISS', issPos.x, issPos.y - 12);\n                    }\n                }\n\n                // 情報パネルを更新\n                const infoDiv = document.getElementById('iss-skymap-info');\n\n                if (window.selectedPass) {\n                    // 選択されたパスの情報を表示\n                    const pass = window.selectedPass;\n                    const duration = (pass.endTime - pass.startTime) / 1000 / 60;\n                    infoDiv.innerHTML = `\n                        <div class=\"bg-blue-900/30 rounded p-2\">\n                            <div class=\"text-blue-300 font-semibold text-sm mb-2 flex items-center justify-between\">\n                                <span>\uD83D\uDCE1  選択されたパス</span>\n                                <button onclick=\"window.selectedPass = null; drawISSSkymapCanvas();\" class=\"text-xs text-slate-400 hover:text-white\">\n                                    現在位置に戻る\n                                </button>\n                            </div>\n                            <div class=\"grid grid-cols-2 gap-2 text-xs\">\n                                <div>\n                                    <div class=\"text-slate-400\">開始時刻</div>\n                                    <div class=\"text-white font-mono\">${moment(pass.startTime).format('M/D HH:mm')}</div>\n                                </div>\n                                <div>\n                                    <div class=\"text-slate-400\">終了時刻</div>\n                                    <div class=\"text-white font-mono\">${moment(pass.endTime).format('M/D HH:mm')}</div>\n                                </div>\n                                <div>\n                                    <div class=\"text-slate-400\">最大高度</div>\n                                    <div class=\"text-white font-mono\">${pass.maxElevation.toFixed(1)}°</div>\n                                </div>\n                                <div>\n                                    <div class=\"text-slate-400\">最大高度時刻</div>\n                                    <div class=\"text-white font-mono\">${moment(pass.maxElevationTime).format('HH:mm')}</div>\n                                </div>\n                                <div>\n                                    <div class=\"text-slate-400\">継続時間</div>\n                                    <div class=\"text-white\">${duration.toFixed(0)}分</div>\n                                </div>\n                                <div>\n                                    <div class=\"text-slate-400\">距離</div>\n                                    <div class=\"text-white\">${pass.maxDistance.toFixed(0)}km</div>\n                                </div>\n                            </div>\n                        </div>\n                    `;\n                } else if (issVisible) {\n                    const direction = getDirection(issAzimuth);\n                    infoDiv.innerHTML = `\n                        <div class=\"grid grid-cols-3 gap-4 text-xs\">\n                            <div>\n                                <div class=\"text-slate-400\">方位角</div>\n                                <div class=\"text-white font-mono text-sm\">${issAzimuth.toFixed(1)}° (${direction})</div>\n                            </div>\n                            <div>\n                                <div class=\"text-slate-400\">高 度</div>\n                                <div class=\"text-white font-mono text-sm\">${issAltitude.toFixed(1)}°</div>\n                            </div>\n                            <div>\n                                <div class=\"text-slate-400\">状態</div>\n                                <div class=\"text-green-300 text-sm font-semibold\">視野内 ✓</div>\n                            </div>\n                        </div>\n                        <div class=\"mt-2 text-xs text-slate-400\">\n                            \uD83D\uDCCD 観測地点: ${currentLat.toFixed(2)}°, ${currentLon.toFixed(2)}° | 計算時刻: ${moment(targetDate).format('HH:mm:ss')}\n                        </div>\n                    `;\n                } else {\n                    infoDiv.innerHTML = `\n                        <div class=\"text-center text-slate-400\">\n                            <div class=\"text-lg mb-2\">\uD83C\uDF05</div>\n                            <div class=\"font-semibold\">ISSは現在視野内にありません</div>\n                            <div class=\"text-xs mt-2\">\n                                高度: ${issAltitude.toFixed(1)}° (地平線下)\n                            </div>\n                            <div class=\"text-xs mt-1\">\n                                \uD83D\uDCCD 観測地点: ${currentLat.toFixed(2)}°, ${currentLon.toFixed(2)}° | 計算時刻: ${moment(targetDate).format('HH:mm:ss')}\n                            </div>\n                        </div>\n                    `;\n                }\n\n            } catch (error) {\n                console.error('星座図描画エ ラー:', error);\n                console.error('エラースタック:', error.stack);\n                ctx.fillStyle = '#ef4444';\n                ctx.font = '16px sans-serif';\n                ctx.textAlign = 'center';\n                ctx.fillText('エラーが発生しました', width / 2, height / 2 - 20);\n                ctx.font = '12px sans-serif';\n                ctx.fillText(error.message, width / 2, height / 2 + 10);\n            }\n        }\n\n        // 方位角を方位名に変換\n        function getDirection(azimuth) {\n            if (azimuth >= 337.5 || azimuth < 22.5) return '北';\n            else if (azimuth >= 22.5 && azimuth < 67.5) return '北東';\n            else if (azimuth >= 67.5 && azimuth < 112.5) return '東';\n            else if (azimuth >= 112.5 && azimuth < 157.5) return '南 東';\n            else if (azimuth >= 157.5 && azimuth < 202.5) return '南';\n            else if (azimuth >= 202.5 && azimuth < 247.5) return '南西';\n            else if (azimuth >= 247.5 && azimuth < 292.5) return '西';\n            else return '北西';\n        }\n    </script>\n</body>\n</html>\n
./.idea/shelf/リベース_前の未コミットの変更_[変更]/shelved.patch:<+><!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>天体観測できるかな？</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ja.js\"></script>\n    <!-- Lucide Icons -->\n    <script src=\"https://unpkg.com/lucide@latest\"></script>\n    <!-- Leaflet (Map) -->\n    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\" />\n    <script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\"></script>\n    <!-- Astronomy Engine for planetary calculations -->\n    <script src=\"https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js\"></script>\n    <style>\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');\n        body { font-family: 'Noto Sans JP', sans-serif; }\n        .glass-panel {\n            background: rgba(255, 255, 255, 0.1);\n            backdrop-filter: blur(10px);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n        }\n        /* Date picker custom styles for dark mode compatibility */\n        input[type=\"datetime-local\"] {\n            color-scheme: dark;\n        }\n        #map {\n            height: 300px;\n            width: 100%;\n            border-radius: 0.75rem;\n            z-index: 1;\n        }\n        /* Leaflet customization */\n        .leaflet-container {\n            background: #1e293b;\n        }\n        /* Night Vision Mode */\n        body.night-vision {\n            filter: hue-rotate(180deg) invert(1);\n            background: #300000 !important;\n        }\n        body.night-vision .glass-panel {\n            background: rgba(100, 0, 0, 0.3) !important;\n            border-color: rgba(200, 0, 0, 0.3) !important;\n        }\n        body.night-vision * {\n            color: #ff6666 !important;\n            border-color: #ff3333 !important;\n        }\n        /* Starry Score Meter */\n        .score-meter {\n            width: 200px;\n            height: 200px;\n            position: relative;\n        }\n        .score-circle {\n            stroke-dasharray: 440;\n            stroke-dashoffset: 440;\n            transition: stroke-dashoffset 1s ease;\n        }\n        /* Timeline styles */\n        .timeline-bar {\n            position: relative;\n            height: 60px;\n            background: linear-gradient(to right, #1e293b 0%, #0f172a 50%, #1e293b 100%);\n            border-radius: 8px;\n            overflow: hidden;\n        }\n        .timeline-segment {\n            position: absolute;\n            height: 100%;\n            opacity: 0.7;\n        }\n    </style>\n</head>\n<body class=\"bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen p-4 md:p-8\">\n\n    <div class=\"max-w-6xl mx-auto space-y-6\">\n        \n        <!-- ヘッダー -->\n        <header class=\"flex flex-col md:flex-row justify-between items-center gap-4\">\n            <div class=\"flex-1\">\n                <!-- メインタイトル -->\n                <h1 class=\"text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-100 via-blue-200 to-blue-400 mb-3 flex items-center gap-3\">\n                    <i data-lucide=\"telescope\" class=\"text-yellow-200 w-8 h-8 md:w-12 md:h-12\"></i>\n                    天体観測できるかな？\n                </h1>\n                \n                <!-- 場所情報 -->\n                <div class=\"flex items-center gap-2 text-xl font-semibold text-slate-200 pl-1\">\n                    <i data-lucide=\"map-pin\" class=\"text-blue-400\"></i>\n                    <span id=\"location-name\">位置情報を取得中...</span>\n                </div>\n                <p class=\"text-slate-400 text-sm mt-1 flex items-center gap-2 pl-1\">\n                    <span id=\"coords-display\">緯度: -- | 経度: --</span>\n                    <button onclick=\"toggleMap()\" class=\"text-blue-300 hover:text-white underline text-xs ml-2\">\n                        地図で場所を変更\n                    </button>\n                </p>\n            </div>\n            <div class=\"text-right flex flex-col items-end\">\n                <div id=\"current-clock\" class=\"text-xl font-semibold font-mono\">--:--:--</div>\n                <div class=\"text-slate-400 text-sm\">現在時刻 (Asia/Tokyo)</div>\n                <div class=\"text-slate-500 text-xs mt-2 flex items-center gap-2\">\n                    Ver. 2.2.1\n                    <button onclick=\"toggleNightVision()\" class=\"text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded border border-red-600/30\" title=\"ナイトビジョンモード\">\n                        <i data-lucide=\"moon\" class=\"w-3 h-3 inline\"></i>\n                    </button>\n                </div>\n            </div>\n        </header>\n\n        <!-- 地図・位置設定エリア (初期は非表示) -->\n        <div id=\"location-settings\" class=\"hidden glass-panel rounded-xl p-4 space-y-4\">\n            <div class=\"flex flex-wrap justify-between items-center gap-4\">\n                <h3 class=\"font-bold flex items-center gap-2\">\n                    <i data-lucide=\"map\" class=\"w-5 h-5 text-green-400\"></i> 地図から場所を選択\n                </h3>\n                <button onclick=\"getCurrentLocation()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2\">\n                    <i data-lucide=\"crosshair\" class=\"w-4 h-4\"></i> 現在地を取得\n                </button>\n            </div>\n            <p class=\"text-sm text-slate-300\">地図をクリックすると 、その場所の天気を表示します。</p>\n            <div id=\"map\"></div>\n        </div>\n\n        <!-- コントロールバー (日時指定) -->\n        <div class=\"glass-panel rounded-xl p-4 flex flex-col sm:flex-row items-center justify-between gap-4\">\n            <div class=\"flex items-center gap-2 text-sm md:text-base\">\n                <i data-lucide=\"settings-2\" class=\"text-slate-300 w-5 h-5\"></i>\n                <span class=\"font-bold\">表示日時を指定:</span>\n            </div>\n            <div class=\"flex items-center gap-3 w-full sm:w-auto\">\n                <input type=\"datetime-local\" id=\"target-datetime\" \n                    class=\"bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-400 w-full sm:w-auto font-mono\"\n                    onchange=\"updateDashboardTime()\">\n                \n                <button onclick=\"resetToNow()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap\">\n                    現在に戻す\n                </button>\n            </div>\n        </div>\n\n        <!-- ロード中表示 -->\n        <div id=\"loading\" class=\"text-center py-20 text-xl animate-pulse\">天気データを取得中...</div>\n        \n        <div id=\"dashboard-content\" class=\"hidden space-y-6\">\n            <!-- 星空視認性スコア（大型表示） -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <div class=\"flex flex-col md:flex-row items-center justify-between gap-6\">\n                    <div class=\"flex flex-col items-center justify-center\">\n                        <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                            <i data-lucide=\"sparkles\" class=\"text-yellow-400 w-5 h-5\"></i> 星空視認性スコア\n                        </h3>\n                        <svg class=\"score-meter\" viewBox=\"0 0 160 160\">\n                            <circle cx=\"80\" cy=\"80\" r=\"70\" fill=\"none\" stroke=\"#334155\" stroke-width=\"12\"/>\n                            <circle id=\"score-circle\" class=\"score-circle\" cx=\"80\" cy=\"80\" r=\"70\" fill=\"none\" stroke=\"url(#scoreGradient)\" stroke-width=\"12\" stroke-linecap=\"round\" transform=\"rotate(-90 80 80)\"/>\n                            <defs>\n                                <linearGradient id=\"scoreGradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\n                                    <stop offset=\"0%\" style=\"stop-color:#ef4444;stop-opacity:1\" />\n                                    <stop offset=\"50%\" style=\"stop-color:#eab308;stop-opacity:1\" />\n                                    <stop offset=\"100%\" style=\"stop-color:#22c55e;stop-opacity:1\" />\n                                </linearGradient>\n                            </defs>\n                            <text id=\"score-text\" x=\"80\" y=\"75\" text-anchor=\"middle\" font-size=\"36\" font-weight=\"bold\" fill=\"#fff\">--</text>\n                            <text x=\"80\" y=\"95\" text-anchor=\"middle\" font-size=\"12\" fill=\"#94a3b8\">/ 100</text>\n                        </svg>\n                        <p id=\"score-comment\" class=\"text-sm text-slate-300 mt-3 text-center\">計算中...</p>\n                    </div>\n\n                    <!-- お気に入り地点 -->\n                    <div class=\"flex-1 w-full\">\n                        <h4 class=\"font-semibold text-sm mb-3 flex items-center gap-2\">\n                            <i data-lucide=\"bookmark\" class=\"w-4 h-4 text-blue-400\"></i>\n                            お気に入り地点\n                        </h4>\n                        <div id=\"favorite-locations\" class=\"space-y-2\">\n                            <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                                <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                                現在地をお気に入りに追加\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- メイン指標 -->\n            <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <!-- 気温カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden group hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の気温</div>\n                    <i data-lucide=\"thermometer\" class=\"w-12 h-12 text-orange-400 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-temp\">--°C</div>\n                    <div class=\"text-slate-300\">気温</div>\n                </div>\n\n                <!-- 雲量カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の雲量</div>\n                    <i data-lucide=\"cloud\" class=\"w-12 h-12 text-slate-300 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-clouds\">--%</div>\n                    <div class=\"text-slate-300\">全天雲量</div>\n                </div>\n\n                <!-- 雲の詳細 -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col justify-center gap-4 hover:bg-white/5 transition\">\n                    <div class=\"text-slate-400 text-sm font-medium uppercase tracking-wider mb-2\">雲の層（高度別）</div>\n                    \n                    <div class=\"flex justify-between items-center\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-up\" class=\"w-4 h-4\"></i> 上層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-high\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 上層雲: Violet -->\n                        <div id=\"bar-high\" class=\"bg-violet-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"minus\" class=\"w-4 h-4\"></i> 中層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-mid\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 中層雲: Emerald -->\n                        <div id=\"bar-mid\" class=\"bg-emerald-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-down\" class=\"w-4 h-4\"></i> 下層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-low\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 下層雲: 明るいグレー -->\n                        <div id=\"bar-low\" class=\"bg-gray-300 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 追加気 象データ + 天文薄明時刻 -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                <!-- 追加気象データ -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"gauge\" class=\"text-cyan-400 w-5 h-5\"></i> 詳細気象データ\n                    </h3>\n                    <div class=\"grid grid-cols-2 gap-4\">\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">風速・風向</div>\n                            <div class=\"text-xl font-bold\" id=\"wind-speed\">-- m/s</div>\n                            <div class=\"text-sm text-slate-300\" id=\"wind-direction\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">気圧</div>\n                            <div class=\"text-xl font-bold\" id=\"pressure\">-- hPa</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\"> 露点温度</div>\n                            <div class=\"text-xl font-bold\" id=\"dewpoint\">--°C</div>\n                            <div class=\"text-xs text-slate-400\" id=\"condensation-risk\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">視程</div>\n                            <div class=\"text-xl font-bold\" id=\"visibility\">-- km</div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 天文薄明・日月出没時刻 -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"sunrise\" class=\"text-orange-400 w-5 h-5\"></i> 天文薄明・出没時刻\n                    </h3>\n                    <div class=\"space-y-3\">\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明開始</span>\n                            <span class=\"font-mono font-bold\" id=\"twilight-astro-begin\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の出</span>\n                            <span class=\"font-mono font-bold\" id=\"sunrise-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の入</span>\n                            <span class=\"font-mono font-bold\" id=\"sunset-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明終了</span>\n                            <span class=\"font-mono font-bold text-green-300\" id=\"twilight-astro-end\">--:--</span>\n                        </div>\n                        <div class=\"border-t border-slate-700 pt-3 mt-3\">\n                            <div class=\"flex items-center justify-between text-sm\">\n                                <span class=\"text-slate-300\">月の出</span>\n                                <span class=\"font-mono font-bold\" id=\"moonrise-time\">--:--</span>\n                            </div>\n                            <div class=\"flex items-center justify-between text-sm mt-2\">\n                                <span class=\"text-slate-300\">月の入</span>\n                                <span class=\"font-mono font-bold\" id=\"moonset-time\">--:--</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 24時間タイムライン -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"clock\" class=\"text-purple-400 w-5 h-5\"></i> 24時間観測適性タイムライン\n                </h3>\n                <div id=\"timeline-container\" class=\"timeline-bar\"></div>\n                <div class=\"flex items-center justify-between mt-3 text-xs text-slate-400\">\n                    <span>00:00</span>\n                    <span>06:00</span>\n                    <span>12:00</span>\n                    <span>18:00</span>\n                    <span>24:00</span>\n                </div>\n                <div class=\"flex items-center gap-4 mt-3 text-xs flex-wrap\">\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-yellow-500/50 rounded\"></div>\n                        <span>日中</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-blue-500/50 rounded\"></div>\n                        <span>薄明</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-green-500/50 rounded\"></div>\n                        <span>観測適時</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-slate-500/50 rounded\"></div>\n                        <span>月明かり</span>\n                    </div>\n                </div>\n            </div>\n\n             <!-- サマリーエリア（拡張版：天気分析＋月齢） -->\n             <div class=\"glass-panel rounded-2xl p-6\">\n                <div class=\"flex flex-col md:flex-row gap-6\">\n                    <!-- 左側：天気サマリー -->\n                    <div class=\"flex-1 flex flex-col justify-center border-l-4 border-blue-400 pl-4\">\n                        <p class=\"text-slate-300 italic\" id=\"forecast-summary\">予報を分析中...</p>\n                        <p class=\"text-xs text-slate-500 mt-2\" id=\"summary-timestamp\">--</p>\n                    </div>\n\n                    <!-- 右側：月齢情報 -->\n                    <div class=\"flex flex-col items-center justify-center min-w-[150px] border-t md:border-t-0 md:border-l border-slate-700 pt-4 md:pt-0 md:pl-6\">\n                        <div class=\"text-xs text-slate-400 mb-1 uppercase tracking-wider\">Moon Phase</div>\n                        <div class=\"text-4xl mb-1\" id=\"current-moon-icon\">\uD83C\uDF11</div>\n                        <div class=\"text-xl font-bold text-yellow-100\" id=\"current-moon-age-text\">--</div>\n                        <div class=\"text-sm text-yellow-200\" id=\"current-moon-name\">--</div>\n                    </div>\n                </div>\n             </div>\n\n            <!-- 天体イベント情報セクション -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"star\" class=\"text-yellow-400 w-5 h-5\"></i> 天体イベント情報\n                </h3>\n\n                <div class=\"space-y-3\">\n                    <!-- 今夜見える惑星 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('planets')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"planet\" class=\"w-4 h-4 text-purple-400\"></i>\n                                <span class=\"font-semibold text-sm\">今夜見える惑星</span>\n                            </div>\n                            <i id=\"icon-planets\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-planets\" class=\"hidden px-4 pb-4\">\n                            <div id=\"visible-planets\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 流星群カレンダー -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('meteors')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"zap\" class=\"w-4 h-4 text-yellow-400\"></i>\n                                <span class=\"font-semibold text-sm\">流 星群カレンダー</span>\n                            </div>\n                            <i id=\"icon-meteors\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-meteors\" class=\"hidden px-4 pb-4\">\n                            <div id=\"meteor-showers\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">読み込み中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 月齢による観測推奨天体 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('recommended')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"telescope\" class=\"w-4 h-4 text-green-400\"></i>\n                                <span class=\"font-semibold text-sm\">月齢による観測推奨天体</span>\n                            </div>\n                            <i id=\"icon-recommended\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-recommended\" class=\"hidden px-4 pb-4\">\n                            <div id=\"recommended-objects\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算 中...</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 観測適性レーダーチャート -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"radar\" class=\"text-pink-400 w-5 h-5\"></i> 観測適性レーダーチャート\n                </h3>\n                <div class=\"relative h-80 w-full\">\n                    <canvas id=\"radarChart\"></canvas>\n                </div>\n                <p class=\"text-xs text-slate-400 mt-2 text-center\">各要素が外側に近いほど観測に適した条件です</p>\n            </div>\n\n            <!-- チャートセクション -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <!-- 気温チャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"clock\" class=\"text-orange-400 w-5 h-5\"></i> 気温予報 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"tempChart\"></canvas>\n                    </div>\n                </div>\n\n                <!-- 雲の積層チャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"layers\" class=\"text-blue-400 w-5 h-5\"></i> 雲量推移 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"cloudChart\"></canvas>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 週間天気予報 -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"calendar\" class=\"text-green-400 w-5 h-5\"></i> 週間天気予報\n                    <span class=\"text-xs font-normal text-slate-400 ml-2\">※日付をクリックするとその日の詳細を表示します</span>\n                </h3>\n                <div class=\"overflow-x-auto\">\n                    <table class=\"w-full text-left border-collapse\">\n                        <thead>\n                            <tr class=\"text-slate-400 text-sm border-b border-slate-700\">\n                                <th class=\"py-3 px-2\">日付</th>\n                                <th class=\"py-3 px-2\">天気</th>\n                                <th class=\"py-3 px-2 text-center\">降水確率 / 量</th>\n                                <th class=\"py-3 px-2 text-center\">平均雲量</th>\n                                <th class=\"py-3 px-2 text-center\">平均湿度</th>\n                                <th class=\"py-3 px-2 text-center\">月齢</th>\n                                <th class=\"py-3 px-2 text-right\">最高 / 最低気温</th>\n                            </tr>\n                        </thead>\n                        <tbody id=\"weekly-forecast-body\" class=\"text-sm md:text-base\">\n                            <!-- JSで生成 -->\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        </div>\n\n        <!-- フッター (APIクレジット) -->\n        <footer class=\"glass-panel rounded-xl p-4 text-center text-slate-400 text-sm\">\n            <p>\n                Data sources: \n                <a href=\"https://open-meteo.com/\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">Open-Meteo</a> (Weather Data) & \n                <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">OpenStreetMap</a> (Map & Address Data)\n            </p>\n        </footer>\n\n    </div>\n\n    <script>\n        // --- 初期設定 ---\n        lucide.createIcons();\n        moment.locale('ja'); \n\n        let mapInstance = null;\n        let markerInstance = null;\n        let weatherData = null;\n        let tempChartInstance = null;\n        let cloudChartInstance = null;\n        let radarChartInstance = null;\n        let favoriteLocations = JSON.parse(localStorage.getItem('favoriteLocations') || '[]');\n\n        // デフォルト位置（三島市）\n        let currentLat = 35.1167;\n        let currentLon = 138.9167;\n\n        // --- ナイトビジョンモード ---\n        function toggleNightVision() {\n            document.body.classList.toggle('night-vision');\n            const isNight = document.body.classList.contains('night-vision');\n            localStorage.setItem('nightVisionMode', isNight);\n        }\n\n        // ページロード時にナイトビジョンモードを復元\n        if (localStorage.getItem('nightVisionMode') === 'true') {\n            document.body.classList.add('night-vision');\n        }\n\n        // --- アコーディオン機能 ---\n        function toggleAccordion(id) {\n            const content = document.getElementById('content-' + id);\n            const icon = document.getElementById('icon-' + id);\n\n            if (content.classList.contains('hidden')) {\n                content.classList.remove('hidden');\n                icon.style.transform = 'rotate(180deg)';\n            } else {\n                content.classList.add('hidden');\n                icon.style.transform = 'rotate(0deg)';\n            }\n\n            // Lucideアイコンを再初期化\n            lucide.createIcons();\n        }\n\n        // --- お気に入り地点管理 ---\n        function addFavoriteLocation() {\n            const name = prompt('この地点の名前を入力してください:', document.getElementById('location-name').innerText || '未設定');\n            if (name) {\n                const location = {\n                    name: name,\n                    lat: currentLat,\n                    lon: currentLon\n                };\n                favoriteLocations.push(location);\n                if (favoriteLocations.length > 5) favoriteLocations.shift(); // 最大5件\n                localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n                renderFavoriteLocations();\n            }\n        }\n\n        function renderFavoriteLocations() {\n            const container = document.getElementById('favorite-locations');\n            if (favoriteLocations.length === 0) {\n                container.innerHTML = `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                        現在地をお気に入りに追加\n                    </button>\n                `;\n            } else {\n                container.innerHTML = favoriteLocations.map((loc, index) => `\n                    <div class=\"bg-slate-800/50 rounded-lg p-2 flex items-center justify-between border border-slate-700\">\n                        <button onclick=\"loadFavoriteLocation(${index})\" class=\"flex-1 text-left text-sm hover:text-blue-300\">\n                            <i data-lucide=\"map-pin\" class=\"w-3 h-3 inline mr-1\"></i>\n                            ${loc.name}\n                        </button>\n                        <button onclick=\"removeFavoriteLocation(${index})\" class=\"text-red-400 hover:text-red-300 text-xs\">\n                            <i data-lucide=\"x\" class=\"w-3 h-3\"></i>\n                        </button>\n                    </div>\n                `).join('') + `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-2 text-xs border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-3 h-3\"></i>\n                        追加\n                    </button>\n                `;\n            }\n            lucide.createIcons();\n        }\n\n        function loadFavoriteLocation(index) {\n            const loc = favoriteLocations[index];\n            updateAppLocation(loc.lat, loc.lon);\n        }\n\n        function removeFavoriteLocation(index) {\n            favoriteLocations.splice(index, 1);\n            localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n            renderFavoriteLocations();\n        }\n\n        // --- 星空視認性スコア計算 ---\n        function calculateStarryScore(cloudCover, moonAge, humidity, visibility = 24, windSpeed = 5) {\n            // 雲量スコア (0-100) - 雲が少ないほど高い\n            const cloudScore = Math.max(0, 100 - cloudCover);\n\n            // 月明かりスコア (0-100) - 新月に近いほど高い\n            const moonScore = moonAge < 3 || moonAge > 26 ? 100 :\n                             moonAge < 10 || moonAge > 18 ? 60 : 20;\n\n            // 湿度スコア (0-100) - 湿度が低いほど高い\n            const humidityScore = Math.max(0, 100 - humidity);\n\n            // 視程スコア (0-100)\n            const visibilityScore = Math.min(100, (visibility / 50) * 100);\n\n            // 風速スコア (0-100) - 風が弱いほど高い\n            const windScore = windSpeed < 2 ? 100 : windSpeed < 5 ? 80 : windSpeed < 10 ? 50 : 20;\n\n            // 加重平均 (雲量と月明かりを重視)\n            const totalScore = (cloudScore * 0.4 + moonScore * 0.3 + humidityScore * 0.15 + visibilityScore * 0.1 + windScore * 0.05);\n\n            return Math.round(totalScore);\n        }\n\n        function updateStarryScore(score) {\n            const circle = document.getElementById('score-circle');\n            const text = document.getElementById('score-text');\n            const comment = document.getElementById('score-comment');\n\n            // スコアに応じた円の進行度 (0-100を0-440に変換)\n            const dashOffset = 440 - (score / 100) * 440;\n            circle.style.strokeDashoffset = dashOffset;\n\n            text.textContent = score;\n\n            // コメント\n            if (score >= 80) {\n                comment.textContent = '⭐ 絶好の観測日和！星空が最高に美しく見えるでしょう';\n            } else if (score >= 60) {\n                comment.textContent = '✨ 観測に適した条件です 。良い星空が期待できます';\n            } else if (score >= 40) {\n                comment.textContent = '\uD83C\uDF24\uFE0F まずまずの条件。明るい星は観測でき ます';\n            } else if (score >= 20) {\n                comment.textContent = '☁\uFE0F やや条件が悪いです。観測には忍耐が必要かも';\n            } else {\n                comment.textContent = '❌ 観測には不向きな条件です';\n            }\n        }\n\n        // 時計更新\n        setInterval(() => {\n            document.getElementById('current-clock').textContent = moment().format('HH:mm:ss');\n        }, 1000);\n\n        // --- アプリケーション起動フロー ---\n        window.addEventListener('load', () => {\n            // お気に入り地点を表示\n            renderFavoriteLocations();\n            // 現在地取得を試みる\n            getCurrentLocation(true); // true = 初回起動時の自動取得\n        });\n\n        // --- 位置情報関連 ---\n\n        // ブラウザの現在地取得\n        function getCurrentLocation(isInitial = false) {\n            if (!navigator.geolocation) {\n                if(!isInitial) alert(\"このブラウザは位置情報をサポートしていません。\");\n                initializeDashboardWithCurrentCoords(); //  デフォルトで起動\n                return;\n            }\n\n            // ロー ド表示\n            document.getElementById('loading').innerHTML = '現在地を取得中...';\n            document.getElementById('loading').classList.remove('hidden');\n\n            navigator.geolocation.getCurrentPosition(\n                (position) => {\n                    currentLat = position.coords.latitude;\n                    currentLon = position.coords.longitude;\n                    updateAppLocation(currentLat, currentLon);\n                },\n                (error) => {\n                    console.warn(\"位置情報取得失敗:\", error.message);\n                    if(!isInitial) alert(\"位置情報を取得できませんでした。\");\n                    // 失敗した場合はデフォルト位置（三島）で開始\n                    initializeDashboardWithCurrentCoords(); \n                }\n            );\n        }\n\n        // 座標を指定してアプリ全体を更新するメイン関数\n        async function updateAppLocation(lat, lon) {\n            currentLat = lat;\n            currentLon = lon;\n\n            // 1. UIの座標表示更新\n            document.getElementById('coords-display').innerText = `緯度: ${lat.toFixed(4)} | 経度: ${lon.toFixed(4)}`;\n\n            // 2. 住所取得 (逆ジオコーディング)\n            fetchAddress(lat, lon);\n\n            // 3. 地図マーカー更新（地図が開いている、または初期化されている場合）\n            if (mapInstance) {\n                updateMapMarker(lat, lon);\n            }\n\n            // 4. 天 気データ取得\n            await fetchWeather(lat, lon);\n        }\n\n        // 住所取得 (OpenStreetMap Nominatim API)\n        async function fetchAddress(lat, lon) {\n            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=ja`;\n            \n            try {\n                const response = await fetch(url, {\n                    headers: { 'User-Agent': 'WeatherDashboardDemo/1.0' } // マナーとしてUser-Agentを設定\n                });\n                const data = await response.json();\n                \n                if (data && data.address) {\n                    const addr = data.address;\n                    // 見やすい住所を構築（県 + 市町村 + 町名）\n                    const pref = addr.province || addr.state || '';\n                    const city = addr.city || addr.ward || addr.town || addr.village || '';\n                    const sub = addr.suburb || addr.quarter || addr.neighbourhood || '';\n                    \n                    const fullName = `${pref} ${city} ${sub}`.trim() || \"不明な場 所\";\n                    document.getElementById('location-name').innerText = fullName;\n                } else {\n                    document.getElementById('location-name').innerText = \"住所不明\";\n                }\n            } catch (error) {\n                console.error(\"住所取得エラー:\", error);\n                document.getElementById('location-name').innerText = \"住所取得失敗\";\n            }\n        }\n\n        // デフォルト/現在の座標で初期化\n        function initializeDashboardWithCurrentCoords() {\n            updateAppLocation(currentLat, currentLon);\n        }\n\n        // --- 地図機能 ---\n\n        function toggleMap() {\n            const container = document.getElementById('location-settings');\n            const isHidden = container.classList.contains('hidden');\n            \n            if (isHidden) {\n                container.classList.remove('hidden');\n                // 地図が初めて表示されるときに初期化\n                if (!mapInstance) {\n                    initMap();\n                } else {\n                    // サイズ再計算（hiddenから復帰時に必要）\n                    setTimeout(() => mapInstance.invalidateSize(), 100);\n                }\n            } else {\n                container.classList.add('hidden');\n            }\n        }\n\n        function initMap() {\n            // 地図初期化\n            mapInstance = L.map('map').setView([currentLat, currentLon], 13);\n\n            // OpenStreetMapタイル\n            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n            }).addTo(mapInstance);\n\n            // マーカー追加\n            markerInstance = L.marker([currentLat, currentLon], {draggable: false}).addTo(mapInstance);\n\n            // マップクリックイベント\n            mapInstance.on('click', function(e) {\n                const lat = e.latlng.lat;\n                const lon = e.latlng.lng;\n                updateAppLocation(lat, lon);\n            });\n        }\n\n        function updateMapMarker(lat, lon) {\n            if (markerInstance) {\n                markerInstance.setLatLng([lat, lon]);\n            }\n            mapInstance.panTo([lat, lon]);\n        }\n\n        // --- ヘルパー関数 ---\n        function getWindDirection(degrees) {\n            const directions = ['北', '北北東', '北東', '東北東', '東', '東南東', '南東', '南南東', '南', '南南西', '南西', '西南西', '西', '西北西', '北西', '北北西'];\n            const index = Math.round(degrees / 22.5) % 16;\n            return directions[index];\n        }\n\n        // --- レーダーチャート描画 ---\n        function renderRadarChart(data) {\n            const ctx = document.getElementById('radarChart').getContext('2d');\n            if (radarChartInstance) radarChartInstance.destroy();\n\n            radarChartInstance = new Chart(ctx, {\n                type: 'radar',\n                data: {\n                    labels: ['雲の少なさ', '月の暗さ', '低湿度', '高視程', '風の穏やかさ'],\n                    datasets: [{\n                        label: '観測適性',\n                        data: [data.cloudClearness, data.moonDarkness, data.lowHumidity, data.goodVisibility, data.calmWind],\n                        backgroundColor: 'rgba(34, 197, 94, 0.2)',\n                        borderColor: 'rgba(34, 197, 94, 1)',\n                        borderWidth: 2,\n                        pointBackgroundColor: 'rgba(34, 197, 94, 1)',\n                        pointBorderColor: '#fff',\n                        pointHoverBackgroundColor: '#fff',\n                        pointHoverBorderColor: 'rgba(34, 197, 94, 1)'\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    scales: {\n                        r: {\n                            beginAtZero: true,\n                            max: 100,\n                            ticks: {\n                                stepSize: 20,\n                                color: '#94a3b8'\n                            },\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)'\n                            },\n                            pointLabels: {\n                                color: '#cbd5e1',\n                                font: {\n                                    size: 12\n                                }\n                            }\n                        }\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        }\n                    }\n                }\n            });\n        }\n\n        // --- 流星群データ (年間イベント) ---\n        const meteorShowers = [\n            { name: \"しぶんぎ座流星群\", peakStart: \"01-03\", peakEnd: \"01-04\", rate: \"120個/時\", note: \"年始の三大流星群\" },\n            { name: \"こと座流 星群\", peakStart: \"04-22\", peakEnd: \"04-23\", rate: \"18個/時\", note: \"安 定した流星群\" },\n            { name: \"みずがめ座η流星群\", peakStart: \"05-06\", peakEnd: \"05-07\", rate: \"50個/時\", note: \"南半球で好条件\" },\n            { name: \"ペルセウス座流星群\", peakStart: \"08-12\", peakEnd: \"08-13\", rate: \"100個/時\", note: \"三大流星群の一つ\" },\n            { name: \"オリオン 座流星群\", peakStart: \"10-21\", peakEnd: \"10-22\", rate: \"20個/時\", note: \"ハレー彗星起源\" },\n            { name: \"しし座流星群\", peakStart: \"11-17\", peakEnd: \"11-18\", rate: \"15個/時\", note: \"33年周期で大出現\" },\n            { name: \"ふたご座流星群\", peakStart: \"12-13\", peakEnd: \"12-14\", rate: \"120個/時\", note: \"三大流星群の一つ\" },\n            { name: \"こぐま座流星 群\", peakStart: \"12-22\", peakEnd: \"12-23\", rate: \"10個/時\", note: \"安定 した観測\" }\n        ];\n\n        // --- 月齢計算ロジック ---\n        function calculateMoonData(date) {\n            // 2000年1月6日 18:14 (UTC) は新月 (Lunation Number 953)\n            // 簡易計算のため、UTCでの日付差分を利用\n            const knownNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0)); \n            const diffTime = date.getTime() - knownNewMoon.getTime();\n            const diffDays = diffTime / (1000 * 60 * 60 * 24);\n            const synodicMonth = 29.53058867;\n            \n            let age = diffDays % synodicMonth;\n            if (age < 0) age += synodicMonth;\n            \n            // 月相の判 定\n            let phaseName = \"\";\n            let icon = \"\";\n            \n            // 絵文字と名前のマッピング (簡易版)\n            if (age < 1.0 || age > 28.5) { phaseName = \"新月\"; icon = \"\uD83C\uDF11\"; }\n            else if (age < 6.0) { phaseName = \"三日月\"; icon = \"\uD83C\uDF12\"; }\n            else if (age < 9.0) { phaseName = \"上弦の月\"; icon = \"\uD83C\uDF13\"; }\n            else if (age < 13.5) { phaseName = \"十日夜\"; icon = \"\uD83C\uDF14\"; }\n            else if (age < 16.5) { phaseName = \"満月\"; icon = \"\uD83C\uDF15\"; }\n            else if (age < 21.0) { phaseName = \"立待月\"; icon = \"\uD83C\uDF16\"; }\n            else if (age < 24.0) { phaseName = \"下弦の月\"; icon = \"\uD83C\uDF17\"; }\n            else { phaseName = \"有明月\"; icon = \"\uD83C\uDF18\"; }\n\n            return {\n                age: age.toFixed(1),\n                phaseName: phaseName,\n                icon: icon\n            };\n        }\n\n        // --- 日の出入り・月の出入り・天文薄明計算 ---\n        function calculateSunMoonTimes(date, lat, lon) {\n            try {\n                const observer = new Astronomy.Observer(lat, lon, 0);\n\n                // 日の出・日の入り\n                const sunrise = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, 1, date, 1);\n                const sunset = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, date, 1);\n\n                // 天文薄明 (-18度)\n                const astroTwilightMorning = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, -1, date, 1, -18);\n                const astroTwilightEvening = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, 1, date, 1, -18);\n\n                // 月の出・月の入り\n                const moonrise = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, 1, date, 1);\n                const moonset = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, date, 1);\n\n                return {\n                    sunrise: sunrise ? moment(sunrise.date).format('HH:mm') : '--:--',\n                    sunset: sunset ? moment(sunset.date).format('HH:mm') : '--:--',\n                    astroTwilightBegin: astroTwilightMorning ? moment(astroTwilightMorning.date).format('HH:mm') : '--:--',\n                    astroTwilightEnd: astroTwilightEvening ? moment(astroTwilightEvening.date).format('HH:mm') : '--:--',\n                    moonrise: moonrise ? moment(moonrise.date).format('HH:mm') : '--:--',\n                    moonset: moonset ? moment(moonset.date).format('HH:mm') : '--:--',\n                    sunriseDate: sunrise ? sunrise.date : null,\n                    sunsetDate: sunset ? sunset.date : null,\n                    astroBeginDate: astroTwilightMorning ? astroTwilightMorning.date : null,\n                    astroEndDate: astroTwilightEvening ? astroTwilightEvening.date : null\n                };\n            } catch (error) {\n                console.error('日月時刻計算エラー:', error);\n                return {\n                    sunrise: '--:--',\n                    sunset: '--:--',\n                    astroTwilightBegin: '--:--',\n                    astroTwilightEnd: '--:--',\n                    moonrise: '--:--',\n                    moonset: '--:--'\n                };\n            }\n        }\n\n        function updateSunMoonDisplay(times) {\n            document.getElementById('sunrise-time').innerText = times.sunrise;\n            document.getElementById('sunset-time').innerText = times.sunset;\n            document.getElementById('twilight-astro-begin').innerText = times.astroTwilightBegin;\n            document.getElementById('twilight-astro-end').innerText = times.astroTwilightEnd;\n            document.getElementById('moonrise-time').innerText = times.moonrise;\n            document.getElementById('moonset-time').innerText = times.moonset;\n        }\n\n        // --- 24時間タイムライン描画 ---\n        function renderTimeline(times, targetDate) {\n            const container = document.getElementById('timeline-container');\n            container.innerHTML = '';\n\n            const dayStart = moment(targetDate).startOf('day');\n            const dayEnd = moment(targetDate).endOf('day');\n\n            // セグメントを追加\n            const segments = [];\n\n            // 日中（日の出～日の入り）\n            if (times.sunriseDate && times.sunsetDate) {\n                const sunriseTime = moment(times.sunriseDate);\n                const sunsetTime = moment(times.sunsetDate);\n\n                const start = ((sunriseTime - dayStart) / (dayEnd - dayStart)) * 100;\n                const width = ((sunsetTime - sunriseTime) / (dayEnd - dayStart)) * 100;\n\n                segments.push({ start, width, color: '#eab308', label: '日中' });\n            }\n\n            // 天文薄明\n            if (times.astroBeginDate && times.astroEndDate) {\n                const astroBegin = moment(times.astroBeginDate);\n                const astroEnd = moment(times.astroEndDate);\n\n                // 朝の薄明\n                const morningStart = ((astroBegin - dayStart) / (dayEnd - dayStart)) * 100;\n                const morningWidth = ((moment(times.sunriseDate) - astroBegin) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: morningStart, width: morningWidth, color: '#3b82f6', label: '朝薄明' });\n\n                // 夕方の薄明\n                const eveningStart = ((moment(times.sunsetDate) - dayStart) / (dayEnd - dayStart)) * 100;\n                const eveningWidth = ((astroEnd - moment(times.sunsetDate)) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: eveningStart, width: eveningWidth, color: '#3b82f6', label: '夕薄明' });\n\n                //  観測適時（天文薄明終了後～天文薄明開始前）\n                const observeStart = ((astroEnd - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeEnd = ((astroBegin.clone().add(1, 'day') - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeWidth = observeEnd - observeStart;\n                if (observeWidth > 0) {\n                    segments.push({ start: observeStart, width: observeWidth, color: '#22c55e', label: '観測適時' });\n                }\n            }\n\n            // セグメントを描画\n            segments.forEach(seg => {\n                const div = document.createElement('div');\n                div.className = 'timeline-segment';\n                div.style.left = `${seg.start}%`;\n                div.style.width = `${seg.width}%`;\n                div.style.background = seg.color;\n                div.title = seg.label;\n                container.appendChild(div);\n            });\n        }\n\n        // --- 天体イベント関数 ---\n\n        // 1. 今夜見える惑星を計算\n        function calculateVisiblePlanets(observerDate, observerLat, observerLon) {\n            try {\n                const observer = new Astronomy.Observer(observerLat, observerLon, 0);\n                const planets = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];\n                const planetNames = {\n                    'Mercury': '水星',\n                    'Venus': '金星',\n                    'Mars': '火星',\n                    'Jupiter': '木星',\n                    'Saturn': '土星'\n                };\n                const planetIcons = {\n                    'Mercury': '⚫',\n                    'Venus': '\uD83C\uDF1F',\n                    'Mars': '\uD83D\uDD34',\n                    'Jupiter': '\uD83D\uDFE0',\n                    'Saturn': '\uD83E\uDE90'\n                };\n\n                let visiblePlanets = [];\n\n                planets.forEach(planet => {\n                    const equator = Astronomy.Equator(planet, observerDate, observer, true, true);\n                    const horizon = Astronomy.Horizon(observerDate, observer, equator.ra, equator.dec, 'normal');\n                    const illumination = Astronomy.Illumination(planet, observerDate);\n\n                    // 地平線より上（高度 > 0）で、ある程度明るい天体のみ表示\n                    if (horizon.altitude > 0) {\n                        visiblePlanets.push({\n                            name: planetNames[planet],\n                            icon: planetIcons[planet],\n                            altitude: horizon.altitude.toFixed(1),\n                            azimuth: horizon.azimuth.toFixed(1),\n                            magnitude: illumination.mag.toFixed(1)\n                        });\n                    }\n                });\n\n                // HTMLに表示\n                const container = document.getElementById('visible-planets');\n                if (visiblePlanets.length === 0) {\n                    container.innerHTML = '<div class=\"text-slate-400\">現在、地平線上に惑星はありません</div>';\n                } else {\n                    container.innerHTML = visiblePlanets.map(p => `\n                        <div class=\"flex items-center justify-between bg-slate-700/30 rounded-lg p-2\">\n                            <div class=\"flex items-center gap-2\">\n                                <span class=\"text-lg\">${p.icon}</span>\n                                <span class=\"font-semibold\">${p.name}</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400\">\n                                高度: ${p.altitude}° | 方位: ${p.azimuth}° | 等級: ${p.magnitude}\n                            </div>\n                        </div>\n                    `).join('');\n                }\n            } catch (error) {\n                console.error('惑星計算エラー:', error);\n                document.getElementById('visible-planets').innerHTML = '<div class=\"text-red-400\">計算エラー</div>';\n            }\n        }\n\n        // 2. 流星群カレンダーを更新\n        function updateMeteorShowers(targetDate) {\n            const currentYear = targetDate.getFullYear();\n            const currentMonth = String(targetDate.getMonth() + 1).padStart(2, '0');\n            const currentDay = String(targetDate.getDate()).padStart(2, '0');\n            const currentDateStr = `${currentMonth}-${currentDay}`;\n\n            // 前後30日以内 の流星群をフィルタ\n            const relevantShowers = meteorShowers.filter(shower => {\n                const showerDate = new Date(`${currentYear}-${shower.peakStart}`);\n                const targetDateTime = targetDate.getTime();\n                const diffDays = Math.abs((showerDate - targetDateTime) / (1000 * 60 * 60 * 24));\n                return diffDays <= 30;\n            });\n\n            const container = document.getElementById('meteor-showers');\n            if (relevantShowers.length === 0) {\n                container.innerHTML = '<div class=\"text-slate-400\">今後30日以内に極大を迎える流星群はありません</div>';\n            } else {\n                container.innerHTML = relevantShowers.map(shower => {\n                    const isPeak = currentDateStr === shower.peakStart || currentDateStr === shower.peakEnd;\n                    const showerDateStr = shower.peakStart.replace('-', '/');\n                    return `\n                        <div class=\"bg-slate-700/30 rounded-lg p-2 ${isPeak ? 'border-l-2 border-yellow-400' : ''}\">\n                            <div class=\"flex items-center justify-between\">\n                                <span class=\"font-semibold ${isPeak ? 'text-yellow-300' : ''}\">${shower.name}</span>\n                                <span class=\"text-xs text-slate-400\">${showerDateStr}  極大</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400 mt-1\">\n                                ${shower.rate} | ${shower.note}\n                            </div>\n                            ${isPeak ? '<div class=\"text-xs text-yellow-300 mt-1\">\uD83C\uDF1F 本日が極大日です！</div>' : ''}\n                        </div>\n                    `;\n                }).join('');\n            }\n        }\n\n        // 3. 月齢による観測推奨天体\n        function updateRecommendedObjects(moonAge) {\n            const age = parseFloat(moonAge);\n            const container = document.getElementById('recommended-objects');\n\n            let recommendations = [];\n\n            if (age < 3 || age > 26) {\n                // 新月期: 暗い天体に最適\n                recommendations = [\n                    { name: 'アンドロメダ銀河 (M31)', type: '銀河', reason: '暗い夜空で見やすい' },\n                    { name: 'オリオン大星雲 (M42)', type: '星雲', reason: '新月期が最適' },\n                    { name: 'プレアデス星団 (M45)', type: '星団', reason: '暗い空で美しい' }\n                ];\n            } else if (age >= 3 && age < 10) {\n                // 上弦前後: 月面観測に適する\n                recommendations = [\n                    { name: '月面クレーター', type: '月', reason: '影が長く見やすい' },\n                    { name: '明るい惑星', type: '惑星', reason: '月明かりの影響少ない' },\n                    { name: '二重星（アルビレオ）', type: '恒星', reason: '明るい星なら観測可' }\n                ];\n            } else if (age >= 10 && age < 18) {\n                // 満月期: 月面観測メイン\n                recommendations = [\n                    { name: '満月の地形観測', type: '月', reason: '全体像を観測' },\n                    { name: '明るい星雲 (M42)', type: '星雲', reason: '明るい天体のみ' },\n                    { name: ' 惑星の衛星', type: '惑星', reason: '木星の衛星など' }\n                ];\n            } else {\n                // 下弦前後: 朝方の観測\n                recommendations = [\n                    { name: '月面南部クレーター', type: '月', reason: '下弦は南部が見やすい' },\n                    { name: '明け方の惑星', type: '惑星', reason: '水星・金星が好条件' },\n                    { name: '球状星団 (M13)', type: '星団', reason: '明け方なら観測可' }\n                ];\n            }\n\n            container.innerHTML = recommendations.map(rec => `\n                <div class=\"bg-slate-700/30 rounded-lg p-2\">\n                    <div class=\"flex items-center justify-between\">\n                        <span class=\"font-semibold\">${rec.name}</span>\n                        <span class=\"text-xs bg-green-600/30 text-green-300 px-2 py-0.5 rounded\">${rec.type}</span>\n                    </div>\n                    <div class=\"text-xs text-slate-400 mt-1\">${rec.reason}</div>\n                </div>\n            `).join('');\n        }\n\n        // --- 天気データ取得 & 描画 ---\n\n        async function fetchWeather(lat, lon) {\n            // API URL (追加気象データを含む)\n            const API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,cloud_cover,cloud_cover_low,cloud_cover_mid,cloud_cover_high,windspeed_10m,winddirection_10m,surface_pressure,dewpoint_2m,visibility&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset&timezone=Asia%2FTokyo&past_days=2&forecast_days=10`;\n\n            try {\n                const response = await fetch(API_URL);\n                weatherData = await response.json();\n                \n                // 初回は現在時刻で描画\n                // もしユーザーが過去の日付を選択中の場合はそのまま維持しても良いが、\n                // 場所を変えたら「現在」に戻る方が自然なため、現在時刻にリ セットする\n                const now = moment();\n                setDatePickerValue(now);\n                renderDashboard(now);\n            } catch (error) {\n                document.getElementById('loading').innerHTML = `<span class=\"text-red-400\">データ取得エラー: ${error.message}</span>`;\n                console.error(error);\n            }\n        }\n\n        // --- UIレンダリング ( 既存のロジック) ---\n\n        function setDatePickerValue(momentObj) {\n            const formatted = momentObj.format('YYYY-MM-DDTHH:mm');\n            document.getElementById('target-datetime').value = formatted;\n        }\n\n        function updateDashboardTime() {\n            const val = document.getElementById('target-datetime').value;\n            if (val && weatherData) {\n                renderDashboard(moment(val));\n            }\n        }\n\n        function resetToNow() {\n            const now = moment();\n            setDatePickerValue(now);\n            if (weatherData) {\n                renderDashboard(now);\n            }\n        }\n\n        // 新しい関数: 週間予報の日付クリック時の処理\n        function selectDate(dateStr) {\n            // 現在の入力値（時間）を取得して、日付だけ差し替える\n            const currentVal = document.getElementById('target-datetime').value;\n            let targetMoment = moment(dateStr); \n            \n            if (currentVal) {\n                const currentMoment = moment(currentVal);\n                // 時間と分を維持\n                targetMoment.hour(currentMoment.hour());\n                targetMoment.minute(currentMoment.minute());\n            } else {\n                // デフォルトは正午などにするか、現在時刻に合わせる\n                const now = moment();\n                targetMoment.hour(now.hour());\n                targetMoment.minute(now.minute());\n            }\n\n            setDatePickerValue(targetMoment);\n            renderDashboard(targetMoment);\n            \n            // スクロールを上部へ（スマホなどで見やすくするため）\n            document.getElementById('dashboard-content').scrollIntoView({ behavior: 'smooth' });\n        }\n\n        function getWeatherInfo(code) {\n            if (code === 0) return { label: '快晴', icon: 'sun', color: 'text-orange-400' };\n            if (code >= 1 && code <= 3) return { label: '曇り・晴れ間', icon: 'cloud-sun', color: 'text-gray-300' };\n            if (code >= 45 && code <= 48) return { label: '霧', icon: 'align-justify', color: 'text-gray-400' };\n            if (code >= 51 && code <= 55) return { label: '霧雨', icon: 'cloud-drizzle', color: 'text-blue-300' };\n            if (code >= 61 && code <= 67) return { label: '雨', icon: 'cloud-rain', color: 'text-blue-400' };\n            if (code >= 71 && code <= 77) return { label: '雪', icon: 'snowflake', color: 'text-white' };\n            if (code >= 80 && code <= 82) return { label: 'にわか雨', icon: 'cloud-hail', color: 'text-blue-300' };\n            if (code >= 95 && code <= 99) return { label: '雷雨', icon: 'cloud-lightning', color: 'text-yellow-400' };\n            return { label: '不明', icon: 'help-circle', color: 'text-gray-500' };\n        }\n\n        function renderDashboard(targetMoment) {\n            if (!weatherData) return;\n\n            const hourly = weatherData.hourly;\n            const daily = weatherData.daily;\n            const targetDate = targetMoment.toDate();\n            \n            let currentIndex = 0;\n            let minDiff = Infinity;\n            let isOutOfRange = true;\n\n            hourly.time.forEach((t, i) => {\n                const diff = Math.abs(new Date(t) - targetDate);\n                if (diff < minDiff) {\n                    minDiff = diff;\n                    currentIndex = i;\n                }\n                if (diff < 90 * 60 * 1000) { \n                    isOutOfRange = false;\n                }\n            });\n\n            if (isOutOfRange && minDiff > 24 * 60 * 60 * 1000) {\n                 document.getElementById('forecast-summary').innerText = \"選択された日時の詳細データがありません（範囲外です）\";\n                 return;\n            }\n\n            // 現在のステータス更新\n            const currentTemp = hourly.temperature_2m[currentIndex];\n            const currentCloudTotal = hourly.cloud_cover[currentIndex];\n            const currentLow = hourly.cloud_cover_low[currentIndex];\n            const currentMid = hourly.cloud_cover_mid[currentIndex];\n            const currentHigh = hourly.cloud_cover_high[currentIndex];\n\n            document.getElementById('current-temp').innerText = `${currentTemp}°C`;\n            document.getElementById('current-clouds').innerText = `${currentCloudTotal}%`;\n            \n            document.getElementById('clouds-high').innerText = `${currentHigh}%`;\n            document.getElementById('bar-high').style.width = `${currentHigh}%`;\n            \n            document.getElementById('clouds-mid').innerText = `${currentMid}%`;\n            document.getElementById('bar-mid').style.width = `${currentMid}%`;\n            \n            document.getElementById('clouds-low').innerText = `${currentLow}%`;\n            document.getElementById('bar-low').style.width = `${currentLow}%`;\n\n            // 月齢情報の更新 (サマリーエリア)\n            const moonData = calculateMoonData(targetDate);\n            document.getElementById('current-moon-icon').innerText = moonData.icon;\n            document.getElementById('current-moon-age-text').innerText = moonData.age;\n            document.getElementById('current-moon-name').innerText = moonData.phaseName;\n\n            // 天体イベント情報を更新\n            calculateVisiblePlanets(targetDate, currentLat, currentLon);\n            updateMeteorShowers(targetDate);\n            updateRecommendedObjects(moonData.age);\n\n            // 追加気象データの表示\n            const currentWindSpeed = hourly.windspeed_10m ? hourly.windspeed_10m[currentIndex] : 0;\n            const currentWindDir = hourly.winddirection_10m ? hourly.winddirection_10m[currentIndex] : 0;\n            const currentPressure = hourly.surface_pressure ? hourly.surface_pressure[currentIndex] : 1013;\n            const currentDewpoint = hourly.dewpoint_2m ? hourly.dewpoint_2m[currentIndex] : 0;\n            const currentVisibility = hourly.visibility ? (hourly.visibility[currentIndex] / 1000).toFixed(1) : 24;\n            const currentHumidity = hourly.relative_humidity_2m[currentIndex];\n\n            document.getElementById('wind-speed').innerText = `${currentWindSpeed.toFixed(1)} m/s`;\n            const windDirText = getWindDirection(currentWindDir);\n            document.getElementById('wind-direction').innerText = windDirText;\n            document.getElementById('pressure').innerText = `${currentPressure.toFixed(0)} hPa`;\n            document.getElementById('dewpoint').innerText = `${currentDewpoint.toFixed(1)}°C`;\n            document.getElementById('visibility').innerText = `${currentVisibility} km`;\n\n            // 結露リスク判定\n            const tempDiff = currentTemp - currentDewpoint;\n            let condensationRisk = '';\n            if (tempDiff < 2) condensationRisk = '⚠\uFE0F 結露リスク高';\n            else if (tempDiff < 5) condensationRisk = '⚡ 結露注意';\n            else condensationRisk = '✅ 結露リス ク低';\n            document.getElementById('condensation-risk').innerText = condensationRisk;\n\n            // 日月出没・天文薄明の計算と表示\n            const sunMoonTimes = calculateSunMoonTimes(targetDate, currentLat, currentLon);\n            updateSunMoonDisplay(sunMoonTimes);\n            renderTimeline(sunMoonTimes, targetDate);\n\n            // 星空視認性スコアの計算\n            const starryScore = calculateStarryScore(currentCloudTotal, moonData.age, currentHumidity, parseFloat(currentVisibility), currentWindSpeed);\n            updateStarryScore(starryScore);\n\n            // レーダーチャートのデータ準備\n            const radarData = {\n                cloudClearness: Math.max(0, 100 - currentCloudTotal),\n                moonDarkness: moonData.age < 3 || moonData.age > 26 ? 100 : moonData.age < 10 || moonData.age > 18 ? 60 : 20,\n                lowHumidity: Math.max(0, 100 - currentHumidity),\n                goodVisibility: Math.min(100, (parseFloat(currentVisibility) / 50) * 100),\n                calmWind: currentWindSpeed < 2 ? 100 : currentWindSpeed < 5 ? 80 : currentWindSpeed < 10 ? 50 : 20\n            };\n            renderRadarChart(radarData);\n\n\n            // サマリーテキスト\n            const displayTimeStr = targetMoment.format('M月D日 H:mm');\n            document.getElementById('summary-timestamp').innerText = `表示データ時刻: ${displayTimeStr}`;\n\n            let summary = `気 温 ${currentTemp}°C。`;\n            if(currentCloudTotal < 20) summary += \" 快晴または晴れ。\";\n            else if(currentCloudTotal < 60) summary += \" 雲 間あり。\";\n            else summary += \" 曇り空。\";\n            \n            if (currentIndex + 6 < hourly.temperature_2m.length) {\n                const futureTemp = hourly.temperature_2m[currentIndex + 6];\n                const tempDiff = futureTemp - currentTemp;\n                if(tempDiff > 2) summary += \" その後、気温は上昇傾向です。\";\n                else if(tempDiff < -2) summary += \" その後、冷え込む見込みです。\";\n            }\n\n            // --- 天体観測サマリー追加 ---\n            // 選択された日時の「夜間（20:00 - 翌04:00）」のデータを取得\n            let astroStart = targetMoment.clone().startOf('day').add(20, 'hours');\n            // 修正: 深夜でも「その日の20時〜」を対象にす るため、深夜補正ロジックを削除\n            \n            const astroEnd = astroStart.clone().add(8, 'hours'); // 20:00 -> 04:00 (8時間)\n            \n            let astroCloudSum = 0;\n            let astroCount = 0;\n            \n            hourly.time.forEach((t, i) => {\n                const time = moment(t);\n                if (time.isSameOrAfter(astroStart) && time.isBefore(astroEnd)) {\n                    astroCloudSum += hourly.cloud_cover[i];\n                    astroCount++;\n                }\n            });\n\n            if (astroCount > 0) {\n                const avgAstroCloud = astroCloudSum / astroCount;\n                summary += \"<br><br><strong>\uD83D\uDD2D 天体観測予報:</strong> \";\n                const dateStr = astroStart.format('M/D');\n                \n                // 月の影響を加味したコメント\n                let moonComment = \"\";\n                if (moonData.age > 10 && moonData.age < 18) {\n                    moonComment = \"ただし、月明かりの影響が大きいでしょう。\";\n                }\n\n                if (avgAstroCloud < 15) {\n                    summary += `${dateStr}の夜は、雲が少なく<strong>絶好の天体観測日和</strong>です。${moonComment}`;\n                } else if (avgAstroCloud < 40) {\n                    summary += `${dateStr}の夜は、雲は少なめで<strong>観測に適しています</strong>。${moonComment}`;\n                } else if (avgAstroCloud < 75) {\n                    summary += `${dateStr}の夜は、雲が出るため観測には<strong>忍耐が必要</strong>かもしれません。`;\n                } else {\n                    summary += `${dateStr}の夜は、雲が多く<strong>観測には不向き</strong>な予報です。`;\n                }\n            }\n            \n            // innerText -> innerHTML (タグを有効化するため)\n            document.getElementById('forecast-summary').innerHTML = summary;\n\n            // チャート描画 (24時間分に修正)\n            const sliceStart = currentIndex;\n            const sliceEnd = Math.min(currentIndex + 24, hourly.time.length);\n            \n            const labels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('D日 H時'));\n            const fullDateLabels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('M月D日 H:mm'));\n            \n            const temps = hourly.temperature_2m.slice(sliceStart, sliceEnd);\n            const cloudLow = hourly.cloud_cover_low.slice(sliceStart, sliceEnd);\n            const cloudMid = hourly.cloud_cover_mid.slice(sliceStart, sliceEnd);\n            const cloudHigh = hourly.cloud_cover_high.slice(sliceStart, sliceEnd);\n\n            // 気温チャート\n            const ctxTemp = document.getElementById('tempChart').getContext('2d');\n            if(tempChartInstance) tempChartInstance.destroy();\n\n            let gradientTemp = ctxTemp.createLinearGradient(0, 0, 0, 400);\n            gradientTemp.addColorStop(0, 'rgba(251, 146, 60, 0.5)'); \n            gradientTemp.addColorStop(1, 'rgba(251, 146, 60, 0.0)');\n\n            tempChartInstance = new Chart(ctxTemp, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: '気温 (°C)',\n                        data: temps,\n                        borderColor: '#fb923c',\n                        backgroundColor: gradientTemp,\n                        borderWidth: 3,\n                        pointBackgroundColor: '#fff',\n                        tension: 0.4,\n                        fill: true\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { display: false },\n                        tooltip: { callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] } }\n                    },\n                    scales: {\n                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 雲チャート (積み上げ順を修正: Low -> Mid -> High)\n            // 配色: 下層=Gray-300(変更), 中層=Emerald, 上層=Violet\n            const ctxCloud = document.getElementById('cloudChart').getContext('2d');\n            if(cloudChartInstance) cloudChartInstance.destroy();\n\n            cloudChartInstance = new Chart(ctxCloud, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [\n                        { label: '下層雲', data: cloudLow, borderColor: '#d1d5db', backgroundColor: 'rgba(209, 213, 219, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },\n                        { label: '中層雲', data: cloudMid, borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },\n                        { label: ' 上層雲', data: cloudHigh, borderColor: '#a78bfa', backgroundColor: 'rgba(167, 139, 250, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 }\n                    ]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { labels: { color: '#cbd5e1' } },\n                        tooltip: {\n                            mode: 'index',\n                            intersect: false,\n                             callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] }\n                        }\n                    },\n                    scales: {\n                        y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 週 間予報テーブル\n            const weeklyBody = document.getElementById('weekly-forecast-body');\n            weeklyBody.innerHTML = '';\n            \n            daily.time.forEach((t, i) => {\n                const date = moment(t);\n                const isSelectedDay = date.isSame(targetMoment, 'day');\n                const weatherInfo = getWeatherInfo(daily.weathercode[i]);\n                const maxTemp = daily.temperature_2m_max[i];\n                const minTemp = daily.temperature_2m_min[i];\n                const rainSum = daily.precipitation_sum[i];\n                const rainProb = daily.precipitation_probability_max[i];\n                \n                // 月齢計算\n                const moonInfo = calculateMoonData(date.toDate());\n\n                // 1時間ごとのデータから、この日の平均雲量と湿度を計算\n                const dateStr = t; // \"YYYY-MM-DD\"\n                let cloudSum = 0;\n                let humSum = 0;\n                let count = 0;\n                \n                // データ量が少ない ので単純ループで集計\n                hourly.time.forEach((hTime, hIndex) => {\n                    if (hTime.startsWith(dateStr)) {\n                        cloudSum += hourly.cloud_cover[hIndex];\n                        humSum += hourly.relative_humidity_2m[hIndex];\n                        count++;\n                    }\n                });\n                \n                const avgCloud = count > 0 ? Math.round(cloudSum / count) : '-';\n                const avgHum = count > 0 ? Math.round(humSum / count) : '-';\n\n                const row = document.createElement('tr');\n                // cursor-pointer を追加、onclickを 追加\n                row.className = `border-b border-slate-700/50 transition cursor-pointer ${isSelectedDay ? 'bg-blue-500/20 border-l-4 border-l-blue-400' : 'hover:bg-white/5'}`;\n                row.onclick = () => selectDate(t); // ク リックイベント\n\n                row.innerHTML = `\n                    <td class=\"py-4 px-2\">\n                        <div class=\"font-bold ${isSelectedDay ? 'text-blue-300' : 'text-white'}\">${date.format('M/D')}</div>\n                        <div class=\"text-xs text-slate-400\">${date.format('ddd')}</div>\n                    </td>\n                    <td class=\"py-4 px-2\">\n                        <div class=\"flex items-center gap-3\">\n                            <i data-lucide=\"${weatherInfo.icon}\" class=\"${weatherInfo.color} w-6 h-6\"></i>\n                            <span class=\"hidden md:inline text-sm\">${weatherInfo.label}</span>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm\">${rainProb !== null ? rainProb + '%' : '-'}</div>\n                        <div class=\"text-xs text-blue-300\">${rainSum > 0 ? rainSum + 'mm' : ''}</div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold\">${avgCloud !== '-' ? avgCloud + '%' : '-'}</div>\n                        <div class=\"w-16 bg-slate-700/50 rounded-full h-1 mx-auto mt-1\">\n                            <div class=\"bg-slate-400 h-1 rounded-full\" style=\"width: ${avgCloud !== '-' ? avgCloud : 0}%\"></div>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold text-blue-200 flex items-center justify-center gap-1\">\n                            <i data-lucide=\"droplet\" class=\"w-3 h-3\"></i>\n                            ${avgHum !== '-' ? avgHum + '%' : '-'}\n                        </div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-lg\" title=\"${moonInfo.phaseName} (月齢${moonInfo.age})\">${moonInfo.icon}</div>\n                        <div class=\"text-xs text-slate-400\">${moonInfo.age}</div>\n                    </td>\n                    <td class=\"py-4 px-2 text-right\">\n                        <span class=\"font-bold text-orange-400\">${maxTemp}°</span> \n                        <span class=\"text-slate-500 mx-1\">/</span> \n                        <span class=\"text-blue-300\">${minTemp}°</span>\n                    </td>\n                `;\n                weeklyBody.appendChild(row);\n            });\n            \n            lucide.createIcons();\n\n            document.getElementById('loading').classList.add('hidden');\n            document.getElementById('dashboard-content').classList.remove('hidden');\n        }\n    </script>\n</body>\n</html>\n
./.idea/shelf/リベース_前の未コミットの変更_[変更]1/shelved.patch:<+><!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>天体 観測できるかな？</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ja.js\"></script>\n    <!-- Lucide Icons -->\n    <script src=\"https://unpkg.com/lucide@latest\"></script>\n    <!-- Leaflet (Map) -->\n    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\" />\n    <script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\"></script>\n    <!-- Astronomy Engine for planetary calculations -->\n    <script src=\"https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js\"></script>\n    <style>\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');\n        body { font-family: 'Noto Sans JP', sans-serif; }\n        .glass-panel {\n            background: rgba(255, 255, 255, 0.1);\n            backdrop-filter: blur(10px);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n        }\n        /* Date picker custom styles for dark mode compatibility */\n        input[type=\"datetime-local\"] {\n            color-scheme: dark;\n        }\n        #map {\n            height: 300px;\n            width: 100%;\n            border-radius: 0.75rem;\n            z-index: 1;\n        }\n        /* Leaflet customization */\n        .leaflet-container {\n            background: #1e293b;\n        }\n        /* Night Vision Mode */\n        body.night-vision {\n            filter: hue-rotate(180deg) invert(1);\n            background: #300000 !important;\n        }\n        body.night-vision .glass-panel {\n            background: rgba(100, 0, 0, 0.3) !important;\n            border-color: rgba(200, 0, 0, 0.3) !important;\n        }\n        body.night-vision * {\n            color: #ff6666 !important;\n            border-color: #ff3333 !important;\n        }\n        /* Starry Score Meter */\n        .score-meter {\n            width: 200px;\n            height: 200px;\n            position: relative;\n        }\n        .score-circle {\n            stroke-dasharray: 440;\n            stroke-dashoffset: 440;\n            transition: stroke-dashoffset 1s ease;\n        }\n        /* Timeline styles */\n        .timeline-bar {\n            position: relative;\n            height: 60px;\n            background: linear-gradient(to right, #1e293b 0%, #0f172a 50%, #1e293b 100%);\n            border-radius: 8px;\n            overflow: hidden;\n        }\n        .timeline-segment {\n            position: absolute;\n            height: 100%;\n            opacity: 0.7;\n        }\n    </style>\n</head>\n<body class=\"bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen p-4 md:p-8\">\n\n    <div class=\"max-w-6xl mx-auto space-y-6\">\n        \n        <!-- ヘッダー -->\n        <header class=\"flex flex-col md:flex-row justify-between items-center gap-4\">\n            <div class=\"flex-1\">\n                <!-- メインタイトル -->\n                <h1 class=\"text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-100 via-blue-200 to-blue-400 mb-3 flex items-center gap-3\">\n                    <i data-lucide=\"telescope\" class=\"text-yellow-200 w-8 h-8 md:w-12 md:h-12\"></i>\n                    天体観測できるかな？\n                </h1>\n                \n                <!-- 場所情報 -->\n                <div class=\"flex items-center gap-2 text-xl font-semibold text-slate-200 pl-1\">\n                    <i data-lucide=\"map-pin\" class=\"text-blue-400\"></i>\n                    <span id=\"location-name\">位置情報を取得中...</span>\n                </div>\n                <p class=\"text-slate-400 text-sm mt-1 flex items-center gap-2 pl-1\">\n                    <span id=\"coords-display\">緯度: -- | 経度: --</span>\n                    <button onclick=\"toggleMap()\" class=\"text-blue-300 hover:text-white underline text-xs ml-2\">\n                        地図で場所を変更\n                    </button>\n                </p>\n            </div>\n            <div class=\"text-right flex flex-col items-end\">\n                <div id=\"current-clock\" class=\"text-xl font-semibold font-mono\">--:--:--</div>\n                <div class=\"text-slate-400 text-sm\">現在時刻 (Asia/Tokyo)</div>\n                <div class=\"text-slate-500 text-xs mt-2 flex items-center gap-2\">\n                    Ver. 2.2.1\n                    <button onclick=\"toggleNightVision()\" class=\"text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded border border-red-600/30\" title=\"ナイトビジョンモード\">\n                        <i data-lucide=\"moon\" class=\"w-3 h-3 inline\"></i>\n                    </button>\n                </div>\n            </div>\n        </header>\n\n        <!-- 地図・位置設定エリア (初期は非表示) -->\n        <div id=\"location-settings\" class=\"hidden glass-panel rounded-xl p-4 space-y-4\">\n            <div class=\"flex flex-wrap justify-between items-center gap-4\">\n                <h3 class=\"font-bold flex items-center gap-2\">\n                    <i data-lucide=\"map\" class=\"w-5 h-5 text-green-400\"></i> 地図から場所を選択\n                </h3>\n                <button onclick=\"getCurrentLocation()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2\">\n                    <i data-lucide=\"crosshair\" class=\"w-4 h-4\"></i> 現在地を取得\n                </button>\n            </div>\n            <p class=\"text-sm text-slate-300\">地図をクリックする と、その場所の天気を表示します。</p>\n            <div id=\"map\"></div>\n        </div>\n\n        <!-- コントロールバー (日時指定) -->\n        <div class=\"glass-panel rounded-xl p-4 flex flex-col sm:flex-row items-center justify-between gap-4\">\n            <div class=\"flex items-center gap-2 text-sm md:text-base\">\n                <i data-lucide=\"settings-2\" class=\"text-slate-300 w-5 h-5\"></i>\n                <span class=\"font-bold\">表示日時を指定:</span>\n            </div>\n            <div class=\"flex items-center gap-3 w-full sm:w-auto\">\n                <input type=\"datetime-local\" id=\"target-datetime\" \n                    class=\"bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-400 w-full sm:w-auto font-mono\"\n                    onchange=\"updateDashboardTime()\">\n                \n                <button onclick=\"resetToNow()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap\">\n                    現在に戻す\n                </button>\n            </div>\n        </div>\n\n        <!-- ロード中表示 -->\n        <div id=\"loading\" class=\"text-center py-20 text-xl animate-pulse\">天気データを取得中...</div>\n        \n        <div id=\"dashboard-content\" class=\"hidden space-y-6\">\n            <!-- 星空視認性スコア（大型表示） -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <div class=\"flex flex-col md:flex-row items-center justify-between gap-6\">\n                    <div class=\"flex flex-col items-center justify-center\">\n                        <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                            <i data-lucide=\"sparkles\" class=\"text-yellow-400 w-5 h-5\"></i> 星空視認性スコア\n                        </h3>\n                        <svg class=\"score-meter\" viewBox=\"0 0 160 160\">\n                            <circle cx=\"80\" cy=\"80\" r=\"70\" fill=\"none\" stroke=\"#334155\" stroke-width=\"12\"/>\n                            <circle id=\"score-circle\" class=\"score-circle\" cx=\"80\" cy=\"80\" r=\"70\" fill=\"none\" stroke=\"url(#scoreGradient)\" stroke-width=\"12\" stroke-linecap=\"round\" transform=\"rotate(-90 80 80)\"/>\n                            <defs>\n                                <linearGradient id=\"scoreGradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\n                                    <stop offset=\"0%\" style=\"stop-color:#ef4444;stop-opacity:1\" />\n                                    <stop offset=\"50%\" style=\"stop-color:#eab308;stop-opacity:1\" />\n                                    <stop offset=\"100%\" style=\"stop-color:#22c55e;stop-opacity:1\" />\n                                </linearGradient>\n                            </defs>\n                            <text id=\"score-text\" x=\"80\" y=\"75\" text-anchor=\"middle\" font-size=\"36\" font-weight=\"bold\" fill=\"#fff\">--</text>\n                            <text x=\"80\" y=\"95\" text-anchor=\"middle\" font-size=\"12\" fill=\"#94a3b8\">/ 100</text>\n                        </svg>\n                        <p id=\"score-comment\" class=\"text-sm text-slate-300 mt-3 text-center\">計算中...</p>\n                    </div>\n\n                    <!-- お気に入り地点 -->\n                    <div class=\"flex-1 w-full\">\n                        <h4 class=\"font-semibold text-sm mb-3 flex items-center gap-2\">\n                            <i data-lucide=\"bookmark\" class=\"w-4 h-4 text-blue-400\"></i>\n                            お気に入り地点\n                        </h4>\n                        <div id=\"favorite-locations\" class=\"space-y-2\">\n                            <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                                <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                                現在地をお気に入りに追加\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- メイン指標 -->\n            <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <!-- 気温カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden group hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の気温</div>\n                    <i data-lucide=\"thermometer\" class=\"w-12 h-12 text-orange-400 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-temp\">--°C</div>\n                    <div class=\"text-slate-300\">気温</div>\n                </div>\n\n                <!-- 雲量カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の雲量</div>\n                    <i data-lucide=\"cloud\" class=\"w-12 h-12 text-slate-300 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-clouds\">--%</div>\n                    <div class=\"text-slate-300\">全天雲量</div>\n                </div>\n\n                <!-- 雲の詳細 -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col justify-center gap-4 hover:bg-white/5 transition\">\n                    <div class=\"text-slate-400 text-sm font-medium uppercase tracking-wider mb-2\">雲の層（高度別）</div>\n                    \n                    <div class=\"flex justify-between items-center\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-up\" class=\"w-4 h-4\"></i> 上層 雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-high\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 上層雲: Violet -->\n                        <div id=\"bar-high\" class=\"bg-violet-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"minus\" class=\"w-4 h-4\"></i> 中層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-mid\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 中層雲: Emerald -->\n                        <div id=\"bar-mid\" class=\"bg-emerald-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-down\" class=\"w-4 h-4\"></i> 下層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-low\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 下層雲: 明るいグレー -->\n                        <div id=\"bar-low\" class=\"bg-gray-300 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 追加気象データ + 天文薄明時刻 -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                <!-- 追加気象データ -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"gauge\" class=\"text-cyan-400 w-5 h-5\"></i> 詳細気象データ\n                    </h3>\n                    <div class=\"grid grid-cols-2 gap-4\">\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">風速・風向</div>\n                            <div class=\"text-xl font-bold\" id=\"wind-speed\">-- m/s</div>\n                            <div class=\"text-sm text-slate-300\" id=\"wind-direction\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">気圧</div>\n                            <div class=\"text-xl font-bold\" id=\"pressure\">-- hPa</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">露点温度</div>\n                            <div class=\"text-xl font-bold\" id=\"dewpoint\">--°C</div>\n                            <div class=\"text-xs text-slate-400\" id=\"condensation-risk\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">視程</div>\n                            <div class=\"text-xl font-bold\" id=\"visibility\">-- km</div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 天文薄明・日月出没時刻 -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"sunrise\" class=\"text-orange-400 w-5 h-5\"></i> 天文薄明・出没時刻\n                    </h3>\n                    <div class=\"space-y-3\">\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明開始</span>\n                            <span class=\"font-mono font-bold\" id=\"twilight-astro-begin\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の出</span>\n                            <span class=\"font-mono font-bold\" id=\"sunrise-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の入</span>\n                            <span class=\"font-mono font-bold\" id=\"sunset-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明終了</span>\n                            <span class=\"font-mono font-bold text-green-300\" id=\"twilight-astro-end\">--:--</span>\n                        </div>\n                        <div class=\"border-t border-slate-700 pt-3 mt-3\">\n                            <div class=\"flex items-center justify-between text-sm\">\n                                <span class=\"text-slate-300\">月の出</span>\n                                <span class=\"font-mono font-bold\" id=\"moonrise-time\">--:--</span>\n                            </div>\n                            <div class=\"flex items-center justify-between text-sm mt-2\">\n                                <span class=\"text-slate-300\">月の入</span>\n                                <span class=\"font-mono font-bold\" id=\"moonset-time\">--:--</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 24時間 タイムライン -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"clock\" class=\"text-purple-400 w-5 h-5\"></i> 24時間観測適性タイムライン\n                </h3>\n                <div id=\"timeline-container\" class=\"timeline-bar\"></div>\n                <div class=\"flex items-center justify-between mt-3 text-xs text-slate-400\">\n                    <span>00:00</span>\n                    <span>06:00</span>\n                    <span>12:00</span>\n                    <span>18:00</span>\n                    <span>24:00</span>\n                </div>\n                <div class=\"flex items-center gap-4 mt-3 text-xs flex-wrap\">\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-yellow-500/50 rounded\"></div>\n                        <span>日中</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-blue-500/50 rounded\"></div>\n                        <span>薄明</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-green-500/50 rounded\"></div>\n                        <span>観測適時</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-slate-500/50 rounded\"></div>\n                        <span>月明かり</span>\n                    </div>\n                </div>\n            </div>\n\n             <!-- サマリーエリア（拡張版：天気分析＋月齢） -->\n             <div class=\"glass-panel rounded-2xl p-6\">\n                <div class=\"flex flex-col md:flex-row gap-6\">\n                    <!-- 左側：天気サマリー -->\n                    <div class=\"flex-1 flex flex-col justify-center border-l-4 border-blue-400 pl-4\">\n                        <p class=\"text-slate-300 italic\" id=\"forecast-summary\">予報を分析中...</p>\n                        <p class=\"text-xs text-slate-500 mt-2\" id=\"summary-timestamp\">--</p>\n                    </div>\n\n                    <!-- 右側：月齢情報 -->\n                    <div class=\"flex flex-col items-center justify-center min-w-[150px] border-t md:border-t-0 md:border-l border-slate-700 pt-4 md:pt-0 md:pl-6\">\n                        <div class=\"text-xs text-slate-400 mb-1 uppercase tracking-wider\">Moon Phase</div>\n                        <div class=\"text-4xl mb-1\" id=\"current-moon-icon\">\uD83C\uDF11</div>\n                        <div class=\"text-xl font-bold text-yellow-100\" id=\"current-moon-age-text\">--</div>\n                        <div class=\"text-sm text-yellow-200\" id=\"current-moon-name\">--</div>\n                    </div>\n                </div>\n             </div>\n\n            <!-- 天体イベント情報セクション -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"star\" class=\"text-yellow-400 w-5 h-5\"></i> 天体イベント情報\n                </h3>\n\n                <div class=\"space-y-3\">\n                    <!-- 今夜見える惑星 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('planets')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"planet\" class=\"w-4 h-4 text-purple-400\"></i>\n                                <span class=\"font-semibold text-sm\">今夜見える惑星</span>\n                            </div>\n                            <i id=\"icon-planets\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-planets\" class=\"hidden px-4 pb-4\">\n                            <div id=\"visible-planets\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 流星群カレンダー -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('meteors')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"zap\" class=\"w-4 h-4 text-yellow-400\"></i>\n                                <span class=\"font-semibold text-sm\"> 流星群カレンダー</span>\n                            </div>\n                            <i id=\"icon-meteors\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-meteors\" class=\"hidden px-4 pb-4\">\n                            <div id=\"meteor-showers\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">読み込み中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 月齢による観測推奨天体 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('recommended')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"telescope\" class=\"w-4 h-4 text-green-400\"></i>\n                                <span class=\"font-semibold text-sm\">月齢による観測推奨天体</span>\n                            </div>\n                            <i id=\"icon-recommended\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-recommended\" class=\"hidden px-4 pb-4\">\n                            <div id=\"recommended-objects\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計 算中...</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 観測適性レーダーチャート -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"radar\" class=\"text-pink-400 w-5 h-5\"></i> 観測適性レーダーチャート\n                </h3>\n                <div class=\"relative h-80 w-full\">\n                    <canvas id=\"radarChart\"></canvas>\n                </div>\n                <p class=\"text-xs text-slate-400 mt-2 text-center\">各要素が外側に近いほど観測に適した条件で す</p>\n            </div>\n\n            <!-- チャートセクション -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <!--  気温チャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"clock\" class=\"text-orange-400 w-5 h-5\"></i> 気温予報 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"tempChart\"></canvas>\n                    </div>\n                </div>\n\n                <!-- 雲の積層チャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"layers\" class=\"text-blue-400 w-5 h-5\"></i> 雲量推移 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"cloudChart\"></canvas>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 週間天気予報 -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"calendar\" class=\"text-green-400 w-5 h-5\"></i> 週間天気予報\n                    <span class=\"text-xs font-normal text-slate-400 ml-2\">※日付をクリックするとその日の詳細を表示します</span>\n                </h3>\n                <div class=\"overflow-x-auto\">\n                    <table class=\"w-full text-left border-collapse\">\n                        <thead>\n                            <tr class=\"text-slate-400 text-sm border-b border-slate-700\">\n                                <th class=\"py-3 px-2\">日付</th>\n                                <th class=\"py-3 px-2\">天気</th>\n                                <th class=\"py-3 px-2 text-center\">降水確率 / 量</th>\n                                <th class=\"py-3 px-2 text-center\">平均雲量</th>\n                                <th class=\"py-3 px-2 text-center\">平均湿度</th>\n                                <th class=\"py-3 px-2 text-center\">月齢</th>\n                                <th class=\"py-3 px-2 text-right\">最高 / 最低気温</th>\n                            </tr>\n                        </thead>\n                        <tbody id=\"weekly-forecast-body\" class=\"text-sm md:text-base\">\n                            <!-- JSで生成 -->\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        </div>\n\n        <!-- フッター (APIクレジット) -->\n        <footer class=\"glass-panel rounded-xl p-4 text-center text-slate-400 text-sm\">\n            <p>\n                Data sources: \n                <a href=\"https://open-meteo.com/\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">Open-Meteo</a> (Weather Data) & \n                <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">OpenStreetMap</a> (Map & Address Data)\n            </p>\n        </footer>\n\n    </div>\n\n    <script>\n        // --- 初期設定 ---\n        lucide.createIcons();\n        moment.locale('ja'); \n\n        let mapInstance = null;\n        let markerInstance = null;\n        let weatherData = null;\n        let tempChartInstance = null;\n        let cloudChartInstance = null;\n        let radarChartInstance = null;\n        let favoriteLocations = JSON.parse(localStorage.getItem('favoriteLocations') || '[]');\n\n        // デフォルト位置（三島市）\n        let currentLat = 35.1167;\n        let currentLon = 138.9167;\n\n        // --- ナイトビジョンモード ---\n        function toggleNightVision() {\n            document.body.classList.toggle('night-vision');\n            const isNight = document.body.classList.contains('night-vision');\n            localStorage.setItem('nightVisionMode', isNight);\n        }\n\n        // ページロード時にナイトビジョンモードを復元\n        if (localStorage.getItem('nightVisionMode') === 'true') {\n            document.body.classList.add('night-vision');\n        }\n\n        // --- アコーディオン機能 ---\n        function toggleAccordion(id) {\n            const content = document.getElementById('content-' + id);\n            const icon = document.getElementById('icon-' + id);\n\n            if (content.classList.contains('hidden')) {\n                content.classList.remove('hidden');\n                icon.style.transform = 'rotate(180deg)';\n            } else {\n                content.classList.add('hidden');\n                icon.style.transform = 'rotate(0deg)';\n            }\n\n            // Lucideアイコンを再初期化\n            lucide.createIcons();\n        }\n\n        // --- お気に入り地点管理 ---\n        function addFavoriteLocation() {\n            const name = prompt('この地点の名前を入力してください:', document.getElementById('location-name').innerText || '未設定');\n            if (name) {\n                const location = {\n                    name: name,\n                    lat: currentLat,\n                    lon: currentLon\n                };\n                favoriteLocations.push(location);\n                if (favoriteLocations.length > 5) favoriteLocations.shift(); // 最大5件\n                localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n                renderFavoriteLocations();\n            }\n        }\n\n        function renderFavoriteLocations() {\n            const container = document.getElementById('favorite-locations');\n            if (favoriteLocations.length === 0) {\n                container.innerHTML = `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                        現在地をお気に入りに追加\n                    </button>\n                `;\n            } else {\n                container.innerHTML = favoriteLocations.map((loc, index) => `\n                    <div class=\"bg-slate-800/50 rounded-lg p-2 flex items-center justify-between border border-slate-700\">\n                        <button onclick=\"loadFavoriteLocation(${index})\" class=\"flex-1 text-left text-sm hover:text-blue-300\">\n                            <i data-lucide=\"map-pin\" class=\"w-3 h-3 inline mr-1\"></i>\n                            ${loc.name}\n                        </button>\n                        <button onclick=\"removeFavoriteLocation(${index})\" class=\"text-red-400 hover:text-red-300 text-xs\">\n                            <i data-lucide=\"x\" class=\"w-3 h-3\"></i>\n                        </button>\n                    </div>\n                `).join('') + `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-2 text-xs border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-3 h-3\"></i>\n                        追加\n                    </button>\n                `;\n            }\n            lucide.createIcons();\n        }\n\n        function loadFavoriteLocation(index) {\n            const loc = favoriteLocations[index];\n            updateAppLocation(loc.lat, loc.lon);\n        }\n\n        function removeFavoriteLocation(index) {\n            favoriteLocations.splice(index, 1);\n            localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n            renderFavoriteLocations();\n        }\n\n        // --- 星空視認性スコア計算 ---\n        function calculateStarryScore(cloudCover, moonAge, humidity, visibility = 24, windSpeed = 5) {\n            // 雲量スコア (0-100) - 雲が少ないほど高い\n            const cloudScore = Math.max(0, 100 - cloudCover);\n\n            // 月明かりスコア (0-100) - 新月に近いほど高い\n            const moonScore = moonAge < 3 || moonAge > 26 ? 100 :\n                             moonAge < 10 || moonAge > 18 ? 60 : 20;\n\n            // 湿度スコア (0-100) - 湿度が低いほど高い\n            const humidityScore = Math.max(0, 100 - humidity);\n\n            // 視程スコア (0-100)\n            const visibilityScore = Math.min(100, (visibility / 50) * 100);\n\n            // 風速スコア (0-100) - 風が弱いほど高い\n            const windScore = windSpeed < 2 ? 100 : windSpeed < 5 ? 80 : windSpeed < 10 ? 50 : 20;\n\n            // 加重平均 (雲量と月明かりを重視)\n            const totalScore = (cloudScore * 0.4 + moonScore * 0.3 + humidityScore * 0.15 + visibilityScore * 0.1 + windScore * 0.05);\n\n            return Math.round(totalScore);\n        }\n\n        function updateStarryScore(score) {\n            const circle = document.getElementById('score-circle');\n            const text = document.getElementById('score-text');\n            const comment = document.getElementById('score-comment');\n\n            // スコアに応じた円の進行度 (0-100を0-440に変換)\n            const dashOffset = 440 - (score / 100) * 440;\n            circle.style.strokeDashoffset = dashOffset;\n\n            text.textContent = score;\n\n            // コメント\n            if (score >= 80) {\n                comment.textContent = '⭐ 絶好の観測日和！星空が最高に美しく見えるでしょう';\n            } else if (score >= 60) {\n                comment.textContent = '✨ 観測に適した条件 です。良い星空が期待できます';\n            } else if (score >= 40) {\n                comment.textContent = '\uD83C\uDF24\uFE0F まずまずの条件。明るい星は観測 できます';\n            } else if (score >= 20) {\n                comment.textContent = '☁\uFE0F やや条件が悪いです。観測には忍耐が必要かも';\n            } else {\n                comment.textContent = '❌ 観測には不向きな条件です';\n            }\n        }\n\n        // 時計更新\n        setInterval(() => {\n            document.getElementById('current-clock').textContent = moment().format('HH:mm:ss');\n        }, 1000);\n\n        // --- アプリケーション起動フロー ---\n        window.addEventListener('load', () => {\n            // お気に入り地点を表示\n            renderFavoriteLocations();\n            // 現在地取得を試みる\n            getCurrentLocation(true); // true = 初回起動時の自動取得\n        });\n\n        // --- 位置情報関連 ---\n\n        // ブラウザの現在地取得\n        function getCurrentLocation(isInitial = false) {\n            if (!navigator.geolocation) {\n                if(!isInitial) alert(\"このブラウザは位置情報をサポートしていません。\");\n                initializeDashboardWithCurrentCoords(); // デフォルトで起動\n                return;\n            }\n\n            // ロード表示\n            document.getElementById('loading').innerHTML = '現在地を取得中...';\n            document.getElementById('loading').classList.remove('hidden');\n\n            navigator.geolocation.getCurrentPosition(\n                (position) => {\n                    currentLat = position.coords.latitude;\n                    currentLon = position.coords.longitude;\n                    updateAppLocation(currentLat, currentLon);\n                },\n                (error) => {\n                    console.warn(\"位置情報取得失敗:\", error.message);\n                    if(!isInitial) alert(\"位置情報を取得できませんでした。\");\n                    // 失敗した場合はデフォルト位置（三島）で開始\n                    initializeDashboardWithCurrentCoords(); \n                }\n            );\n        }\n\n        // 座標を指定してアプリ全体を更新するメイン関数\n        async function updateAppLocation(lat, lon) {\n            currentLat = lat;\n            currentLon = lon;\n\n            // 1. UIの座標表示更新\n            document.getElementById('coords-display').innerText = `緯度: ${lat.toFixed(4)} | 経度: ${lon.toFixed(4)}`;\n\n            // 2. 住所取得 (逆ジオコーディング)\n            fetchAddress(lat, lon);\n\n            // 3. 地図マーカー更新（地図が開いている、または初期化されている場合）\n            if (mapInstance) {\n                updateMapMarker(lat, lon);\n            }\n\n            // 4.  天気データ取得\n            await fetchWeather(lat, lon);\n        }\n\n        // 住所取得 (OpenStreetMap Nominatim API)\n        async function fetchAddress(lat, lon) {\n            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=ja`;\n            \n            try {\n                const response = await fetch(url, {\n                    headers: { 'User-Agent': 'WeatherDashboardDemo/1.0' } // マナーとしてUser-Agentを設定\n                });\n                const data = await response.json();\n                \n                if (data && data.address) {\n                    const addr = data.address;\n                    // 見やすい住所を構築（県 + 市町村 + 町名）\n                    const pref = addr.province || addr.state || '';\n                    const city = addr.city || addr.ward || addr.town || addr.village || '';\n                    const sub = addr.suburb || addr.quarter || addr.neighbourhood || '';\n                    \n                    const fullName = `${pref} ${city} ${sub}`.trim() || \"不明な 場所\";\n                    document.getElementById('location-name').innerText = fullName;\n                } else {\n                    document.getElementById('location-name').innerText = \"住所不明\";\n                }\n            } catch (error) {\n                console.error(\"住所取得エラー:\", error);\n                document.getElementById('location-name').innerText = \"住所取得失敗\";\n            }\n        }\n\n        // デフォルト/現在の座標で初期化\n        function initializeDashboardWithCurrentCoords() {\n            updateAppLocation(currentLat, currentLon);\n        }\n\n        // --- 地図機能 ---\n\n        function toggleMap() {\n            const container = document.getElementById('location-settings');\n            const isHidden = container.classList.contains('hidden');\n            \n            if (isHidden) {\n                container.classList.remove('hidden');\n                // 地図が初めて表示されるときに初期化\n                if (!mapInstance) {\n                    initMap();\n                } else {\n                    // サイズ再計算（hiddenから復帰時に必要）\n                    setTimeout(() => mapInstance.invalidateSize(), 100);\n                }\n            } else {\n                container.classList.add('hidden');\n            }\n        }\n\n        function initMap() {\n            // 地図初期化\n            mapInstance = L.map('map').setView([currentLat, currentLon], 13);\n\n            // OpenStreetMapタイル\n            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n            }).addTo(mapInstance);\n\n            // マーカー追 加\n            markerInstance = L.marker([currentLat, currentLon], {draggable: false}).addTo(mapInstance);\n\n            // マップクリックイベント\n            mapInstance.on('click', function(e) {\n                const lat = e.latlng.lat;\n                const lon = e.latlng.lng;\n                updateAppLocation(lat, lon);\n            });\n        }\n\n        function updateMapMarker(lat, lon) {\n            if (markerInstance) {\n                markerInstance.setLatLng([lat, lon]);\n            }\n            mapInstance.panTo([lat, lon]);\n        }\n\n        // --- ヘルパー関数 ---\n        function getWindDirection(degrees) {\n            const directions = ['北', '北北東', '北東', '東北東', '東', '東南東', '南東', '南南東', '南', '南南西', '南西', '西南西', '西', '西北西', '北西', '北北西'];\n            const index = Math.round(degrees / 22.5) % 16;\n            return directions[index];\n        }\n\n        // --- レーダーチャ ート描画 ---\n        function renderRadarChart(data) {\n            const ctx = document.getElementById('radarChart').getContext('2d');\n            if (radarChartInstance) radarChartInstance.destroy();\n\n            radarChartInstance = new Chart(ctx, {\n                type: 'radar',\n                data: {\n                    labels: ['雲の少なさ', '月の暗さ', '低湿度', '高視程', '風の穏や かさ'],\n                    datasets: [{\n                        label: '観測 適性',\n                        data: [data.cloudClearness, data.moonDarkness, data.lowHumidity, data.goodVisibility, data.calmWind],\n                        backgroundColor: 'rgba(34, 197, 94, 0.2)',\n                        borderColor: 'rgba(34, 197, 94, 1)',\n                        borderWidth: 2,\n                        pointBackgroundColor: 'rgba(34, 197, 94, 1)',\n                        pointBorderColor: '#fff',\n                        pointHoverBackgroundColor: '#fff',\n                        pointHoverBorderColor: 'rgba(34, 197, 94, 1)'\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    scales: {\n                        r: {\n                            beginAtZero: true,\n                            max: 100,\n                            ticks: {\n                                stepSize: 20,\n                                color: '#94a3b8'\n                            },\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)'\n                            },\n                            pointLabels: {\n                                color: '#cbd5e1',\n                                font: {\n                                    size: 12\n                                }\n                            }\n                        }\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        }\n                    }\n                }\n            });\n        }\n\n        // --- 流星群データ (年間イベント) ---\n        const meteorShowers = [\n            { name: \"しぶんぎ座流星群\", peakStart: \"01-03\", peakEnd: \"01-04\", rate: \"120個/時\", note: \"年始の三大流星群\" },\n            { name: \"こ と座流星群\", peakStart: \"04-22\", peakEnd: \"04-23\", rate: \"18個/時\", note: \"安定した流星群\" },\n            { name: \"みずがめ座η流星群\", peakStart: \"05-06\", peakEnd: \"05-07\", rate: \"50個/時\", note: \"南半球で好条件\" },\n            { name: \"ペルセウス座流星群\", peakStart: \"08-12\", peakEnd: \"08-13\", rate: \"100個/時\", note: \"三大流星群の一つ\" },\n            { name: \"オリオン座流星群\", peakStart: \"10-21\", peakEnd: \"10-22\", rate: \"20個/時\", note: \"ハレー彗星起源\" },\n            { name: \"しし座流星群\", peakStart: \"11-17\", peakEnd: \"11-18\", rate: \"15個/時\", note: \"33年周期で大出現\" },\n            { name: \"ふたご座流星群\", peakStart: \"12-13\", peakEnd: \"12-14\", rate: \"120個/時\", note: \"三大流星群の一つ\" },\n            { name: \"こぐま座 流星群\", peakStart: \"12-22\", peakEnd: \"12-23\", rate: \"10個/時\", note: \" 安定した観測\" }\n        ];\n\n        // --- 月齢計算ロジック ---\n        function calculateMoonData(date) {\n            // 2000年1月6日 18:14 (UTC) は新月 (Lunation Number 953)\n            // 簡易計算のため、UTCでの日付差分を利用\n            const knownNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0)); \n            const diffTime = date.getTime() - knownNewMoon.getTime();\n            const diffDays = diffTime / (1000 * 60 * 60 * 24);\n            const synodicMonth = 29.53058867;\n            \n            let age = diffDays % synodicMonth;\n            if (age < 0) age += synodicMonth;\n            \n            // 月相 の判定\n            let phaseName = \"\";\n            let icon = \"\";\n            \n            // 絵文字と名前のマッピング (簡易版)\n            if (age < 1.0 || age > 28.5) { phaseName = \"新月\"; icon = \"\uD83C\uDF11\"; }\n            else if (age < 6.0) { phaseName = \"三日月\"; icon = \"\uD83C\uDF12\"; }\n            else if (age < 9.0) { phaseName = \"上弦の月\"; icon = \"\uD83C\uDF13\"; }\n            else if (age < 13.5) { phaseName = \"十日夜\"; icon = \"\uD83C\uDF14\"; }\n            else if (age < 16.5) { phaseName = \"満月\"; icon = \"\uD83C\uDF15\"; }\n            else if (age < 21.0) { phaseName = \"立待月\"; icon = \"\uD83C\uDF16\"; }\n            else if (age < 24.0) { phaseName = \"下弦の月\"; icon = \"\uD83C\uDF17\"; }\n            else { phaseName = \"有明月\"; icon = \"\uD83C\uDF18\"; }\n\n            return {\n                age: age.toFixed(1),\n                phaseName: phaseName,\n                icon: icon\n            };\n        }\n\n        // --- 日の出入り・月の出入り・天文薄明計算 ---\n        function calculateSunMoonTimes(date, lat, lon) {\n            try {\n                const observer = new Astronomy.Observer(lat, lon, 0);\n\n                // 日の出・日の入り\n                const sunrise = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, 1, date, 1);\n                const sunset = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, date, 1);\n\n                // 天文薄明 (-18度)\n                const astroTwilightMorning = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, -1, date, 1, -18);\n                const astroTwilightEvening = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, 1, date, 1, -18);\n\n                // 月の出・月の入り\n                const moonrise = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, 1, date, 1);\n                const moonset = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, date, 1);\n\n                return {\n                    sunrise: sunrise ? moment(sunrise.date).format('HH:mm') : '--:--',\n                    sunset: sunset ? moment(sunset.date).format('HH:mm') : '--:--',\n                    astroTwilightBegin: astroTwilightMorning ? moment(astroTwilightMorning.date).format('HH:mm') : '--:--',\n                    astroTwilightEnd: astroTwilightEvening ? moment(astroTwilightEvening.date).format('HH:mm') : '--:--',\n                    moonrise: moonrise ? moment(moonrise.date).format('HH:mm') : '--:--',\n                    moonset: moonset ? moment(moonset.date).format('HH:mm') : '--:--',\n                    sunriseDate: sunrise ? sunrise.date : null,\n                    sunsetDate: sunset ? sunset.date : null,\n                    astroBeginDate: astroTwilightMorning ? astroTwilightMorning.date : null,\n                    astroEndDate: astroTwilightEvening ? astroTwilightEvening.date : null\n                };\n            } catch (error) {\n                console.error('日月時刻計算エラー:', error);\n                return {\n                    sunrise: '--:--',\n                    sunset: '--:--',\n                    astroTwilightBegin: '--:--',\n                    astroTwilightEnd: '--:--',\n                    moonrise: '--:--',\n                    moonset: '--:--'\n                };\n            }\n        }\n\n        function updateSunMoonDisplay(times) {\n            document.getElementById('sunrise-time').innerText = times.sunrise;\n            document.getElementById('sunset-time').innerText = times.sunset;\n            document.getElementById('twilight-astro-begin').innerText = times.astroTwilightBegin;\n            document.getElementById('twilight-astro-end').innerText = times.astroTwilightEnd;\n            document.getElementById('moonrise-time').innerText = times.moonrise;\n            document.getElementById('moonset-time').innerText = times.moonset;\n        }\n\n        // --- 24時間タイムライン描画 ---\n        function renderTimeline(times, targetDate) {\n            const container = document.getElementById('timeline-container');\n            container.innerHTML = '';\n\n            const dayStart = moment(targetDate).startOf('day');\n            const dayEnd = moment(targetDate).endOf('day');\n\n            // セグメントを追加\n            const segments = [];\n\n            // 日中（日の出～日の入り）\n            if (times.sunriseDate && times.sunsetDate) {\n                const sunriseTime = moment(times.sunriseDate);\n                const sunsetTime = moment(times.sunsetDate);\n\n                const start = ((sunriseTime - dayStart) / (dayEnd - dayStart)) * 100;\n                const width = ((sunsetTime - sunriseTime) / (dayEnd - dayStart)) * 100;\n\n                segments.push({ start, width, color: '#eab308', label: '日中' });\n            }\n\n            // 天文薄明\n            if (times.astroBeginDate && times.astroEndDate) {\n                const astroBegin = moment(times.astroBeginDate);\n                const astroEnd = moment(times.astroEndDate);\n\n                // 朝の薄明\n                const morningStart = ((astroBegin - dayStart) / (dayEnd - dayStart)) * 100;\n                const morningWidth = ((moment(times.sunriseDate) - astroBegin) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: morningStart, width: morningWidth, color: '#3b82f6', label: '朝薄明' });\n\n                // 夕方の薄明\n                const eveningStart = ((moment(times.sunsetDate) - dayStart) / (dayEnd - dayStart)) * 100;\n                const eveningWidth = ((astroEnd - moment(times.sunsetDate)) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: eveningStart, width: eveningWidth, color: '#3b82f6', label: '夕薄明' });\n\n                // 観測適時（天文薄明終了後～天文薄明開始前）\n                const observeStart = ((astroEnd - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeEnd = ((astroBegin.clone().add(1, 'day') - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeWidth = observeEnd - observeStart;\n                if (observeWidth > 0) {\n                    segments.push({ start: observeStart, width: observeWidth, color: '#22c55e', label: '観測適時' });\n                }\n            }\n\n            // セグメントを描画\n            segments.forEach(seg => {\n                const div = document.createElement('div');\n                div.className = 'timeline-segment';\n                div.style.left = `${seg.start}%`;\n                div.style.width = `${seg.width}%`;\n                div.style.background = seg.color;\n                div.title = seg.label;\n                container.appendChild(div);\n            });\n        }\n\n        // --- 天体イベント関数 ---\n\n        // 1. 今夜見える惑星を計算\n        function calculateVisiblePlanets(observerDate, observerLat, observerLon) {\n            try {\n                const observer = new Astronomy.Observer(observerLat, observerLon, 0);\n                const planets = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];\n                const planetNames = {\n                    'Mercury': '水星',\n                    'Venus': '金星',\n                    'Mars': '火星',\n                    'Jupiter': '木星',\n                    'Saturn': '土星'\n                };\n                const planetIcons = {\n                    'Mercury': '⚫',\n                    'Venus': '\uD83C\uDF1F',\n                    'Mars': '\uD83D\uDD34',\n                    'Jupiter': '\uD83D\uDFE0',\n                    'Saturn': '\uD83E\uDE90'\n                };\n\n                let visiblePlanets = [];\n\n                planets.forEach(planet => {\n                    const equator = Astronomy.Equator(planet, observerDate, observer, true, true);\n                    const horizon = Astronomy.Horizon(observerDate, observer, equator.ra, equator.dec, 'normal');\n                    const illumination = Astronomy.Illumination(planet, observerDate);\n\n                    // 地平線より上（高度 > 0）で、ある程度明るい天体のみ表 示\n                    if (horizon.altitude > 0) {\n                        visiblePlanets.push({\n                            name: planetNames[planet],\n                            icon: planetIcons[planet],\n                            altitude: horizon.altitude.toFixed(1),\n                            azimuth: horizon.azimuth.toFixed(1),\n                            magnitude: illumination.mag.toFixed(1)\n                        });\n                    }\n                });\n\n                // HTMLに表示\n                const container = document.getElementById('visible-planets');\n                if (visiblePlanets.length === 0) {\n                    container.innerHTML = '<div class=\"text-slate-400\">現在、地平線上に惑星はありません</div>';\n                } else {\n                    container.innerHTML = visiblePlanets.map(p => `\n                        <div class=\"flex items-center justify-between bg-slate-700/30 rounded-lg p-2\">\n                            <div class=\"flex items-center gap-2\">\n                                <span class=\"text-lg\">${p.icon}</span>\n                                <span class=\"font-semibold\">${p.name}</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400\">\n                                高度: ${p.altitude}° | 方位: ${p.azimuth}° | 等級: ${p.magnitude}\n                            </div>\n                        </div>\n                    `).join('');\n                }\n            } catch (error) {\n                console.error('惑星計算エラー:', error);\n                document.getElementById('visible-planets').innerHTML = '<div class=\"text-red-400\">計算エラー</div>';\n            }\n        }\n\n        // 2. 流星群カレンダーを更新\n        function updateMeteorShowers(targetDate) {\n            const currentYear = targetDate.getFullYear();\n            const currentMonth = String(targetDate.getMonth() + 1).padStart(2, '0');\n            const currentDay = String(targetDate.getDate()).padStart(2, '0');\n            const currentDateStr = `${currentMonth}-${currentDay}`;\n\n            // 前後30日 以内の流星群をフィルタ\n            const relevantShowers = meteorShowers.filter(shower => {\n                const showerDate = new Date(`${currentYear}-${shower.peakStart}`);\n                const targetDateTime = targetDate.getTime();\n                const diffDays = Math.abs((showerDate - targetDateTime) / (1000 * 60 * 60 * 24));\n                return diffDays <= 30;\n            });\n\n            const container = document.getElementById('meteor-showers');\n            if (relevantShowers.length === 0) {\n                container.innerHTML = '<div class=\"text-slate-400\">今後30日以内に極大を迎える流星群はありません</div>';\n            } else {\n                container.innerHTML = relevantShowers.map(shower => {\n                    const isPeak = currentDateStr === shower.peakStart || currentDateStr === shower.peakEnd;\n                    const showerDateStr = shower.peakStart.replace('-', '/');\n                    return `\n                        <div class=\"bg-slate-700/30 rounded-lg p-2 ${isPeak ? 'border-l-2 border-yellow-400' : ''}\">\n                            <div class=\"flex items-center justify-between\">\n                                <span class=\"font-semibold ${isPeak ? 'text-yellow-300' : ''}\">${shower.name}</span>\n                                <span class=\"text-xs text-slate-400\">${showerDateStr} 極大</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400 mt-1\">\n                                ${shower.rate} | ${shower.note}\n                            </div>\n                            ${isPeak ? '<div class=\"text-xs text-yellow-300 mt-1\">\uD83C\uDF1F 本日が極大日です！</div>' : ''}\n                        </div>\n                    `;\n                }).join('');\n            }\n        }\n\n        // 3. 月齢による観測推奨天体\n        function updateRecommendedObjects(moonAge) {\n            const age = parseFloat(moonAge);\n            const container = document.getElementById('recommended-objects');\n\n            let recommendations = [];\n\n            if (age < 3 || age > 26) {\n                // 新月期: 暗 い天体に最適\n                recommendations = [\n                    { name: 'アンドロメダ銀河 (M31)', type: '銀河', reason: '暗い夜空で見やすい' },\n                    { name: 'オリオン大星雲 (M42)', type: '星雲', reason: '新月期が最適' },\n                    { name: 'プレアデス星団 (M45)', type: '星団', reason: '暗い空で美しい' }\n                ];\n            } else if (age >= 3 && age < 10) {\n                // 上弦前後: 月面観測に適する\n                recommendations = [\n                    { name: '月面クレーター', type: '月', reason: '影が長く見やすい' },\n                    { name: '明るい惑星', type: '惑星', reason: '月明かりの影響少ない' },\n                    { name: '二重星（アルビレオ）', type: '恒星', reason: '明るい星なら観測可' }\n                ];\n            } else if (age >= 10 && age < 18) {\n                // 満月期: 月面観測メイン\n                recommendations = [\n                    { name: '満月の地形観 測', type: '月', reason: '全体像を観測' },\n                    { name: '明るい 星雲 (M42)', type: '星雲', reason: '明るい天体のみ' },\n                    { name: '惑星の衛星', type: '惑星', reason: '木星の衛星など' }\n                ];\n            } else {\n                // 下弦前後: 朝方の観測\n                recommendations = [\n                    { name: '月面南部クレーター', type: '月', reason: '下弦は南部が見やすい' },\n                    { name: '明け方の惑星', type: '惑星', reason: '水星・金星が好条件' },\n                    { name: '球 状星団 (M13)', type: '星団', reason: '明け方なら観測可' }\n                ];\n            }\n\n            container.innerHTML = recommendations.map(rec => `\n                <div class=\"bg-slate-700/30 rounded-lg p-2\">\n                    <div class=\"flex items-center justify-between\">\n                        <span class=\"font-semibold\">${rec.name}</span>\n                        <span class=\"text-xs bg-green-600/30 text-green-300 px-2 py-0.5 rounded\">${rec.type}</span>\n                    </div>\n                    <div class=\"text-xs text-slate-400 mt-1\">${rec.reason}</div>\n                </div>\n            `).join('');\n        }\n\n        // --- 天気データ取得 & 描画 ---\n\n        async function fetchWeather(lat, lon) {\n            // API URL (追加気象データを含む)\n            const API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,cloud_cover,cloud_cover_low,cloud_cover_mid,cloud_cover_high,windspeed_10m,winddirection_10m,surface_pressure,dewpoint_2m,visibility&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset&timezone=Asia%2FTokyo&past_days=2&forecast_days=10`;\n\n            try {\n                const response = await fetch(API_URL);\n                weatherData = await response.json();\n                \n                // 初回は現在時刻で描 画\n                // もしユーザーが過去の日付を選択中の場合はそのまま維持して も良いが、\n                // 場所を変えたら「現在」に戻る方が自然なため、現在 時刻にリセットする\n                const now = moment();\n                setDatePickerValue(now);\n                renderDashboard(now);\n            } catch (error) {\n                document.getElementById('loading').innerHTML = `<span class=\"text-red-400\">データ取得エラー: ${error.message}</span>`;\n                console.error(error);\n            }\n        }\n\n        // --- UIレンダ リング (既存のロジック) ---\n\n        function setDatePickerValue(momentObj) {\n            const formatted = momentObj.format('YYYY-MM-DDTHH:mm');\n            document.getElementById('target-datetime').value = formatted;\n        }\n\n        function updateDashboardTime() {\n            const val = document.getElementById('target-datetime').value;\n            if (val && weatherData) {\n                renderDashboard(moment(val));\n            }\n        }\n\n        function resetToNow() {\n            const now = moment();\n            setDatePickerValue(now);\n            if (weatherData) {\n                renderDashboard(now);\n            }\n        }\n\n        // 新しい関数: 週間予報の日付クリック 時の処理\n        function selectDate(dateStr) {\n            // 現在の入力値（ 時間）を取得して、日付だけ差し替える\n            const currentVal = document.getElementById('target-datetime').value;\n            let targetMoment = moment(dateStr); \n            \n            if (currentVal) {\n                const currentMoment = moment(currentVal);\n                // 時間と分を維持\n                targetMoment.hour(currentMoment.hour());\n                targetMoment.minute(currentMoment.minute());\n            } else {\n                // デフォルトは正午などにするか、現在時刻に合わせる\n                const now = moment();\n                targetMoment.hour(now.hour());\n                targetMoment.minute(now.minute());\n            }\n\n            setDatePickerValue(targetMoment);\n            renderDashboard(targetMoment);\n            \n            // スクロールを上部へ（スマホなどで見やすくするため）\n            document.getElementById('dashboard-content').scrollIntoView({ behavior: 'smooth' });\n        }\n\n        function getWeatherInfo(code) {\n            if (code === 0) return { label: '快晴', icon: 'sun', color: 'text-orange-400' };\n            if (code >= 1 && code <= 3) return { label: '曇り・晴れ間', icon: 'cloud-sun', color: 'text-gray-300' };\n            if (code >= 45 && code <= 48) return { label: '霧', icon: 'align-justify', color: 'text-gray-400' };\n            if (code >= 51 && code <= 55) return { label: '霧雨', icon: 'cloud-drizzle', color: 'text-blue-300' };\n            if (code >= 61 && code <= 67) return { label: '雨', icon: 'cloud-rain', color: 'text-blue-400' };\n            if (code >= 71 && code <= 77) return { label: '雪', icon: 'snowflake', color: 'text-white' };\n            if (code >= 80 && code <= 82) return { label: 'にわか雨', icon: 'cloud-hail', color: 'text-blue-300' };\n            if (code >= 95 && code <= 99) return { label: '雷雨', icon: 'cloud-lightning', color: 'text-yellow-400' };\n            return { label: '不明', icon: 'help-circle', color: 'text-gray-500' };\n        }\n\n        function renderDashboard(targetMoment) {\n            if (!weatherData) return;\n\n            const hourly = weatherData.hourly;\n            const daily = weatherData.daily;\n            const targetDate = targetMoment.toDate();\n            \n            let currentIndex = 0;\n            let minDiff = Infinity;\n            let isOutOfRange = true;\n\n            hourly.time.forEach((t, i) => {\n                const diff = Math.abs(new Date(t) - targetDate);\n                if (diff < minDiff) {\n                    minDiff = diff;\n                    currentIndex = i;\n                }\n                if (diff < 90 * 60 * 1000) { \n                    isOutOfRange = false;\n                }\n            });\n\n            if (isOutOfRange && minDiff > 24 * 60 * 60 * 1000) {\n                 document.getElementById('forecast-summary').innerText = \"選択された日時の詳細データがありません（範囲外です）\";\n                 return;\n            }\n\n            // 現在のステータス更新\n            const currentTemp = hourly.temperature_2m[currentIndex];\n            const currentCloudTotal = hourly.cloud_cover[currentIndex];\n            const currentLow = hourly.cloud_cover_low[currentIndex];\n            const currentMid = hourly.cloud_cover_mid[currentIndex];\n            const currentHigh = hourly.cloud_cover_high[currentIndex];\n\n            document.getElementById('current-temp').innerText = `${currentTemp}°C`;\n            document.getElementById('current-clouds').innerText = `${currentCloudTotal}%`;\n            \n            document.getElementById('clouds-high').innerText = `${currentHigh}%`;\n            document.getElementById('bar-high').style.width = `${currentHigh}%`;\n            \n            document.getElementById('clouds-mid').innerText = `${currentMid}%`;\n            document.getElementById('bar-mid').style.width = `${currentMid}%`;\n            \n            document.getElementById('clouds-low').innerText = `${currentLow}%`;\n            document.getElementById('bar-low').style.width = `${currentLow}%`;\n\n            // 月齢情報の更新 (サマリーエリア)\n            const moonData = calculateMoonData(targetDate);\n            document.getElementById('current-moon-icon').innerText = moonData.icon;\n            document.getElementById('current-moon-age-text').innerText = moonData.age;\n            document.getElementById('current-moon-name').innerText = moonData.phaseName;\n\n            // 天体イベント情 報を更新\n            calculateVisiblePlanets(targetDate, currentLat, currentLon);\n            updateMeteorShowers(targetDate);\n            updateRecommendedObjects(moonData.age);\n\n            // 追加気象データの表示\n            const currentWindSpeed = hourly.windspeed_10m ? hourly.windspeed_10m[currentIndex] : 0;\n            const currentWindDir = hourly.winddirection_10m ? hourly.winddirection_10m[currentIndex] : 0;\n            const currentPressure = hourly.surface_pressure ? hourly.surface_pressure[currentIndex] : 1013;\n            const currentDewpoint = hourly.dewpoint_2m ? hourly.dewpoint_2m[currentIndex] : 0;\n            const currentVisibility = hourly.visibility ? (hourly.visibility[currentIndex] / 1000).toFixed(1) : 24;\n            const currentHumidity = hourly.relative_humidity_2m[currentIndex];\n\n            document.getElementById('wind-speed').innerText = `${currentWindSpeed.toFixed(1)} m/s`;\n            const windDirText = getWindDirection(currentWindDir);\n            document.getElementById('wind-direction').innerText = windDirText;\n            document.getElementById('pressure').innerText = `${currentPressure.toFixed(0)} hPa`;\n            document.getElementById('dewpoint').innerText = `${currentDewpoint.toFixed(1)}°C`;\n            document.getElementById('visibility').innerText = `${currentVisibility} km`;\n\n            // 結露リスク判定\n            const tempDiff = currentTemp - currentDewpoint;\n            let condensationRisk = '';\n            if (tempDiff < 2) condensationRisk = '⚠\uFE0F 結露リスク高';\n            else if (tempDiff < 5) condensationRisk = '⚡ 結露注意';\n            else condensationRisk = '✅ 結露リスク低';\n            document.getElementById('condensation-risk').innerText = condensationRisk;\n\n            // 日月出没・天文薄明の計算と表示\n            const sunMoonTimes = calculateSunMoonTimes(targetDate, currentLat, currentLon);\n            updateSunMoonDisplay(sunMoonTimes);\n            renderTimeline(sunMoonTimes, targetDate);\n\n            // 星空視認性スコアの計算\n            const starryScore = calculateStarryScore(currentCloudTotal, moonData.age, currentHumidity, parseFloat(currentVisibility), currentWindSpeed);\n            updateStarryScore(starryScore);\n\n            // レーダーチャートのデータ準備\n            const radarData = {\n                cloudClearness: Math.max(0, 100 - currentCloudTotal),\n                moonDarkness: moonData.age < 3 || moonData.age > 26 ? 100 : moonData.age < 10 || moonData.age > 18 ? 60 : 20,\n                lowHumidity: Math.max(0, 100 - currentHumidity),\n                goodVisibility: Math.min(100, (parseFloat(currentVisibility) / 50) * 100),\n                calmWind: currentWindSpeed < 2 ? 100 : currentWindSpeed < 5 ? 80 : currentWindSpeed < 10 ? 50 : 20\n            };\n            renderRadarChart(radarData);\n\n\n            // サマリーテキスト\n            const displayTimeStr = targetMoment.format('M月D日 H:mm');\n            document.getElementById('summary-timestamp').innerText = `表示データ時刻: ${displayTimeStr}`;\n\n            let summary = `気温 ${currentTemp}°C。`;\n            if(currentCloudTotal < 20) summary += \" 快晴または晴れ。\";\n            else if(currentCloudTotal < 60) summary += \" 雲間あり。\";\n            else summary += \" 曇り空。\";\n            \n            if (currentIndex + 6 < hourly.temperature_2m.length) {\n                const futureTemp = hourly.temperature_2m[currentIndex + 6];\n                const tempDiff = futureTemp - currentTemp;\n                if(tempDiff > 2) summary += \" その後、気温は上昇傾向です。\";\n                else if(tempDiff < -2) summary += \" その後、冷え込む見込みです。\";\n            }\n\n            // --- 天体観測サマリー追加 ---\n            // 選択された日時の「夜間（20:00 -  翌04:00）」のデータを取得\n            let astroStart = targetMoment.clone().startOf('day').add(20, 'hours');\n            // 修正: 深夜でも「その日の20時〜」を対象にするため、深夜補正ロジックを削除\n            \n            const astroEnd = astroStart.clone().add(8, 'hours'); // 20:00 -> 04:00 (8時間)\n            \n            let astroCloudSum = 0;\n            let astroCount = 0;\n            \n            hourly.time.forEach((t, i) => {\n                const time = moment(t);\n                if (time.isSameOrAfter(astroStart) && time.isBefore(astroEnd)) {\n                    astroCloudSum += hourly.cloud_cover[i];\n                    astroCount++;\n                }\n            });\n\n            if (astroCount > 0) {\n                const avgAstroCloud = astroCloudSum / astroCount;\n                summary += \"<br><br><strong>\uD83D\uDD2D 天体観測予報:</strong> \";\n                const dateStr = astroStart.format('M/D');\n                \n                // 月の影響を加味したコメント\n                let moonComment = \"\";\n                if (moonData.age > 10 && moonData.age < 18) {\n                    moonComment = \"ただし、月明かりの影響が大きいでしょう。\";\n                }\n\n                if (avgAstroCloud < 15) {\n                    summary += `${dateStr}の夜は、雲が少なく<strong>絶好の天体観測日和</strong>です。${moonComment}`;\n                } else if (avgAstroCloud < 40) {\n                    summary += `${dateStr}の夜は、雲は少なめで<strong>観測に適してい ます</strong>。${moonComment}`;\n                } else if (avgAstroCloud < 75) {\n                    summary += `${dateStr}の夜は、雲が出るため観測には<strong>忍耐が必要</strong>かもしれません。`;\n                } else {\n                    summary += `${dateStr}の夜は、雲が多く<strong>観測には不向き</strong>な予 報です。`;\n                }\n            }\n            \n            // innerText -> innerHTML (タグを有効化するため)\n            document.getElementById('forecast-summary').innerHTML = summary;\n\n            // チャート描画 (24時間分 に修正)\n            const sliceStart = currentIndex;\n            const sliceEnd = Math.min(currentIndex + 24, hourly.time.length);\n            \n            const labels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('D日 H時'));\n            const fullDateLabels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('M月D日 H:mm'));\n            \n            const temps = hourly.temperature_2m.slice(sliceStart, sliceEnd);\n            const cloudLow = hourly.cloud_cover_low.slice(sliceStart, sliceEnd);\n            const cloudMid = hourly.cloud_cover_mid.slice(sliceStart, sliceEnd);\n            const cloudHigh = hourly.cloud_cover_high.slice(sliceStart, sliceEnd);\n\n            // 気温チャート\n            const ctxTemp = document.getElementById('tempChart').getContext('2d');\n            if(tempChartInstance) tempChartInstance.destroy();\n\n            let gradientTemp = ctxTemp.createLinearGradient(0, 0, 0, 400);\n            gradientTemp.addColorStop(0, 'rgba(251, 146, 60, 0.5)'); \n            gradientTemp.addColorStop(1, 'rgba(251, 146, 60, 0.0)');\n\n            tempChartInstance = new Chart(ctxTemp, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: '気温 (°C)',\n                        data: temps,\n                        borderColor: '#fb923c',\n                        backgroundColor: gradientTemp,\n                        borderWidth: 3,\n                        pointBackgroundColor: '#fff',\n                        tension: 0.4,\n                        fill: true\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { display: false },\n                        tooltip: { callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] } }\n                    },\n                    scales: {\n                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 雲チャート (積み上げ順を修正: Low -> Mid -> High)\n            // 配色: 下層=Gray-300(変更), 中層=Emerald, 上層=Violet\n            const ctxCloud = document.getElementById('cloudChart').getContext('2d');\n            if(cloudChartInstance) cloudChartInstance.destroy();\n\n            cloudChartInstance = new Chart(ctxCloud, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [\n                        { label: '下層雲', data: cloudLow, borderColor: '#d1d5db', backgroundColor: 'rgba(209, 213, 219, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },\n                        { label: '中層雲', data: cloudMid, borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },\n                        { label: '上層雲', data: cloudHigh, borderColor: '#a78bfa', backgroundColor: 'rgba(167, 139, 250, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 }\n                    ]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { labels: { color: '#cbd5e1' } },\n                        tooltip: {\n                            mode: 'index',\n                            intersect: false,\n                             callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] }\n                        }\n                    },\n                    scales: {\n                        y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 週間予報テーブル\n            const weeklyBody = document.getElementById('weekly-forecast-body');\n            weeklyBody.innerHTML = '';\n            \n            daily.time.forEach((t, i) => {\n                const date = moment(t);\n                const isSelectedDay = date.isSame(targetMoment, 'day');\n                const weatherInfo = getWeatherInfo(daily.weathercode[i]);\n                const maxTemp = daily.temperature_2m_max[i];\n                const minTemp = daily.temperature_2m_min[i];\n                const rainSum = daily.precipitation_sum[i];\n                const rainProb = daily.precipitation_probability_max[i];\n                \n                // 月齢計算\n                const moonInfo = calculateMoonData(date.toDate());\n\n                // 1時間ごとの データから、この日の平均雲量と湿度を計算\n                const dateStr = t; // \"YYYY-MM-DD\"\n                let cloudSum = 0;\n                let humSum = 0;\n                let count = 0;\n                \n                // データ 量が少ないので単純ループで集計\n                hourly.time.forEach((hTime, hIndex) => {\n                    if (hTime.startsWith(dateStr)) {\n                        cloudSum += hourly.cloud_cover[hIndex];\n                        humSum += hourly.relative_humidity_2m[hIndex];\n                        count++;\n                    }\n                });\n                \n                const avgCloud = count > 0 ? Math.round(cloudSum / count) : '-';\n                const avgHum = count > 0 ? Math.round(humSum / count) : '-';\n\n                const row = document.createElement('tr');\n                // cursor-pointer を追加、onclickを追加\n                row.className = `border-b border-slate-700/50 transition cursor-pointer ${isSelectedDay ? 'bg-blue-500/20 border-l-4 border-l-blue-400' : 'hover:bg-white/5'}`;\n                row.onclick = () => selectDate(t); // クリックイベント\n\n                row.innerHTML = `\n                    <td class=\"py-4 px-2\">\n                        <div class=\"font-bold ${isSelectedDay ? 'text-blue-300' : 'text-white'}\">${date.format('M/D')}</div>\n                        <div class=\"text-xs text-slate-400\">${date.format('ddd')}</div>\n                    </td>\n                    <td class=\"py-4 px-2\">\n                        <div class=\"flex items-center gap-3\">\n                            <i data-lucide=\"${weatherInfo.icon}\" class=\"${weatherInfo.color} w-6 h-6\"></i>\n                            <span class=\"hidden md:inline text-sm\">${weatherInfo.label}</span>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm\">${rainProb !== null ? rainProb + '%' : '-'}</div>\n                        <div class=\"text-xs text-blue-300\">${rainSum > 0 ? rainSum + 'mm' : ''}</div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold\">${avgCloud !== '-' ? avgCloud + '%' : '-'}</div>\n                        <div class=\"w-16 bg-slate-700/50 rounded-full h-1 mx-auto mt-1\">\n                            <div class=\"bg-slate-400 h-1 rounded-full\" style=\"width: ${avgCloud !== '-' ? avgCloud : 0}%\"></div>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold text-blue-200 flex items-center justify-center gap-1\">\n                            <i data-lucide=\"droplet\" class=\"w-3 h-3\"></i>\n                            ${avgHum !== '-' ? avgHum + '%' : '-'}\n                        </div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-lg\" title=\"${moonInfo.phaseName} (月齢${moonInfo.age})\">${moonInfo.icon}</div>\n                        <div class=\"text-xs text-slate-400\">${moonInfo.age}</div>\n                    </td>\n                    <td class=\"py-4 px-2 text-right\">\n                        <span class=\"font-bold text-orange-400\">${maxTemp}°</span> \n                        <span class=\"text-slate-500 mx-1\">/</span> \n                        <span class=\"text-blue-300\">${minTemp}°</span>\n                    </td>\n                `;\n                weeklyBody.appendChild(row);\n            });\n            \n            lucide.createIcons();\n\n            document.getElementById('loading').classList.add('hidden');\n            document.getElementById('dashboard-content').classList.remove('hidden');\n        }\n    </script>\n</body>\n</html>\n
./.idea/shelf/2026_01_15_10_59_の_更新_前の未コミットの変更_[変更]/shelved.patch:<+><!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>天体観測できるかな？</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ja.js\"></script>\n    <!-- Lucide Icons -->\n    <script src=\"https://unpkg.com/lucide@latest\"></script>\n    <!-- Leaflet (Map) -->\n    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\" />\n    <script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\"></script>\n    <!-- Astronomy Engine for planetary calculations -->\n    <script src=\"https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js\"></script>\n    <style>\n        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');\n        body { font-family: 'Noto Sans JP', sans-serif; }\n        .glass-panel {\n            background: rgba(255, 255, 255, 0.1);\n            backdrop-filter: blur(10px);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n        }\n        /* Date picker custom styles for dark mode compatibility */\n        input[type=\"datetime-local\"] {\n            color-scheme: dark;\n        }\n        #map {\n            height: 300px;\n            width: 100%;\n            border-radius: 0.75rem;\n            z-index: 1;\n        }\n        /* Leaflet customization */\n        .leaflet-container {\n            background: #1e293b;\n        }\n        /* Night Vision Mode */\n        body.night-vision {\n            filter: hue-rotate(180deg) invert(1);\n            background: #300000 !important;\n        }\n        body.night-vision .glass-panel {\n            background: rgba(100, 0, 0, 0.3) !important;\n            border-color: rgba(200, 0, 0, 0.3) !important;\n        }\n        body.night-vision * {\n            color: #ff6666 !important;\n            border-color: #ff3333 !important;\n        }\n        /* Starry Score Meter */\n        .score-meter {\n            width: 200px;\n            height: 200px;\n            position: relative;\n        }\n        .score-circle {\n            stroke-dasharray: 440;\n            stroke-dashoffset: 440;\n            transition: stroke-dashoffset 1s ease;\n        }\n        /* Timeline styles */\n        .timeline-bar {\n            position: relative;\n            height: 60px;\n            background: linear-gradient(to right, #1e293b 0%, #0f172a 50%, #1e293b 100%);\n            border-radius: 8px;\n            overflow: hidden;\n        }\n        .timeline-segment {\n            position: absolute;\n            height: 100%;\n            opacity: 0.7;\n        }\n    </style>\n</head>\n<body class=\"bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen p-4 md:p-8\">\n\n    <div class=\"max-w-6xl mx-auto space-y-6\">\n        \n        <!-- ヘッダー -->\n        <header class=\"flex flex-col md:flex-row justify-between items-center gap-4\">\n            <div class=\"flex-1\">\n                <!-- メインタイトル -->\n                <h1 class=\"text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-100 via-blue-200 to-blue-400 mb-3 flex items-center gap-3\">\n                    <i data-lucide=\"telescope\" class=\"text-yellow-200 w-8 h-8 md:w-12 md:h-12\"></i>\n                    天体観測できるかな？\n                </h1>\n                \n                <!-- 場所情報 -->\n                <div class=\"flex items-center gap-2 text-xl font-semibold text-slate-200 pl-1\">\n                    <i data-lucide=\"map-pin\" class=\"text-blue-400\"></i>\n                    <span id=\"location-name\">位置情報を取得中...</span>\n                </div>\n                <p class=\"text-slate-400 text-sm mt-1 flex items-center gap-2 pl-1\">\n                    <span id=\"coords-display\">緯度: -- | 経度: --</span>\n                    <button onclick=\"toggleMap()\" class=\"text-blue-300 hover:text-white underline text-xs ml-2\">\n                        地図で 場所を変更\n                    </button>\n                </p>\n            </div>\n            <div class=\"text-right flex flex-col items-end\">\n                <div id=\"current-clock\" class=\"text-xl font-semibold font-mono\">--:--:--</div>\n                <div class=\"text-slate-400 text-sm\">現在時刻 (Asia/Tokyo)</div>\n                <div class=\"text-slate-500 text-xs mt-2 flex items-center gap-2\">\n                    Ver. 2.2.0\n                    <button onclick=\"toggleNightVision()\" class=\"text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded border border-red-600/30\" title=\"ナイトビジョンモード\">\n                        <i data-lucide=\"moon\" class=\"w-3 h-3 inline\"></i>\n                    </button>\n                </div>\n            </div>\n        </header>\n\n        <!-- 地図・位置設定エリア (初期は非表示) -->\n        <div id=\"location-settings\" class=\"hidden glass-panel rounded-xl p-4 space-y-4\">\n            <div class=\"flex flex-wrap justify-between items-center gap-4\">\n                <h3 class=\"font-bold flex items-center gap-2\">\n                    <i data-lucide=\"map\" class=\"w-5 h-5 text-green-400\"></i> 地図から場所を選択\n                </h3>\n                <button onclick=\"getCurrentLocation()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2\">\n                    <i data-lucide=\"crosshair\" class=\"w-4 h-4\"></i> 現在地を取得\n                </button>\n            </div>\n            <p class=\"text-sm text-slate-300\">地図をクリックすると、その場所の天気を表示します。</p>\n            <div id=\"map\"></div>\n        </div>\n\n        <!-- コントロールバー (日時指定) -->\n        <div class=\"glass-panel rounded-xl p-4 flex flex-col sm:flex-row items-center justify-between gap-4\">\n            <div class=\"flex items-center gap-2 text-sm md:text-base\">\n                <i data-lucide=\"settings-2\" class=\"text-slate-300 w-5 h-5\"></i>\n                <span class=\"font-bold\">表示日時を指定:</span>\n            </div>\n            <div class=\"flex items-center gap-3 w-full sm:w-auto\">\n                <input type=\"datetime-local\" id=\"target-datetime\" \n                    class=\"bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-400 w-full sm:w-auto font-mono\"\n                    onchange=\"updateDashboardTime()\">\n                \n                <button onclick=\"resetToNow()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap\">\n                    現在に戻す\n                </button>\n            </div>\n        </div>\n\n        <!-- ロード中表示 -->\n        <div id=\"loading\" class=\"text-center py-20 text-xl animate-pulse\">天気デ ータを取得中...</div>\n        \n        <div id=\"dashboard-content\" class=\"hidden space-y-6\">\n            <!-- 星空視認性スコア（大型表示） -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <div class=\"flex flex-col md:flex-row items-center justify-between gap-6\">\n                    <div class=\"flex flex-col items-center justify-center\">\n                        <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                            <i data-lucide=\"sparkles\" class=\"text-yellow-400 w-5 h-5\"></i> 星空視認性スコア\n                        </h3>\n                        <svg class=\"score-meter\" viewBox=\"0 0 160 160\">\n                            <circle cx=\"80\" cy=\"80\" r=\"70\" fill=\"none\" stroke=\"#334155\" stroke-width=\"12\"/>\n                            <circle id=\"score-circle\" class=\"score-circle\" cx=\"80\" cy=\"80\" r=\"70\" fill=\"none\" stroke=\"url(#scoreGradient)\" stroke-width=\"12\" stroke-linecap=\"round\" transform=\"rotate(-90 80 80)\"/>\n                            <defs>\n                                <linearGradient id=\"scoreGradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\n                                    <stop offset=\"0%\" style=\"stop-color:#ef4444;stop-opacity:1\" />\n                                    <stop offset=\"50%\" style=\"stop-color:#eab308;stop-opacity:1\" />\n                                    <stop offset=\"100%\" style=\"stop-color:#22c55e;stop-opacity:1\" />\n                                </linearGradient>\n                            </defs>\n                            <text id=\"score-text\" x=\"80\" y=\"75\" text-anchor=\"middle\" font-size=\"36\" font-weight=\"bold\" fill=\"#fff\">--</text>\n                            <text x=\"80\" y=\"95\" text-anchor=\"middle\" font-size=\"12\" fill=\"#94a3b8\">/ 100</text>\n                        </svg>\n                        <p id=\"score-comment\" class=\"text-sm text-slate-300 mt-3 text-center\">計算中...</p>\n                    </div>\n\n                    <!-- お気に入り地点 -->\n                    <div class=\"flex-1 w-full\">\n                        <h4 class=\"font-semibold text-sm mb-3 flex items-center gap-2\">\n                            <i data-lucide=\"bookmark\" class=\"w-4 h-4 text-blue-400\"></i>\n                            お気に入り地点\n                        </h4>\n                        <div id=\"favorite-locations\" class=\"space-y-2\">\n                            <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                                <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                                現在地をお気に入りに追加\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- メイン指標 -->\n            <div class=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <!-- 気温カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden group hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の気温</div>\n                    <i data-lucide=\"thermometer\" class=\"w-12 h-12 text-orange-400 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-temp\">--°C</div>\n                    <div class=\"text-slate-300\">気温</div>\n                </div>\n\n                <!-- 雲量カード -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden hover:bg-white/5 transition\">\n                    <div class=\"absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider\">指定時刻の雲量</div>\n                    <i data-lucide=\"cloud\" class=\"w-12 h-12 text-slate-300 mb-4\"></i>\n                    <div class=\"text-5xl font-bold mb-1\" id=\"current-clouds\">--%</div>\n                    <div class=\"text-slate-300\">全天雲量</div>\n                </div>\n\n                <!-- 雲の詳細 -->\n                <div class=\"glass-panel rounded-2xl p-6 flex flex-col justify-center gap-4 hover:bg-white/5 transition\">\n                    <div class=\"text-slate-400 text-sm font-medium uppercase tracking-wider mb-2\">雲の層（高度別）</div>\n                    \n                    <div class=\"flex justify-between items-center\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-up\" class=\"w-4 h-4\"></i> 上層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-high\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 上層雲: Violet -->\n                        <div id=\"bar-high\" class=\"bg-violet-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"minus\" class=\"w-4 h-4\"></i> 中層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-mid\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 中層雲: Emerald -->\n                        <div id=\"bar-mid\" class=\"bg-emerald-400 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n\n                    <div class=\"flex justify-between items-center mt-1\">\n                        <span class=\"text-slate-300 flex items-center gap-2\"><i data-lucide=\"arrow-down\" class=\"w-4 h-4\"></i> 下層雲</span>\n                        <span class=\"font-bold text-lg\" id=\"clouds-low\">--%</span>\n                    </div>\n                    <div class=\"w-full bg-slate-700/50 rounded-full h-2\">\n                        <!-- 下層雲: 明るいグレー -->\n                        <div id=\"bar-low\" class=\"bg-gray-300 h-2 rounded-full\" style=\"width: 0%\"></div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 追加気象データ + 天文薄明時刻 -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                <!-- 追加気象データ -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"gauge\" class=\"text-cyan-400 w-5 h-5\"></i> 詳細気象デー タ\n                    </h3>\n                    <div class=\"grid grid-cols-2 gap-4\">\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">風速・風向</div>\n                            <div class=\"text-xl font-bold\" id=\"wind-speed\">-- m/s</div>\n                            <div class=\"text-sm text-slate-300\" id=\"wind-direction\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">気圧</div>\n                            <div class=\"text-xl font-bold\" id=\"pressure\">-- hPa</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">露点温度</div>\n                            <div class=\"text-xl font-bold\" id=\"dewpoint\">--°C</div>\n                            <div class=\"text-xs text-slate-400\" id=\"condensation-risk\">--</div>\n                        </div>\n                        <div class=\"bg-slate-800/50 rounded-lg p-3\">\n                            <div class=\"text-xs text-slate-400 mb-1\">視 程</div>\n                            <div class=\"text-xl font-bold\" id=\"visibility\">-- km</div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- 天文薄明・日月出没時刻 -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"sunrise\" class=\"text-orange-400 w-5 h-5\"></i> 天文 薄明・出没時刻\n                    </h3>\n                    <div class=\"space-y-3\">\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明開始</span>\n                            <span class=\"font-mono font-bold\" id=\"twilight-astro-begin\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の出</span>\n                            <span class=\"font-mono font-bold\" id=\"sunrise-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">日の入</span>\n                            <span class=\"font-mono font-bold\" id=\"sunset-time\">--:--</span>\n                        </div>\n                        <div class=\"flex items-center justify-between text-sm\">\n                            <span class=\"text-slate-300\">天文薄明終了</span>\n                            <span class=\"font-mono font-bold text-green-300\" id=\"twilight-astro-end\">--:--</span>\n                        </div>\n                        <div class=\"border-t border-slate-700 pt-3 mt-3\">\n                            <div class=\"flex items-center justify-between text-sm\">\n                                <span class=\"text-slate-300\">月の出</span>\n                                <span class=\"font-mono font-bold\" id=\"moonrise-time\">--:--</span>\n                            </div>\n                            <div class=\"flex items-center justify-between text-sm mt-2\">\n                                <span class=\"text-slate-300\">月の入</span>\n                                <span class=\"font-mono font-bold\" id=\"moonset-time\">--:--</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 24時間タイムライン -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"clock\" class=\"text-purple-400 w-5 h-5\"></i> 24時間観測適性タイムライン\n                </h3>\n                <div id=\"timeline-container\" class=\"timeline-bar\"></div>\n                <div class=\"flex items-center justify-between mt-3 text-xs text-slate-400\">\n                    <span>00:00</span>\n                    <span>06:00</span>\n                    <span>12:00</span>\n                    <span>18:00</span>\n                    <span>24:00</span>\n                </div>\n                <div class=\"flex items-center gap-4 mt-3 text-xs flex-wrap\">\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-yellow-500/50 rounded\"></div>\n                        <span>日 中</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-blue-500/50 rounded\"></div>\n                        <span>薄明</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-green-500/50 rounded\"></div>\n                        <span>観測適時</span>\n                    </div>\n                    <div class=\"flex items-center gap-1\">\n                        <div class=\"w-4 h-4 bg-slate-500/50 rounded\"></div>\n                        <span>月明かり</span>\n                    </div>\n                </div>\n            </div>\n\n             <!-- サマリーエリア（拡張版：天気分析＋月齢） -->\n             <div class=\"glass-panel rounded-2xl p-6\">\n                <div class=\"flex flex-col md:flex-row gap-6\">\n                    <!-- 左側：天気サマリー -->\n                    <div class=\"flex-1 flex flex-col justify-center border-l-4 border-blue-400 pl-4\">\n                        <p class=\"text-slate-300 italic\" id=\"forecast-summary\">予報を分析中...</p>\n                        <p class=\"text-xs text-slate-500 mt-2\" id=\"summary-timestamp\">--</p>\n                    </div>\n\n                    <!-- 右側：月齢情報 -->\n                    <div class=\"flex flex-col items-center justify-center min-w-[150px] border-t md:border-t-0 md:border-l border-slate-700 pt-4 md:pt-0 md:pl-6\">\n                        <div class=\"text-xs text-slate-400 mb-1 uppercase tracking-wider\">Moon Phase</div>\n                        <div class=\"text-4xl mb-1\" id=\"current-moon-icon\">\uD83C\uDF11</div>\n                        <div class=\"text-xl font-bold text-yellow-100\" id=\"current-moon-age-text\">--</div>\n                        <div class=\"text-sm text-yellow-200\" id=\"current-moon-name\">--</div>\n                    </div>\n                </div>\n             </div>\n\n            <!-- 天体イベント情報セクション -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"star\" class=\"text-yellow-400 w-5 h-5\"></i> 天体イベント情報\n                </h3>\n\n                <div class=\"space-y-3\">\n                    <!-- 今夜見える惑星 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('planets')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"planet\" class=\"w-4 h-4 text-purple-400\"></i>\n                                <span class=\"font-semibold text-sm\">今夜見える惑星</span>\n                            </div>\n                            <i id=\"icon-planets\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-planets\" class=\"hidden px-4 pb-4\">\n                            <div id=\"visible-planets\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算 中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 流星群カレンダー -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('meteors')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"zap\" class=\"w-4 h-4 text-yellow-400\"></i>\n                                <span class=\"font-semibold text-sm\">流星群カレンダー</span>\n                            </div>\n                            <i id=\"icon-meteors\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-meteors\" class=\"hidden px-4 pb-4\">\n                            <div id=\"meteor-showers\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">読み込み中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- ISS現在位置 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('iss-location-acc')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"satellite\" class=\"w-4 h-4 text-blue-400\"></i>\n                                <span class=\"font-semibold text-sm\">ISS現在位置</span>\n                            </div>\n                            <i id=\"icon-iss-location-acc\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-iss-location-acc\" class=\"hidden px-4 pb-4\">\n                            <div id=\"iss-location\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\"> 取得中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- ISS乗員情報 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('astronauts')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"users\" class=\"w-4 h-4 text-purple-400\"></i>\n                                <span class=\"font-semibold text-sm\">ISS乗員情報</span>\n                            </div>\n                            <i id=\"icon-astronauts\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-astronauts\" class=\"hidden px-4 pb-4\">\n                            <div id=\"iss-astronauts\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">取得中...</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- 月齢による観測推奨天体 -->\n                    <div class=\"bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden\">\n                        <button onclick=\"toggleAccordion('recommended')\" class=\"w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition\">\n                            <div class=\"flex items-center gap-2\">\n                                <i data-lucide=\"telescope\" class=\"w-4 h-4 text-green-400\"></i>\n                                <span class=\"font-semibold text-sm\">月齢による観測推奨天体</span>\n                            </div>\n                            <i id=\"icon-recommended\" data-lucide=\"chevron-down\" class=\"w-4 h-4 transition-transform\"></i>\n                        </button>\n                        <div id=\"content-recommended\" class=\"hidden px-4 pb-4\">\n                            <div id=\"recommended-objects\" class=\"space-y-2 text-sm\">\n                                <div class=\"text-slate-400\">計算中...</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 観測適性レーダーチャート -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"radar\" class=\"text-pink-400 w-5 h-5\"></i> 観測適性レーダーチャート\n                </h3>\n                <div class=\"relative h-80 w-full\">\n                    <canvas id=\"radarChart\"></canvas>\n                </div>\n                <p class=\"text-xs text-slate-400 mt-2 text-center\">各要素が外側に近いほど観測に適した条件です</p>\n            </div>\n\n            <!-- チャートセクショ ン -->\n            <div class=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <!-- 気温チャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"clock\" class=\"text-orange-400 w-5 h-5\"></i> 気温予報 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"tempChart\"></canvas>\n                    </div>\n                </div>\n\n                <!-- 雲の積層チャート -->\n                <div class=\"glass-panel rounded-2xl p-6\">\n                    <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                        <i data-lucide=\"layers\" class=\"text-blue-400 w-5 h-5\"></i> 雲量推移 (指定時刻より24時間)\n                    </h3>\n                    <div class=\"relative h-64 w-full\">\n                        <canvas id=\"cloudChart\"></canvas>\n                    </div>\n                </div>\n            </div>\n\n            <!-- 週間天気予報 -->\n            <div class=\"glass-panel rounded-2xl p-6\">\n                <h3 class=\"text-lg font-semibold mb-4 flex items-center gap-2\">\n                    <i data-lucide=\"calendar\" class=\"text-green-400 w-5 h-5\"></i> 週間天気予報\n                    <span class=\"text-xs font-normal text-slate-400 ml-2\">※日付をクリックするとその日の詳細を表示します</span>\n                </h3>\n                <div class=\"overflow-x-auto\">\n                    <table class=\"w-full text-left border-collapse\">\n                        <thead>\n                            <tr class=\"text-slate-400 text-sm border-b border-slate-700\">\n                                <th class=\"py-3 px-2\">日付</th>\n                                <th class=\"py-3 px-2\">天気</th>\n                                <th class=\"py-3 px-2 text-center\">降水確率 / 量</th>\n                                <th class=\"py-3 px-2 text-center\">平均雲量</th>\n                                <th class=\"py-3 px-2 text-center\">平 均湿度</th>\n                                <th class=\"py-3 px-2 text-center\">月齢</th>\n                                <th class=\"py-3 px-2 text-right\"> 最高 / 最低気温</th>\n                            </tr>\n                        </thead>\n                        <tbody id=\"weekly-forecast-body\" class=\"text-sm md:text-base\">\n                            <!-- JSで生成 -->\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        </div>\n\n        <!-- フッター (APIクレジット) -->\n        <footer class=\"glass-panel rounded-xl p-4 text-center text-slate-400 text-sm\">\n            <p>\n                Data sources: \n                <a href=\"https://open-meteo.com/\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">Open-Meteo</a> (Weather Data) & \n                <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-300 hover:underline\">OpenStreetMap</a> (Map & Address Data)\n            </p>\n        </footer>\n\n    </div>\n\n    <script>\n        // --- 初期設定 ---\n        lucide.createIcons();\n        moment.locale('ja'); \n\n        let mapInstance = null;\n        let markerInstance = null;\n        let weatherData = null;\n        let tempChartInstance = null;\n        let cloudChartInstance = null;\n        let radarChartInstance = null;\n        let favoriteLocations = JSON.parse(localStorage.getItem('favoriteLocations') || '[]');\n\n        // デフォルト位置（三島市）\n        let currentLat = 35.1167;\n        let currentLon = 138.9167;\n\n        // --- ナイトビジョンモード ---\n        function toggleNightVision() {\n            document.body.classList.toggle('night-vision');\n            const isNight = document.body.classList.contains('night-vision');\n            localStorage.setItem('nightVisionMode', isNight);\n        }\n\n        // ページロード時にナイトビジョンモードを 復元\n        if (localStorage.getItem('nightVisionMode') === 'true') {\n            document.body.classList.add('night-vision');\n        }\n\n        // ---  アコーディオン機能 ---\n        function toggleAccordion(id) {\n            const content = document.getElementById('content-' + id);\n            const icon = document.getElementById('icon-' + id);\n\n            if (content.classList.contains('hidden')) {\n                content.classList.remove('hidden');\n                icon.style.transform = 'rotate(180deg)';\n            } else {\n                content.classList.add('hidden');\n                icon.style.transform = 'rotate(0deg)';\n            }\n\n            // Lucideアイコンを再初期化\n            lucide.createIcons();\n        }\n\n        // --- お気に入り地点管理 ---\n        function addFavoriteLocation() {\n            const name = prompt('この地点の名前を入力してください:', document.getElementById('location-name').innerText || '未設定');\n            if (name) {\n                const location = {\n                    name: name,\n                    lat: currentLat,\n                    lon: currentLon\n                };\n                favoriteLocations.push(location);\n                if (favoriteLocations.length > 5) favoriteLocations.shift(); // 最大5件\n                localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n                renderFavoriteLocations();\n            }\n        }\n\n        function renderFavoriteLocations() {\n            const container = document.getElementById('favorite-locations');\n            if (favoriteLocations.length === 0) {\n                container.innerHTML = `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-4 h-4\"></i>\n                        現在地 をお気に入りに追加\n                    </button>\n                `;\n            } else {\n                container.innerHTML = favoriteLocations.map((loc, index) => `\n                    <div class=\"bg-slate-800/50 rounded-lg p-2 flex items-center justify-between border border-slate-700\">\n                        <button onclick=\"loadFavoriteLocation(${index})\" class=\"flex-1 text-left text-sm hover:text-blue-300\">\n                            <i data-lucide=\"map-pin\" class=\"w-3 h-3 inline mr-1\"></i>\n                            ${loc.name}\n                        </button>\n                        <button onclick=\"removeFavoriteLocation(${index})\" class=\"text-red-400 hover:text-red-300 text-xs\">\n                            <i data-lucide=\"x\" class=\"w-3 h-3\"></i>\n                        </button>\n                    </div>\n                `).join('') + `\n                    <button onclick=\"addFavoriteLocation()\" class=\"w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-2 text-xs border border-slate-700 flex items-center justify-center gap-2\">\n                        <i data-lucide=\"plus\" class=\"w-3 h-3\"></i>\n                        追加\n                    </button>\n                `;\n            }\n            lucide.createIcons();\n        }\n\n        function loadFavoriteLocation(index) {\n            const loc = favoriteLocations[index];\n            updateAppLocation(loc.lat, loc.lon);\n        }\n\n        function removeFavoriteLocation(index) {\n            favoriteLocations.splice(index, 1);\n            localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));\n            renderFavoriteLocations();\n        }\n\n        // --- 星空視認性スコア計算 ---\n        function calculateStarryScore(cloudCover, moonAge, humidity, visibility = 24, windSpeed = 5) {\n            // 雲量スコア (0-100) - 雲が少ないほど高い\n            const cloudScore = Math.max(0, 100 - cloudCover);\n\n            // 月明かりスコア (0-100) - 新月に近いほど高い\n            const moonScore = moonAge < 3 || moonAge > 26 ? 100 :\n                             moonAge < 10 || moonAge > 18 ? 60 : 20;\n\n            // 湿度スコア (0-100) - 湿度が低いほど高い\n            const humidityScore = Math.max(0, 100 - humidity);\n\n            // 視程スコア (0-100)\n            const visibilityScore = Math.min(100, (visibility / 50) * 100);\n\n            // 風速スコア (0-100) - 風が弱いほど高い\n            const windScore = windSpeed < 2 ? 100 : windSpeed < 5 ? 80 : windSpeed < 10 ? 50 : 20;\n\n            // 加重平均 (雲量と月明かりを重視)\n            const totalScore = (cloudScore * 0.4 + moonScore * 0.3 + humidityScore * 0.15 + visibilityScore * 0.1 + windScore * 0.05);\n\n            return Math.round(totalScore);\n        }\n\n        function updateStarryScore(score) {\n            const circle = document.getElementById('score-circle');\n            const text = document.getElementById('score-text');\n            const comment = document.getElementById('score-comment');\n\n            // スコアに応じた円の進行度 (0-100 を0-440に変換)\n            const dashOffset = 440 - (score / 100) * 440;\n            circle.style.strokeDashoffset = dashOffset;\n\n            text.textContent = score;\n\n            // コメント\n            if (score >= 80) {\n                comment.textContent = '⭐ 絶好の観測日和！星空が最高に美しく見えるでしょ う';\n            } else if (score >= 60) {\n                comment.textContent = '✨ 観測に適した条件です。良い星空が期待できます';\n            } else if (score >= 40) {\n                comment.textContent = '\uD83C\uDF24\uFE0F まずまず の条件。明るい星は観測できます';\n            } else if (score >= 20) {\n                comment.textContent = '☁\uFE0F やや条件が悪いです。観測には忍耐が必要かも';\n            } else {\n                comment.textContent = '❌ 観測には不 向きな条件です';\n            }\n        }\n\n        // 時計更新\n        setInterval(() => {\n            document.getElementById('current-clock').textContent = moment().format('HH:mm:ss');\n        }, 1000);\n\n        // --- アプリケー ション起動フロー ---\n        window.addEventListener('load', () => {\n            // お気に入り地点を表示\n            renderFavoriteLocations();\n            // 現在地取得を試みる\n            getCurrentLocation(true); // true = 初回起動 時の自動取得\n        });\n\n        // --- 位置情報関連 ---\n\n        // ブラ ウザの現在地取得\n        function getCurrentLocation(isInitial = false) {\n            if (!navigator.geolocation) {\n                if(!isInitial) alert(\"このブラウザは位置情報をサポートしていません。\");\n                initializeDashboardWithCurrentCoords(); // デフォルトで起動\n                return;\n            }\n\n            // ロード表示\n            document.getElementById('loading').innerHTML = '現在地を取得中...';\n            document.getElementById('loading').classList.remove('hidden');\n\n            navigator.geolocation.getCurrentPosition(\n                (position) => {\n                    currentLat = position.coords.latitude;\n                    currentLon = position.coords.longitude;\n                    updateAppLocation(currentLat, currentLon);\n                },\n                (error) => {\n                    console.warn(\"位置情 報取得失敗:\", error.message);\n                    if(!isInitial) alert(\"位置 情報を取得できませんでした。\");\n                    // 失敗した場合はデフォル ト位置（三島）で開始\n                    initializeDashboardWithCurrentCoords(); \n                }\n            );\n        }\n\n        // 座標を指定してア プリ全体を更新するメイン関数\n        async function updateAppLocation(lat, lon) {\n            currentLat = lat;\n            currentLon = lon;\n\n            // 1. UIの座標表示更新\n            document.getElementById('coords-display').innerText = `緯度: ${lat.toFixed(4)} | 経度: ${lon.toFixed(4)}`;\n\n            // 2. 住所取得 (逆ジオコーディング)\n            fetchAddress(lat, lon);\n\n            // 3. 地図マーカー更新（地図が開いている、または初期化されている場合）\n            if (mapInstance) {\n                updateMapMarker(lat, lon);\n            }\n\n            // 4. 天気データ取得\n            await fetchWeather(lat, lon);\n\n            // 5. ISS現在位置を取得\n            await fetchISSLocation();\n\n            // 6. ISS乗員情報を取得\n            await fetchAstronauts();\n        }\n\n        // 住所取得 (OpenStreetMap Nominatim API)\n        async function fetchAddress(lat, lon) {\n            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=ja`;\n            \n            try {\n                const response = await fetch(url, {\n                    headers: { 'User-Agent': 'WeatherDashboardDemo/1.0' } // マナーとしてUser-Agentを設定\n                });\n                const data = await response.json();\n                \n                if (data && data.address) {\n                    const addr = data.address;\n                    // 見やすい住所を構築（県 + 市町村 + 町名）\n                    const pref = addr.province || addr.state || '';\n                    const city = addr.city || addr.ward || addr.town || addr.village || '';\n                    const sub = addr.suburb || addr.quarter || addr.neighbourhood || '';\n                    \n                    const fullName = `${pref} ${city} ${sub}`.trim() || \"不明な場所\";\n                    document.getElementById('location-name').innerText = fullName;\n                } else {\n                    document.getElementById('location-name').innerText = \"住所不明\";\n                }\n            } catch (error) {\n                console.error(\"住所取得エラー:\", error);\n                document.getElementById('location-name').innerText = \"住所取得失敗\";\n            }\n        }\n\n        // デフォルト/現在の座標で初期化\n        function initializeDashboardWithCurrentCoords() {\n            updateAppLocation(currentLat, currentLon);\n        }\n\n        // --- 地図機能 ---\n\n        function toggleMap() {\n            const container = document.getElementById('location-settings');\n            const isHidden = container.classList.contains('hidden');\n            \n            if (isHidden) {\n                container.classList.remove('hidden');\n                // 地図が 初めて表示されるときに初期化\n                if (!mapInstance) {\n                    initMap();\n                } else {\n                    // サイズ再計算（hiddenから復帰時に必要）\n                    setTimeout(() => mapInstance.invalidateSize(), 100);\n                }\n            } else {\n                container.classList.add('hidden');\n            }\n        }\n\n        function initMap() {\n            // 地図初期化\n            mapInstance = L.map('map').setView([currentLat, currentLon], 13);\n\n            // OpenStreetMapタイル\n            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n            }).addTo(mapInstance);\n\n            // マーカー追加\n            markerInstance = L.marker([currentLat, currentLon], {draggable: false}).addTo(mapInstance);\n\n            // マップクリ ックイベント\n            mapInstance.on('click', function(e) {\n                const lat = e.latlng.lat;\n                const lon = e.latlng.lng;\n                updateAppLocation(lat, lon);\n            });\n        }\n\n        function updateMapMarker(lat, lon) {\n            if (markerInstance) {\n                markerInstance.setLatLng([lat, lon]);\n            }\n            mapInstance.panTo([lat, lon]);\n        }\n\n        // --- ヘルパー関数 ---\n        function getWindDirection(degrees) {\n            const directions = ['北', '北北東', '北東', '東北東', '東', '東南東', '南東', '南南東', '南', '南南西', '南西', ' 西南西', '西', '西北西', '北西', '北北西'];\n            const index = Math.round(degrees / 22.5) % 16;\n            return directions[index];\n        }\n\n        // --- レーダーチャート描画 ---\n        function renderRadarChart(data) {\n            const ctx = document.getElementById('radarChart').getContext('2d');\n            if (radarChartInstance) radarChartInstance.destroy();\n\n            radarChartInstance = new Chart(ctx, {\n                type: 'radar',\n                data: {\n                    labels: ['雲の少なさ', '月の暗さ', '低湿 度', '高視程', '風の穏やかさ'],\n                    datasets: [{\n                        label: '観測適性',\n                        data: [data.cloudClearness, data.moonDarkness, data.lowHumidity, data.goodVisibility, data.calmWind],\n                        backgroundColor: 'rgba(34, 197, 94, 0.2)',\n                        borderColor: 'rgba(34, 197, 94, 1)',\n                        borderWidth: 2,\n                        pointBackgroundColor: 'rgba(34, 197, 94, 1)',\n                        pointBorderColor: '#fff',\n                        pointHoverBackgroundColor: '#fff',\n                        pointHoverBorderColor: 'rgba(34, 197, 94, 1)'\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    scales: {\n                        r: {\n                            beginAtZero: true,\n                            max: 100,\n                            ticks: {\n                                stepSize: 20,\n                                color: '#94a3b8'\n                            },\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)'\n                            },\n                            pointLabels: {\n                                color: '#cbd5e1',\n                                font: {\n                                    size: 12\n                                }\n                            }\n                        }\n                    },\n                    plugins: {\n                        legend: {\n                            display: false\n                        }\n                    }\n                }\n            });\n        }\n\n        // --- 流星群データ (年間イベント) ---\n        const meteorShowers = [\n            { name: \"しぶんぎ座流星群\", peakStart: \"01-03\", peakEnd: \"01-04\", rate: \"120個/時\", note: \"年始の三大流星群\" },\n            { name: \"こと座流星群\", peakStart: \"04-22\", peakEnd: \"04-23\", rate: \"18個/時\", note: \"安定した流星群\" },\n            { name: \"みずがめ座η 流星群\", peakStart: \"05-06\", peakEnd: \"05-07\", rate: \"50個/時\", note: \" 南半球で好条件\" },\n            { name: \"ペルセウス座流星群\", peakStart: \"08-12\", peakEnd: \"08-13\", rate: \"100個/時\", note: \"三大流星群の一つ\" },\n            { name: \"オリオン座流星群\", peakStart: \"10-21\", peakEnd: \"10-22\", rate: \"20個/時\", note: \"ハレー彗星起源\" },\n            { name: \"しし座流星群\", peakStart: \"11-17\", peakEnd: \"11-18\", rate: \"15個/時\", note: \"33 年周期で大出現\" },\n            { name: \"ふたご座流星群\", peakStart: \"12-13\", peakEnd: \"12-14\", rate: \"120個/時\", note: \"三大流星群の一つ\" },\n            { name: \"こぐま座流星群\", peakStart: \"12-22\", peakEnd: \"12-23\", rate: \"10個/時\", note: \"安定した観測\" }\n        ];\n\n        // --- 月齢計算ロジック ---\n        function calculateMoonData(date) {\n            // 2000年1月6日 18:14 (UTC) は新月 (Lunation Number 953)\n            // 簡易計算のため、UTCでの日付差分を利用\n            const knownNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0)); \n            const diffTime = date.getTime() - knownNewMoon.getTime();\n            const diffDays = diffTime / (1000 * 60 * 60 * 24);\n            const synodicMonth = 29.53058867;\n            \n            let age = diffDays % synodicMonth;\n            if (age < 0) age += synodicMonth;\n            \n            // 月相の判定\n            let phaseName = \"\";\n            let icon = \"\";\n            \n            // 絵文字と名前のマッピング (簡易版)\n            if (age < 1.0 || age > 28.5) { phaseName = \"新月\"; icon = \"\uD83C\uDF11\"; }\n            else if (age < 6.0) { phaseName = \"三日月\"; icon = \"\uD83C\uDF12\"; }\n            else if (age < 9.0) { phaseName = \"上弦の月\"; icon = \"\uD83C\uDF13\"; }\n            else if (age < 13.5) { phaseName = \"十日 夜\"; icon = \"\uD83C\uDF14\"; }\n            else if (age < 16.5) { phaseName = \"満月\"; icon = \"\uD83C\uDF15\"; }\n            else if (age < 21.0) { phaseName = \"立待月\"; icon = \"\uD83C\uDF16\"; }\n            else if (age < 24.0) { phaseName = \"下弦の月\"; icon = \"\uD83C\uDF17\"; }\n            else { phaseName = \"有明月\"; icon = \"\uD83C\uDF18\"; }\n\n            return {\n                age: age.toFixed(1),\n                phaseName: phaseName,\n                icon: icon\n            };\n        }\n\n        // --- 日の出入り・月の出入 り・天文薄明計算 ---\n        function calculateSunMoonTimes(date, lat, lon) {\n            try {\n                const observer = new Astronomy.Observer(lat, lon, 0);\n\n                // 日の出・日の入り\n                const sunrise = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, 1, date, 1);\n                const sunset = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, date, 1);\n\n                // 天文薄明 (-18度)\n                const astroTwilightMorning = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, -1, date, 1, -18);\n                const astroTwilightEvening = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, 1, date, 1, -18);\n\n                // 月の出・月の入り\n                const moonrise = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, 1, date, 1);\n                const moonset = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, date, 1);\n\n                return {\n                    sunrise: sunrise ? moment(sunrise.date).format('HH:mm') : '--:--',\n                    sunset: sunset ? moment(sunset.date).format('HH:mm') : '--:--',\n                    astroTwilightBegin: astroTwilightMorning ? moment(astroTwilightMorning.date).format('HH:mm') : '--:--',\n                    astroTwilightEnd: astroTwilightEvening ? moment(astroTwilightEvening.date).format('HH:mm') : '--:--',\n                    moonrise: moonrise ? moment(moonrise.date).format('HH:mm') : '--:--',\n                    moonset: moonset ? moment(moonset.date).format('HH:mm') : '--:--',\n                    sunriseDate: sunrise ? sunrise.date : null,\n                    sunsetDate: sunset ? sunset.date : null,\n                    astroBeginDate: astroTwilightMorning ? astroTwilightMorning.date : null,\n                    astroEndDate: astroTwilightEvening ? astroTwilightEvening.date : null\n                };\n            } catch (error) {\n                console.error('日月時刻計算エラー:', error);\n                return {\n                    sunrise: '--:--',\n                    sunset: '--:--',\n                    astroTwilightBegin: '--:--',\n                    astroTwilightEnd: '--:--',\n                    moonrise: '--:--',\n                    moonset: '--:--'\n                };\n            }\n        }\n\n        function updateSunMoonDisplay(times) {\n            document.getElementById('sunrise-time').innerText = times.sunrise;\n            document.getElementById('sunset-time').innerText = times.sunset;\n            document.getElementById('twilight-astro-begin').innerText = times.astroTwilightBegin;\n            document.getElementById('twilight-astro-end').innerText = times.astroTwilightEnd;\n            document.getElementById('moonrise-time').innerText = times.moonrise;\n            document.getElementById('moonset-time').innerText = times.moonset;\n        }\n\n        // --- 24時間タイムライン描画 ---\n        function renderTimeline(times, targetDate) {\n            const container = document.getElementById('timeline-container');\n            container.innerHTML = '';\n\n            const dayStart = moment(targetDate).startOf('day');\n            const dayEnd = moment(targetDate).endOf('day');\n\n            // セグメントを追加\n            const segments = [];\n\n            // 日中（日の出～日の入り）\n            if (times.sunriseDate && times.sunsetDate) {\n                const sunriseTime = moment(times.sunriseDate);\n                const sunsetTime = moment(times.sunsetDate);\n\n                const start = ((sunriseTime - dayStart) / (dayEnd - dayStart)) * 100;\n                const width = ((sunsetTime - sunriseTime) / (dayEnd - dayStart)) * 100;\n\n                segments.push({ start, width, color: '#eab308', label: '日中' });\n            }\n\n            // 天文薄明\n            if (times.astroBeginDate && times.astroEndDate) {\n                const astroBegin = moment(times.astroBeginDate);\n                const astroEnd = moment(times.astroEndDate);\n\n                // 朝の薄明\n                const morningStart = ((astroBegin - dayStart) / (dayEnd - dayStart)) * 100;\n                const morningWidth = ((moment(times.sunriseDate) - astroBegin) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: morningStart, width: morningWidth, color: '#3b82f6', label: '朝薄明' });\n\n                // 夕方の薄明\n                const eveningStart = ((moment(times.sunsetDate) - dayStart) / (dayEnd - dayStart)) * 100;\n                const eveningWidth = ((astroEnd - moment(times.sunsetDate)) / (dayEnd - dayStart)) * 100;\n                segments.push({ start: eveningStart, width: eveningWidth, color: '#3b82f6', label: '夕薄明' });\n\n                // 観測適時（天文薄明終了後～天文薄明開始前）\n                const observeStart = ((astroEnd - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeEnd = ((astroBegin.clone().add(1, 'day') - dayStart) / (dayEnd - dayStart)) * 100;\n                const observeWidth = observeEnd - observeStart;\n                if (observeWidth > 0) {\n                    segments.push({ start: observeStart, width: observeWidth, color: '#22c55e', label: '観測適時' });\n                }\n            }\n\n            // セグメン トを描画\n            segments.forEach(seg => {\n                const div = document.createElement('div');\n                div.className = 'timeline-segment';\n                div.style.left = `${seg.start}%`;\n                div.style.width = `${seg.width}%`;\n                div.style.background = seg.color;\n                div.title = seg.label;\n                container.appendChild(div);\n            });\n        }\n\n        // --- 天体イベント関数 ---\n\n        // 1. 今夜見える惑星を計算\n        function calculateVisiblePlanets(observerDate, observerLat, observerLon) {\n            try {\n                const observer = new Astronomy.Observer(observerLat, observerLon, 0);\n                const planets = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];\n                const planetNames = {\n                    'Mercury': '水星',\n                    'Venus': '金星',\n                    'Mars': '火星',\n                    'Jupiter': '木星',\n                    'Saturn': '土星'\n                };\n                const planetIcons = {\n                    'Mercury': '⚫',\n                    'Venus': '\uD83C\uDF1F',\n                    'Mars': '\uD83D\uDD34',\n                    'Jupiter': '\uD83D\uDFE0',\n                    'Saturn': '\uD83E\uDE90'\n                };\n\n                let visiblePlanets = [];\n\n                planets.forEach(planet => {\n                    const equator = Astronomy.Equator(planet, observerDate, observer, true, true);\n                    const horizon = Astronomy.Horizon(observerDate, observer, equator.ra, equator.dec, 'normal');\n                    const illumination = Astronomy.Illumination(planet, observerDate);\n\n                    // 地平線より上（高度 > 0）で、ある程度明るい天体のみ表示\n                    if (horizon.altitude > 0) {\n                        visiblePlanets.push({\n                            name: planetNames[planet],\n                            icon: planetIcons[planet],\n                            altitude: horizon.altitude.toFixed(1),\n                            azimuth: horizon.azimuth.toFixed(1),\n                            magnitude: illumination.mag.toFixed(1)\n                        });\n                    }\n                });\n\n                // HTMLに表示\n                const container = document.getElementById('visible-planets');\n                if (visiblePlanets.length === 0) {\n                    container.innerHTML = '<div class=\"text-slate-400\">現在、地平線上に惑星はありません</div>';\n                } else {\n                    container.innerHTML = visiblePlanets.map(p => `\n                        <div class=\"flex items-center justify-between bg-slate-700/30 rounded-lg p-2\">\n                            <div class=\"flex items-center gap-2\">\n                                <span class=\"text-lg\">${p.icon}</span>\n                                <span class=\"font-semibold\">${p.name}</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400\">\n                                高度: ${p.altitude}° | 方位: ${p.azimuth}° | 等級: ${p.magnitude}\n                            </div>\n                        </div>\n                    `).join('');\n                }\n            } catch (error) {\n                console.error('惑星計算エラー:', error);\n                document.getElementById('visible-planets').innerHTML = '<div class=\"text-red-400\">計算エラー</div>';\n            }\n        }\n\n        // 2. 流星群カレンダーを更新\n        function updateMeteorShowers(targetDate) {\n            const currentYear = targetDate.getFullYear();\n            const currentMonth = String(targetDate.getMonth() + 1).padStart(2, '0');\n            const currentDay = String(targetDate.getDate()).padStart(2, '0');\n            const currentDateStr = `${currentMonth}-${currentDay}`;\n\n            // 前後30日以内の流星群をフィルタ\n            const relevantShowers = meteorShowers.filter(shower => {\n                const showerDate = new Date(`${currentYear}-${shower.peakStart}`);\n                const targetDateTime = targetDate.getTime();\n                const diffDays = Math.abs((showerDate - targetDateTime) / (1000 * 60 * 60 * 24));\n                return diffDays <= 30;\n            });\n\n            const container = document.getElementById('meteor-showers');\n            if (relevantShowers.length === 0) {\n                container.innerHTML = '<div class=\"text-slate-400\">今後30日以内に極大を迎える 流星群はありません</div>';\n            } else {\n                container.innerHTML = relevantShowers.map(shower => {\n                    const isPeak = currentDateStr === shower.peakStart || currentDateStr === shower.peakEnd;\n                    const showerDateStr = shower.peakStart.replace('-', '/');\n                    return `\n                        <div class=\"bg-slate-700/30 rounded-lg p-2 ${isPeak ? 'border-l-2 border-yellow-400' : ''}\">\n                            <div class=\"flex items-center justify-between\">\n                                <span class=\"font-semibold ${isPeak ? 'text-yellow-300' : ''}\">${shower.name}</span>\n                                <span class=\"text-xs text-slate-400\">${showerDateStr} 極大</span>\n                            </div>\n                            <div class=\"text-xs text-slate-400 mt-1\">\n                                ${shower.rate} | ${shower.note}\n                            </div>\n                            ${isPeak ? '<div class=\"text-xs text-yellow-300 mt-1\">\uD83C\uDF1F 本日が極大日です！</div>' : ''}\n                        </div>\n                    `;\n                }).join('');\n            }\n        }\n\n        // 3. ISS現在位置を取得\n        async function fetchISSLocation() {\n            const container = document.getElementById('iss-location');\n            try {\n                // Open Notify API の /iss-now.json エン ドポイントを使用\n                const response = await fetch('http://api.open-notify.org/iss-now.json');\n                const data = await response.json();\n\n                if (data.iss_position) {\n                    const lat = parseFloat(data.iss_position.latitude);\n                    const lon = parseFloat(data.iss_position.longitude);\n                    const timestamp = moment.unix(data.timestamp);\n\n                    container.innerHTML = `\n                        <div class=\"bg-blue-500/20 rounded-lg p-3 border border-blue-400/30\">\n                            <div class=\"flex items-center justify-between mb-2\">\n                                <span class=\"text-slate-300 text-xs\"> リアルタイム位置</span>\n                                <span class=\"text-xs text-blue-300\">${timestamp.format('HH:mm:ss')}</span>\n                            </div>\n                            <div class=\"grid grid-cols-2 gap-3\">\n                                <div class=\"bg-slate-700/30 rounded-lg p-2\">\n                                    <div class=\"text-xs text-slate-400\">緯度</div>\n                                    <div class=\"font-semibold text-slate-200\">${lat.toFixed(4)}°</div>\n                                </div>\n                                <div class=\"bg-slate-700/30 rounded-lg p-2\">\n                                    <div class=\"text-xs text-slate-400\">経度</div>\n                                    <div class=\"font-semibold text-slate-200\">${lon.toFixed(4)}°</div>\n                                </div>\n                            </div>\n                            <div class=\"text-xs text-slate-400 mt-2\">\n                                高度: 約 408km | 速度: 約 27,600km/h\n                            </div>\n                        </div>\n                    `;\n                } else {\n                    container.innerHTML = '<div class=\"text-slate-400\">位置情報を取得できませんでした</div>';\n                }\n            } catch (error) {\n                console.error('ISS位 置情報エラー:', error);\n                container.innerHTML = '<div class=\"text-slate-400\">位置情報を取得できませんでした</div>';\n            }\n        }\n\n        // 3-2. ISS乗員情報を取得\n        async function fetchAstronauts() {\n            const container = document.getElementById('iss-astronauts');\n            try {\n                // Open Notify API の /astros.json エンドポイント を使用\n                const response = await fetch('https://api.open-notify.org/astros.json');\n                const data = await response.json();\n\n                if (data.people && data.people.length > 0) {\n                    // ISSにいる宇宙飛行士のみフィルタ\n                    const issCrewMembers = data.people.filter(person => person.craft === 'ISS');\n\n                    if (issCrewMembers.length > 0) {\n                        // 人数表示\n                        const countHtml = `\n                            <div class=\"bg-purple-500/20 rounded-lg p-3 mb-3 border border-purple-400/30\">\n                                <div class=\"flex items-center justify-between\">\n                                    <span class=\"text-slate-300\">現在のISS滞在人数</span>\n                                    <span class=\"text-2xl font-bold text-purple-300\">${issCrewMembers.length}名</span>\n                                </div>\n                            </div>\n                        `;\n\n                        // 乗員リスト\n                        const crewListHtml = issCrewMembers.map(person => {\n                            return `\n                                <div class=\"bg-slate-700/30 rounded-lg p-2 flex items-center gap-2\">\n                                    <i data-lucide=\"user\" class=\"w-4 h-4 text-purple-300\"></i>\n                                    <div class=\"flex-1\">\n                                        <div class=\"font-semibold text-slate-200\">${person.name}</div>\n                                        <div class=\"text-xs text-slate-400\">所属: ${person.craft}</div>\n                                    </div>\n                                </div>\n                            `;\n                        }).join('');\n\n                        container.innerHTML = countHtml + crewListHtml;\n\n                        // Lucide icons を再初期化\n                        if (window.lucide) {\n                            lucide.createIcons();\n                        }\n                    } else {\n                        container.innerHTML = '<div class=\"text-slate-400\">現在ISSに滞在中の宇宙飛行士はいません</div>';\n                    }\n                } else {\n                    container.innerHTML = '<div class=\"text-slate-400\">宇宙飛行士情報がありません</div>';\n                }\n            } catch (error) {\n                console.error('ISS乗員情報エラー:', error);\n                container.innerHTML = '<div class=\"text-slate-400\">乗員情報 を取得できませんでした</div>';\n            }\n        }\n\n        // 4. 月齢による観測推奨天体\n        function updateRecommendedObjects(moonAge) {\n            const age = parseFloat(moonAge);\n            const container = document.getElementById('recommended-objects');\n\n            let recommendations = [];\n\n            if (age < 3 || age > 26) {\n                // 新月期: 暗い天体に最 適\n                recommendations = [\n                    { name: 'アンドロメダ銀河 (M31)', type: '銀河', reason: '暗い夜空で見やすい' },\n                    { name: 'オリオン大星雲 (M42)', type: '星雲', reason: '新月期が最適' },\n                    { name: 'プレアデス星団 (M45)', type: '星団', reason: '暗い空で美しい' }\n                ];\n            } else if (age >= 3 && age < 10) {\n                // 上弦前後: 月面観測に適する\n                recommendations = [\n                    { name: '月面クレーター', type: '月', reason: '影が長く見やすい' },\n                    { name: '明るい惑星', type: '惑星', reason: '月明 かりの影響少ない' },\n                    { name: '二重星（アルビレオ）', type: '恒星', reason: '明るい星なら観測可' }\n                ];\n            } else if (age >= 10 && age < 18) {\n                // 満月期: 月面観測メイン\n                recommendations = [\n                    { name: '満月の地形観測', type: '月', reason: '全体像を観測' },\n                    { name: '明るい星雲 (M42)', type: '星雲', reason: '明るい天体のみ' },\n                    { name: '惑星の衛星', type: '惑星', reason: '木星の衛星など' }\n                ];\n            } else {\n                // 下弦前後: 朝方の観測\n                recommendations = [\n                    { name: '月面南部クレーター', type: '月', reason: '下弦は南部が見やすい' },\n                    { name: '明け方の惑星', type: '惑 星', reason: '水星・金星が好条件' },\n                    { name: '球状星団 (M13)', type: '星団', reason: '明け方なら観測可' }\n                ];\n            }\n\n            container.innerHTML = recommendations.map(rec => `\n                <div class=\"bg-slate-700/30 rounded-lg p-2\">\n                    <div class=\"flex items-center justify-between\">\n                        <span class=\"font-semibold\">${rec.name}</span>\n                        <span class=\"text-xs bg-green-600/30 text-green-300 px-2 py-0.5 rounded\">${rec.type}</span>\n                    </div>\n                    <div class=\"text-xs text-slate-400 mt-1\">${rec.reason}</div>\n                </div>\n            `).join('');\n        }\n\n        // --- 天気データ取得 & 描画 ---\n\n        async function fetchWeather(lat, lon) {\n            // API URL (追加気象データを含む)\n            const API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,cloud_cover,cloud_cover_low,cloud_cover_mid,cloud_cover_high,windspeed_10m,winddirection_10m,surface_pressure,dewpoint_2m,visibility&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset&timezone=Asia%2FTokyo&past_days=2&forecast_days=10`;\n\n            try {\n                const response = await fetch(API_URL);\n                weatherData = await response.json();\n                \n                // 初回は現在時刻で描画\n                // もしユーザーが過去の日付を選択中の場合はそのまま維持しても良いが、\n                // 場所を変えたら「現在」に戻る方が自然なため、現在時刻にリセットする\n                const now = moment();\n                setDatePickerValue(now);\n                renderDashboard(now);\n            } catch (error) {\n                document.getElementById('loading').innerHTML = `<span class=\"text-red-400\">データ取得エラー: ${error.message}</span>`;\n                console.error(error);\n            }\n        }\n\n        // --- UIレンダリング (既存の ロジック) ---\n\n        function setDatePickerValue(momentObj) {\n            const formatted = momentObj.format('YYYY-MM-DDTHH:mm');\n            document.getElementById('target-datetime').value = formatted;\n        }\n\n        function updateDashboardTime() {\n            const val = document.getElementById('target-datetime').value;\n            if (val && weatherData) {\n                renderDashboard(moment(val));\n            }\n        }\n\n        function resetToNow() {\n            const now = moment();\n            setDatePickerValue(now);\n            if (weatherData) {\n                renderDashboard(now);\n            }\n        }\n\n        // 新しい関数: 週間予報の日付クリック時の処理\n        function selectDate(dateStr) {\n            // 現在の入力値（時間）を取得して、日付だけ差し替える\n            const currentVal = document.getElementById('target-datetime').value;\n            let targetMoment = moment(dateStr); \n            \n            if (currentVal) {\n                const currentMoment = moment(currentVal);\n                // 時間と分を維持\n                targetMoment.hour(currentMoment.hour());\n                targetMoment.minute(currentMoment.minute());\n            } else {\n                // デフォルトは正午などにするか、現在時刻に合わせる\n                const now = moment();\n                targetMoment.hour(now.hour());\n                targetMoment.minute(now.minute());\n            }\n\n            setDatePickerValue(targetMoment);\n            renderDashboard(targetMoment);\n            \n            // スクロールを上部へ（スマホなどで見やすくするため）\n            document.getElementById('dashboard-content').scrollIntoView({ behavior: 'smooth' });\n        }\n\n        function getWeatherInfo(code) {\n            if (code === 0) return { label: '快晴', icon: 'sun', color: 'text-orange-400' };\n            if (code >= 1 && code <= 3) return { label: '曇り・晴れ間', icon: 'cloud-sun', color: 'text-gray-300' };\n            if (code >= 45 && code <= 48) return { label: '霧', icon: 'align-justify', color: 'text-gray-400' };\n            if (code >= 51 && code <= 55) return { label: '霧雨', icon: 'cloud-drizzle', color: 'text-blue-300' };\n            if (code >= 61 && code <= 67) return { label: '雨', icon: 'cloud-rain', color: 'text-blue-400' };\n            if (code >= 71 && code <= 77) return { label: '雪', icon: 'snowflake', color: 'text-white' };\n            if (code >= 80 && code <= 82) return { label: 'にわか雨', icon: 'cloud-hail', color: 'text-blue-300' };\n            if (code >= 95 && code <= 99) return { label: '雷雨', icon: 'cloud-lightning', color: 'text-yellow-400' };\n            return { label: '不明', icon: 'help-circle', color: 'text-gray-500' };\n        }\n\n        function renderDashboard(targetMoment) {\n            if (!weatherData) return;\n\n            const hourly = weatherData.hourly;\n            const daily = weatherData.daily;\n            const targetDate = targetMoment.toDate();\n            \n            let currentIndex = 0;\n            let minDiff = Infinity;\n            let isOutOfRange = true;\n\n            hourly.time.forEach((t, i) => {\n                const diff = Math.abs(new Date(t) - targetDate);\n                if (diff < minDiff) {\n                    minDiff = diff;\n                    currentIndex = i;\n                }\n                if (diff < 90 * 60 * 1000) { \n                    isOutOfRange = false;\n                }\n            });\n\n            if (isOutOfRange && minDiff > 24 * 60 * 60 * 1000) {\n                 document.getElementById('forecast-summary').innerText = \"選択された日時の詳細データがありません（範囲外です）\";\n                 return;\n            }\n\n            // 現在のステータス更新\n            const currentTemp = hourly.temperature_2m[currentIndex];\n            const currentCloudTotal = hourly.cloud_cover[currentIndex];\n            const currentLow = hourly.cloud_cover_low[currentIndex];\n            const currentMid = hourly.cloud_cover_mid[currentIndex];\n            const currentHigh = hourly.cloud_cover_high[currentIndex];\n\n            document.getElementById('current-temp').innerText = `${currentTemp}°C`;\n            document.getElementById('current-clouds').innerText = `${currentCloudTotal}%`;\n            \n            document.getElementById('clouds-high').innerText = `${currentHigh}%`;\n            document.getElementById('bar-high').style.width = `${currentHigh}%`;\n            \n            document.getElementById('clouds-mid').innerText = `${currentMid}%`;\n            document.getElementById('bar-mid').style.width = `${currentMid}%`;\n            \n            document.getElementById('clouds-low').innerText = `${currentLow}%`;\n            document.getElementById('bar-low').style.width = `${currentLow}%`;\n\n            // 月齢 情報の更新 (サマリーエリア)\n            const moonData = calculateMoonData(targetDate);\n            document.getElementById('current-moon-icon').innerText = moonData.icon;\n            document.getElementById('current-moon-age-text').innerText = moonData.age;\n            document.getElementById('current-moon-name').innerText = moonData.phaseName;\n\n            // 天体イベント情報を更新\n            calculateVisiblePlanets(targetDate, currentLat, currentLon);\n            updateMeteorShowers(targetDate);\n            updateRecommendedObjects(moonData.age);\n\n            // 追加気象データの表示\n            const currentWindSpeed = hourly.windspeed_10m ? hourly.windspeed_10m[currentIndex] : 0;\n            const currentWindDir = hourly.winddirection_10m ? hourly.winddirection_10m[currentIndex] : 0;\n            const currentPressure = hourly.surface_pressure ? hourly.surface_pressure[currentIndex] : 1013;\n            const currentDewpoint = hourly.dewpoint_2m ? hourly.dewpoint_2m[currentIndex] : 0;\n            const currentVisibility = hourly.visibility ? (hourly.visibility[currentIndex] / 1000).toFixed(1) : 24;\n            const currentHumidity = hourly.relative_humidity_2m[currentIndex];\n\n            document.getElementById('wind-speed').innerText = `${currentWindSpeed.toFixed(1)} m/s`;\n            const windDirText = getWindDirection(currentWindDir);\n            document.getElementById('wind-direction').innerText = windDirText;\n            document.getElementById('pressure').innerText = `${currentPressure.toFixed(0)} hPa`;\n            document.getElementById('dewpoint').innerText = `${currentDewpoint.toFixed(1)}°C`;\n            document.getElementById('visibility').innerText = `${currentVisibility} km`;\n\n            // 結露リスク判定\n            const tempDiff = currentTemp - currentDewpoint;\n            let condensationRisk = '';\n            if (tempDiff < 2) condensationRisk = '⚠\uFE0F 結露リスク高';\n            else if (tempDiff < 5) condensationRisk = '⚡ 結露注意';\n            else condensationRisk = '✅ 結露リスク低';\n            document.getElementById('condensation-risk').innerText = condensationRisk;\n\n            // 日月出没・天文薄明の計算と表示\n            const sunMoonTimes = calculateSunMoonTimes(targetDate, currentLat, currentLon);\n            updateSunMoonDisplay(sunMoonTimes);\n            renderTimeline(sunMoonTimes, targetDate);\n\n            // 星空視認性スコアの計算\n            const starryScore = calculateStarryScore(currentCloudTotal, moonData.age, currentHumidity, parseFloat(currentVisibility), currentWindSpeed);\n            updateStarryScore(starryScore);\n\n            // レーダーチャートのデータ準備\n            const radarData = {\n                cloudClearness: Math.max(0, 100 - currentCloudTotal),\n                moonDarkness: moonData.age < 3 || moonData.age > 26 ? 100 : moonData.age < 10 || moonData.age > 18 ? 60 : 20,\n                lowHumidity: Math.max(0, 100 - currentHumidity),\n                goodVisibility: Math.min(100, (parseFloat(currentVisibility) / 50) * 100),\n                calmWind: currentWindSpeed < 2 ? 100 : currentWindSpeed < 5 ? 80 : currentWindSpeed < 10 ? 50 : 20\n            };\n            renderRadarChart(radarData);\n\n\n            // サマリーテキスト\n            const displayTimeStr = targetMoment.format('M月D日 H:mm');\n            document.getElementById('summary-timestamp').innerText = `表示データ時刻: ${displayTimeStr}`;\n\n            let summary = `気温 ${currentTemp}°C。`;\n            if(currentCloudTotal < 20) summary += \" 快晴また は晴れ。\";\n            else if(currentCloudTotal < 60) summary += \" 雲間あり 。\";\n            else summary += \" 曇り空。\";\n            \n            if (currentIndex + 6 < hourly.temperature_2m.length) {\n                const futureTemp = hourly.temperature_2m[currentIndex + 6];\n                const tempDiff = futureTemp - currentTemp;\n                if(tempDiff > 2) summary += \" そ の後、気温は上昇傾向です。\";\n                else if(tempDiff < -2) summary += \" その後、冷え込む見込みです。\";\n            }\n\n            // --- 天体観 測サマリー追加 ---\n            // 選択された日時の「夜間（20:00 - 翌04:00）」のデータを取得\n            let astroStart = targetMoment.clone().startOf('day').add(20, 'hours');\n            // 修正: 深夜でも「その日の20時〜」を対象にするた め、深夜補正ロジックを削除\n            \n            const astroEnd = astroStart.clone().add(8, 'hours'); // 20:00 -> 04:00 (8時間)\n            \n            let astroCloudSum = 0;\n            let astroCount = 0;\n            \n            hourly.time.forEach((t, i) => {\n                const time = moment(t);\n                if (time.isSameOrAfter(astroStart) && time.isBefore(astroEnd)) {\n                    astroCloudSum += hourly.cloud_cover[i];\n                    astroCount++;\n                }\n            });\n\n            if (astroCount > 0) {\n                const avgAstroCloud = astroCloudSum / astroCount;\n                summary += \"<br><br><strong>\uD83D\uDD2D 天体観測予報:</strong> \";\n                const dateStr = astroStart.format('M/D');\n                \n                // 月の影響を加味したコメント\n                let moonComment = \"\";\n                if (moonData.age > 10 && moonData.age < 18) {\n                    moonComment = \"ただし、月明かりの影響が大きいでしょう。\";\n                }\n\n                if (avgAstroCloud < 15) {\n                    summary += `${dateStr}の夜は、雲が少なく<strong>絶好の天体観測日和</strong>です。${moonComment}`;\n                } else if (avgAstroCloud < 40) {\n                    summary += `${dateStr}の夜は、雲は少なめで<strong>観測に適しています</strong>。${moonComment}`;\n                } else if (avgAstroCloud < 75) {\n                    summary += `${dateStr}の夜は、雲が出るため観測には<strong>忍耐が必要</strong>かもしれません。`;\n                } else {\n                    summary += `${dateStr}の夜は、雲が多く<strong>観測には不向き</strong>な予報です。`;\n                }\n            }\n            \n            // innerText -> innerHTML (タグを有効化するため)\n            document.getElementById('forecast-summary').innerHTML = summary;\n\n            // チャート描画 (24時間分に修正)\n            const sliceStart = currentIndex;\n            const sliceEnd = Math.min(currentIndex + 24, hourly.time.length);\n            \n            const labels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('D日 H時'));\n            const fullDateLabels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('M月D日 H:mm'));\n            \n            const temps = hourly.temperature_2m.slice(sliceStart, sliceEnd);\n            const cloudLow = hourly.cloud_cover_low.slice(sliceStart, sliceEnd);\n            const cloudMid = hourly.cloud_cover_mid.slice(sliceStart, sliceEnd);\n            const cloudHigh = hourly.cloud_cover_high.slice(sliceStart, sliceEnd);\n\n            // 気温チャート\n            const ctxTemp = document.getElementById('tempChart').getContext('2d');\n            if(tempChartInstance) tempChartInstance.destroy();\n\n            let gradientTemp = ctxTemp.createLinearGradient(0, 0, 0, 400);\n            gradientTemp.addColorStop(0, 'rgba(251, 146, 60, 0.5)'); \n            gradientTemp.addColorStop(1, 'rgba(251, 146, 60, 0.0)');\n\n            tempChartInstance = new Chart(ctxTemp, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: '気温 (°C)',\n                        data: temps,\n                        borderColor: '#fb923c',\n                        backgroundColor: gradientTemp,\n                        borderWidth: 3,\n                        pointBackgroundColor: '#fff',\n                        tension: 0.4,\n                        fill: true\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { display: false },\n                        tooltip: { callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] } }\n                    },\n                    scales: {\n                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 雲チャート (積み上げ順を修正: Low -> Mid -> High)\n            // 配色: 下層=Gray-300(変更), 中層=Emerald, 上層=Violet\n            const ctxCloud = document.getElementById('cloudChart').getContext('2d');\n            if(cloudChartInstance) cloudChartInstance.destroy();\n\n            cloudChartInstance = new Chart(ctxCloud, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [\n                        { label: '下層雲', data: cloudLow, borderColor: '#d1d5db', backgroundColor: 'rgba(209, 213, 219, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },\n                        { label: '中層雲', data: cloudMid, borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },\n                        { label: '上層 雲', data: cloudHigh, borderColor: '#a78bfa', backgroundColor: 'rgba(167, 139, 250, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 }\n                    ]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: { labels: { color: '#cbd5e1' } },\n                        tooltip: {\n                            mode: 'index',\n                            intersect: false,\n                             callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] }\n                        }\n                    },\n                    scales: {\n                        y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },\n                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }\n                    }\n                }\n            });\n\n            // 週間予 報テーブル\n            const weeklyBody = document.getElementById('weekly-forecast-body');\n            weeklyBody.innerHTML = '';\n            \n            daily.time.forEach((t, i) => {\n                const date = moment(t);\n                const isSelectedDay = date.isSame(targetMoment, 'day');\n                const weatherInfo = getWeatherInfo(daily.weathercode[i]);\n                const maxTemp = daily.temperature_2m_max[i];\n                const minTemp = daily.temperature_2m_min[i];\n                const rainSum = daily.precipitation_sum[i];\n                const rainProb = daily.precipitation_probability_max[i];\n                \n                // 月齢計算\n                const moonInfo = calculateMoonData(date.toDate());\n\n                // 1時間ごとのデータから、この日の平均雲量と湿度を計算\n                const dateStr = t; // \"YYYY-MM-DD\"\n                let cloudSum = 0;\n                let humSum = 0;\n                let count = 0;\n                \n                // データ量が少ないので 単純ループで集計\n                hourly.time.forEach((hTime, hIndex) => {\n                    if (hTime.startsWith(dateStr)) {\n                        cloudSum += hourly.cloud_cover[hIndex];\n                        humSum += hourly.relative_humidity_2m[hIndex];\n                        count++;\n                    }\n                });\n                \n                const avgCloud = count > 0 ? Math.round(cloudSum / count) : '-';\n                const avgHum = count > 0 ? Math.round(humSum / count) : '-';\n\n                const row = document.createElement('tr');\n                // cursor-pointer を追加、onclickを追加\n                row.className = `border-b border-slate-700/50 transition cursor-pointer ${isSelectedDay ? 'bg-blue-500/20 border-l-4 border-l-blue-400' : 'hover:bg-white/5'}`;\n                row.onclick = () => selectDate(t); // クリックイベント\n\n                row.innerHTML = `\n                    <td class=\"py-4 px-2\">\n                        <div class=\"font-bold ${isSelectedDay ? 'text-blue-300' : 'text-white'}\">${date.format('M/D')}</div>\n                        <div class=\"text-xs text-slate-400\">${date.format('ddd')}</div>\n                    </td>\n                    <td class=\"py-4 px-2\">\n                        <div class=\"flex items-center gap-3\">\n                            <i data-lucide=\"${weatherInfo.icon}\" class=\"${weatherInfo.color} w-6 h-6\"></i>\n                            <span class=\"hidden md:inline text-sm\">${weatherInfo.label}</span>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm\">${rainProb !== null ? rainProb + '%' : '-'}</div>\n                        <div class=\"text-xs text-blue-300\">${rainSum > 0 ? rainSum + 'mm' : ''}</div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold\">${avgCloud !== '-' ? avgCloud + '%' : '-'}</div>\n                        <div class=\"w-16 bg-slate-700/50 rounded-full h-1 mx-auto mt-1\">\n                            <div class=\"bg-slate-400 h-1 rounded-full\" style=\"width: ${avgCloud !== '-' ? avgCloud : 0}%\"></div>\n                        </div>\n                    </td>\n                    <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-sm font-semibold text-blue-200 flex items-center justify-center gap-1\">\n                            <i data-lucide=\"droplet\" class=\"w-3 h-3\"></i>\n                            ${avgHum !== '-' ? avgHum + '%' : '-'}\n                        </div>\n                    </td>\n                     <td class=\"py-4 px-2 text-center\">\n                        <div class=\"text-lg\" title=\"${moonInfo.phaseName} (月齢${moonInfo.age})\">${moonInfo.icon}</div>\n                        <div class=\"text-xs text-slate-400\">${moonInfo.age}</div>\n                    </td>\n                    <td class=\"py-4 px-2 text-right\">\n                        <span class=\"font-bold text-orange-400\">${maxTemp}°</span> \n                        <span class=\"text-slate-500 mx-1\">/</span> \n                        <span class=\"text-blue-300\">${minTemp}°</span>\n                    </td>\n                `;\n                weeklyBody.appendChild(row);\n            });\n            \n            lucide.createIcons();\n\n            document.getElementById('loading').classList.add('hidden');\n            document.getElementById('dashboard-content').classList.remove('hidden');\n        }\n    </script>\n</body>\n</html>\n

LINE LIMIT EXCEEDED
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©ä½“è¦³æ¸¬ã§ãã‚‹ã‹ãªï¼Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ja.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Astronomy Engine for planetary calculations -->
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Date picker custom styles for dark mode compatibility */
        input[type="datetime-local"] {
            color-scheme: dark;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1;
        }
        /* Leaflet customization */
        .leaflet-container {
            background: #1e293b;
        }
        /* Night Vision Mode */
        body.night-vision {
            filter: hue-rotate(180deg) invert(1);
            background: #300000 !important;
        }
        body.night-vision .glass-panel {
            background: rgba(100, 0, 0, 0.3) !important;
            border-color: rgba(200, 0, 0, 0.3) !important;
        }
        body.night-vision * {
            color: #ff6666 !important;
            border-color: #ff3333 !important;
        }
        /* Starry Score Meter */
        .score-meter {
            width: 200px;
            height: 200px;
            position: relative;
        }
        .score-circle {
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 1s ease;
        }
        /* Timeline styles */
        .timeline-bar {
            position: relative;
            height: 60px;
            background: linear-gradient(to right, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 8px;
            overflow: hidden;
        }
        .timeline-segment {
            position: absolute;
            height: 100%;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex-1">
                <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ« -->
                <h1 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-100 via-blue-200 to-blue-400 mb-3 flex items-center gap-3">
                    <i data-lucide="telescope" class="text-yellow-200 w-8 h-8 md:w-12 md:h-12"></i>
                    å¤©ä½“è¦³æ¸¬ã§ãã‚‹ã‹ãªï¼Ÿ
                </h1>
                
                <!-- å ´æ‰€æƒ…å ± -->
                <div class="flex items-center gap-2 text-xl font-semibold text-slate-200 pl-1">
                    <i data-lucide="map-pin" class="text-blue-400"></i>
                    <span id="location-name">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</span>
                </div>
                <p class="text-slate-400 text-sm mt-1 flex items-center gap-2 pl-1">
                    <span id="coords-display">ç·¯åº¦: -- | çµŒåº¦: --</span>
                    <button onclick="toggleMap()" class="text-blue-300 hover:text-white underline text-xs ml-2">
                        åœ°å›³ã§å ´æ‰€ã‚’å¤‰æ›´
                    </button>
                </p>
            </div>
            <div class="text-right flex flex-col items-end">
                <div id="current-clock" class="text-xl font-semibold font-mono">--:--:--</div>
                <div class="text-slate-400 text-sm">ç¾åœ¨æ™‚åˆ» (Asia/Tokyo)</div>
                <div class="text-slate-500 text-xs mt-2 flex items-center gap-2">
                    Ver. 2.2.1
                    <button onclick="toggleNightVision()" class="text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded border border-red-600/30" title="ãƒŠã‚¤ãƒˆãƒ“ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰">
                        <i data-lucide="moon" class="w-3 h-3 inline"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- åœ°å›³ãƒ»ä½ç½®è¨­å®šã‚¨ãƒªã‚¢ (åˆæœŸã¯éè¡¨ç¤º) -->
        <div id="location-settings" class="hidden glass-panel rounded-xl p-4 space-y-4">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h3 class="font-bold flex items-center gap-2">
                    <i data-lucide="map" class="w-5 h-5 text-green-400"></i> åœ°å›³ã‹ã‚‰å ´æ‰€ã‚’é¸æŠ
                </h3>
                <button onclick="getCurrentLocation()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <i data-lucide="crosshair" class="w-4 h-4"></i> ç¾åœ¨åœ°ã‚’å–å¾—
                </button>
            </div>
            <p class="text-sm text-slate-300">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å ´æ‰€ã®å¤©æ°—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            <div id="map"></div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ (æ—¥æ™‚æŒ‡å®š) -->
        <div class="glass-panel rounded-xl p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-2 text-sm md:text-base">
                <i data-lucide="settings-2" class="text-slate-300 w-5 h-5"></i>
                <span class="font-bold">è¡¨ç¤ºæ—¥æ™‚ã‚’æŒ‡å®š:</span>
            </div>
            <div class="flex items-center gap-3 w-full sm:w-auto">
                <input type="datetime-local" id="target-datetime" 
                    class="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-400 w-full sm:w-auto font-mono"
                    onchange="updateDashboardTime()">
                
                <button onclick="resetToNow()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap">
                    ç¾åœ¨ã«æˆ»ã™
                </button>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º -->
        <div id="loading" class="text-center py-20 text-xl animate-pulse">å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
        
        <div id="dashboard-content" class="hidden space-y-6">
            <!-- æ˜Ÿç©ºè¦–èªæ€§ã‚¹ã‚³ã‚¢ï¼ˆå¤§å‹è¡¨ç¤ºï¼‰ -->
            <div class="glass-panel rounded-2xl p-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex flex-col items-center justify-center">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="sparkles" class="text-yellow-400 w-5 h-5"></i> æ˜Ÿç©ºè¦–èªæ€§ã‚¹ã‚³ã‚¢
                        </h3>
                        <svg class="score-meter" viewBox="0 0 160 160">
                            <circle cx="80" cy="80" r="70" fill="none" stroke="#334155" stroke-width="12"/>
                            <circle id="score-circle" class="score-circle" cx="80" cy="80" r="70" fill="none" stroke="url(#scoreGradient)" stroke-width="12" stroke-linecap="round" transform="rotate(-90 80 80)"/>
                            <defs>
                                <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#eab308;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#22c55e;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <text id="score-text" x="80" y="75" text-anchor="middle" font-size="36" font-weight="bold" fill="#fff">--</text>
                            <text x="80" y="95" text-anchor="middle" font-size="12" fill="#94a3b8">/ 100</text>
                        </svg>
                        <p id="score-comment" class="text-sm text-slate-300 mt-3 text-center">è¨ˆç®—ä¸­...</p>
                    </div>

                    <!-- ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹ -->
                    <div class="flex-1 w-full">
                        <h4 class="font-semibold text-sm mb-3 flex items-center gap-2">
                            <i data-lucide="bookmark" class="w-4 h-4 text-blue-400"></i>
                            ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹
                        </h4>
                        <div id="favorite-locations" class="space-y-2">
                            <button onclick="addFavoriteLocation()" class="w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                ç¾åœ¨åœ°ã‚’ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ 
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³æŒ‡æ¨™ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- æ°—æ¸©ã‚«ãƒ¼ãƒ‰ -->
                <div class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden group hover:bg-white/5 transition">
                    <div class="absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider">æŒ‡å®šæ™‚åˆ»ã®æ°—æ¸©</div>
                    <i data-lucide="thermometer" class="w-12 h-12 text-orange-400 mb-4"></i>
                    <div class="text-5xl font-bold mb-1" id="current-temp">--Â°C</div>
                    <div class="text-slate-300">æ°—æ¸©</div>
                </div>

                <!-- é›²é‡ã‚«ãƒ¼ãƒ‰ -->
                <div class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden hover:bg-white/5 transition">
                    <div class="absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider">æŒ‡å®šæ™‚åˆ»ã®é›²é‡</div>
                    <i data-lucide="cloud" class="w-12 h-12 text-slate-300 mb-4"></i>
                    <div class="text-5xl font-bold mb-1" id="current-clouds">--%</div>
                    <div class="text-slate-300">å…¨å¤©é›²é‡</div>
                </div>

                <!-- é›²ã®è©³ç´° -->
                <div class="glass-panel rounded-2xl p-6 flex flex-col justify-center gap-4 hover:bg-white/5 transition">
                    <div class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-2">é›²ã®å±¤ï¼ˆé«˜åº¦åˆ¥ï¼‰</div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300 flex items-center gap-2"><i data-lucide="arrow-up" class="w-4 h-4"></i> ä¸Šå±¤é›²</span>
                        <span class="font-bold text-lg" id="clouds-high">--%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-2">
                        <!-- ä¸Šå±¤é›²: Violet -->
                        <div id="bar-high" class="bg-violet-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>

                    <div class="flex justify-between items-center mt-1">
                        <span class="text-slate-300 flex items-center gap-2"><i data-lucide="minus" class="w-4 h-4"></i> ä¸­å±¤é›²</span>
                        <span class="font-bold text-lg" id="clouds-mid">--%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-2">
                        <!-- ä¸­å±¤é›²: Emerald -->
                        <div id="bar-mid" class="bg-emerald-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>

                    <div class="flex justify-between items-center mt-1">
                        <span class="text-slate-300 flex items-center gap-2"><i data-lucide="arrow-down" class="w-4 h-4"></i> ä¸‹å±¤é›²</span>
                        <span class="font-bold text-lg" id="clouds-low">--%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-2">
                        <!-- ä¸‹å±¤é›²: æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ -->
                        <div id="bar-low" class="bg-gray-300 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- è¿½åŠ æ°—è±¡ãƒ‡ãƒ¼ã‚¿ + å¤©æ–‡è–„æ˜æ™‚åˆ» -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- è¿½åŠ æ°—è±¡ãƒ‡ãƒ¼ã‚¿ -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="gauge" class="text-cyan-400 w-5 h-5"></i> è©³ç´°æ°—è±¡ãƒ‡ãƒ¼ã‚¿
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">é¢¨é€Ÿãƒ»é¢¨å‘</div>
                            <div class="text-xl font-bold" id="wind-speed">-- m/s</div>
                            <div class="text-sm text-slate-300" id="wind-direction">--</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">æ°—åœ§</div>
                            <div class="text-xl font-bold" id="pressure">-- hPa</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">éœ²ç‚¹æ¸©åº¦</div>
                            <div class="text-xl font-bold" id="dewpoint">--Â°C</div>
                            <div class="text-xs text-slate-400" id="condensation-risk">--</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">è¦–ç¨‹</div>
                            <div class="text-xl font-bold" id="visibility">-- km</div>
                        </div>
                    </div>
                </div>

                <!-- å¤©æ–‡è–„æ˜ãƒ»æ—¥æœˆå‡ºæ²¡æ™‚åˆ» -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="sunrise" class="text-orange-400 w-5 h-5"></i> å¤©æ–‡è–„æ˜ãƒ»å‡ºæ²¡æ™‚åˆ»
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-300">å¤©æ–‡è–„æ˜é–‹å§‹</span>
                            <span class="font-mono font-bold" id="twilight-astro-begin">--:--</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-300">æ—¥ã®å‡º</span>
                            <span class="font-mono font-bold" id="sunrise-time">--:--</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-300">æ—¥ã®å…¥</span>
                            <span class="font-mono font-bold" id="sunset-time">--:--</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-300">å¤©æ–‡è–„æ˜çµ‚äº†</span>
                            <span class="font-mono font-bold text-green-300" id="twilight-astro-end">--:--</span>
                        </div>
                        <div class="border-t border-slate-700 pt-3 mt-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-slate-300">æœˆã®å‡º</span>
                                <span class="font-mono font-bold" id="moonrise-time">--:--</span>
                            </div>
                            <div class="flex items-center justify-between text-sm mt-2">
                                <span class="text-slate-300">æœˆã®å…¥</span>
                                <span class="font-mono font-bold" id="moonset-time">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 24æ™‚é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="clock" class="text-purple-400 w-5 h-5"></i> 24æ™‚é–“è¦³æ¸¬é©æ€§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </h3>
                <div id="timeline-container" class="timeline-bar"></div>
                <div class="flex items-center justify-between mt-3 text-xs text-slate-400">
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>24:00</span>
                </div>
                <div class="flex items-center gap-4 mt-3 text-xs flex-wrap">
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-yellow-500/50 rounded"></div>
                        <span>æ—¥ä¸­</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-blue-500/50 rounded"></div>
                        <span>è–„æ˜</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-green-500/50 rounded"></div>
                        <span>è¦³æ¸¬é©æ™‚</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-slate-500/50 rounded"></div>
                        <span>æœˆæ˜ã‹ã‚Š</span>
                    </div>
                </div>
            </div>

             <!-- ã‚µãƒãƒªãƒ¼ã‚¨ãƒªã‚¢ï¼ˆæ‹¡å¼µç‰ˆï¼šå¤©æ°—åˆ†æï¼‹æœˆé½¢ï¼‰ -->
             <div class="glass-panel rounded-2xl p-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- å·¦å´ï¼šå¤©æ°—ã‚µãƒãƒªãƒ¼ -->
                    <div class="flex-1 flex flex-col justify-center border-l-4 border-blue-400 pl-4">
                        <p class="text-slate-300 italic" id="forecast-summary">äºˆå ±ã‚’åˆ†æä¸­...</p>
                        <p class="text-xs text-slate-500 mt-2" id="summary-timestamp">--</p>
                    </div>

                    <!-- å³å´ï¼šæœˆé½¢æƒ…å ± -->
                    <div class="flex flex-col items-center justify-center min-w-[150px] border-t md:border-t-0 md:border-l border-slate-700 pt-4 md:pt-0 md:pl-6">
                        <div class="text-xs text-slate-400 mb-1 uppercase tracking-wider">Moon Phase</div>
                        <div class="text-4xl mb-1" id="current-moon-icon">ğŸŒ‘</div>
                        <div class="text-xl font-bold text-yellow-100" id="current-moon-age-text">--</div>
                        <div class="text-sm text-yellow-200" id="current-moon-name">--</div>
                    </div>
                </div>
             </div>

            <!-- å¤©ä½“ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="star" class="text-yellow-400 w-5 h-5"></i> å¤©ä½“ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
                </h3>

                <div class="space-y-3">
                    <!-- ä»Šå¤œè¦‹ãˆã‚‹æƒ‘æ˜Ÿ -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('planets')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="planet" class="w-4 h-4 text-purple-400"></i>
                                <span class="font-semibold text-sm">ä»Šå¤œè¦‹ãˆã‚‹æƒ‘æ˜Ÿ</span>
                            </div>
                            <i id="icon-planets" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-planets" class="hidden px-4 pb-4">
                            <div id="visible-planets" class="space-y-2 text-sm">
                                <div class="text-slate-400">è¨ˆç®—ä¸­...</div>
                            </div>
                        </div>
                    </div>

                    <!-- æµæ˜Ÿç¾¤ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('meteors')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i>
                                <span class="font-semibold text-sm">æµæ˜Ÿç¾¤ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
                            </div>
                            <i id="icon-meteors" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-meteors" class="hidden px-4 pb-4">
                            <div id="meteor-showers" class="space-y-2 text-sm">
                                <div class="text-slate-400">èª­ã¿è¾¼ã¿ä¸­...</div>
                            </div>
                        </div>
                    </div>

                    <!-- æœˆé½¢ã«ã‚ˆã‚‹è¦³æ¸¬æ¨å¥¨å¤©ä½“ -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('recommended')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="telescope" class="w-4 h-4 text-green-400"></i>
                                <span class="font-semibold text-sm">æœˆé½¢ã«ã‚ˆã‚‹è¦³æ¸¬æ¨å¥¨å¤©ä½“</span>
                            </div>
                            <i id="icon-recommended" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-recommended" class="hidden px-4 pb-4">
                            <div id="recommended-objects" class="space-y-2 text-sm">
                                <div class="text-slate-400">è¨ˆç®—ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¦³æ¸¬é©æ€§ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="radar" class="text-pink-400 w-5 h-5"></i> è¦³æ¸¬é©æ€§ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
                </h3>
                <div class="relative h-80 w-full">
                    <canvas id="radarChart"></canvas>
                </div>
                <p class="text-xs text-slate-400 mt-2 text-center">å„è¦ç´ ãŒå¤–å´ã«è¿‘ã„ã»ã©è¦³æ¸¬ã«é©ã—ãŸæ¡ä»¶ã§ã™</p>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- æ°—æ¸©ãƒãƒ£ãƒ¼ãƒˆ -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="text-orange-400 w-5 h-5"></i> æ°—æ¸©äºˆå ± (æŒ‡å®šæ™‚åˆ»ã‚ˆã‚Š24æ™‚é–“)
                    </h3>
                    <div class="relative h-64 w-full">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <!-- é›²ã®ç©å±¤ãƒãƒ£ãƒ¼ãƒˆ -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="layers" class="text-blue-400 w-5 h-5"></i> é›²é‡æ¨ç§» (æŒ‡å®šæ™‚åˆ»ã‚ˆã‚Š24æ™‚é–“)
                    </h3>
                    <div class="relative h-64 w-full">
                        <canvas id="cloudChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- é€±é–“å¤©æ°—äºˆå ± -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="calendar" class="text-green-400 w-5 h-5"></i> é€±é–“å¤©æ°—äºˆå ±
                    <span class="text-xs font-normal text-slate-400 ml-2">â€»æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®æ—¥ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™</span>
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-slate-400 text-sm border-b border-slate-700">
                                <th class="py-3 px-2">æ—¥ä»˜</th>
                                <th class="py-3 px-2">å¤©æ°—</th>
                                <th class="py-3 px-2 text-center">é™æ°´ç¢ºç‡ / é‡</th>
                                <th class="py-3 px-2 text-center">å¹³å‡é›²é‡</th>
                                <th class="py-3 px-2 text-center">å¹³å‡æ¹¿åº¦</th>
                                <th class="py-3 px-2 text-center">æœˆé½¢</th>
                                <th class="py-3 px-2 text-right">æœ€é«˜ / æœ€ä½æ°—æ¸©</th>
                            </tr>
                        </thead>
                        <tbody id="weekly-forecast-body" class="text-sm md:text-base">
                            <!-- JSã§ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ (APIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ) -->
        <footer class="glass-panel rounded-xl p-4 text-center text-slate-400 text-sm">
            <p>
                Data sources: 
                <a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer" class="text-blue-300 hover:underline">Open-Meteo</a> (Weather Data) & 
                <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer" class="text-blue-300 hover:underline">OpenStreetMap</a> (Map & Address Data)
            </p>
        </footer>

    </div>

    <script>
        // --- åˆæœŸè¨­å®š ---
        lucide.createIcons();
        moment.locale('ja'); 

        let mapInstance = null;
        let markerInstance = null;
        let weatherData = null;
        let tempChartInstance = null;
        let cloudChartInstance = null;
        let radarChartInstance = null;
        let favoriteLocations = JSON.parse(localStorage.getItem('favoriteLocations') || '[]');

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆä¸‰å³¶å¸‚ï¼‰
        let currentLat = 35.1167;
        let currentLon = 138.9167;

        // --- ãƒŠã‚¤ãƒˆãƒ“ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ ---
        function toggleNightVision() {
            document.body.classList.toggle('night-vision');
            const isNight = document.body.classList.contains('night-vision');
            localStorage.setItem('nightVisionMode', isNight);
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒŠã‚¤ãƒˆãƒ“ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
        if (localStorage.getItem('nightVisionMode') === 'true') {
            document.body.classList.add('night-vision');
        }

        // --- ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ ---
        function toggleAccordion(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }

            // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’å†åˆæœŸåŒ–
            lucide.createIcons();
        }

        // --- ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹ç®¡ç† ---
        function addFavoriteLocation() {
            const name = prompt('ã“ã®åœ°ç‚¹ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', document.getElementById('location-name').innerText || 'æœªè¨­å®š');
            if (name) {
                const location = {
                    name: name,
                    lat: currentLat,
                    lon: currentLon
                };
                favoriteLocations.push(location);
                if (favoriteLocations.length > 5) favoriteLocations.shift(); // æœ€å¤§5ä»¶
                localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));
                renderFavoriteLocations();
            }
        }

        function renderFavoriteLocations() {
            const container = document.getElementById('favorite-locations');
            if (favoriteLocations.length === 0) {
                container.innerHTML = `
                    <button onclick="addFavoriteLocation()" class="w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        ç¾åœ¨åœ°ã‚’ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ 
                    </button>
                `;
            } else {
                container.innerHTML = favoriteLocations.map((loc, index) => `
                    <div class="bg-slate-800/50 rounded-lg p-2 flex items-center justify-between border border-slate-700">
                        <button onclick="loadFavoriteLocation(${index})" class="flex-1 text-left text-sm hover:text-blue-300">
                            <i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i>
                            ${loc.name}
                        </button>
                        <button onclick="removeFavoriteLocation(${index})" class="text-red-400 hover:text-red-300 text-xs">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                `).join('') + `
                    <button onclick="addFavoriteLocation()" class="w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-2 text-xs border border-slate-700 flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-3 h-3"></i>
                        è¿½åŠ 
                    </button>
                `;
            }
            lucide.createIcons();
        }

        function loadFavoriteLocation(index) {
            const loc = favoriteLocations[index];
            updateAppLocation(loc.lat, loc.lon);
        }

        function removeFavoriteLocation(index) {
            favoriteLocations.splice(index, 1);
            localStorage.setItem('favoriteLocations', JSON.stringify(favoriteLocations));
            renderFavoriteLocations();
        }

        // --- æ˜Ÿç©ºè¦–èªæ€§ã‚¹ã‚³ã‚¢è¨ˆç®— ---
        function calculateStarryScore(cloudCover, moonAge, humidity, visibility = 24, windSpeed = 5) {
            // é›²é‡ã‚¹ã‚³ã‚¢ (0-100) - é›²ãŒå°‘ãªã„ã»ã©é«˜ã„
            const cloudScore = Math.max(0, 100 - cloudCover);

            // æœˆæ˜ã‹ã‚Šã‚¹ã‚³ã‚¢ (0-100) - æ–°æœˆã«è¿‘ã„ã»ã©é«˜ã„
            const moonScore = moonAge < 3 || moonAge > 26 ? 100 :
                             moonAge < 10 || moonAge > 18 ? 60 : 20;

            // æ¹¿åº¦ã‚¹ã‚³ã‚¢ (0-100) - æ¹¿åº¦ãŒä½ã„ã»ã©é«˜ã„
            const humidityScore = Math.max(0, 100 - humidity);

            // è¦–ç¨‹ã‚¹ã‚³ã‚¢ (0-100)
            const visibilityScore = Math.min(100, (visibility / 50) * 100);

            // é¢¨é€Ÿã‚¹ã‚³ã‚¢ (0-100) - é¢¨ãŒå¼±ã„ã»ã©é«˜ã„
            const windScore = windSpeed < 2 ? 100 : windSpeed < 5 ? 80 : windSpeed < 10 ? 50 : 20;

            // åŠ é‡å¹³å‡ (é›²é‡ã¨æœˆæ˜ã‹ã‚Šã‚’é‡è¦–)
            const totalScore = (cloudScore * 0.4 + moonScore * 0.3 + humidityScore * 0.15 + visibilityScore * 0.1 + windScore * 0.05);

            return Math.round(totalScore);
        }

        function updateStarryScore(score) {
            const circle = document.getElementById('score-circle');
            const text = document.getElementById('score-text');
            const comment = document.getElementById('score-comment');

            // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸå††ã®é€²è¡Œåº¦ (0-100ã‚’0-440ã«å¤‰æ›)
            const dashOffset = 440 - (score / 100) * 440;
            circle.style.strokeDashoffset = dashOffset;

            text.textContent = score;

            // ã‚³ãƒ¡ãƒ³ãƒˆ
            if (score >= 80) {
                comment.textContent = 'â­ çµ¶å¥½ã®è¦³æ¸¬æ—¥å’Œï¼æ˜Ÿç©ºãŒæœ€é«˜ã«ç¾ã—ãè¦‹ãˆã‚‹ã§ã—ã‚‡ã†';
            } else if (score >= 60) {
                comment.textContent = 'âœ¨ è¦³æ¸¬ã«é©ã—ãŸæ¡ä»¶ã§ã™ã€‚è‰¯ã„æ˜Ÿç©ºãŒæœŸå¾…ã§ãã¾ã™';
            } else if (score >= 40) {
                comment.textContent = 'ğŸŒ¤ï¸ ã¾ãšã¾ãšã®æ¡ä»¶ã€‚æ˜ã‚‹ã„æ˜Ÿã¯è¦³æ¸¬ã§ãã¾ã™';
            } else if (score >= 20) {
                comment.textContent = 'â˜ï¸ ã‚„ã‚„æ¡ä»¶ãŒæ‚ªã„ã§ã™ã€‚è¦³æ¸¬ã«ã¯å¿è€ãŒå¿…è¦ã‹ã‚‚';
            } else {
                comment.textContent = 'âŒ è¦³æ¸¬ã«ã¯ä¸å‘ããªæ¡ä»¶ã§ã™';
            }
        }

        // æ™‚è¨ˆæ›´æ–°
        setInterval(() => {
            document.getElementById('current-clock').textContent = moment().format('HH:mm:ss');
        }, 1000);

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ãƒ•ãƒ­ãƒ¼ ---
        window.addEventListener('load', () => {
            // ãŠæ°—ã«å…¥ã‚Šåœ°ç‚¹ã‚’è¡¨ç¤º
            renderFavoriteLocations();
            // ç¾åœ¨åœ°å–å¾—ã‚’è©¦ã¿ã‚‹
            getCurrentLocation(true); // true = åˆå›èµ·å‹•æ™‚ã®è‡ªå‹•å–å¾—
        });

        // --- ä½ç½®æƒ…å ±é–¢é€£ ---

        // ãƒ–ãƒ©ã‚¦ã‚¶ã®ç¾åœ¨åœ°å–å¾—
        function getCurrentLocation(isInitial = false) {
            if (!navigator.geolocation) {
                if(!isInitial) alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
                initializeDashboardWithCurrentCoords(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§èµ·å‹•
                return;
            }

            // ãƒ­ãƒ¼ãƒ‰è¡¨ç¤º
            document.getElementById('loading').innerHTML = 'ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...';
            document.getElementById('loading').classList.remove('hidden');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLon = position.coords.longitude;
                    updateAppLocation(currentLat, currentLon);
                },
                (error) => {
                    console.warn("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—:", error.message);
                    if(!isInitial) alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                    // å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆä¸‰å³¶ï¼‰ã§é–‹å§‹
                    initializeDashboardWithCurrentCoords(); 
                }
            );
        }

        // åº§æ¨™ã‚’æŒ‡å®šã—ã¦ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function updateAppLocation(lat, lon) {
            currentLat = lat;
            currentLon = lon;

            // 1. UIã®åº§æ¨™è¡¨ç¤ºæ›´æ–°
            document.getElementById('coords-display').innerText = `ç·¯åº¦: ${lat.toFixed(4)} | çµŒåº¦: ${lon.toFixed(4)}`;

            // 2. ä½æ‰€å–å¾— (é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°)
            fetchAddress(lat, lon);

            // 3. åœ°å›³ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°ï¼ˆåœ°å›³ãŒé–‹ã„ã¦ã„ã‚‹ã€ã¾ãŸã¯åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            if (mapInstance) {
                updateMapMarker(lat, lon);
            }

            // 4. å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—
            await fetchWeather(lat, lon);
        }

        // ä½æ‰€å–å¾— (OpenStreetMap Nominatim API)
        async function fetchAddress(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=ja`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'WeatherDashboardDemo/1.0' } // ãƒãƒŠãƒ¼ã¨ã—ã¦User-Agentã‚’è¨­å®š
                });
                const data = await response.json();
                
                if (data && data.address) {
                    const addr = data.address;
                    // è¦‹ã‚„ã™ã„ä½æ‰€ã‚’æ§‹ç¯‰ï¼ˆçœŒ + å¸‚ç”ºæ‘ + ç”ºåï¼‰
                    const pref = addr.province || addr.state || '';
                    const city = addr.city || addr.ward || addr.town || addr.village || '';
                    const sub = addr.suburb || addr.quarter || addr.neighbourhood || '';
                    
                    const fullName = `${pref} ${city} ${sub}`.trim() || "ä¸æ˜ãªå ´æ‰€";
                    document.getElementById('location-name').innerText = fullName;
                } else {
                    document.getElementById('location-name').innerText = "ä½æ‰€ä¸æ˜";
                }
            } catch (error) {
                console.error("ä½æ‰€å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('location-name').innerText = "ä½æ‰€å–å¾—å¤±æ•—";
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ/ç¾åœ¨ã®åº§æ¨™ã§åˆæœŸåŒ–
        function initializeDashboardWithCurrentCoords() {
            updateAppLocation(currentLat, currentLon);
        }

        // --- åœ°å›³æ©Ÿèƒ½ ---

        function toggleMap() {
            const container = document.getElementById('location-settings');
            const isHidden = container.classList.contains('hidden');
            
            if (isHidden) {
                container.classList.remove('hidden');
                // åœ°å›³ãŒåˆã‚ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã¨ãã«åˆæœŸåŒ–
                if (!mapInstance) {
                    initMap();
                } else {
                    // ã‚µã‚¤ã‚ºå†è¨ˆç®—ï¼ˆhiddenã‹ã‚‰å¾©å¸°æ™‚ã«å¿…è¦ï¼‰
                    setTimeout(() => mapInstance.invalidateSize(), 100);
                }
            } else {
                container.classList.add('hidden');
            }
        }

        function initMap() {
            // åœ°å›³åˆæœŸåŒ–
            mapInstance = L.map('map').setView([currentLat, currentLon], 13);

            // OpenStreetMapã‚¿ã‚¤ãƒ«
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
            markerInstance = L.marker([currentLat, currentLon], {draggable: false}).addTo(mapInstance);

            // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            mapInstance.on('click', function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                updateAppLocation(lat, lon);
            });
        }

        function updateMapMarker(lat, lon) {
            if (markerInstance) {
                markerInstance.setLatLng([lat, lon]);
            }
            mapInstance.panTo([lat, lon]);
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function getWindDirection(degrees) {
            const directions = ['åŒ—', 'åŒ—åŒ—æ±', 'åŒ—æ±', 'æ±åŒ—æ±', 'æ±', 'æ±å—æ±', 'å—æ±', 'å—å—æ±', 'å—', 'å—å—è¥¿', 'å—è¥¿', 'è¥¿å—è¥¿', 'è¥¿', 'è¥¿åŒ—è¥¿', 'åŒ—è¥¿', 'åŒ—åŒ—è¥¿'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // --- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæç”» ---
        function renderRadarChart(data) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (radarChartInstance) radarChartInstance.destroy();

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['é›²ã®å°‘ãªã•', 'æœˆã®æš—ã•', 'ä½æ¹¿åº¦', 'é«˜è¦–ç¨‹', 'é¢¨ã®ç©ã‚„ã‹ã•'],
                    datasets: [{
                        label: 'è¦³æ¸¬é©æ€§',
                        data: [data.cloudClearness, data.moonDarkness, data.lowHumidity, data.goodVisibility, data.calmWind],
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(34, 197, 94, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: '#cbd5e1',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // --- æµæ˜Ÿç¾¤ãƒ‡ãƒ¼ã‚¿ (å¹´é–“ã‚¤ãƒ™ãƒ³ãƒˆ) ---
        const meteorShowers = [
            { name: "ã—ã¶ã‚“ãåº§æµæ˜Ÿç¾¤", peakStart: "01-03", peakEnd: "01-04", rate: "120å€‹/æ™‚", note: "å¹´å§‹ã®ä¸‰å¤§æµæ˜Ÿç¾¤" },
            { name: "ã“ã¨åº§æµæ˜Ÿç¾¤", peakStart: "04-22", peakEnd: "04-23", rate: "18å€‹/æ™‚", note: "å®‰å®šã—ãŸæµæ˜Ÿç¾¤" },
            { name: "ã¿ãšãŒã‚åº§Î·æµæ˜Ÿç¾¤", peakStart: "05-06", peakEnd: "05-07", rate: "50å€‹/æ™‚", note: "å—åŠçƒã§å¥½æ¡ä»¶" },
            { name: "ãƒšãƒ«ã‚»ã‚¦ã‚¹åº§æµæ˜Ÿç¾¤", peakStart: "08-12", peakEnd: "08-13", rate: "100å€‹/æ™‚", note: "ä¸‰å¤§æµæ˜Ÿç¾¤ã®ä¸€ã¤" },
            { name: "ã‚ªãƒªã‚ªãƒ³åº§æµæ˜Ÿç¾¤", peakStart: "10-21", peakEnd: "10-22", rate: "20å€‹/æ™‚", note: "ãƒãƒ¬ãƒ¼å½—æ˜Ÿèµ·æº" },
            { name: "ã—ã—åº§æµæ˜Ÿç¾¤", peakStart: "11-17", peakEnd: "11-18", rate: "15å€‹/æ™‚", note: "33å¹´å‘¨æœŸã§å¤§å‡ºç¾" },
            { name: "ãµãŸã”åº§æµæ˜Ÿç¾¤", peakStart: "12-13", peakEnd: "12-14", rate: "120å€‹/æ™‚", note: "ä¸‰å¤§æµæ˜Ÿç¾¤ã®ä¸€ã¤" },
            { name: "ã“ãã¾åº§æµæ˜Ÿç¾¤", peakStart: "12-22", peakEnd: "12-23", rate: "10å€‹/æ™‚", note: "å®‰å®šã—ãŸè¦³æ¸¬" }
        ];

        // --- æœˆé½¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        function calculateMoonData(date) {
            // 2000å¹´1æœˆ6æ—¥ 18:14 (UTC) ã¯æ–°æœˆ (Lunation Number 953)
            // ç°¡æ˜“è¨ˆç®—ã®ãŸã‚ã€UTCã§ã®æ—¥ä»˜å·®åˆ†ã‚’åˆ©ç”¨
            const knownNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0)); 
            const diffTime = date.getTime() - knownNewMoon.getTime();
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            const synodicMonth = 29.53058867;
            
            let age = diffDays % synodicMonth;
            if (age < 0) age += synodicMonth;
            
            // æœˆç›¸ã®åˆ¤å®š
            let phaseName = "";
            let icon = "";
            
            // çµµæ–‡å­—ã¨åå‰ã®ãƒãƒƒãƒ”ãƒ³ã‚° (ç°¡æ˜“ç‰ˆ)
            if (age < 1.0 || age > 28.5) { phaseName = "æ–°æœˆ"; icon = "ğŸŒ‘"; }
            else if (age < 6.0) { phaseName = "ä¸‰æ—¥æœˆ"; icon = "ğŸŒ’"; }
            else if (age < 9.0) { phaseName = "ä¸Šå¼¦ã®æœˆ"; icon = "ğŸŒ“"; }
            else if (age < 13.5) { phaseName = "åæ—¥å¤œ"; icon = "ğŸŒ”"; }
            else if (age < 16.5) { phaseName = "æº€æœˆ"; icon = "ğŸŒ•"; }
            else if (age < 21.0) { phaseName = "ç«‹å¾…æœˆ"; icon = "ğŸŒ–"; }
            else if (age < 24.0) { phaseName = "ä¸‹å¼¦ã®æœˆ"; icon = "ğŸŒ—"; }
            else { phaseName = "æœ‰æ˜æœˆ"; icon = "ğŸŒ˜"; }

            return {
                age: age.toFixed(1),
                phaseName: phaseName,
                icon: icon
            };
        }

        // --- æ—¥ã®å‡ºå…¥ã‚Šãƒ»æœˆã®å‡ºå…¥ã‚Šãƒ»å¤©æ–‡è–„æ˜è¨ˆç®— ---
        function calculateSunMoonTimes(date, lat, lon) {
            try {
                const observer = new Astronomy.Observer(lat, lon, 0);

                // æ—¥ã®å‡ºãƒ»æ—¥ã®å…¥ã‚Š
                const sunrise = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, 1, date, 1);
                const sunset = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, date, 1);

                // å¤©æ–‡è–„æ˜ (-18åº¦)
                const astroTwilightMorning = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, -1, date, 1, -18);
                const astroTwilightEvening = Astronomy.SearchAltitude(Astronomy.Body.Sun, observer, 1, date, 1, -18);

                // æœˆã®å‡ºãƒ»æœˆã®å…¥ã‚Š
                const moonrise = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, 1, date, 1);
                const moonset = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, date, 1);

                return {
                    sunrise: sunrise ? moment(sunrise.date).format('HH:mm') : '--:--',
                    sunset: sunset ? moment(sunset.date).format('HH:mm') : '--:--',
                    astroTwilightBegin: astroTwilightMorning ? moment(astroTwilightMorning.date).format('HH:mm') : '--:--',
                    astroTwilightEnd: astroTwilightEvening ? moment(astroTwilightEvening.date).format('HH:mm') : '--:--',
                    moonrise: moonrise ? moment(moonrise.date).format('HH:mm') : '--:--',
                    moonset: moonset ? moment(moonset.date).format('HH:mm') : '--:--',
                    sunriseDate: sunrise ? sunrise.date : null,
                    sunsetDate: sunset ? sunset.date : null,
                    astroBeginDate: astroTwilightMorning ? astroTwilightMorning.date : null,
                    astroEndDate: astroTwilightEvening ? astroTwilightEvening.date : null
                };
            } catch (error) {
                console.error('æ—¥æœˆæ™‚åˆ»è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                return {
                    sunrise: '--:--',
                    sunset: '--:--',
                    astroTwilightBegin: '--:--',
                    astroTwilightEnd: '--:--',
                    moonrise: '--:--',
                    moonset: '--:--'
                };
            }
        }

        function updateSunMoonDisplay(times) {
            document.getElementById('sunrise-time').innerText = times.sunrise;
            document.getElementById('sunset-time').innerText = times.sunset;
            document.getElementById('twilight-astro-begin').innerText = times.astroTwilightBegin;
            document.getElementById('twilight-astro-end').innerText = times.astroTwilightEnd;
            document.getElementById('moonrise-time').innerText = times.moonrise;
            document.getElementById('moonset-time').innerText = times.moonset;
        }

        // --- 24æ™‚é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”» ---
        function renderTimeline(times, targetDate) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            const dayStart = moment(targetDate).startOf('day');
            const dayEnd = moment(targetDate).endOf('day');

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            const segments = [];

            // æ—¥ä¸­ï¼ˆæ—¥ã®å‡ºï½æ—¥ã®å…¥ã‚Šï¼‰
            if (times.sunriseDate && times.sunsetDate) {
                const sunriseTime = moment(times.sunriseDate);
                const sunsetTime = moment(times.sunsetDate);

                const start = ((sunriseTime - dayStart) / (dayEnd - dayStart)) * 100;
                const width = ((sunsetTime - sunriseTime) / (dayEnd - dayStart)) * 100;

                segments.push({ start, width, color: '#eab308', label: 'æ—¥ä¸­' });
            }

            // å¤©æ–‡è–„æ˜
            if (times.astroBeginDate && times.astroEndDate) {
                const astroBegin = moment(times.astroBeginDate);
                const astroEnd = moment(times.astroEndDate);

                // æœã®è–„æ˜
                const morningStart = ((astroBegin - dayStart) / (dayEnd - dayStart)) * 100;
                const morningWidth = ((moment(times.sunriseDate) - astroBegin) / (dayEnd - dayStart)) * 100;
                segments.push({ start: morningStart, width: morningWidth, color: '#3b82f6', label: 'æœè–„æ˜' });

                // å¤•æ–¹ã®è–„æ˜
                const eveningStart = ((moment(times.sunsetDate) - dayStart) / (dayEnd - dayStart)) * 100;
                const eveningWidth = ((astroEnd - moment(times.sunsetDate)) / (dayEnd - dayStart)) * 100;
                segments.push({ start: eveningStart, width: eveningWidth, color: '#3b82f6', label: 'å¤•è–„æ˜' });

                // è¦³æ¸¬é©æ™‚ï¼ˆå¤©æ–‡è–„æ˜çµ‚äº†å¾Œï½å¤©æ–‡è–„æ˜é–‹å§‹å‰ï¼‰
                const observeStart = ((astroEnd - dayStart) / (dayEnd - dayStart)) * 100;
                const observeEnd = ((astroBegin.clone().add(1, 'day') - dayStart) / (dayEnd - dayStart)) * 100;
                const observeWidth = observeEnd - observeStart;
                if (observeWidth > 0) {
                    segments.push({ start: observeStart, width: observeWidth, color: '#22c55e', label: 'è¦³æ¸¬é©æ™‚' });
                }
            }

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æç”»
            segments.forEach(seg => {
                const div = document.createElement('div');
                div.className = 'timeline-segment';
                div.style.left = `${seg.start}%`;
                div.style.width = `${seg.width}%`;
                div.style.background = seg.color;
                div.title = seg.label;
                container.appendChild(div);
            });
        }

        // --- å¤©ä½“ã‚¤ãƒ™ãƒ³ãƒˆé–¢æ•° ---

        // 1. ä»Šå¤œè¦‹ãˆã‚‹æƒ‘æ˜Ÿã‚’è¨ˆç®—
        function calculateVisiblePlanets(observerDate, observerLat, observerLon) {
            try {
                const observer = new Astronomy.Observer(observerLat, observerLon, 0);
                const planets = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];
                const planetNames = {
                    'Mercury': 'æ°´æ˜Ÿ',
                    'Venus': 'é‡‘æ˜Ÿ',
                    'Mars': 'ç«æ˜Ÿ',
                    'Jupiter': 'æœ¨æ˜Ÿ',
                    'Saturn': 'åœŸæ˜Ÿ'
                };
                const planetIcons = {
                    'Mercury': 'âš«',
                    'Venus': 'ğŸŒŸ',
                    'Mars': 'ğŸ”´',
                    'Jupiter': 'ğŸŸ ',
                    'Saturn': 'ğŸª'
                };

                let visiblePlanets = [];

                planets.forEach(planet => {
                    const equator = Astronomy.Equator(planet, observerDate, observer, true, true);
                    const horizon = Astronomy.Horizon(observerDate, observer, equator.ra, equator.dec, 'normal');
                    const illumination = Astronomy.Illumination(planet, observerDate);

                    // åœ°å¹³ç·šã‚ˆã‚Šä¸Šï¼ˆé«˜åº¦ > 0ï¼‰ã§ã€ã‚ã‚‹ç¨‹åº¦æ˜ã‚‹ã„å¤©ä½“ã®ã¿è¡¨ç¤º
                    if (horizon.altitude > 0) {
                        visiblePlanets.push({
                            name: planetNames[planet],
                            icon: planetIcons[planet],
                            altitude: horizon.altitude.toFixed(1),
                            azimuth: horizon.azimuth.toFixed(1),
                            magnitude: illumination.mag.toFixed(1)
                        });
                    }
                });

                // HTMLã«è¡¨ç¤º
                const container = document.getElementById('visible-planets');
                if (visiblePlanets.length === 0) {
                    container.innerHTML = '<div class="text-slate-400">ç¾åœ¨ã€åœ°å¹³ç·šä¸Šã«æƒ‘æ˜Ÿã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                } else {
                    container.innerHTML = visiblePlanets.map(p => `
                        <div class="flex items-center justify-between bg-slate-700/30 rounded-lg p-2">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${p.icon}</span>
                                <span class="font-semibold">${p.name}</span>
                            </div>
                            <div class="text-xs text-slate-400">
                                é«˜åº¦: ${p.altitude}Â° | æ–¹ä½: ${p.azimuth}Â° | ç­‰ç´š: ${p.magnitude}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('æƒ‘æ˜Ÿè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('visible-planets').innerHTML = '<div class="text-red-400">è¨ˆç®—ã‚¨ãƒ©ãƒ¼</div>';
            }
        }

        // 2. æµæ˜Ÿç¾¤ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
        function updateMeteorShowers(targetDate) {
            const currentYear = targetDate.getFullYear();
            const currentMonth = String(targetDate.getMonth() + 1).padStart(2, '0');
            const currentDay = String(targetDate.getDate()).padStart(2, '0');
            const currentDateStr = `${currentMonth}-${currentDay}`;

            // å‰å¾Œ30æ—¥ä»¥å†…ã®æµæ˜Ÿç¾¤ã‚’ãƒ•ã‚£ãƒ«ã‚¿
            const relevantShowers = meteorShowers.filter(shower => {
                const showerDate = new Date(`${currentYear}-${shower.peakStart}`);
                const targetDateTime = targetDate.getTime();
                const diffDays = Math.abs((showerDate - targetDateTime) / (1000 * 60 * 60 * 24));
                return diffDays <= 30;
            });

            const container = document.getElementById('meteor-showers');
            if (relevantShowers.length === 0) {
                container.innerHTML = '<div class="text-slate-400">ä»Šå¾Œ30æ—¥ä»¥å†…ã«æ¥µå¤§ã‚’è¿ãˆã‚‹æµæ˜Ÿç¾¤ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                container.innerHTML = relevantShowers.map(shower => {
                    const isPeak = currentDateStr === shower.peakStart || currentDateStr === shower.peakEnd;
                    const showerDateStr = shower.peakStart.replace('-', '/');
                    return `
                        <div class="bg-slate-700/30 rounded-lg p-2 ${isPeak ? 'border-l-2 border-yellow-400' : ''}">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold ${isPeak ? 'text-yellow-300' : ''}">${shower.name}</span>
                                <span class="text-xs text-slate-400">${showerDateStr} æ¥µå¤§</span>
                            </div>
                            <div class="text-xs text-slate-400 mt-1">
                                ${shower.rate} | ${shower.note}
                            </div>
                            ${isPeak ? '<div class="text-xs text-yellow-300 mt-1">ğŸŒŸ æœ¬æ—¥ãŒæ¥µå¤§æ—¥ã§ã™ï¼</div>' : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        // 3. æœˆé½¢ã«ã‚ˆã‚‹è¦³æ¸¬æ¨å¥¨å¤©ä½“
        function updateRecommendedObjects(moonAge) {
            const age = parseFloat(moonAge);
            const container = document.getElementById('recommended-objects');

            let recommendations = [];

            if (age < 3 || age > 26) {
                // æ–°æœˆæœŸ: æš—ã„å¤©ä½“ã«æœ€é©
                recommendations = [
                    { name: 'ã‚¢ãƒ³ãƒ‰ãƒ­ãƒ¡ãƒ€éŠ€æ²³ (M31)', type: 'éŠ€æ²³', reason: 'æš—ã„å¤œç©ºã§è¦‹ã‚„ã™ã„' },
                    { name: 'ã‚ªãƒªã‚ªãƒ³å¤§æ˜Ÿé›² (M42)', type: 'æ˜Ÿé›²', reason: 'æ–°æœˆæœŸãŒæœ€é©' },
                    { name: 'ãƒ—ãƒ¬ã‚¢ãƒ‡ã‚¹æ˜Ÿå›£ (M45)', type: 'æ˜Ÿå›£', reason: 'æš—ã„ç©ºã§ç¾ã—ã„' }
                ];
            } else if (age >= 3 && age < 10) {
                // ä¸Šå¼¦å‰å¾Œ: æœˆé¢è¦³æ¸¬ã«é©ã™ã‚‹
                recommendations = [
                    { name: 'æœˆé¢ã‚¯ãƒ¬ãƒ¼ã‚¿ãƒ¼', type: 'æœˆ', reason: 'å½±ãŒé•·ãè¦‹ã‚„ã™ã„' },
                    { name: 'æ˜ã‚‹ã„æƒ‘æ˜Ÿ', type: 'æƒ‘æ˜Ÿ', reason: 'æœˆæ˜ã‹ã‚Šã®å½±éŸ¿å°‘ãªã„' },
                    { name: 'äºŒé‡æ˜Ÿï¼ˆã‚¢ãƒ«ãƒ“ãƒ¬ã‚ªï¼‰', type: 'æ’æ˜Ÿ', reason: 'æ˜ã‚‹ã„æ˜Ÿãªã‚‰è¦³æ¸¬å¯' }
                ];
            } else if (age >= 10 && age < 18) {
                // æº€æœˆæœŸ: æœˆé¢è¦³æ¸¬ãƒ¡ã‚¤ãƒ³
                recommendations = [
                    { name: 'æº€æœˆã®åœ°å½¢è¦³æ¸¬', type: 'æœˆ', reason: 'å…¨ä½“åƒã‚’è¦³æ¸¬' },
                    { name: 'æ˜ã‚‹ã„æ˜Ÿé›² (M42)', type: 'æ˜Ÿé›²', reason: 'æ˜ã‚‹ã„å¤©ä½“ã®ã¿' },
                    { name: 'æƒ‘æ˜Ÿã®è¡›æ˜Ÿ', type: 'æƒ‘æ˜Ÿ', reason: 'æœ¨æ˜Ÿã®è¡›æ˜Ÿãªã©' }
                ];
            } else {
                // ä¸‹å¼¦å‰å¾Œ: æœæ–¹ã®è¦³æ¸¬
                recommendations = [
                    { name: 'æœˆé¢å—éƒ¨ã‚¯ãƒ¬ãƒ¼ã‚¿ãƒ¼', type: 'æœˆ', reason: 'ä¸‹å¼¦ã¯å—éƒ¨ãŒè¦‹ã‚„ã™ã„' },
                    { name: 'æ˜ã‘æ–¹ã®æƒ‘æ˜Ÿ', type: 'æƒ‘æ˜Ÿ', reason: 'æ°´æ˜Ÿãƒ»é‡‘æ˜ŸãŒå¥½æ¡ä»¶' },
                    { name: 'çƒçŠ¶æ˜Ÿå›£ (M13)', type: 'æ˜Ÿå›£', reason: 'æ˜ã‘æ–¹ãªã‚‰è¦³æ¸¬å¯' }
                ];
            }

            container.innerHTML = recommendations.map(rec => `
                <div class="bg-slate-700/30 rounded-lg p-2">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">${rec.name}</span>
                        <span class="text-xs bg-green-600/30 text-green-300 px-2 py-0.5 rounded">${rec.type}</span>
                    </div>
                    <div class="text-xs text-slate-400 mt-1">${rec.reason}</div>
                </div>
            `).join('');
        }

        // --- å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾— & æç”» ---

        async function fetchWeather(lat, lon) {
            // API URL (è¿½åŠ æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€)
            const API_URL = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,cloud_cover,cloud_cover_low,cloud_cover_mid,cloud_cover_high,windspeed_10m,winddirection_10m,surface_pressure,dewpoint_2m,visibility&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset&timezone=Asia%2FTokyo&past_days=2&forecast_days=10`;

            try {
                const response = await fetch(API_URL);
                weatherData = await response.json();
                
                // åˆå›ã¯ç¾åœ¨æ™‚åˆ»ã§æç”»
                // ã‚‚ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéå»ã®æ—¥ä»˜ã‚’é¸æŠä¸­ã®å ´åˆã¯ãã®ã¾ã¾ç¶­æŒã—ã¦ã‚‚è‰¯ã„ãŒã€
                // å ´æ‰€ã‚’å¤‰ãˆãŸã‚‰ã€Œç¾åœ¨ã€ã«æˆ»ã‚‹æ–¹ãŒè‡ªç„¶ãªãŸã‚ã€ç¾åœ¨æ™‚åˆ»ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹
                const now = moment();
                setDatePickerValue(now);
                renderDashboard(now);
            } catch (error) {
                document.getElementById('loading').innerHTML = `<span class="text-red-400">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
                console.error(error);
            }
        }

        // --- UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯) ---

        function setDatePickerValue(momentObj) {
            const formatted = momentObj.format('YYYY-MM-DDTHH:mm');
            document.getElementById('target-datetime').value = formatted;
        }

        function updateDashboardTime() {
            const val = document.getElementById('target-datetime').value;
            if (val && weatherData) {
                renderDashboard(moment(val));
            }
        }

        function resetToNow() {
            const now = moment();
            setDatePickerValue(now);
            if (weatherData) {
                renderDashboard(now);
            }
        }

        // æ–°ã—ã„é–¢æ•°: é€±é–“äºˆå ±ã®æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        function selectDate(dateStr) {
            // ç¾åœ¨ã®å…¥åŠ›å€¤ï¼ˆæ™‚é–“ï¼‰ã‚’å–å¾—ã—ã¦ã€æ—¥ä»˜ã ã‘å·®ã—æ›¿ãˆã‚‹
            const currentVal = document.getElementById('target-datetime').value;
            let targetMoment = moment(dateStr); 
            
            if (currentVal) {
                const currentMoment = moment(currentVal);
                // æ™‚é–“ã¨åˆ†ã‚’ç¶­æŒ
                targetMoment.hour(currentMoment.hour());
                targetMoment.minute(currentMoment.minute());
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ­£åˆãªã©ã«ã™ã‚‹ã‹ã€ç¾åœ¨æ™‚åˆ»ã«åˆã‚ã›ã‚‹
                const now = moment();
                targetMoment.hour(now.hour());
                targetMoment.minute(now.minute());
            }

            setDatePickerValue(targetMoment);
            renderDashboard(targetMoment);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸Šéƒ¨ã¸ï¼ˆã‚¹ãƒãƒ›ãªã©ã§è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
            document.getElementById('dashboard-content').scrollIntoView({ behavior: 'smooth' });
        }

        function getWeatherInfo(code) {
            if (code === 0) return { label: 'å¿«æ™´', icon: 'sun', color: 'text-orange-400' };
            if (code >= 1 && code <= 3) return { label: 'æ›‡ã‚Šãƒ»æ™´ã‚Œé–“', icon: 'cloud-sun', color: 'text-gray-300' };
            if (code >= 45 && code <= 48) return { label: 'éœ§', icon: 'align-justify', color: 'text-gray-400' };
            if (code >= 51 && code <= 55) return { label: 'éœ§é›¨', icon: 'cloud-drizzle', color: 'text-blue-300' };
            if (code >= 61 && code <= 67) return { label: 'é›¨', icon: 'cloud-rain', color: 'text-blue-400' };
            if (code >= 71 && code <= 77) return { label: 'é›ª', icon: 'snowflake', color: 'text-white' };
            if (code >= 80 && code <= 82) return { label: 'ã«ã‚ã‹é›¨', icon: 'cloud-hail', color: 'text-blue-300' };
            if (code >= 95 && code <= 99) return { label: 'é›·é›¨', icon: 'cloud-lightning', color: 'text-yellow-400' };
            return { label: 'ä¸æ˜', icon: 'help-circle', color: 'text-gray-500' };
        }

        function renderDashboard(targetMoment) {
            if (!weatherData) return;

            const hourly = weatherData.hourly;
            const daily = weatherData.daily;
            const targetDate = targetMoment.toDate();
            
            let currentIndex = 0;
            let minDiff = Infinity;
            let isOutOfRange = true;

            hourly.time.forEach((t, i) => {
                const diff = Math.abs(new Date(t) - targetDate);
                if (diff < minDiff) {
                    minDiff = diff;
                    currentIndex = i;
                }
                if (diff < 90 * 60 * 1000) { 
                    isOutOfRange = false;
                }
            });

            if (isOutOfRange && minDiff > 24 * 60 * 60 * 1000) {
                 document.getElementById('forecast-summary').innerText = "é¸æŠã•ã‚ŒãŸæ—¥æ™‚ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç¯„å›²å¤–ã§ã™ï¼‰";
                 return;
            }

            // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            const currentTemp = hourly.temperature_2m[currentIndex];
            const currentCloudTotal = hourly.cloud_cover[currentIndex];
            const currentLow = hourly.cloud_cover_low[currentIndex];
            const currentMid = hourly.cloud_cover_mid[currentIndex];
            const currentHigh = hourly.cloud_cover_high[currentIndex];

            document.getElementById('current-temp').innerText = `${currentTemp}Â°C`;
            document.getElementById('current-clouds').innerText = `${currentCloudTotal}%`;
            
            document.getElementById('clouds-high').innerText = `${currentHigh}%`;
            document.getElementById('bar-high').style.width = `${currentHigh}%`;
            
            document.getElementById('clouds-mid').innerText = `${currentMid}%`;
            document.getElementById('bar-mid').style.width = `${currentMid}%`;
            
            document.getElementById('clouds-low').innerText = `${currentLow}%`;
            document.getElementById('bar-low').style.width = `${currentLow}%`;

            // æœˆé½¢æƒ…å ±ã®æ›´æ–° (ã‚µãƒãƒªãƒ¼ã‚¨ãƒªã‚¢)
            const moonData = calculateMoonData(targetDate);
            document.getElementById('current-moon-icon').innerText = moonData.icon;
            document.getElementById('current-moon-age-text').innerText = moonData.age;
            document.getElementById('current-moon-name').innerText = moonData.phaseName;

            // å¤©ä½“ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æ›´æ–°
            calculateVisiblePlanets(targetDate, currentLat, currentLon);
            updateMeteorShowers(targetDate);
            updateRecommendedObjects(moonData.age);

            // è¿½åŠ æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
            const currentWindSpeed = hourly.windspeed_10m ? hourly.windspeed_10m[currentIndex] : 0;
            const currentWindDir = hourly.winddirection_10m ? hourly.winddirection_10m[currentIndex] : 0;
            const currentPressure = hourly.surface_pressure ? hourly.surface_pressure[currentIndex] : 1013;
            const currentDewpoint = hourly.dewpoint_2m ? hourly.dewpoint_2m[currentIndex] : 0;
            const currentVisibility = hourly.visibility ? (hourly.visibility[currentIndex] / 1000).toFixed(1) : 24;
            const currentHumidity = hourly.relative_humidity_2m[currentIndex];

            document.getElementById('wind-speed').innerText = `${currentWindSpeed.toFixed(1)} m/s`;
            const windDirText = getWindDirection(currentWindDir);
            document.getElementById('wind-direction').innerText = windDirText;
            document.getElementById('pressure').innerText = `${currentPressure.toFixed(0)} hPa`;
            document.getElementById('dewpoint').innerText = `${currentDewpoint.toFixed(1)}Â°C`;
            document.getElementById('visibility').innerText = `${currentVisibility} km`;

            // çµéœ²ãƒªã‚¹ã‚¯åˆ¤å®š
            const tempDiff = currentTemp - currentDewpoint;
            let condensationRisk = '';
            if (tempDiff < 2) condensationRisk = 'âš ï¸ çµéœ²ãƒªã‚¹ã‚¯é«˜';
            else if (tempDiff < 5) condensationRisk = 'âš¡ çµéœ²æ³¨æ„';
            else condensationRisk = 'âœ… çµéœ²ãƒªã‚¹ã‚¯ä½';
            document.getElementById('condensation-risk').innerText = condensationRisk;

            // æ—¥æœˆå‡ºæ²¡ãƒ»å¤©æ–‡è–„æ˜ã®è¨ˆç®—ã¨è¡¨ç¤º
            const sunMoonTimes = calculateSunMoonTimes(targetDate, currentLat, currentLon);
            updateSunMoonDisplay(sunMoonTimes);
            renderTimeline(sunMoonTimes, targetDate);

            // æ˜Ÿç©ºè¦–èªæ€§ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
            const starryScore = calculateStarryScore(currentCloudTotal, moonData.age, currentHumidity, parseFloat(currentVisibility), currentWindSpeed);
            updateStarryScore(starryScore);

            // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿æº–å‚™
            const radarData = {
                cloudClearness: Math.max(0, 100 - currentCloudTotal),
                moonDarkness: moonData.age < 3 || moonData.age > 26 ? 100 : moonData.age < 10 || moonData.age > 18 ? 60 : 20,
                lowHumidity: Math.max(0, 100 - currentHumidity),
                goodVisibility: Math.min(100, (parseFloat(currentVisibility) / 50) * 100),
                calmWind: currentWindSpeed < 2 ? 100 : currentWindSpeed < 5 ? 80 : currentWindSpeed < 10 ? 50 : 20
            };
            renderRadarChart(radarData);


            // ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ
            const displayTimeStr = targetMoment.format('MæœˆDæ—¥ H:mm');
            document.getElementById('summary-timestamp').innerText = `è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿æ™‚åˆ»: ${displayTimeStr}`;

            let summary = `æ°—æ¸© ${currentTemp}Â°Cã€‚`;
            if(currentCloudTotal < 20) summary += " å¿«æ™´ã¾ãŸã¯æ™´ã‚Œã€‚";
            else if(currentCloudTotal < 60) summary += " é›²é–“ã‚ã‚Šã€‚";
            else summary += " æ›‡ã‚Šç©ºã€‚";
            
            if (currentIndex + 6 < hourly.temperature_2m.length) {
                const futureTemp = hourly.temperature_2m[currentIndex + 6];
                const tempDiff = futureTemp - currentTemp;
                if(tempDiff > 2) summary += " ãã®å¾Œã€æ°—æ¸©ã¯ä¸Šæ˜‡å‚¾å‘ã§ã™ã€‚";
                else if(tempDiff < -2) summary += " ãã®å¾Œã€å†·ãˆè¾¼ã‚€è¦‹è¾¼ã¿ã§ã™ã€‚";
            }

            // --- å¤©ä½“è¦³æ¸¬ã‚µãƒãƒªãƒ¼è¿½åŠ  ---
            // é¸æŠã•ã‚ŒãŸæ—¥æ™‚ã®ã€Œå¤œé–“ï¼ˆ20:00 - ç¿Œ04:00ï¼‰ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let astroStart = targetMoment.clone().startOf('day').add(20, 'hours');
            // ä¿®æ­£: æ·±å¤œã§ã‚‚ã€Œãã®æ—¥ã®20æ™‚ã€œã€ã‚’å¯¾è±¡ã«ã™ã‚‹ãŸã‚ã€æ·±å¤œè£œæ­£ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤
            
            const astroEnd = astroStart.clone().add(8, 'hours'); // 20:00 -> 04:00 (8æ™‚é–“)
            
            let astroCloudSum = 0;
            let astroCount = 0;
            
            hourly.time.forEach((t, i) => {
                const time = moment(t);
                if (time.isSameOrAfter(astroStart) && time.isBefore(astroEnd)) {
                    astroCloudSum += hourly.cloud_cover[i];
                    astroCount++;
                }
            });

            if (astroCount > 0) {
                const avgAstroCloud = astroCloudSum / astroCount;
                summary += "<br><br><strong>ğŸ”­ å¤©ä½“è¦³æ¸¬äºˆå ±:</strong> ";
                const dateStr = astroStart.format('M/D');
                
                // æœˆã®å½±éŸ¿ã‚’åŠ å‘³ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ
                let moonComment = "";
                if (moonData.age > 10 && moonData.age < 18) {
                    moonComment = "ãŸã ã—ã€æœˆæ˜ã‹ã‚Šã®å½±éŸ¿ãŒå¤§ãã„ã§ã—ã‚‡ã†ã€‚";
                }

                if (avgAstroCloud < 15) {
                    summary += `${dateStr}ã®å¤œã¯ã€é›²ãŒå°‘ãªã<strong>çµ¶å¥½ã®å¤©ä½“è¦³æ¸¬æ—¥å’Œ</strong>ã§ã™ã€‚${moonComment}`;
                } else if (avgAstroCloud < 40) {
                    summary += `${dateStr}ã®å¤œã¯ã€é›²ã¯å°‘ãªã‚ã§<strong>è¦³æ¸¬ã«é©ã—ã¦ã„ã¾ã™</strong>ã€‚${moonComment}`;
                } else if (avgAstroCloud < 75) {
                    summary += `${dateStr}ã®å¤œã¯ã€é›²ãŒå‡ºã‚‹ãŸã‚è¦³æ¸¬ã«ã¯<strong>å¿è€ãŒå¿…è¦</strong>ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`;
                } else {
                    summary += `${dateStr}ã®å¤œã¯ã€é›²ãŒå¤šã<strong>è¦³æ¸¬ã«ã¯ä¸å‘ã</strong>ãªäºˆå ±ã§ã™ã€‚`;
                }
            }
            
            // innerText -> innerHTML (ã‚¿ã‚°ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚)
            document.getElementById('forecast-summary').innerHTML = summary;

            // ãƒãƒ£ãƒ¼ãƒˆæç”» (24æ™‚é–“åˆ†ã«ä¿®æ­£)
            const sliceStart = currentIndex;
            const sliceEnd = Math.min(currentIndex + 24, hourly.time.length);
            
            const labels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('Dæ—¥ Hæ™‚'));
            const fullDateLabels = hourly.time.slice(sliceStart, sliceEnd).map(t => moment(t).format('MæœˆDæ—¥ H:mm'));
            
            const temps = hourly.temperature_2m.slice(sliceStart, sliceEnd);
            const cloudLow = hourly.cloud_cover_low.slice(sliceStart, sliceEnd);
            const cloudMid = hourly.cloud_cover_mid.slice(sliceStart, sliceEnd);
            const cloudHigh = hourly.cloud_cover_high.slice(sliceStart, sliceEnd);

            // æ°—æ¸©ãƒãƒ£ãƒ¼ãƒˆ
            const ctxTemp = document.getElementById('tempChart').getContext('2d');
            if(tempChartInstance) tempChartInstance.destroy();

            let gradientTemp = ctxTemp.createLinearGradient(0, 0, 0, 400);
            gradientTemp.addColorStop(0, 'rgba(251, 146, 60, 0.5)'); 
            gradientTemp.addColorStop(1, 'rgba(251, 146, 60, 0.0)');

            tempChartInstance = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ°—æ¸© (Â°C)',
                        data: temps,
                        borderColor: '#fb923c',
                        backgroundColor: gradientTemp,
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] } }
                    },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }
                    }
                }
            });

            // é›²ãƒãƒ£ãƒ¼ãƒˆ (ç©ã¿ä¸Šã’é †ã‚’ä¿®æ­£: Low -> Mid -> High)
            // é…è‰²: ä¸‹å±¤=Gray-300(å¤‰æ›´), ä¸­å±¤=Emerald, ä¸Šå±¤=Violet
            const ctxCloud = document.getElementById('cloudChart').getContext('2d');
            if(cloudChartInstance) cloudChartInstance.destroy();

            cloudChartInstance = new Chart(ctxCloud, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ä¸‹å±¤é›²', data: cloudLow, borderColor: '#d1d5db', backgroundColor: 'rgba(209, 213, 219, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },
                        { label: 'ä¸­å±¤é›²', data: cloudMid, borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 },
                        { label: 'ä¸Šå±¤é›²', data: cloudHigh, borderColor: '#a78bfa', backgroundColor: 'rgba(167, 139, 250, 0.6)', borderWidth: 1, fill: true, tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#cbd5e1' } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                             callbacks: { title: (items) => fullDateLabels[items[0].dataIndex] }
                        }
                    },
                    scales: {
                        y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } }
                    }
                }
            });

            // é€±é–“äºˆå ±ãƒ†ãƒ¼ãƒ–ãƒ«
            const weeklyBody = document.getElementById('weekly-forecast-body');
            weeklyBody.innerHTML = '';
            
            daily.time.forEach((t, i) => {
                const date = moment(t);
                const isSelectedDay = date.isSame(targetMoment, 'day');
                const weatherInfo = getWeatherInfo(daily.weathercode[i]);
                const maxTemp = daily.temperature_2m_max[i];
                const minTemp = daily.temperature_2m_min[i];
                const rainSum = daily.precipitation_sum[i];
                const rainProb = daily.precipitation_probability_max[i];
                
                // æœˆé½¢è¨ˆç®—
                const moonInfo = calculateMoonData(date.toDate());

                // 1æ™‚é–“ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã“ã®æ—¥ã®å¹³å‡é›²é‡ã¨æ¹¿åº¦ã‚’è¨ˆç®—
                const dateStr = t; // "YYYY-MM-DD"
                let cloudSum = 0;
                let humSum = 0;
                let count = 0;
                
                // ãƒ‡ãƒ¼ã‚¿é‡ãŒå°‘ãªã„ã®ã§å˜ç´”ãƒ«ãƒ¼ãƒ—ã§é›†è¨ˆ
                hourly.time.forEach((hTime, hIndex) => {
                    if (hTime.startsWith(dateStr)) {
                        cloudSum += hourly.cloud_cover[hIndex];
                        humSum += hourly.relative_humidity_2m[hIndex];
                        count++;
                    }
                });
                
                const avgCloud = count > 0 ? Math.round(cloudSum / count) : '-';
                const avgHum = count > 0 ? Math.round(humSum / count) : '-';

                const row = document.createElement('tr');
                // cursor-pointer ã‚’è¿½åŠ ã€onclickã‚’è¿½åŠ 
                row.className = `border-b border-slate-700/50 transition cursor-pointer ${isSelectedDay ? 'bg-blue-500/20 border-l-4 border-l-blue-400' : 'hover:bg-white/5'}`;
                row.onclick = () => selectDate(t); // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ

                row.innerHTML = `
                    <td class="py-4 px-2">
                        <div class="font-bold ${isSelectedDay ? 'text-blue-300' : 'text-white'}">${date.format('M/D')}</div>
                        <div class="text-xs text-slate-400">${date.format('ddd')}</div>
                    </td>
                    <td class="py-4 px-2">
                        <div class="flex items-center gap-3">
                            <i data-lucide="${weatherInfo.icon}" class="${weatherInfo.color} w-6 h-6"></i>
                            <span class="hidden md:inline text-sm">${weatherInfo.label}</span>
                        </div>
                    </td>
                    <td class="py-4 px-2 text-center">
                        <div class="text-sm">${rainProb !== null ? rainProb + '%' : '-'}</div>
                        <div class="text-xs text-blue-300">${rainSum > 0 ? rainSum + 'mm' : ''}</div>
                    </td>
                     <td class="py-4 px-2 text-center">
                        <div class="text-sm font-semibold">${avgCloud !== '-' ? avgCloud + '%' : '-'}</div>
                        <div class="w-16 bg-slate-700/50 rounded-full h-1 mx-auto mt-1">
                            <div class="bg-slate-400 h-1 rounded-full" style="width: ${avgCloud !== '-' ? avgCloud : 0}%"></div>
                        </div>
                    </td>
                    <td class="py-4 px-2 text-center">
                        <div class="text-sm font-semibold text-blue-200 flex items-center justify-center gap-1">
                            <i data-lucide="droplet" class="w-3 h-3"></i>
                            ${avgHum !== '-' ? avgHum + '%' : '-'}
                        </div>
                    </td>
                     <td class="py-4 px-2 text-center">
                        <div class="text-lg" title="${moonInfo.phaseName} (æœˆé½¢${moonInfo.age})">${moonInfo.icon}</div>
                        <div class="text-xs text-slate-400">${moonInfo.age}</div>
                    </td>
                    <td class="py-4 px-2 text-right">
                        <span class="font-bold text-orange-400">${maxTemp}Â°</span> 
                        <span class="text-slate-500 mx-1">/</span> 
                        <span class="text-blue-300">${minTemp}Â°</span>
                    </td>
                `;
                weeklyBody.appendChild(row);
            });
            
            lucide.createIcons();

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
        }
    </script>
</body>
</html>

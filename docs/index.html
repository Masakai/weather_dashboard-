<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天体観測できるかな？</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ja.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Astronomy Engine for planetary calculations -->
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Date picker custom styles for dark mode compatibility */
        input[type="datetime-local"] {
            color-scheme: dark;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1;
        }
        /* Leaflet customization */
        .leaflet-container {
            background: #1e293b;
        }
        /* Night Vision Mode */
        body.night-vision {
            filter: hue-rotate(180deg) invert(1);
            background: #300000 !important;
        }
        body.night-vision .glass-panel {
            background: rgba(100, 0, 0, 0.3) !important;
            border-color: rgba(200, 0, 0, 0.3) !important;
        }
        body.night-vision * {
            color: #ff6666 !important;
            border-color: #ff3333 !important;
        }
        /* Starry Score Meter */
        .score-meter {
            width: 200px;
            height: 200px;
            position: relative;
        }
        .score-circle {
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 1s ease;
        }
        /* Timeline styles */
        .timeline-bar {
            position: relative;
            height: 60px;
            background: linear-gradient(to right, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 8px;
            overflow: hidden;
        }
        .timeline-segment {
            position: absolute;
            height: 100%;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen p-4 md:p-8">

    <!-- ISS通過通知バナー -->
    <div id="iss-notification-banner" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md w-full mx-4">
        <div class="bg-gradient-to-r from-yellow-500/95 to-orange-500/95 backdrop-blur-sm rounded-xl shadow-2xl border-2 border-yellow-300/50 p-4">
            <div class="flex items-start gap-3">
                <i data-lucide="satellite" class="w-6 h-6 text-white flex-shrink-0 mt-0.5"></i>
                <div class="flex-1">
                    <div class="font-bold text-white text-sm mb-1">🛰️ ISS通過まもなく！</div>
                    <div id="iss-notification-text" class="text-white text-xs"></div>
                </div>
                <button onclick="closeISSNotification()" class="text-white hover:text-yellow-100 transition flex-shrink-0">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- ヘッダー -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex-1">
                <!-- メインタイトル -->
                <h1 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-100 via-blue-200 to-blue-400 mb-3 flex items-center gap-3">
                    <i data-lucide="telescope" class="text-yellow-200 w-8 h-8 md:w-12 md:h-12"></i>
                    天体観測できるかな？
                </h1>
                
                <!-- 場所情報 -->
                <div class="flex items-center gap-2 text-xl font-semibold text-slate-200 pl-1">
                    <i data-lucide="map-pin" class="text-blue-400"></i>
                    <span id="location-name">位置情報を取得中...</span>
                </div>
                <p class="text-slate-400 text-sm mt-1 flex items-center gap-2 pl-1">
                    <span id="coords-display">緯度: -- | 経度: --</span>
                    <button onclick="toggleMap()" class="text-blue-300 hover:text-white underline text-xs ml-2">
                        地図で場所を変更
                    </button>
                </p>
            </div>
            <div class="text-right flex flex-col items-end">
                <div id="current-clock" class="text-xl font-semibold font-mono">--:--:--</div>
                <div class="text-slate-400 text-sm">現在時刻 (Asia/Tokyo)</div>
                <div class="text-slate-500 text-xs mt-2 flex items-center gap-2">
                    Ver. 3.0.0
                    <button onclick="toggleNightVision()" class="text-xs bg-red-900/30 hover:bg-red-800/50 px-2 py-1 rounded border border-red-600/30" title="ナイトビジョンモード">
                        <i data-lucide="moon" class="w-3 h-3 inline"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 地図・位置設定エリア (初期は非表示) -->
        <div id="location-settings" class="hidden glass-panel rounded-xl p-4 space-y-4">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h3 class="font-bold flex items-center gap-2">
                    <i data-lucide="map" class="w-5 h-5 text-green-400"></i> 地図から場所を選択
                </h3>
                <button onclick="getCurrentLocation()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <i data-lucide="crosshair" class="w-4 h-4"></i> 現在地を取得
                </button>
            </div>
            <p class="text-sm text-slate-300">地図をクリックすると、その場所の天気を表示します。</p>
            <div id="map"></div>
        </div>

        <!-- コントロールバー (日時指定) -->
        <div class="glass-panel rounded-xl p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-2 text-sm md:text-base">
                <i data-lucide="settings-2" class="text-slate-300 w-5 h-5"></i>
                <span class="font-bold">表示日時を指定:</span>
            </div>
            <div class="flex items-center gap-3 w-full sm:w-auto">
                <input type="datetime-local" id="target-datetime"
                    class="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-400 w-full sm:w-auto font-mono"
                    step="900"
                    onchange="updateDashboardTime()"
                    title="日付と時刻を選択してください">

                <button onclick="resetToNow()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap">
                    現在に戻す
                </button>
            </div>
        </div>

        <!-- ロード中表示 -->
        <div id="loading" class="text-center py-20 text-xl animate-pulse">天気データを取得中...</div>
        
        <div id="dashboard-content" class="hidden space-y-6">
            <!-- 星空視認性スコア（大型表示） -->
            <div class="glass-panel rounded-2xl p-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex flex-col items-center justify-center">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="sparkles" class="text-yellow-400 w-5 h-5"></i> 星空視認性スコア
                        </h3>
                        <svg class="score-meter" viewBox="0 0 160 160">
                            <circle cx="80" cy="80" r="70" fill="none" stroke="#334155" stroke-width="12"/>
                            <circle id="score-circle" class="score-circle" cx="80" cy="80" r="70" fill="none" stroke="url(#scoreGradient)" stroke-width="12" stroke-linecap="round" transform="rotate(-90 80 80)"/>
                            <defs>
                                <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#eab308;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#22c55e;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <text id="score-text" x="80" y="75" text-anchor="middle" font-size="36" font-weight="bold" fill="#fff">--</text>
                            <text x="80" y="95" text-anchor="middle" font-size="12" fill="#94a3b8">/ 100</text>
                        </svg>
                        <p id="score-comment" class="text-sm text-slate-300 mt-3 text-center">計算中...</p>
                    </div>

                    <!-- お気に入り地点 -->
                    <div class="flex-1 w-full">
                        <h4 class="font-semibold text-sm mb-3 flex items-center gap-2">
                            <i data-lucide="bookmark" class="w-4 h-4 text-blue-400"></i>
                            お気に入り地点
                        </h4>
                        <div id="favorite-locations" class="space-y-2">
                            <button onclick="addFavoriteLocation()" class="w-full bg-slate-800/50 hover:bg-slate-700/50 rounded-lg p-3 text-sm border border-slate-700 flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                現在地をお気に入りに追加
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- メイン指標 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 気温カード -->
                <div class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden group hover:bg-white/5 transition">
                    <div class="absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider">指定時刻の気温</div>
                    <i data-lucide="thermometer" class="w-12 h-12 text-orange-400 mb-4"></i>
                    <div class="text-5xl font-bold mb-1" id="current-temp">--°C</div>
                    <div class="text-slate-300">気温</div>
                </div>

                <!-- 雲量カード -->
                <div class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden hover:bg-white/5 transition">
                    <div class="absolute top-4 left-4 text-slate-400 text-sm font-medium uppercase tracking-wider">指定時刻の雲量</div>
                    <i data-lucide="cloud" class="w-12 h-12 text-slate-300 mb-4"></i>
                    <div class="text-5xl font-bold mb-1" id="current-clouds">--%</div>
                    <div class="text-slate-300">全天雲量</div>
                </div>

                <!-- 雲の詳細 -->
                <div class="glass-panel rounded-2xl p-6 flex flex-col justify-center gap-4 hover:bg-white/5 transition">
                    <div class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-2">雲の層（高度別）</div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300 flex items-center gap-2"><i data-lucide="arrow-up" class="w-4 h-4"></i> 上層雲</span>
                        <span class="font-bold text-lg" id="clouds-high">--%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-2">
                        <!-- 上層雲: Violet -->
                        <div id="bar-high" class="bg-violet-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>

                    <div class="flex justify-between items-center mt-1">
                        <span class="text-slate-300 flex items-center gap-2"><i data-lucide="minus" class="w-4 h-4"></i> 中層雲</span>
                        <span class="font-bold text-lg" id="clouds-mid">--%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-2">
                        <!-- 中層雲: Emerald -->
                        <div id="bar-mid" class="bg-emerald-400 h-2 rounded-full" style="width: 0%"></div>
                    </div>

                    <div class="flex justify-between items-center mt-1">
                        <span class="text-slate-300 flex items-center gap-2"><i data-lucide="arrow-down" class="w-4 h-4"></i> 下層雲</span>
                        <span class="font-bold text-lg" id="clouds-low">--%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-2">
                        <!-- 下層雲: 明るいグレー -->
                        <div id="bar-low" class="bg-gray-300 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 追加気象データ + 天文薄明時刻 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- 追加気象データ -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="gauge" class="text-cyan-400 w-5 h-5"></i> 詳細気象データ
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">風速・風向</div>
                            <div class="text-xl font-bold" id="wind-speed">-- m/s</div>
                            <div class="text-sm text-slate-300" id="wind-direction">--</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">気圧</div>
                            <div class="text-xl font-bold" id="pressure">-- hPa</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">露点温度</div>
                            <div class="text-xl font-bold" id="dewpoint">--°C</div>
                            <div class="text-xs text-slate-400" id="condensation-risk">--</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">視程</div>
                            <div class="text-xl font-bold" id="visibility">-- km</div>
                        </div>
                    </div>
                </div>

                <!-- 天体観測時間帯 -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="stars" class="text-yellow-400 w-5 h-5"></i> 天体観測の時間帯
                    </h3>

                    <!-- 観測可能時間（最重要情報） -->
                    <div class="bg-slate-800/50 rounded-lg p-3 mb-4 border border-green-500/30">
                        <div class="text-xs text-green-400 mb-2 flex items-center gap-1">
                            <i data-lucide="telescope" class="w-3 h-3"></i> 観測に最適な時間帯
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-center">
                                <div class="text-xs text-slate-400">観測開始</div>
                                <div class="font-mono font-bold text-lg text-green-300" id="observation-start-time">--:--</div>
                                <div class="text-xs text-slate-500">完全に暗くなる</div>
                            </div>
                            <div class="text-slate-500 text-2xl">→</div>
                            <div class="text-center">
                                <div class="text-xs text-slate-400">観測終了</div>
                                <div class="font-mono font-bold text-lg text-orange-300" id="observation-end-time">--:--</div>
                                <div class="text-xs text-slate-500">明るくなり始め</div>
                            </div>
                        </div>
                    </div>

                    <!-- 夕方→夜 -->
                    <div class="mb-3">
                        <div class="text-xs text-orange-400 mb-2 flex items-center gap-1">
                            <i data-lucide="sunset" class="w-3 h-3"></i> 夕方の流れ
                        </div>
                        <div class="space-y-1 text-sm pl-2 border-l-2 border-orange-500/30">
                            <div class="flex items-center justify-between">
                                <span class="text-slate-400">日の入り</span>
                                <span class="font-mono" id="sunset-time">--:--</span>
                            </div>
                            <div class="flex items-center justify-between text-slate-500 text-xs">
                                <span>↓ 約1時間で暗くなる</span>
                            </div>
                        </div>
                    </div>

                    <!-- 夜→朝 -->
                    <div class="mb-3">
                        <div class="text-xs text-blue-400 mb-2 flex items-center gap-1">
                            <i data-lucide="sunrise" class="w-3 h-3"></i> 朝方の流れ
                        </div>
                        <div class="space-y-1 text-sm pl-2 border-l-2 border-blue-500/30">
                            <div class="flex items-center justify-between text-slate-500 text-xs">
                                <span>↓ 約1時間で明るくなる</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-400">日の出</span>
                                <span class="font-mono" id="sunrise-time">--:--</span>
                            </div>
                        </div>
                    </div>

                    <!-- 月の出没 -->
                    <div class="border-t border-slate-700 pt-3">
                        <div class="text-xs text-slate-400 mb-2 flex items-center gap-1">
                            <i data-lucide="moon" class="w-3 h-3"></i> 月の出没（月明かりの影響）
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-slate-400">月の出</span>
                                <span class="font-mono" id="moonrise-time">--:--</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-400">月の入</span>
                                <span class="font-mono" id="moonset-time">--:--</span>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 mt-2">※ 月が出ている間は淡い天体が見えにくくなります</div>
                    </div>
                </div>
            </div>

            <!-- 夜間観測タイムライン -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="moon-star" class="text-purple-400 w-5 h-5"></i> 夜間観測タイムライン
                </h3>
                <div id="timeline-period" class="text-xs text-slate-400 mb-2"></div>
                <div id="timeline-container" class="timeline-bar"></div>
                <div id="timeline-labels" class="flex items-center justify-between mt-3 text-xs text-slate-400"></div>
                <div class="flex items-center gap-4 mt-3 text-xs flex-wrap">
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-blue-500 opacity-70 rounded"></div>
                        <span>薄明</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-green-500 opacity-70 rounded"></div>
                        <span>適時 (0-20%)</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-yellow-500 opacity-70 rounded"></div>
                        <span>注意 (20-50%)</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-orange-500 opacity-70 rounded"></div>
                        <span>不適 (50-80%)</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-4 h-4 bg-red-500 opacity-70 rounded"></div>
                        <span>不可 (80-100%)</span>
                    </div>
                </div>
            </div>

             <!-- サマリーエリア（拡張版：天気分析＋月齢） -->
             <div class="glass-panel rounded-2xl p-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- 左側：天気サマリー -->
                    <div class="flex-1 flex flex-col justify-center border-l-4 border-blue-400 pl-4">
                        <p class="text-slate-300 italic" id="forecast-summary">予報を分析中...</p>
                        <p class="text-xs text-slate-500 mt-2" id="summary-timestamp">--</p>
                    </div>

                    <!-- 右側：月齢情報 -->
                    <div class="flex flex-col items-center justify-center min-w-[150px] border-t md:border-t-0 md:border-l border-slate-700 pt-4 md:pt-0 md:pl-6">
                        <div class="text-xs text-slate-400 mb-1 uppercase tracking-wider">Moon Phase</div>
                        <div class="text-4xl mb-1" id="current-moon-icon">🌑</div>
                        <div class="text-xl font-bold text-yellow-100" id="current-moon-age-text">--</div>
                        <div class="text-sm text-yellow-200" id="current-moon-name">--</div>
                    </div>
                </div>
             </div>

            <!-- 天体イベント情報セクション -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="star" class="text-yellow-400 w-5 h-5"></i> 天体イベント情報
                </h3>

                <div class="space-y-3">
                    <!-- 天文イベント（月食・日食など） -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('astronomical-events')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="moon" class="w-4 h-4 text-orange-400"></i>
                                <span class="font-semibold text-sm">天文イベント（月食・日食）</span>
                            </div>
                            <i id="icon-astronomical-events" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-astronomical-events" class="hidden px-4 pb-4">
                            <div id="astronomical-events" class="space-y-2 text-sm">
                                <div class="text-slate-400">計算中...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 国際宇宙ステーション (ISS) -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('iss')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="satellite" class="w-4 h-4 text-blue-400"></i>
                                <span class="font-semibold text-sm">国際宇宙ステーション (ISS)</span>
                            </div>
                            <i id="icon-iss" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-iss" class="hidden px-4 pb-4">
                            <div id="iss-info" class="space-y-2 text-sm">
                                <div class="text-slate-400">計算中...</div>
                            </div>
                            <!-- ISS可視予報 -->
                            <div id="iss-prediction" class="mt-3 pt-3 border-t border-slate-700 space-y-2 text-sm hidden">
                                <div class="flex items-center gap-2 text-yellow-400">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    <span class="font-bold">可視予報</span>
                                </div>
                                <div id="iss-prediction-content" class="bg-blue-900/30 rounded-lg p-2 text-xs text-blue-200">
                                    条件を確認中...
                                </div>
                            </div>

                            <!-- 次回パス予測 -->
                            <div class="mt-3 pt-3 border-t border-slate-700 space-y-2 text-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 text-green-400">
                                        <i data-lucide="calendar-clock" class="w-4 h-4"></i>
                                        <span class="font-bold">次回パス予測（7日間）</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="requestISSNotificationPermission()" class="text-xs bg-yellow-600/20 hover:bg-yellow-600/30 px-2 py-1 rounded border border-yellow-600/30 text-yellow-300 transition flex items-center gap-1" title="1時間前通知を有効化">
                                            <i data-lucide="bell" class="w-3 h-3"></i>
                                            通知設定
                                        </button>
                                        <button onclick="calculateISSPasses()" class="text-xs text-blue-300 hover:text-blue-200 underline">
                                            再計算
                                        </button>
                                    </div>
                                </div>
                                <div id="iss-passes-list" class="space-y-1 max-h-64 overflow-y-auto">
                                    <div class="text-slate-400 text-xs">計算中...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 天の川視認性予測 -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('milkyway')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4 text-indigo-400"></i>
                                <span class="font-semibold text-sm">天の川視認性予測</span>
                            </div>
                            <i id="icon-milkyway" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-milkyway" class="hidden px-4 pb-4">
                            <div id="milkyway-visibility" class="space-y-2 text-sm">
                                <div class="text-slate-400">計算中...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 大気透明度・シーイング指標 -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('atmospheric')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="eye" class="w-4 h-4 text-cyan-400"></i>
                                <span class="font-semibold text-sm">大気透明度・シーイング指標</span>
                            </div>
                            <i id="icon-atmospheric" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-atmospheric" class="hidden px-4 pb-4">
                            <div id="atmospheric-conditions" class="space-y-2 text-sm">
                                <div class="text-slate-400">計算中...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 天体写真露出計算機 -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('exposure')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4 text-pink-400"></i>
                                <span class="font-semibold text-sm">天体写真露出計算機</span>
                            </div>
                            <i id="icon-exposure" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-exposure" class="hidden px-4 pb-4">
                            <div class="space-y-3 text-sm">
                                <!-- カメラ設定 -->
                                <div class="space-y-2">
                                    <label class="block text-slate-300 text-xs font-semibold">センサーサイズ</label>
                                    <select id="sensor-size" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                        <option value="1.0">フルサイズ (35mm)</option>
                                        <option value="1.5">APS-C (Nikon/Sony)</option>
                                        <option value="1.6">APS-C (Canon)</option>
                                        <option value="2.0">マイクロフォーサーズ</option>
                                        <option value="2.7">1型センサー</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-slate-300 text-xs font-semibold mb-1">焦点距離 (mm)</label>
                                        <input type="number" id="focal-length" value="50" min="1" max="3000" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-slate-300 text-xs font-semibold mb-1">F値</label>
                                        <input type="number" id="aperture" value="2.8" min="0.7" max="22" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-slate-300 text-xs font-semibold mb-1">ISO感度</label>
                                        <select id="iso" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                            <option value="100">100</option>
                                            <option value="200">200</option>
                                            <option value="400">400</option>
                                            <option value="800">800</option>
                                            <option value="1600">1600</option>
                                            <option value="3200" selected>3200</option>
                                            <option value="6400">6400</option>
                                            <option value="12800">12800</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-slate-300 text-xs font-semibold mb-1">赤道儀</label>
                                        <select id="tracking-mount" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                            <option value="none">なし（固定撮影）</option>
                                            <option value="basic">あり（ポータブル）</option>
                                            <option value="advanced">あり（高精度）</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-slate-300 text-xs font-semibold mb-1">撮影対象</label>
                                    <select id="target-type" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                        <option value="landscape">星景写真（風景+星空）</option>
                                        <option value="milkyway">天の川</option>
                                        <option value="widefield">星野写真（広域）</option>
                                        <option value="dso">星雲・星団（DSO）</option>
                                        <option value="galaxy">銀河</option>
                                        <option value="planet">惑星</option>
                                        <option value="moon">月面</option>
                                    </select>
                                </div>

                                <button onclick="calculateExposure()" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                                    <i data-lucide="calculator" class="w-4 h-4 inline mr-2"></i>
                                    露出設定を計算
                                </button>

                                <!-- 計算結果 -->
                                <div id="exposure-results" class="hidden mt-3 p-3 bg-slate-700/50 rounded-lg border border-slate-600">
                                    <!-- 結果がここに表示される -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 今夜見える惑星 -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('planets')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="planet" class="w-4 h-4 text-purple-400"></i>
                                <span class="font-semibold text-sm">今夜見える惑星</span>
                            </div>
                            <i id="icon-planets" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-planets" class="hidden px-4 pb-4">
                            <div id="visible-planets" class="space-y-2 text-sm">
                                <div class="text-slate-400">計算中...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 流星群カレンダー -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('meteors')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i>
                                <span class="font-semibold text-sm">流星群カレンダー</span>
                            </div>
                            <i id="icon-meteors" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-meteors" class="hidden px-4 pb-4">
                            <div id="meteor-showers" class="space-y-2 text-sm">
                                <div class="text-slate-400">読み込み中...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 月齢による観測推奨天体 -->
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <button onclick="toggleAccordion('recommended')" class="w-full p-4 flex items-center justify-between hover:bg-slate-700/30 transition">
                            <div class="flex items-center gap-2">
                                <i data-lucide="telescope" class="w-4 h-4 text-green-400"></i>
                                <span class="font-semibold text-sm">月齢による観測推奨天体</span>
                            </div>
                            <i id="icon-recommended" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                        </button>
                        <div id="content-recommended" class="hidden px-4 pb-4">
                            <div id="recommended-objects" class="space-y-2 text-sm">
                                <div class="text-slate-400">計算中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 観測適性レーダーチャート -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="radar" class="text-pink-400 w-5 h-5"></i> 観測適性レーダーチャート
                </h3>
                <div class="relative h-80 w-full">
                    <canvas id="radarChart"></canvas>
                </div>
                <p class="text-xs text-slate-400 mt-2 text-center">各要素が外側に近いほど観測に適した条件です</p>
            </div>

            <!-- チャートセクション -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 気温チャート -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="text-orange-400 w-5 h-5"></i> 気温予報 (指定時刻より24時間)
                    </h3>
                    <div class="relative h-64 w-full">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <!-- 雲の積層チャート -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="layers" class="text-blue-400 w-5 h-5"></i> 雲量推移 (指定時刻より24時間)
                    </h3>
                    <div class="relative h-64 w-full">
                        <canvas id="cloudChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 週間天気予報 -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="calendar" class="text-green-400 w-5 h-5"></i> 週間天気予報
                    <span class="text-xs font-normal text-slate-400 ml-2">※日付をクリックするとその日の詳細を表示します</span>
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-slate-400 text-sm border-b border-slate-700">
                                <th class="py-3 px-2">日付</th>
                                <th class="py-3 px-2">天気</th>
                                <th class="py-3 px-2 text-center">降水確率 / 量</th>
                                <th class="py-3 px-2 text-center">平均雲量</th>
                                <th class="py-3 px-2 text-center">平均湿度</th>
                                <th class="py-3 px-2 text-center">月齢</th>
                                <th class="py-3 px-2 text-right">最高 / 最低気温</th>
                            </tr>
                        </thead>
                        <tbody id="weekly-forecast-body" class="text-sm md:text-base">
                            <!-- JSで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- フッター (APIクレジット & 著作権) -->
        <footer class="glass-panel rounded-xl p-4 text-center text-slate-400 text-sm">
            <p class="mb-2">
                Data sources: 
                <a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer" class="text-blue-300 hover:underline">Open-Meteo</a> (Weather Data), 
                <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer" class="text-blue-300 hover:underline">OpenStreetMap</a> (Map & Address Data) & 
                <a href="https://celestrak.org/" target="_blank" rel="noopener noreferrer" class="text-blue-300 hover:underline">CelesTrak</a> (ISS TLE Data)
            </p>
            <p class="text-xs border-t border-slate-700/50 pt-2">
                &copy; 2026 株式会社リバーランズ・コンサルティング
            </p>
        </footer>

    </div>

    <!-- ISS星座図モーダル -->
    <div id="iss-skymap-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="closeISSSkymapModal(event)">
        <div class="bg-slate-900 rounded-2xl p-6 max-w-4xl w-full mx-4 border border-slate-700" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="compass" class="w-6 h-6 text-blue-400"></i>
                    現在位置から見える空（星座図）
                </h3>
                <button onclick="closeISSSkymapModal()" class="text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div id="iss-skymap-info" class="text-sm text-slate-300 bg-slate-800/50 rounded-lg p-3"></div>
                <div class="bg-black rounded-lg overflow-hidden border border-slate-700">
                    <canvas id="iss-skymap-canvas" width="800" height="600" class="w-full"></canvas>
                </div>
                <div class="text-xs text-slate-400 space-y-1">
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-3 h-3 bg-red-500 rounded-full"></span>
                        <span>ISS位置（視野内の場合のみ表示）</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-3 h-3 bg-orange-500 rounded-full"></span>
                        <span>太陽（高度>0度）</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-3 h-3 bg-white rounded-full border border-slate-400"></span>
                        <span>月（高度>0度）</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-3 h-3 bg-yellow-400 rounded-full"></span>
                        <span>惑星（高度>0度）</span>
                    </div>
                    <div>※ 観測地点から見える空を方位角・高度で表示（地平座標系）</div>
                    <div class="text-[10px]">※ astronomy-engineの制限により恒星は表示されません</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="main.js"></script>
</body>
</html>

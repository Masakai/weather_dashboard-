# 🌟 天体観測できるかな？

**バージョン 3.1.6**

天体観測に最適な条件を総合判定する、インタラクティブな気象ダッシュボードです。雲量・月明かり・湿度・視程・風速などを総合的に評価し、星空観測の成功率を高めます。

![Version](https://img.shields.io/badge/version-3.1.6-blue)
![License](https://img.shields.io/badge/license-MIT-green)

---

## 📖 目次

- [特徴](#-特徴)
- [デモ](#-デモ)
- [主要機能](#-主要機能)
- [技術スタック](#-技術スタック)
- [セットアップ](#-セットアップ)
- [使い方](#-使い方)
- [API情報](#-api情報)
- [内部仕様書](docs/internal_spec.md)
- [バージョン履歴](#-バージョン履歴)
- [ライセンス](#-ライセンス)

---

## ✨ 特徴

- **🎯 星空視認性スコア**: 複数の気象要素を総合評価し、0-100点でスコア化
- **🌙 天文薄明時刻表示**: 本格観測の開始・終了時刻を高精度計算
- **📊 24時間タイムライン**: 観測適性を時間帯ごとに可視化
- **🌍 地図連携**: クリック一つで任意の地点の気象情報を取得
- **💾 お気に入り地点**: 最大5地点を登録して瞬時に切り替え
- **🔴 ナイトビジョンモード**: 赤色表示で暗順応を妨げない
- **📱 レスポンシブデザイン**: PC・タブレット・スマートフォンに対応

---

## 🎬 デモ

`docs/index.html` をブラウザで開くだけで動作します。

```bash
# リポジトリをクローン
git clone https://github.com/Masakai/weather_dashboard.git

# ディレクトリに移動
cd weather_dashboard

# HTMLを開く
open docs/index.html
# または
firefox docs/index.html
```

---

## 🚀 主要機能

### 1. 星空視認性スコア ⭐

雲量・月明かり・湿度・視程・風速を加重平均で総合評価。

**計算式:**
```
スコア = 雲量(40%) + 月明かり(30%) + 湿度(15%) + 視程(10%) + 風速(5%)
```

**評価基準:**
- 80点以上: ⭐ 絶好の観測日和
- 60-79点: ✨ 観測に適した条件
- 40-59点: 🌤️ まずまずの条件
- 20-39点: ☁️ やや条件が悪い
- 20点未満: ❌ 観測には不向き

### 2. 詳細気象データ 🌡️

| データ項目 | 用途 |
|-----------|------|
| **風速・風向** | 望遠鏡の安定性評価 |
| **露点温度** | レンズ結露リスク判定 |
| **気圧** | 天候変化の予測 |
| **視程** | 空気の澄み具合 |

**結露リスク判定:**
- 気温 - 露点 < 2°C: ⚠️ 結露リスク高
- 気温 - 露点 2-5°C: ⚡ 結露注意
- 気温 - 露点 > 5°C: ✅ 結露リスク低

### 3. 天文薄明・日月出没時刻 🌅

astronomy-engine.jsによる高精度計算:
- **天文薄明開始** (太陽高度 -18°)
- **日の出**
- **日の入**
- **天文薄明終了** (本格観測開始時刻)
- **月の出 / 月の入**

### 4. 24時間観測適性タイムライン 📊

時間帯を色分けして表示:
- 🟡 **黄色**: 日中
- 🔵 **青色**: 薄明 (観測準備時間)
- 🟢 **緑色**: 観測適時 (本格観測時間)

### 5. ナイトビジョンモード 🌙

- 赤色表示で暗順応を妨げない
- ワンクリックで切り替え
- localStorage で設定を記憶

### 6. お気に入り地点機能 📍

- 最大5地点まで登録可能
- 地点名・緯度・経度を保存
- ワンクリックで地点切り替え

### 7. 観測適性レーダーチャート 🎯

5つの評価軸を可視化:
1. 雲の少なさ
2. 月の暗さ
3. 低湿度
4. 高視程
5. 風の穏やかさ

### 8. 天体イベント情報 🌟

#### 8-1. ISS（国際宇宙ステーション）追跡 🛰️
- TLE（Two-Line Element）データから軌道を計算
- CelesTrakからリアルタイムでTLEを取得
- 現在のISS位置（緯度・経度・高度）を表示
- 観測地点からの可視予報（次回可視時刻・最大高度・方位）
- **次回パス予測機能（7日間）** 📅
  - 今後7日間のISSパスを自動予測
  - 時刻・最大仰角・距離を一覧表示
  - パス品質評価（最適/良好/可/低）
  - クリックで星座図に軌道を表示
- **星座図表示機能（地平座標系）** 🌠
  - 観測地点から見える空を方位角・高度で視覚化
  - 太陽、月、惑星5個（水星・金星・火星・木星・土星）を同時表示（高度>0°のみ）
  - ISSが視野内（高度>0°）にある場合のみ表示
  - 選択したパスの軌道を青い点線で表示（5分刻みマーカー付き）
  - 表示時刻の動的最適化（現在位置表示は実時間、予測パスは最大高度時刻を使用）
  - ポップアップ表示で詳細な位置関係を確認

#### 8-2. 天の川視認性予測 🌌
- 銀河中心（いて座A*）の位置を高精度計算（高度・方位）
- 月明かりの影響を多角的に評価（月齢・月の高度・銀河中心との角距離）
- 雲量を考慮した総合視認性スコア（0-100点）
- 5段階評価（絶好/良好/やや不良/不良/視認不可）
- 天の川撮影に適した露出設定のアドバイス
- 観測条件に応じた具体的なアドバイスを提供

#### 8-3. 今夜見える惑星 🪐
- 水星・金星・火星・木星・土星
- 高度・方位・等級をリアルタイム表示

#### 8-4. 流星群カレンダー ☄️
- 主要8流星群を網羅
- 極大日は特別ハイライト
- 前後30日以内の流星群を自動表示

#### 8-5. 月齢による観測推奨天体 🔭
- **新月期**: アンドロメダ銀河、オリオン大星雲など
- **満月期**: 月面地形観測
- **上弦/下弦**: 月面クレーター、惑星

---

## 🛠️ 技術スタック

### フロントエンド
- **HTML5** / **CSS3** (TailwindCSS)
- **JavaScript** (Vanilla JS)

### ライブラリ
| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| [astronomy-engine.js](https://github.com/cosinekitty/astronomy) | 2.1.19 | 惑星位置・天文薄明計算 |
| [satellite.js](https://github.com/shashwatak/satellite-js) | 5.0.0 | ISS軌道計算（TLE処理） |
| [Chart.js](https://www.chartjs.org/) | latest | グラフ描画 |
| [Moment.js](https://momentjs.com/) | 2.29.4 | 日時操作 |
| [Leaflet](https://leafletjs.com/) | 1.9.4 | 地図表示 |
| [Lucide Icons](https://lucide.dev/) | latest | アイコン |

### API
| API | 用途 |
|-----|------|
| [Open-Meteo](https://open-meteo.com/) | 気象データ取得 |
| [OpenStreetMap Nominatim](https://nominatim.openstreetmap.org/) | 逆ジオコーディング |
| [CelesTrak](https://celestrak.org/) | ISS TLEデータ取得 |

---

## 📦 セットアップ

### 必要な環境
- モダンなWebブラウザ (Chrome, Firefox, Safari, Edge)
- インターネット接続 (CDN経由でライブラリを読み込むため)

### インストール

```bash
# リポジトリをクローン
git clone https://github.com/Masakai/weather_dashboard.git

# ディレクトリに移動
cd weather_dashboard

# ブラウザで開く
open docs/index.html
```

**または、ローカルサーバーを起動:**

```bash
# Python 3の場合
python -m http.server 8000

# ブラウザで http://localhost:8000/docs/index.html を開く
```

---

## 📖 使い方

### 基本操作

1. **位置情報の設定**
   - 初回アクセス時に現在地の取得を許可
   - または「地図で場所を変更」から手動で選択

2. **日時の指定**
   - コントロールバーから任意の日時を選択
   - 「現在に戻す」ボタンで現在時刻に戻る

3. **スコアの確認**
   - 星空視認性スコアで観測適性を一目で判断
   - レーダーチャートで詳細な要素を確認

4. **お気に入り地点の登録**
   - 「お気に入りに追加」ボタンをクリック
   - 地点名を入力して保存

5. **ナイトビジョンモード**
   - ヘッダー右上の月アイコンをクリック
   - 赤色表示に切り替わる

### 週間予報の活用

- 週間予報テーブルの日付をクリック
- その日の詳細データが自動表示
- 月齢・雲量・湿度を一覧で比較

---

## 🌐 API情報

### Open-Meteo API
気象予報データの取得に使用。

### OpenStreetMap Nominatim
座標から住所名への変換（逆ジオコーディング）に使用。

### CelesTrak
ISS（国際宇宙ステーション）の最新TLE（軌道要素）データの取得に使用。

---

## 📝 バージョン履歴

### v3.1.5 (2026-01-17)
**パッチアップデート**

- 🛠️ ISSリアルタイム星座図の更新不具合を修正
- 🔄 ダッシュボードで特定の日時を選択している場合でも、リアルタイム星座図では常に「現在」のISS位置と空の状態を表示・更新
- ⚙️ リアルタイムモードの状態管理を導入し、パス予測表示との切り替えを確実に実行

### v3.1.4 (2026-01-17)
**パッチアップデート**

- ⏱️ ISSリアルタイム更新画面で、ISSが地平線下にある場合に次回可視範囲に入るまでのカウントダウンを表示

### v3.1.3 (2026-01-17)
**パッチアップデート**

- 🛠️ ISS軌道計算の安定性向上（TLE取得にタイムアウト追加、パス計算処理の非同期化）
- 🔧 リモート環境での「計算中」のまま固まる問題を解消
- 📦 全モジュールのインポートにバージョンパラメータを追加し、キャッシュ問題を解消

### v3.1.2 (2026-01-17)
**パッチアップデート**

- 🛡️ `escapeHtml` 関数に null/undefined ガード追加
- 📦 `main.js` のキャッシュ対策としてバージョンパラメータを追加

### v3.1.1 (2026-01-17)
**パッチアップデート**

- 🐛 お気に入り登録時に名前が `undefined` と表示される不具合を修正

### v3.1.0 (2026-01-17)
**マイナーアップデート**

- 🛠️ 大規模なバグ修正（構文エラー、未定義関数の修復）
- 📊 観測適性レーダーチャートの不具合を解消
- 🔧 各サービスモジュールの整合性向上

### v3.0.0 (2026-01-17)
**メジャーアップデート - 大規模リファクタリング**

- 🏗️ モジュール化アーキテクチャへの移行
- 📦 `functions.js` (約3,000行) を5つのサービスモジュールに分割
  - `ui-utils.js`: 共通UI制御
  - `location-service.js`: 位置情報、地図管理
  - `weather-service.js`: 気象データ、ダッシュボード
  - `iss-service.js`: ISS軌道計算、通知
  - `astronomy-service.js`: 天体イベント
- 🔄 ES Modules 導入
- 📊 状態管理の一元化（`AppState`）
- ✅ 100% の後方互換性を維持

### v2.14.0 (2026-01-17)
**マイナーアップデート**

- 🌙 夜間観測タイムラインに雲量データを反映
- 🎨 雲密度に基づく4段階の色分け（緑・黄・橙・赤）
- 📊 詳細なツールチップと凡例を追加

### v2.13.0 (2026-01-17)
**マイナーアップデート**

- 🌸 月齢による観測推奨天体に季節対応機能を追加
- 🍂 春夏秋冬の季節ごとに最適な観測対象を表示

### v2.12.0 (2026-01-16)
**マイナーアップデート**

- 🔔 ISS通過の1時間前通知機能を追加
- 📢 ブラウザ通知とアプリ内バナー通知の両方に対応
- ⏰ 通過開始時刻の約1時間前（55-65分前）に自動通知
- 📊 通知には最大高度、継続時間などの詳細情報を表示
- ⚙️ 通知設定ボタンでブラウザ通知の許可をリクエスト

### v2.11.0 (2026-01-16)
**マイナーアップデート**

- 📷 天体写真露出計算機を追加
- 🎯 500ルール＋NPF簡易版による露出時間計算
- 📊 7種類の撮影対象別に最適化（星景/天の川/星野/DSO/銀河/惑星/月面）
- 💡 スタック枚数と総露出時間を提案
- 🎓 撮影アドバイスを自動生成（赤道儀、ISO、F値による最適化）

### v2.10.0 (2026-01-16)
**マイナーアップデート**

- 🔭 大気透明度・シーイング指標機能を追加
- 📊 湿度、視程、風速、気圧安定度から天体観測条件を推定
- 🎯 透明度スコア（星雲・星団観測向け）とシーイングスコア（惑星観測向け）を表示
- 💡 観測目的別のアドバイスを提供
- 🌡️ 気圧の3時間変化から大気安定度を評価

### v2.9.4 (2026-01-16)
**パッチアップデート**

- 🔄 ISS現在位置表示モードの星座図でISSの位置をリアルタイム更新（5秒ごと）
- 🛰️ パス予測表示モードでは固定時刻のまま（変更なし）
- ⏮️ 「現在位置に戻る」ボタンでリアルタイム更新を再開

### v2.9.3 (2026-01-16)
**パッチアップデート**

- ⚖️ フッターに「株式会社リバーランズ・コンサルティング」の著作権表示を追加
- 📝 各種ドキュメントの更新

### v2.9.2 (2026-01-16)
**パッチアップデート**

- 📝 フッターのデータソースリストにCelesTrakを追加（APIリストを3つに拡充）
- 🌐 READMEのAPI情報セクションを詳細化

### v2.9.1 (2026-01-16)
**パッチアップデート**

- 🛰️ ISSのTLE（軌道要素）取得を1日1回に制限
- 💾 localStorageによるキャッシュ機能を実装し、不要なAPIリクエストを削減

### v2.9.0 (2026-01-16)
**マイナーアップデート**

- 📊 天体観測予報のレイアウトを刷新（横並びのカード形式に変更）
- ✨ 予報アイコンを星空視認性スコアと同様のアイコン（⭐✨🌤️☁️）に統一
- 🎨 ガラスパネルデザインに合わせた洗練されたスタイルを適用

### v2.8.1 (2026-01-16)
**パッチアップデート**

- ☀️ 星座図（星図）に太陽をプロットする機能を追加
- 🟠 高度0度以上の時に太陽がオレンジ色のマーカーで表示されるように改善

### v2.8.0 (2026-01-16)
**パッチアップデート**

- ⏰ ISS星座図の計算に使用する時刻を動的に最適化
- 🔄 現在位置表示時は実時間、予測パス表示時は最大高度時刻を使用するように変更
- 🌙 ISSの位置に合わせて月や惑星の位置も正確に表示されるように改善

### v2.7.0 (2026-01-15)
**マイナーアップデート**

- 🛰️ ISSの次回パス予測機能を追加（7日間）
- 📊 次回可視時刻・最大仰角・距離を一覧表示
- ⭐ パスの品質を4段階評価（最適/良好/可/低）
- 🎨 星座図に選択したパスの軌道を青い点線で表示
- ⏰ 軌道上の5分刻みマーカーと時刻ラベル表示
- 📋 パス詳細情報パネル（開始・終了時刻、最大仰角、継続時間、距離）
- 🔄 「現在位置に戻る」ボタンで軌道表示をクリア
- ✨ 最大仰角10度以上のパスのみを表示（観測可能性を考慮）

### v2.6.3 (2026-01-15)
**パッチアップデート**

- 🐛 ISS星座図でastronomy-engineが恒星をサポートしていないため発生するエラーを修正
- 🌙 恒星の代わりに月を追加表示
- 🪐 月と惑星（水星・金星・火星・木星・土星）のみを表示
- 💬 エラーメッセージをより詳細に表示

### v2.6.2 (2026-01-15)
**パッチアップデート**

- 🐛 ISS星座図描画時に「エラーが発生しました」と表示される問題を修正
- 🔧 satellite.jsのAPI呼び出しを正しい形式に修正
- 🛠️ observerGdの定義をlongitudeを先にする形式に統一
- ✨ satellite.js専用関数を使用してコードの一貫性を向上

### v2.6.1 (2026-01-15)
**パッチアップデート**

- 🐛 ISS星座図表示時に「ISS情報が取得できていません」と表示される問題を修正
- 🔧 issTLE変数をwindow.currentTLEにも保存するように修正

### v2.6.0 (2026-01-15)
**マイナーアップデート**

- 🌍 ISS星座図を地平座標系（方位角・高度）で表示するように変更
- 👁️ 観測地点から実際に見える空の様子を表示
- 🎯 ISSが視野内（高度>0°）にある場合のみISSを表示
- ⭐ 高度>0°の恒星と惑星のみを表示（地平線下は非表示）
- 📐 グリッド線を方位角（北・東・南・西）と高度（15°刻み）に変更
- 🌅 地平線（高度0°）を太線で強調表示
- ✨ より直感的で実用的な星座図に改善

### v2.5.0 (2026-01-15)
**マイナーアップデート**

- 🌠 ISS星座図（天球図）表示機能をポップアップで追加
- 🎯 ISSの赤経・赤緯座標を高精度計算（ECI座標系から変換）
- ⭐ 主要な恒星16個（シリウス、ベガ、アークトゥルスなど）と惑星5個を表示
- 🎨 Canvasによる美麗な天球座標グラフ描画
- 📐 赤経（0-24h）・赤緯（-90°～+90°）のグリッド線表示
- 🔴 ISS位置を赤い光輪付きで強調表示
- 🔗 ISSパネルに「星座図を表示」ボタンを追加

### v2.4.0 (2026-01-15)
**マイナーアップデート**

- 🌌 天の川視認性予測機能を追加
- 🎯 銀河中心（いて座A*）の位置を高精度計算（高度・方位）
- 🌙 月明かりの影響を多角的に評価（月齢・月の高度・角距離）
- 📊 雲量を考慮した総合視認性スコア（0-100点、5段階評価）
- 📷 天の川撮影に適した露出設定（ISO/F値/シャッター速度）のアドバイス表示
- ✨ 観測条件に応じた具体的なアドバイスを提供

### v2.3.9 (2026-01-15)
**パッチアップデート**

- 🌕 天体イベント情報に「天文イベント（月食・日食）」パネルを追加
- 📅 前後180日間の月食・日食を自動検索して表示
- 🌑 イベントの種類（皆既・部分・半影月食、皆既・金環・部分日食）を表示
- ⏰ イベントまでの日数を表示（今日/○日後/○日前）
- ⭐ 30日以内のイベントには「近日開催」マークを表示

### v2.3.8 (2026-01-15)
**パッチアップデート**

- 📊 雲量推移グラフを積み重ねグラフから個別線グラフに変更
- 📈 各層（下層・中層・上層）の雲量を独立した線として表示
- 🐛 雲量の積み重ねにより100%を超えてしまう問題を解決
- 💯 Y軸の最大値を100%に固定し、パーセント表示を追加

### v2.3.7 (2026-01-15)
**パッチアップデート**

- 🌙 「当日の夜」の定義を統一：当日の日没から翌日の日の出まで
- 🌟 星空視認性スコアを日没～日の出の期間で計算
- 📊 天体観測予報も日没～日の出の期間で評価
- 📈 レーダーチャートの雲晴れ度も日没～日の出を反映
- ✨ より一般的な「夜」の定義でわかりやすく統一的な評価を実現

### v2.3.6 (2026-01-15)
**パッチアップデート**

- 🛰️ ISS視認可能範囲内の表示機能を追加
- 👁️ 仰角0度以上（地平線上）で「視認可能範囲内」と表示
- ✨ 観測条件に応じて2段階表示（最適条件/視認可能範囲内）
- 💡 仰角が低い場合や日中の場合に注意メッセージを表示

### v2.3.5 (2026-01-15)
**パッチアップデート**

- 🌌 観測期間を天文薄明終了～天文薄明開始に変更（実際の観測実態に合わせる）
- 🌟 星空視認性スコアを天文薄明基準で計算し、評価精度を向上
- 🐛 日没直後の明るい時間帯が観測期間に含まれていた問題を修正
- 🔍 デバッグログ機能を追加（開発者ツールで計算値を確認可能）
- ⚡ 時間帯別雲量と星空視認性スコアの不一致問題を改善

### v2.3.4 (2026-01-15)
**パッチアップデート**

- 🌅 観測期間を固定時間帯から実際の日没～翌日の日の出までに変更
- 🌟 星空視認性スコアを日没～日の出の平均雲量で計算するように改善
- 📊 天体観測予報の時間帯別評価を観測期間の4等分で動的生成
- 🌍 季節や緯度による観測可能時間の違いに対応
- 📈 レーダーチャートの雲晴れ度も実際の観測可能時間を反映

### v2.3.3 (2026-01-15)
**パッチアップデート**

- 📊 天体観測予報の評価基準を厳格化（絶好: 10%未満、良好: 25%未満、やや雲多: 50%未満）
- ⏰ 時間帯別の詳細評価を追加（20-22時、22-24時、0-2時、2-4時の4区分で雲量表示）
- 🌟 星空視認性スコアを夜間平均雲量（20:00-04:00）ベースに変更
- 🐛 雲量推移グラフと天体観測評価が食い違う問題を解決
- 📈 レーダーチャートの雲晴れ度も夜間平均雲量を使用

### v2.3.2 (2026-01-15)
**パッチアップデート**

- 🐛 天体観測予報の日付ずれを修正（指定日時の翌日が表示される問題を解決）
- 🌅 日の出入り・天文薄明の計算を指定日の0時基準に変更
- 📅 夜の時刻を指定しても正しく当日の日の出入り時刻を表示

### v2.3.1 (2026-01-15)
**パッチアップデート**

- 🐛 日時選択機能を改善（時間変更ができない問題を修正）
- ⏰ datetime-local inputにstep属性を追加（15分刻みで時間変更可能に）
- 💡 ツールチップを追加してユーザビリティ向上

### v2.3.0 (2026-01-15)
**マイナーアップデート**

- 🛰️ TLEベースのISS追跡機能を実装（satellite.jsライブラリ使用）
- 📡 CelesTrakからリアルタイムでTLEデータを取得
- 👁️ ISS可視予報機能を追加（観測地点からの可視性を計算）
- 🎨 天体イベント情報をアコーディオン表示に変更（省スペース化）
- 📦 4つのパネル（ISS、惑星、流星群、推奨天体）を折りたたみ可能に

### v2.2.1 (2026-01-15)
**パッチアップデート**

- 🗑️ Open Notify API依存のISS機能を一時削除（API不安定のため）

### v2.0.0 (2026-01-14)
**メジャーアップデート**

- ✨ 星空視認性スコア追加
- ✨ 追加気象データ (風速・風向・気圧・露点・視程)
- ✨ 天文薄明・日月出没時刻表示
- ✨ 24時間観測適性タイムライン
- ✨ ナイトビジョンモード
- ✨ お気に入り地点機能 (最大5件)
- ✨ 観測適性レーダーチャート
- ✨ 天体イベント情報 (惑星・流星群・推奨天体)

### v1.5.3 (2026-01-13)
- 🐛 月の出データを削除
- 🔄 バージョン復元

### v1.5.1
- ✨ 日時指定機能追加
- ✨ 週間予報クリック機能

### v1.0.0
- 🎉 初回リリース

---

## 🤝 貢献

プルリクエストを歓迎します！大きな変更の場合は、まずissueを開いて変更内容を議論してください。

1. Fork the Project
2. Create your Feature Branch (`git checkout -b feature/AmazingFeature`)
3. Commit your Changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the Branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

---

## 📄 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。詳細は [LICENSE](LICENSE) ファイルを参照してください。

&copy; 2026 株式会社リバーランズ・コンサルティング

---

## 🙏 謝辞

- [Open-Meteo](https://open-meteo.com/) - 無料の気象API
- [OpenStreetMap](https://www.openstreetmap.org/) - 地図データ
- [astronomy-engine.js](https://github.com/cosinekitty/astronomy) - 天文計算ライブラリ
- [Chart.js](https://www.chartjs.org/) - グラフ描画ライブラリ
- [Lucide Icons](https://lucide.dev/) - 美しいアイコンセット

---

## 📧 連絡先

プロジェクトリンク: [https://github.com/Masakai/weather_dashboard](https://github.com/Masakai/weather_dashboard)

---

**Happy Stargazing! 🌠**
